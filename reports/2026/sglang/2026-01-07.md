# 每日更新报告（2026-01-07）

## sgl-project/sglang

| 提交时间 | 作者 | 提交信息 |
|----------|------|----------|
| 2026-01-07 23:50:28 | Simo Lin | refactor(e2e): unify RouterInstance into Gateway class, split conftest.py into modular fixtures (#16671) |
| 2026-01-07 23:45:35 | Insideyyy | Add SwapAB Optimization for triton fused_moe_kernel on SM90. (#15712) |
| 2026-01-07 23:21:19 | Baizhou Zhang | [CI] Enable dpsk v31 test on nightly H200 (#16660) |
| 2026-01-07 22:59:49 | Simo Lin | refactor(e2e_test): fix smg ci e2e test code quality (#16664) |
| 2026-01-07 22:52:24 | Yi Zhang | support page size large than 64 for mamba radix cache (#16657) |
| 2026-01-07 22:35:15 | Simo Lin | fix(e2e_test): remove dead code and fix type annotations (#16661) |
| 2026-01-07 22:16:59 | Simo Lin | [smg][ci] preserve model launch order with test collected (#16618) |
| 2026-01-07 22:10:23 | Li Jinliang | [diffusion] bench: upgrade multimodal benchmarks for diverse applications and create a prettier, more intuitive logger. (#16179) |
| 2026-01-07 21:51:30 | Douglas Yang | ci: adding llama4 placeholder test to nightly (#16599) |
| 2026-01-07 21:11:24 | JiLi | Handle Marlin weight restoration and shape recording (QAT INT4 Rollout Part1) (#15238) |
| 2026-01-07 20:52:36 | Xiaoyu Zhang | [Diffusion] Fix Ulysses/Ring process group construction under TP to enable correct Wan2.2 tensor parallelism (#16532) |
| 2026-01-07 20:41:07 | Xiaoyu Zhang | Tiny fix readme (#16654) |
| 2026-01-07 20:20:01 | Even Zhou | [NPU] update docs (#16651) |
| 2026-01-07 18:05:17 | Hudson Xing | Re-enable temp_prefill_info assertion after pairing fix (#16203) |
| 2026-01-07 17:43:11 | Hubert Lu | [AMD] Add 8-GPU MX35X test running DSR1-MXFP4 model for AMD CI (#13602) |
| 2026-01-07 17:37:40 | YC Tseng | [AMD] suppress warning for amd (#16620) |
| 2026-01-07 15:52:46 | YC Tseng | [AMD] CI - add 2 pp test cases to performance-test-2-gpu-amd (#16514) |
| 2026-01-07 15:42:18 | Alison Shao | fix: update AMD CI estimated time for test_torch_compile (#16631) |
| 2026-01-07 14:52:42 | Shangming Cai | [Doc] Optimize pipeline parallelism doc (#16630) |
| 2026-01-07 14:20:42 | Thomas Wang | Upgrade aiter version (#16619) |
| 2026-01-07 14:17:04 | Minglei Zhu | Only allocate encoder metadata for encoder-decoder models (#16527) |
| 2026-01-07 14:00:16 | Baizhou Zhang | Clean Some Environment Variables for DeepSeek V32 (#15938) |
| 2026-01-07 13:38:31 | Douglas Yang | fix: remove performance testing from nightly dpsk v32 cp single node  (#16582) |
| 2026-01-07 13:24:04 | Chi McIsaac | [diffusion] fix: fix ZImage SP sharding for 5D latents and unpad frames (#16418) |
| 2026-01-07 13:04:48 | Alison Shao | Migrate profiling tests to test/registered/profiling/ (#16459) |
| 2026-01-07 12:50:54 | Alison Shao | Migrate attention unit tests to test/registered/attention/ (#16465) |
| 2026-01-07 12:31:52 | Alison Shao | Migrate backends tests to CI registration system (#16468) |
| 2026-01-07 12:18:44 | fzyzcjy | [model-gateway] extract header extraction in policy and add (#16566) |
| 2026-01-07 12:18:10 | Alison Shao | ci: adjust partition counts for stage-b and unit tests (#16617) |
| 2026-01-07 12:15:20 | Simo Lin | [smg][ci]: migrate benchmarks to e2e_test/benchmarks/, use parent conftest (#16597) |
| 2026-01-07 12:00:09 | Yingchun Lai | fix: fill a meaningful tool_index (#16504) |
| 2026-01-07 11:41:05 | Douglas Yang | fix: adjusting vlm accuracy thresholds (#16593) |
| 2026-01-07 11:30:35 | Yuan Luo | [VLM] Fix CUDA IPC OOM (#16118) |
| 2026-01-07 11:03:57 | MOHENOO | [HiCacheStorage & PD] fix prefill bootstrap request host memory leaks (#15439) |
| 2026-01-07 10:57:15 | Yuwei An | PCG Unit Test Adjustment (#16609) |
| 2026-01-07 10:27:43 | Alison Shao | Migrate FP8/TorchAO tests to test/registered/quant/ (#16453) |
| 2026-01-07 10:22:08 | Mick | [diffusion] chore: automatically enable dit_layerwise_offload for Wan (#16499) |
| 2026-01-07 10:15:17 | fzyzcjy | Tiny support http headers in bench serving (#16606) |
| 2026-01-07 09:53:52 | fzyzcjy | Tiny add metrics for prefill delayer (#16603) |
| 2026-01-07 09:37:27 | Hexq0210 | [NPU] fix command in npu best practice (#16576) |
| 2026-01-07 08:33:29 | Chang Su | [router][openai] Rename `prepare_mcp_payload_for_streaming` and `patch_streaming_response_json` (#16596) |
| 2026-01-07 08:32:59 | Chang Su | [router][grpc] Replace `Vec<(String, String, String)>` with `ExtractedToolCall` (#16598) |
| 2026-01-07 08:32:37 | Chang Su | [model-gateway][cleanup] Fix wrong comment in manager.rs (#16601) |
| 2026-01-07 07:05:08 | Simo Lin | refactor(e2e): keep only benchmark tests in e2e_http, remove redundant tests (#16594) |
| 2026-01-07 06:55:52 | Alison Shao | ci: migrate scheduler tests to test/registered/scheduler/ (#16442) |
| 2026-01-07 06:35:57 | Alison Shao | ci: migrate Debug Utils, Ops, and Rotary Embedding tests to test/registered/ (#16422) |
| 2026-01-07 06:34:16 | Yingchun Lai | feat: add .dockerignore to ignore files when build images (#16223) |
| 2026-01-07 06:28:24 | Kangyan-Zhou | Add v1/models endpoint to diffusion model APIs so that they can be discovered by model gateway (#16425) |
| 2026-01-07 06:27:37 | Alison Shao | Remove dllm-test-1-gpu-amd job (followup to DLLM migration) (#16589) |
| 2026-01-07 06:07:45 | Simo Lin | refactor(e2e): remove old embedding tests migrated to e2e_test/embeddings (#16592) |
| 2026-01-07 05:24:37 | Simo Lin | [model-gateway] add embedding tests (#16583) |
| 2026-01-07 05:18:43 | Douglas Yang | fix: kimi k2 thinking accuracy threshold change (#16585) |
| 2026-01-07 04:44:32 | Simo Lin | [smg] clean up logs in mcp (should be info instead warn) (#16591) |
| 2026-01-07 03:09:37 | Alison Shao | ci(test): migrate OpenAI server tests to registered CI system (#16326) |
| 2026-01-07 01:53:12 | Douglas Yang | fix: adding retries for server start and increasing hf read timeout (#16523) |
| 2026-01-07 01:44:26 | Alison Shao | ci: migrate DLLM tests to test/registered/dllm/ (#16420) |
| 2026-01-07 01:23:58 | Simo Lin | [ci] fix url strips in smg ci (#16548) |

### 📊 统计摘要
> 本日共 57 个提交 | 🔴高 9 | 🟡中 26 | 🟢低 22
## 📋 目录

- [sgl-project/sglang](#sgl-project-sglang)
  - [📊 统计摘要](#-统计摘要)
  - [🔴 高重要度变更 (9)](#-🔴-高重要度变更-9)
    - [refactor(e2e): unify RouterInstance into Gateway class, s...](#c356ed0)
    - [refactor(e2e_test): fix smg ci e2e test code quality (#16...](#55b7936)
    - [fix(e2e_test): remove dead code and fix type annotations ...](#8729ad5)
    - [[smg][ci] preserve model launch order with test collected...](#e432057)
    - [[smg][ci]: migrate benchmarks to e2e_test/benchmarks/, us...](#d8b8198)
    - [refactor(e2e): keep only benchmark tests in e2e_http, rem...](#dce8b06)
    - [feat: add .dockerignore to ignore files when build images...](#6beb50d)
    - [refactor(e2e): remove old embedding tests migrated to e2e...](#d415d22)
    - [[model-gateway] add embedding tests (#16583)](#a49b9a6)
  - [🟡 中重要度变更 (26)](#-🟡-中重要度变更-26)
    - [support page size large than 64 for mamba radix cache (#1...](#7fc12e0)
    - [[diffusion] bench: upgrade multimodal benchmarks for dive...](#4d902c8)
    - [Handle Marlin weight restoration and shape recording (QAT...](#fd16c91)
    - [[Diffusion] Fix Ulysses/Ring process group construction u...](#32a6540)
    - [[NPU] update docs (#16651)](#d4b717c)
    - [[AMD] Add 8-GPU MX35X test running DSR1-MXFP4 model for A...](#b86bbf8)
    - [fix: update AMD CI estimated time for test_torch_compile ...](#6b8a9d7)
    - [Clean Some Environment Variables for DeepSeek V32 (#15938)](#7d757d6)
    - [fix: remove performance testing from nightly dpsk v32 cp ...](#5c04088)
    - [[diffusion] fix: fix ZImage SP sharding for 5D latents an...](#f066036)
    - [Migrate profiling tests to test/registered/profiling/ (#1...](#52de807)
    - [Migrate attention unit tests to test/registered/attention...](#70933f3)
    - [[model-gateway] extract header extraction in policy and a...](#3be1e73)
    - [fix: fill a meaningful tool_index (#16504)](#913b688)
    - [fix: adjusting vlm accuracy thresholds (#16593)](#951d16c)
    - [Migrate FP8/TorchAO tests to test/registered/quant/ (#16453)](#90eac38)
    - [Tiny support http headers in bench serving (#16606)](#d874c8b)
    - [Tiny add metrics for prefill delayer (#16603)](#9a21d89)
    - [[router][openai] Rename `prepare_mcp_payload_for_streamin...](#fb5b71d)
    - [[router][grpc] Replace `Vec<(String, String, String)>` wi...](#05b54b6)
    - [ci: migrate scheduler tests to test/registered/scheduler/...](#399d528)
    - [Add v1/models endpoint to diffusion model APIs so that th...](#18e2ef0)
    - [fix: kimi k2 thinking accuracy threshold change (#16585)](#5349764)
    - [ci(test): migrate OpenAI server tests to registered CI sy...](#0cbd8f3)
    - [fix: adding retries for server start and increasing hf re...](#6e3fff1)
    - [[ci] fix url strips in smg ci (#16548)](#a3656cb)
  - [🟢 低重要度变更 (22)](#-🟢-低重要度变更-22)
    - [Add SwapAB Optimization for triton fused_moe_kernel on SM...](#ee4d228)
    - [[CI] Enable dpsk v31 test on nightly H200 (#16660)](#153c69f)
    - [ci: adding llama4 placeholder test to nightly (#16599)](#2ff8723)
    - [Tiny fix readme (#16654)](#62d0280)
    - [Re-enable temp_prefill_info assertion after pairing fix (...](#98a107d)
    - [[AMD] suppress warning for amd (#16620)](#48381c3)
    - [[AMD] CI - add 2 pp test cases to performance-test-2-gpu-...](#8bce085)
    - [[Doc] Optimize pipeline parallelism doc (#16630)](#973116e)
    - [Upgrade aiter version (#16619)](#820e97d)
    - [Only allocate encoder metadata for encoder-decoder models...](#4c85f9d)
    - [Migrate backends tests to CI registration system (#16468)](#ce453fa)
    - [ci: adjust partition counts for stage-b and unit tests (#...](#38895a0)
    - [[VLM] Fix CUDA IPC OOM (#16118)](#5384674)
    - [[HiCacheStorage & PD] fix prefill bootstrap request host ...](#534ac38)
    - [PCG Unit Test Adjustment (#16609)](#2a8d549)
    - [[diffusion] chore: automatically enable dit_layerwise_off...](#badcd02)
    - [[NPU] fix command in npu best practice (#16576)](#4c9ac85)
    - [[model-gateway][cleanup] Fix wrong comment in manager.rs ...](#4f443f4)
    - [ci: migrate Debug Utils, Ops, and Rotary Embedding tests ...](#2e0527d)
    - [Remove dllm-test-1-gpu-amd job (followup to DLLM migratio...](#3271e0e)
    - [[smg] clean up logs in mcp (should be info instead warn) ...](#d57d8e7)
    - [ci: migrate DLLM tests to test/registered/dllm/ (#16420)](#2210155)
#### 🔴 高重要度变更 (9)

### refactor(e2e): unify RouterInstance into Gateway class, split conftest.py into modular fixtures (#16671)
**SHA**: `c356ed0` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/c356ed03dd8f2c6ac8e4246eebacbf35a8ad7622)

**🎯 变更类型**：重构 / 架构变更  

**⚡ 重要程度**：🔴 高  

**📋 变更摘要**  
- 将原有的 `RouterInstance`（仅用于云后端）合并进统一的 `Gateway` 类，新增 **cloud mode**，通过 `gateway.start(cloud_backend=…)` 启动 OpenAI/XAI 云路由器，同时保留原有的 regular、PD、IGW 三种启动方式。  
- 将庞大的 `e2e_test/conftest.py` 拆分为 **fixtures**、**hooks**、**markers**、**pool**、**setup_backend** 等子模块，形成模块化、可维护的 pytest 测试基础设施。  
- 为兼容迁移期间保留了 `RouterInstance`、`launch_cloud_router`、旧 `CLOUD_BACKENDS` 等别名，同时在 `backends.py` 中统一使用 `Gateway`。  
- 更新了相关文档字符串、日志、错误提示以及导出列表，使 `pytest` 能自动发现新模块。  

---

### 🔍 技术洞察

| 维度 | 影响 |
|------|------|
| **架构影响** | 1. **统一入口**：`Gateway` 成为所有路由/网关启动的唯一入口，消除了 `RouterInstance` 与 `Gateway` 的双重实现，简化了代码路径和运行时配置。<br>2. **新的启动模式**：`cloud_backend` 参数让网关直接对接 OpenAI/XAI，无需外部 “router” 进程，内部实现依旧走 `sglang_router.launch_router`，但通过统一的子进程管理。<br>3. **向后兼容**：通过别名 `launch_cloud_router = launch_cloud_gateway`、`RouterInstance` 已被废弃但仍保留旧导入，确保旧 CI / 用户脚本暂时不失效。<br>4. **测试框架重构**：拆分的 `fixtures` 包把 **收集、GPU 校验、模型池管理、后端初始化** 分离，降低 `conftest.py` 的行数（约 1256 → ≈ 400），提升可读性与维护效率。 |
| **性能影响** | - **启动开销**： `Gateway.start(cloud_backend=…)` 与原 `launch_cloud_router` 本质相同，但省去一次包装对象的创建，微幅提升实例化速度（可忽略）。<br>- **资源占用**：云模式不启动本地 `sglang` worker 进程，GPU/CPU 占用明显下降，仅保留网关进程（约 1‑2 s 启动）。<br>- **测试集合**：模块化 fixtures 使 pytest 只在需要时导入对应代码，缩短测试收集时间（尤其在 CI 多并行运行时）。 |
| **安全考虑** | 1. **API Key 注入**：在 `Gateway._launch` 中通过 `self._env` 向子进程注入 `OPENAI_API_KEY` / `XAI_API_KEY`，仅在子进程环境中可见，避免在父进程或日志中泄露。<br>2. **参数校验**：新增 `cloud_backend` 参数检查，仅接受 `"openai"`、`"xai"`，防止任意字符串导致未知子进程启动。<br>3. **历史后端**：仍通过 `--history-backend` 参数传递，保持与本地后端相同的安全模型；若使用 `oracle`（持久化），需自行确保其安全性。<br>4. **向后兼容**：旧的 `RouterInstance.shutdown` 调用已被映射到 `Gateway.shutdown`，不引入新的资源泄露风险。 |
| **可维护性** | - **代码分层清晰**：`fixtures` 包按职责划分（hooks、pool、setup_backend、markers），每个文件职责单一，易于单元测试和独立演进。<br>- **统一错误信息**：启动模式冲突统一抛出 `"Cannot specify multiple modes..."`，降低误用可能。<br>- **文档+日志**：新增详细 docstring 与启动日志（如 `"openai cloud gateway"`），便于调试。 |
| **兼容性风险** | 1. **旧导入**：外部项目仍可能直接引用 `sgl_model_gateway.e2e_test.backends.RouterInstance` 或 `launch_cloud_router`，虽然仍提供别名，但如果直接依赖其属性（如 `base_url`）而未调用 `shutdown`，可能在云模式返回 `Gateway` 时缺少 `base_url`（仍支持，但类型不同）。<br>2. **环境变量**：云模式强制要求对应 `*_API_KEY` 环境变量，缺失时会直接 `ValueError`，导致 CI 失败。<br>3. **pytest 发现**：如果用户自行在根目录下保留老的 `conftest.py`，可能出现重复 fixture 定义冲突。<br>4. **历史后端别名**：`CLOUD_BACKENDS` 仍保留 `oracle_store` 兼容条目，若未迁移到新的 `history_backend` 参数，可能出现配置不一致警告。 |
| **业务价值** | - **统一接口**：开发者只需关心 `Gateway`，无论是本地 worker、PD、IGW 还是云后端，API 统一，降低学习曲线。<br>- **测试加速**：不再需要额外的 “router” 进程启动，云端 E2E 测试资源使用更轻，CI 成本下降。<br>- **迁移准备**：通过模块化 fixtures 为后续 `e2e_response_api` 迁移奠定结构基础，代码更易演进。 |

---

### ⚠️ 潜在风险

1. **API Key 泄露**  
   - 子进程环境 `self._env` 直接复制父进程 `os.environ`，若父进程中已有其他敏感变量未过滤，可能随子进程一起暴露。推荐在 `cloud_mode` 启动时只拷贝必要变量。

2. **启动模式冲突**  
   - 参数组合错误会抛 `ValueError`，但错误信息在 CI 中可能被误解为测试本身失败。建议在文档或 README 中明确说明四种互斥模式的使用方式。

3. **遗留别名带来的隐藏错误**  
   - `launch_cloud_router = launch_cloud_gateway` 仍返回 `Gateway` 实例；旧代码期望 `RouterInstance` 具备 `base_url`、`router_process`、`backend` 属性，若使用了已废弃属性会出现 `AttributeError`。需要在迁移期提供兼容 shim（例如在 `RouterInstance` 类中包装 `Gateway`）。

4. **并发启动冲突**  
   - `Gateway.start` 在 `self._started` 检查后直接创建子进程。若同一 `Gateway` 对象在多线程/多进程下被重复调用，可能出现端口冲突或子进程泄漏。建议在文档中标明 **每个实例只能在单线程/单进程中使用**。

5. **GPU 需求校验与 Cloud Mode**  
   - `validate_gpu_requirements` 仍在 `hooks.py` 中执行，即使所有测试只使用 cloud 后端也会检查 GPU 可用性，导致不必要的错误。可以在 `hooks` 中检测是否所有测试均为云模式后跳过 GPU 校验。

---

### 💡 关注建议

| 对象 | 建议 |
|------|------|
| **开发者** | 1. **迁移到 `Gateway`**：在新代码中直接使用 `Gateway`，删除对 `RouterInstance`、`launch_cloud_router` 的引用。<br>2. **显式指定 `cloud_backend`**：在云端 E2E 测试或本地脚本中使用 `gateway.start(cloud_backend="openai", history_backend="memory")`，避免默认走本地模式。<br>3. **环境变量管理**：只在启动云模式前检查 `*_API_KEY`，若缺失给出明确提示而非异常回溯。 |
| **测试维护者** | 1. **删除旧 `conftest.py`**：确保项目根目录只保留新的 `e2e_test/fixtures` 包，防止重复 fixture 注册。<br>2

---

### refactor(e2e_test): fix smg ci e2e test code quality (#16664)
**SHA**: `55b7936` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/55b7936582eeace2953d12f972f512b403f7a5f1)

**🎯 变更类型**：重构  
**⚡ 重要程度**：🔴 高  

**📋 变更摘要**  
- 对 `e2e_test` 测试套件的核心脚本进行质量提升：统一日志分隔、统一重试次数、提升异常捕获与日志输出。  
- 抽离公共常量（`LOG_SEPARATOR_WIDTH、MAX_RETRY_ATTEMPTS`）并在多处使用，简化健康检查逻辑，新增 `wait_for_health` 公共实现。  
- 将工作节点信息的构造抽象为 `_worker_from_api_response`，统一 API→内部模型的映射。  

**🎯 影响范围**  
- `sgl-model-gateway/e2e_test/benchmarks/conftest.py`  
- `sgl-model-gateway/e2e_test/conftest.py`  
- `sgl-model-gateway/e2e_test/fixtures/router_manager.py`  
- `sgl-model-gateway/e2e_test/infra/*`（constants、gateway、gpu_allocator、model_pool、simple_eval_common、simple_eval_mmlu、run_eval）  

**🔍 技术洞察**  

- **架构影响**  
  1. **统一常量层**：通过 `infra/constants.py` 把日志分隔宽度、重试上限等抽出，提升模块之间的配置一致性，降低硬编码风险。  
  2. **健康检查抽象**：`infra.wait_for_health` 取代 `RouterManager._wait_health`，实现单一职责，便于在其他组件复用（如可能的 worker 启动脚本）。  
  3. **Worker 信息工厂**：`gateway._worker_from_api_response` 把 API 响应转换为内部 `WorkerInfo` 的逻辑集中，降低重复代码，未来若后端字段调整，只需在一个位置修改。  
  4. **错误处理统一**：在调用外部 `genai-bench` 时加入 `FileNotFoundError、PermissionError、OSError` 捕获，直接在测试中通过 `pytest.fail` 报告，防止因系统环境问题导致的隐藏错误。  

- **性能影响**  
  - **几乎无额外运行时开销**：新增的常量读取、函数封装在 Python 层的成本极低。  
  - **日志与异常输出**：在失败路径中追加了更详细的 `logger.error`，对正常路径影响微乎其微。  
  - **GPU 监控与超时处理**：保持原有行为，仅在异常时多记录一次日志。  

- **安全考虑**  
  - **文件执行检查**：捕获 `FileNotFoundError` 与 `PermissionError`，防止因路径被篡改或执行权限被修改而导致的测试误报。  
  - **不泄露敏感信息**：日志仅打印 `stdout`/`stderr` 内容，未加入环境变量或凭证，安全影响有限。  

**⚠️ 潜在风险**  

1. **导入路径变更**：`infra.wait_for_health` 新增后，若项目其他未更新的模块仍引用旧的私有 `_wait_health`，会导致 `ImportError`。  
2. **常量同步**：`LOG_SEPARATOR_WIDTH` 和 `MAX_RETRY_ATTEMPTS` 被硬编码在若干文件中；若后续需要修改，需要确认所有引用已通过 `constants` 统一。  
3. **异常路径对 CI 影响**：新增的 `logger.error` 与 `pytest.fail` 会让原本因可执行文件缺失而“挂起”的测试快速失败，可能导致 CI 立即报错。  
4. **兼容性**：`subprocess.Popen` 的异常捕获在某些平台（Windows）会抛出不同的 OSError 子类，需要确保 `pytest.fail` 能正确显示信息。  
5. **重试次数上限变更**：`MAX_RETRY_ATTEMPTS` 从硬编码 `6` 改为可配置常量，若其他模块仍使用硬编码值，可能出现不一致的重试行为。  

**💡 关注建议**  

- **回归测试**：在本地与 CI 环境完整运行一次 `e2e_test`，确保所有新增常量、函数导入路径均生效。  
- **文档同步**：在项目文档或 `README` 中补充 `LOG_SEPARATOR_WIDTH`、`MAX_RETRY_ATTEMPTS` 的说明，以免后续贡献者误用硬编码。  
- **CI 环境检查**：确保 CI 节点已经装有 `genai-bench` 可执行文件，并且拥有相应执行权限，避免因新加入的 `PermissionError` 检查导致的误报。  
- **退化路径监控**：监控 CI 报告的 `genai-bench` 超时或错误日志，若频繁出现，评估是否需要调高 `GENAI_BENCH_TEST_TIMEOUT`。  
- **代码审查**：后续增加新的 `infra` 组件时，统一走 `constants` → `utils` → `core` 的层级结构，保持本次重构的“一致性”原则。  

---

### fix(e2e_test): remove dead code and fix type annotations (#16661)
**SHA**: `8729ad5` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/8729ad5e6c389f495f1cce9dc8c11f15b3ec0cba)

**🎯 变更类型**：Bug修复 / 代码清理  
**⚡ 重要程度**：🔴高  
**📋 变更摘要**：本次提交删除了 e2e 测试套件中未使用的常量、冗余函数以及旧的 GPU 检测逻辑，同时统一了类型注解（使用 `Any`、`list[str]` 等），并将超时获取的默认值写死为 600 秒。目标是消除死代码、提升代码可读性与类型检查准确性，避免因误导性的常量或函数导致维护负担。

**🎯 影响范围**：  
- `sgl-model-gateway/e2e_test/conftest.py`（类型注解更新）  
- `sgl-model-gateway/e2e_test/infra/simple_eval_common.py`（函数参数类型从 `List[str]` 改为 `list[str]`）  
- `sgl-model-gateway/e2e_test/utils.py`（删除大量未使用的常量与 `skip_if_no_gpu` 辅助函数，简化 `get_test_timeout` 实现）

**🔍 技术洞察**  
- **架构影响**：  
  - 仅限于端到端测试层面的代码清理，对生产业务代码、模型网关主流程没有直接影响。  
  - 移除的 `skip_if_no_gpu` 逻辑本质上是测试层面的资源检测，若项目的 CI/CD 环境依赖该函数进行 GPU 检测，则需要在其它地方补充相同的检测或在 CI 配置中明确跳过此类测试。  

- **性能影响**：  
  - 删除了不再使用的全局常量与函数，加载 `conftest.py` 的解析时间轻微下降，几乎可以忽略不计。  
  - `get_test_timeout` 直接返回硬编码字符串转整数，省去一次 `DEFAULT_TIMEOUT` 变量的读取，提升了微秒级的读取效率，同样对整体执行时间影响极小。  

- **安全考虑**：  
  - 代码改动未触及网络、文件 I/O、权限控制等安全相关路径，风险基本为零。  
  - 由于删除了对 GPU 检测的异常捕获（`torch`/`pynvml` 导入失败时的回退），如果测试环境没有 GPU 且仍然运行需要 GPU 的测试，可能导致测试异常或泄露底层错误信息。但这属于功能层面的可预见行为，不构成安全漏洞。  

**⚠️ 潜在风险**  
1. **测试可靠性**：如果某些 e2e 测试用例原本依赖 `skip_if_no_gpu` 自动跳过，在没有 GPU 的 CI 环境下，这些用例将被强制执行，可能导致测试超时或失败。  
2. **兼容性**：更改了 `make_report_from_example_htmls` 参数的类型注解（从 `List[str]` 到 `list[str]`），在使用旧的类型导入（如 `from typing import List`）的调用方可能出现类型检查警告，但运行时不受影响。  
3. **默认超时硬编码**：若未来需要统一修改默认超时，需要在多个地方手动更新，易产生不一致风险。  

**💡 关注建议**  
- **测试层面**：在 CI 配置中显式声明是否需要 GPU，或在缺少 GPU 时通过 `pytest.mark.skip` 标记相应测试，避免因 `skip_if_no_gpu` 被移除而导致不必要的失败。  
- **维护建议**：将 `E2E_TEST_TIMEOUT` 的默认值抽象为常量（如 `DEFAULT_E2E_TIMEOUT = 600`）放在统一配置文件中，便于后续统一调整。  
- **类型注解**：保持统一的类型导入风格（全部使用 `list[str]`、`dict[str, Any]` 而非 `List`），并在项目的 `mypy` 配置中启用 `strict` 检查，以防止类似的类型不一致再次产生。  
- **文档更新**：在项目的测试文档或 CONTRIBUTING.md 中说明已移除 `skip_if_no_gpu`，并提供新的 GPU 检测或跳过方案的示例。  

---

---

### [smg][ci] preserve model launch order with test collected (#16618)
**SHA**: `e432057` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/e432057381029ca59761729e7c268d26c370d84a)

**🎯 变更类型**：功能增强 / 重构  
**⚡ 重要程度**：🔴 高  

**📋 变更摘要**  
- 为 E2E 测试基础设施引入 **`WorkerIdentity`**，统一描述 `model_id、ConnectionMode、WorkerType、index`，并在模型池、GPU 分配、调度等关键路径使用该标识。  
- 改写 pytest 标记解析 logic，将 **`workers`** 标记（普通、prefill、decode）纳入需求扫描，并记录首次出现顺序，以 **保留模型启动顺序** 与测试收集顺序保持一致。  
- GPU 分配器 `allocate_slots` 新增 `preserve_order` 参数，支持按测试收集顺序而非默认的 **内存大小降序** 进行分配。  
- `ModelPool.startup`、`launch_workers`、`launch_regular_workers` 等统一为 **`launch_workers`**，一次性处理任意 Worker 类型（regular、prefill、decode），并实现 PD（prefill‑decode）工作流的统一引导端口与 InfiniBand 检测。  
- CI workflow 名称从 `router-embeddings` 改为 `e2e`，保持与代码改动一致。  

**🎯 影响范围**  
- `sgl-model-gateway/e2e_test/infra/`（`conftest.py、constants.py、gpu_allocator.py、model_pool.py、__init__.py`）  
- 依赖模型池的所有测试用例（包括 PD、普通、Embeddings、Router 等）  
- CI 脚本 `.github/workflows/pr-test-rust.yml`（测试目录调度）  

**🔍 技术洞察**  

- **架构影响**  
  - **抽象升级**：`WorkerIdentity` 将模型、模式、工作类型与实例索引解耦，为后续扩展（如多模态 worker、跨节点调度）提供统一键。  
  - **启动顺序保留**：通过 `_first_seen_order` 捕获首次出现的 `(model, mode, worker_type)`，在 `ModelPool.startup` 中按该顺序分配 GPU 与启动进程，避免因重新排序导致的 “先启动后面测试需求，后面再启动前面需求” 的资源竞争。  
  - **统一调度入口**：原来的 `launch_regular_workers`、`launch_pd_workers` 被合并为 `launch_workers`，降低 API 表面复杂度，减少代码重复。  
  - **GPU 分配策略可选**：`preserve_order` 使分配器既支持“最佳打包”（默认）也支持“测试顺序优先”，灵活兼顾性能与确定性。  

- **性能影响**  
  - **启动时序**：保持测试收集顺序可能导致 **非最优的 GPU 打包**（例如先分配小模型占用大 GPU，后大模型找不到合适的连续卡），从而触发 **MRU 驱逐** 或产生额外的延迟。  
  - **GPU 分配路径**：新增 `preserve_order` 只在测试场景被使用，对生产环境（默认不保序）保持原有的 **first-fit‑decreasing** 效率。  
  - **统一 `launch_workers`**：一次性批量分配并启动，多进程并发启动不受影响；仅在 PD 场景下额外创建 **共享 bootstrap 端口**，开销可忽略。  

- **安全考虑**  
  - 代码未改变网络通信协议，仅在内部使用 `WorkerIdentity.key` 作为日志/字典键，未引入外部输入直接拼接，风险极低。  
  - 新增的 **InfiniBand 检测** 仍通过内部 `detect_ib_device()`，不泄露系统信息。  
  - 环境变量 `ENV_SKIP_MODEL_POOL`、`ENV_STARTUP_TIMEOUT` 仍受原有校验，未新增安全入口。  

**⚠️ 潜在风险**  

1. **资源竞争与驱逐**  
   - 按顺序分配可能导致 GPU 资源不足，触发 MRU 驱逐逻辑，若驱逐策略不够细致，可能在同一套测试中多次启动/销毁同模型，增加启动时延。  

2. **兼容性**  
   - 旧的测试用例仍可能使用原始 `@pytest.mark.parametrize("setup_backend", …)` 或缺少 `workers` 标记；若未检测到 `workers`，默认 `count=1`，但 **默认模型** 逻辑改为通过 `DEFAULT_MODEL` 且在 `conftest` 中仍保留 `_needs_default_model`，可能出现未预期的默认模型启动。  

3. **CI 稳定性**  
   - CI workflow 中测试目录改名为 `e2e`，若外部脚本仍引用旧目录或旧 job 名称，可能导致 **PR 检查遗漏**。  

4. **GPU 分配错误**  
   - `allocate_slots` 在 `preserve_order=True` 时不再排序，若 `model_specs` 中的 `tp`（跨卡）大于可用连续 GPU 数量，仍会返回空列表并导致 **启动失败**，错误信息可能不够直观。  

5. **日志可读性**  
   - `WorkerIdentity.__str__` 生成的键在日志中出现较多，若 CI 日志未过滤，可能淹没关键错误信息。  

**💡 关注建议**  

- **回归测试**：在本地与 CI 环境分别跑 **完整的 e2e 测试套件**（包括 PD、router、embeddings），确认没有出现意外的驱逐或启动超时。  
- **文档更新**：在项目 README 与 `e2e_test/infra/README.md` 中补充 `workers` 标记使用说明（`count`、`prefill`、`decode`），以及 **保序启动** 的影响与如何禁用（通过 `preserve_order=False`）。  
- **CI 迁移检查**：确认所有依赖此 workflow 的外部工具（如 bots、报告生成器）已同步使用新 job 名称 `e2e`。  
- **GPU 监控**：在 CI 中开启 `GPUMonitor`，并在测试结束后记录 **GPU 使用峰值**，帮助评估保序分配是否导致显著的资源浪费。  
- **容错改进**：在 `allocate_slots` 返回空列表时，可在 `ModelPool.startup` 中打印 **模型‑GPU 匹配详细信息**（所需 TP、可用连续 GPU 列表），便于快速定位配置问题。  
- **逐步回滚方案**：保留旧的 `launch_regular_workers` 与 `launch_pd_workers` 接口（标记 `# pragma: no cover`），以防业务方仍依赖旧 API，提供最小化回滚步骤。  

--- 

以上分析覆盖了架构、性能、兼容性与安全等关键维度，帮助评审者快速定位风险点并制定相应的验证与改进计划。祝评审顺利 🚀

---

### [smg][ci]: migrate benchmarks to e2e_test/benchmarks/, use parent conftest (#16597)
**SHA**: `d8b8198` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/d8b8198192d2ef952de6d5269bc2549aa9d0f81d)

**🎯 变更类型**：功能增强 / 重构 / 架构变更  
**⚡ 重要程度**：🔴高  

**📋 变更摘要**  
1. 将原有的 **router‑benchmark** CI 工作流迁移到统一的 `e2e_test/benchmarks/` 目录，并在 CI 中使用新的 **gateway‑e2e** 矩阵来统一跑 HTTP、gRPC 与基准测试。  
2. 为基准测试提供 **GPU 利用率监控**（`infra/gpu_monitor.py`）以及统一的 **BenchmarkResult/GPUMonitor** 数据类/工具。  
3. 重构 `model_pool`：  
   - 新增 `launch_regular_workers`（多实例负载均衡），  
   - 细化 **MRU 驱逐逻辑**，支持按 **worker 类型 / mode** 排除，  
   - 引入 `instance_key` 让实例键可自定义（避免冲突）。  
4. 新增基准测试 fixtures 与测试（`test_pd_perf.py`, `test_regular_perf.py`），并删除了旧的 HTTP‑only 基准测试实现。  

---

## 🔍 技术洞察

| 维度 | 影响概述 |
|------|----------|
| **架构影响** | • CI 工作流从 **pr-test-pd-router.yml** 完全删除，改为 **gateway‑e2e** 矩阵，统一管理 HTTP、gRPC、Benchmarks。<br>• `sgl-model-gateway` 的模型管理层 (`model_pool`) 现在支持 **多实例并行启动**（regular workers）以及 **细粒度 MRU 驱逐**（可排除特定 `WorkerType`、`ConnectionMode`）。<br>• `infra/gpu_monitor.py` 引入独立进程采样 GPU 利用率，返回统一的 JSON 结构，所有基准测试统一使用 `genai_bench_runner` 调用并自动挂载监控。 |
| **性能影响** | • 通过 **GPU‑util 监控** 能在基准测试期间捕获 GPU 饱和度，帮助定位性能瓶颈。<br>• `launch_regular_workers` 采用 **一次性 GPU 分配 + 并行启动**，避免逐个启动时的反复调度，能在多 worker 场景下提升启动速度和整体吞吐。<br>• MRU 驱逐策略从 “按模型排除” 细化为 “按 worker type / mode 排除”，可以保留需要的 regular workers，同时释放 PD worker 使用的 GPU，提升资源利用率。 |
| **安全考虑** | • 新增的 `gpu_monitor` 只读取本机 NVML 信息，不会泄露网络或文件内容。<br>• CI 中的 `disable_annotations: true` 关闭了 sccache 的注解信息，降低 CI 日志泄露风险。<br>• 所有新增的环境变量（如 `GPU_UTIL_LOG`、阈值字段）均受限于 CI 运行环境，未对外暴露。 |
| **可维护性** | • 基准测试代码统一放在 `e2e_test/benchmarks/`，配套 `conftest.py`、`results.py`、`summarize.py`，结构清晰，便于后续新增 benchmark 场景。<br>• `model_pool._evict_for_gpus` 现在接受 **排除模式** 参数，内部实现改为 **键‑实例二元组**，避免因键名冲突导致错误驱逐。<br>• 新增 `should_monitor_gpu` 统一判断是否启用监控，降低各处硬编码的重复。 |

---

## ⚠️ 潜在风险

| 风险点 | 说明 | 可能后果 |
|--------|------|----------|
| **GPU 监控进程启动失败** | `gpu_monitor.py` 依赖 `pynvml`，如果 CI 镜像未预装或 NVML 初始化报错，会生成空的 `gpu_utilization.json`，导致后续阈值断言误报或失效。 | 基准测试可能误报 “GPU utilization below threshold” 或完全跳过监控检查。 |
| **驱逐逻辑误排除** | `launch_regular_workers` 在 MRU 驱逐时排除 `WorkerType.REGULAR`，但若用户同时请求 `PD` (prefill/ decode) 与 `REGULAR` 的同一模型，可能仍会误驱逐正在运行的 PD 实例（因为排除集合只包括 `REGULAR`）。 | 运行时可能遇到 GPU 不足导致 worker 启动失败，CI 失败。 |
| **实例键冲突** | `instance_key` 允许外部显式指定键；若测试或业务代码自行构造相同键（如 `model_id:mode:index`），则会覆盖已有实例，导致后续 `get` 取到错误实例。 | 可能出现 “worker not reachable” 或 “duplicate worker registration”。 |
| **并发启动竞争** | 在高并发的 CI 环境下，多 workers 同时申请 GPU，若 `allocator.allocate_slots` 的分配策略不具备事务性，仍有可能出现 **资源争抢**（同一个 GPU 被两个实例分配）。 | 某些 worker 启动失败或报错 “CUDA device already in use”。 |
| **阈值硬编码** | 基准测试阈值（如 `ttft_mean_max = 13`）写死在测试文件中，若底层模型或硬件升级导致性能波动，CI 会频繁失效。 | 需要定期维护阈值或改为可配置。 |
| **CI 超时** | 新的 `gateway-e2e` 矩阵每个子任务默认 `timeout: 32/45` 分钟，且在基准测试中调用 `genai-bench` 仍会消耗数分钟；在资源紧张的 GitHub 自托管 Runner（8‑GPU‑a10）上可能触发 **资源饱和**，导致后续 job 被取消。 | CI 频繁出现 “cancelled” 或 “timeout”。 |
| **兼容性** | 删除的 `e2e_http` 目录下的旧 fixtures 可能仍被外部项目引用（例如内部脚本或用户自定义测试）。 | 导入错误 `ModuleNotFoundError`。 |

---

## 💡 关注建议

| 建议类别 | 具体措施 |
|----------|-----------|
| **测试/CI** | 1. 在 CI 镜像中显式 **安装 `pynvml`**（`pip install nvidia-ml-py3`）并验证 `nvidia-smi` 能被访问。<br>2. 为 `gateway-e2e` 矩阵的 **每个子任务** 添加 `continue-on-error: false` 并在失败后打印 `GPU monitor`、`genai-bench` 的完整日志，便于定位是资源不足还是阈值不匹配。 |
| **驱逐策略** | 1. 在 `ModelPool._evict_for_gpus` 中加入 **日志**：列出待驱逐实例的 `key、worker_type、mode、last_used`，并在驱逐前打印 “Attempting MRU eviction”。<br>2. 考虑在 `launch_regular_workers` 中提供 **`allow_partial`** 参数，允许在 GPU 不足时仍启动已能分配的子集，避免整个 job 因缺少 GPU 而直接失败。 |
| **实例键管理** | 将 `instance_key` 生成逻辑统一封装（例如 `ModelPool._make_instance_key(model_id, mode, index=None, worker_type=None)`），并在 `launch_regular_workers` 与 `launch_pd_workers` 中保持一致，防止键冲突。 |
| **基准阈值** | 将阈值抽离到 **配置文件**（如 `benchmarks/thresholds.yaml`），CI 通过 `env` 或 `inputs` 动态读取，便于在模型/硬件升级时只修改配置。 |
| **GPU 监控** | 1. 提供 **可选的采样间隔**（默认 2 s），并在测试中通过 `GPU_UTIL_SAMPLE_INTERVAL` 环境变量调节，兼容不同规模的模型。<br>2. 在 `GPUMonitor.assert_thresholds` 中加入 **可选的 `fail_fast`** 参数，让基准测试在 GPU 利用率异常时直接中止，节省 CI 时间

---

### refactor(e2e): keep only benchmark tests in e2e_http, remove redundant tests (#16594)
**SHA**: `dce8b06` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/dce8b0606c06d3a191a24c7b8cbe8e238ab316c9)

**🎯 变更类型**：重构  
**⚡ 重要程度**：🔴高  
**📋 变更摘要**：本次提交在 `sgl-model-gateway/e2e_test/e2e_http` 目录下删除了大量原有的端到端（e2e）功能测试，仅保留了基准测试 `test_genai_bench`。移除了包括 MMLU 评估、工作节点动态增删、容错、TLS 启动及 API‑Key 鉴权等场景的测试用例，代码行数从 354 行削减至 0 行（全部删除）。

**🎯 影响范围**：  
- `sgl-model-gateway/e2e_test/e2e_http/test_pd_router.py`  
- `sgl-model-gateway/e2e_test/e2e_http/test_regular_router.py`  
- `sgl-model-gateway/e2e_test/e2e_http/test_tls.py`  

这些文件属于 **e2e 测试套件**，不直接参与运行时业务逻辑，但在 CI/CD 中承担功能、可靠性及安全验证的角色。

**🔍 技术洞察**  
- **架构影响**：  
  - 仅删除了测试代码，对系统架构本身（router、worker、gateway）没有任何修改。  
  - 使得 `e2e_http` 目录的职责从“完整端到端验证”收缩为“基准性能验证”，降低了对多种部署/运行时场景的覆盖。  

- **性能影响**：  
  - CI 运行时间大幅下降（原始 e2e 测试需要数分钟至十几分钟），有助于提升 PR 合并效率。  
  - 对生产环境性能没有任何直接影响，因为被删除的代码仅在测试进程中执行。  

- **安全考虑**：  
  - 删除了 `test_tls.py`，该测试验证了 TLS 证书生成、HTTPS 接入以及自签证书的兼容性，意味着 CI 将不再自动检查路由器的 TLS 启动路径。若后续在 TLS 相关配置上出现回归，缺乏自动化检测可能导致安全漏洞未被及时发现。  
  - 其它被删除的测试（如 API‑Key 鉴权、动态 worker 扩容）同样涉及安全和授权检查，失去持续验证。  

**⚠️ 潜在风险**  
1. **回归风险提升**：关键功能（worker 动态增删、容错、身份认证、TLS）不再受自动化测试覆盖，代码改动或依赖升级后更容易出现未捕获的缺陷。  
2. **质量门槛降低**：CI 仅保留基准测试，可能导致团队对功能完整性的感知下降，出现“测试不重要”的错误预期。  
3. **安全回退风险**：缺少 TLS 启动及 API‑Key 鉴权的端到端验证，可能在生产环境中遗漏对加密通道或授权错误的检测。  

**💡 关注建议**  
- **保留或迁移关键功能测试**：将涉及安全/容错的用例（TLS、API‑Key、worker 增删、故障恢复）迁移到专门的 **功能/安全回归套件**，并在 CI 中保留至少每周一次的完整运行。  
- **增加测试标签**：使用 `pytest.mark.slow` 或 `pytest.mark.security` 等标记，对不同重要性的测试进行分层，既能在快速 PR 检查中运行基准测试，又能在每日/每周的全套 CI 中执行完整 e2e 用例。  
- **监控覆盖率**：在 CI 中加入代码覆盖率报告，关注 `sgl-model-gateway` 关键模块（router、worker 管理、TLS 配置）的覆盖率是否因删除测试而下降。  
- **文档更新**：在项目文档或贡献指南中说明已将多数 e2e 场景移出默认 CI，并提供运行完整 e2e 测试的指令，以免贡献者误以为这些功能不再需要验证。  
- **回归验证**：在未来的关键发布（如 major 版本或安全补丁）前，手动或通过专门的 CI job 重新执行完整的 e2e 测试，确保关键路径仍然可靠。  

---  

**结论**：本次重构通过大幅削减 e2e 测试文件，显著提升 CI 速度，但也显著降低了对多场景功能、容错与安全特性的自动化验证。建议在保持快速 PR 检查的同时，建立分层测试策略或定时全套 e2e 执行，确保关键功能不会因缺失测试而产生回归风险。

---

### feat: add .dockerignore to ignore files when build images (#16223)
**SHA**: `6beb50d` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/6beb50d612eff067307d8a090d036aa4a7283db8)

**🎯 变更类型**：功能增强  
**⚡ 重要程度**：🔴高  
**📋 变更摘要**：在仓库根目录新增 `.dockerignore`，其内容仅为 `.gitignore`，用于在 Docker 镜像构建阶段排除该文件；同时对现有 `.gitignore` 做了通配符 (`**/`) 调整，使忽略规则在任意子目录均生效。预计可以减小 Docker 构建上下文体积，加速镜像构建，提升 CI/CD 效率。  

**🎯 影响范围**：  
- Docker 镜像构建流程（`docker build`）  
- CI/CD Pipelines（使用 Docker 的测试/部署阶段）  
- 开发者本地 `git` 操作（因 `.gitignore` 规则更宽泛）  

**🔍 技术洞察**：  
- **架构影响**：  
  - 引入 `.dockerignore` 后，Docker Build 的上下文将不再包含 `.gitignore`（仅 1 KB），对整体架构无直接影响，但间接提升镜像构建的可控性与一致性。  
  - `.gitignore` 中使用 `**/` 前缀，使忽略规则在所有子目录统一生效，降低因新增子目录导致的意外文件泄露风险。  

- **性能影响**：  
  - 减少 Docker 构建上下文大小（尤其是在大型 monorepo 中），可显著缩短 `docker build` 的传输与解压时间。  
  - 对于 CI Runner（如 GitHub Actions、GitLab CI）来说，可降低网络 I/O 与磁盘 I/O，间接提升整体流水线吞吐。  

- **安全考虑**：  
  - `.dockerignore` 防止将 `.gitignore`（以及潜在的敏感文件）打包进镜像，降低意外泄漏的概率。  
  - `.gitignore` 规则的宽化避免了在子目录中误提交临时构建产物（如 `build/`、`dist/`），有助于保持代码库的干净，间接提升供应链安全。  

**⚠️ 潜在风险**：  
1. **误拦截源码文件**：`**/` 前缀会在所有层级匹配，若项目中出现与忽略模式同名的合法文件夹（例如 `lib/custom/`），可能被误忽略，导致 `git add` 时无法提交。  
2. **CI 环境的缓存失效**：若已有 Docker 构建缓存，新增 `.dockerignore` 可能触发重新构建，导致 CI 耗时短暂上升。  
3. **跨平台兼容性**：`**/` 语法在老旧的 Git 版本中不被支持，可能在某些极端环境下出现忽略失效的情况。  

**💡 关注建议**：  
- **回归验证**：在本地与 CI 环境分别执行一次完整的 `docker build`，确认构建产物未受意外影响，且构建时间有预期下降。  
- **审查 `.gitignore`**：在代码审查时特别留意新增的 `**/` 规则，确保不与业务真实目录产生冲突；如有冲突，可使用更细粒度的排除（例如 `!src/lib/keep/`）。  
- **版本要求**：在项目的 `README` 或 `CONTRIBUTING` 中注明最低 Git 版本（≥2.13）以保证 `**/` 语法兼容。  
- **CI 缓存策略**：考虑在 CI 配置中加入 `--no-cache` 参数的短暂验证，以确保新增 `.dockerignore` 不会导致意外的缓存失效后续影响。  
- **安全审计**：在安全审计清单中加入“Docker 上下文文件检查”，确认未来任何敏感文件均已被 `.dockerignore` 正确覆盖。  

---

### refactor(e2e): remove old embedding tests migrated to e2e_test/embeddings (#16592)
**SHA**: `d415d22` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/d415d22daa370104eb064570b6345dc5c2b71d5f)

**🎯 变更类型**：重构（删除冗余测试）  
**⚡ 重要程度**：🔴高  
**📋 变更摘要**：本次提交在 `sgl-model-gateway/e2e_test` 目录下一次性删除了三个旧的 Embedding 相关 E2E 测试文件（`test_embedding_correctness.py`、`test_embedding_server.py`、`test_e2e_embeddings.py`），共计约 **435 行**代码。删除的测试原本用于验证 gRPC 与 HTTP 接口的 Embedding 正确性、数值一致性以及基本请求/响应行为。迁移后的新测试已放置在 `e2e_test/embeddings`（未在本次提交中展示），旨在统一管理并剔除过时的实现。

---

### 🎯 影响范围
- **测试子系统**：`sgl-model-gateway/e2e_test/e2e_grpc/basic`、`sgl-model-gateway/e2e_test/e2e_http`  
- **CI/CD 流程**：GitHub Actions 中的 E2E 测试阶段（运行时间、测试报告）  
- **文档/示例**：与这些旧测试对应的 README/DevGuide 章节（如有）可能需要同步更新  

---

### 🔍 技术洞察

| 维度 | 影响说明 |
|------|----------|
| **架构影响** | 代码层面仅删除了测试文件，对生产代码、服务路由、模型网关等核心组件没有任何结构性改动。唯一的架构层面影响是**测试用例组织方式的变更**——从分散的 `basic`/`http` 子目录统一到 `e2e_test/embeddings`，有助于后续维护与扩展。 |
| **性能影响** | 删除约 4 分钟（CI 经验值）以上的 E2E 测试运行时间，间接提高 CI 反馈速度。对运行时服务本身没有影响。 |
| **安全考虑** | 测试代码不参与生产运行，删除不会引入安全风险。唯一需留意的是**确保新迁移的测试覆盖了相同的安全边界**（如异常输入、token 计数、HTTPS/GRPC 认证），否则可能在后续部署中遗漏安全检测。 |
| **可维护性** | 旧测试文件冗余且未随模型升级同步，导致代码审查噪声。删除后：<br>• **降低维护成本**（不必维护两套几乎相同的测试）<br>• **提升覆盖率可视化**（所有 Embedding 测试集中在同一个目录）<br>然而，若迁移不完整，可能出现**覆盖缺口**，需要通过新测试的覆盖报告进行验证。 |
| **测试覆盖** | 旧文件包含：<br>1. 与 HuggingFace 基准的数值对齐（`test_embedding_correctness.py`）<br>2. gRPC 嵌入接口的基本请求/响应（`test_embedding_server.py`）<br>3. HTTP 接口的批量嵌入返回结构（`test_e2e_embeddings.py`）<br>如果新 `e2e_test/embeddings` 中未覆盖这些场景，**回归风险**会提升。 |

---

### ⚠️ 潜在风险
1. **回归检测缺失**  
   - 若迁移的新版测试未完整复现旧测试的 **语义相似度对齐**、**批量请求**、**日志/用量统计** 等检查，模型网关的数值精度或 API 行为改变后可能不被及时捕获。  
2. **CI 配置不匹配**  
   - GitHub Actions 中的路径过滤（如 `paths: ["e2e_test/**"]`）若未同步更新，可能导致新测试不被触发，导致 CI 通过但功能缺失。  
3. **文档/示例不一致**  
   - 项目文档中仍然引用已删除的文件路径或示例代码，使用者在阅读时会产生困惑。  
4. **误删风险**  
   - 如果这三个文件中包含了特定模型（如 `e5-mistral`）的特殊 **pooling** 逻辑验证，而新测试未覆盖该模型，后续模型升级可能出现隐藏错误。  

---

### 💡 关注建议
| 建议 | 说明 |
|------|------|
| **确认迁移完整度** | 在合并前让 CI 生成 **覆盖率报告**（如 `coverage xml`），对比旧测试涉及的代码路径是否仍被新测试覆盖。重点关注：<br>• `get_openai_embeddings` 与 `get_hf_st_embeddings` 的数值一致性<br>• `compare_embeddings` 中的 cosine 相似度校验<br>• 用量（tokens）统计字段 |
| **更新 CI 配置** | 检查 `.github/workflows/*.yml` 中的 `paths`、`skip-checkout`、`matrix` 等是否仍指向旧目录，必要时改为 `e2e_test/embeddings/**`。 |
| **文档同步** | 在 `README.md`、`docs/quick_start.md`、`docs/e2e_tests.md` 等章节中删除或更新已失效的文件路径和示例代码。 |
| **保留备份或标签** | 若团队担心误删，可在 `git tag` 中打上 `embedding-tests-pre-refactor`，或在 `docs` 中保留旧测试的简要说明，以便历史追溯。 |
| **增加回归告警** | 在 CI 中加入 **新旧数值对齐的阈值检查**（如 `abs(sim - 1.0) < 1e-2`），并在 PR 检查列表中标记 “Embedding 正确性”。 |
| **定期审计** | 建议每个迭代周期（如 2 周）审计一次 `e2e_test/embeddings` 目录的测试用例，确保新加入模型或新特性都有对应的 E2E 验证。 |

---

**结论**：此次提交主要是一次**清理性重构**，通过删除已迁移的旧 Embedding 测试来简化代码库、加快 CI。只要确保新测试完整覆盖了旧测试的核心验证点（数值精度、接口一致性、用量统计），风险可控。后续关注点在于 **CI 配置同步**、**文档更新** 与 **覆盖率监控**，以防止因测试缺失导致的潜在回归。

---

### [model-gateway] add embedding tests (#16583)
**SHA**: `a49b9a6` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/a49b9a6420128a144217f3e044db4645588e00c1)

**🎯 变更类型**：功能增强 / 重构  
**⚡ 重要程度**：🔴高  

**📋 变更摘要**  
1. 为模型网关（model‑gateway）新增完整的 Embedding API 测试，包括基础功能、批量、维度一致性、空串、Unicode 以及与 HuggingFace 参考实现的数值正确性对比。  
2. 重构 E2E 测试标记体系，去除 `scope` 概念，统一使用 MRU（Most‑Recently‑Used）驱动的模型调度；实现模型在需要时按需启动并在 GPU 资源紧张时“最近使用的”模型被驱逐。  
3. 为模型启动命令添加 `--is-embedding` 标志，使网关能够识别并优化嵌入模型。  
4. CI 工作流做了两类调整：① 暂时禁用`router‑benchmark` 作业并添加说明；② 在 Rust 绑定构建阶段对 `pip uninstall sglang-router` 加上容错 (`|| true`)，并在依赖中加入 `numpy`。  
5. 细节改动：新增日志、去除不再使用的 `class‑scoped` 相关代码、改写 GPU 资源分配与驱逐逻辑、更新 IGW（In‑Gateway）模式测试说明。

**🎯 影响范围**  
- `.github/workflows/*`（CI 配置）  
- `sgl-model-gateway/e2e_test/*`（测试框架、infra、router、embeddings）  
- `sgl-model-gateway/e2e_test/infra/model_pool.py`（模型调度与 GPU 分配）  
- `sgl-model-gateway/e2e_test/infra/gateway.py`（启动日志）  
- `sgl-model-gateway/e2e_test/router/test_worker_api.py`（IGW 模式测试）  

**🔍 技术洞察**  

| 维度 | 影响说明 |
|------|----------|
| **架构影响** | - **ModelPool** 由原来的 **session / class** 双层调度改为 **统一 MRU 驱逐**。模型不再在会话开始预加载，而是尽可能在 GPU 空间足够时预启动，资源不足时驱逐最近使用的模型。<br> - 删除 `register_class_scoped_models`、`_class_scoped_models`、`_queued_models`等冗余状态，简化模型生命周期管理。<br> - 新增 `--is-embedding` 标志，使网关二进制在检测到嵌入模型时可以开启专用的向量化路径（目前仅是透传标记，但为后续优化留出入口）。 |
| **性能影响** | - **启动延迟**：第一次请求未预启动的模型需要即时拉起，可能导致单次测试耗时增加（约 1‑2 s）。<br> - **GPU 利用率**：MRU 驱逐策略在 GPU 资源高度竞争的 CI 场景下，可更快释放最近占用的卡，提升整体并发度。<br> - **测试时长**：新增的 Embedding 基础/正确性测试大幅度增加 CI 总时长（≈ +3‑5 min），但对功能覆盖有显著提升。 |
| **安全考虑** | - 本次改动未触及网络或权限控制，仅在 CI 环境中加入 `numpy` 依赖，安全风险极低。<br> - `pip uninstall sglang-router || true` 可能掩盖卸载异常，潜在导致残留旧版本二进制被误用，需在正式发布前确保卸载成功。 |
| **可维护性** | - 删除 `scope` 参数后，测试代码更简洁，标记统一为 `@pytest.mark.model(name)`，降低了新手误用风险。<br> - MRU 驱逐实现集中在 `_evict_for_gpus`，易于后续调参或换成其他策略（如 LFU）。<br> - 由于 `ModelPool.get` 现在会自动执行 `_ensure_gpu_available` 并在必要时触发驱逐，调用方无需关心资源调度，代码耦合度下降。 |
| **CI 影响** | - `pr-test-pd-router.yml` 被临时关闭，若忘记恢复会导致 router‑benchmark 功能缺失。<br> - 增加 `numpy` 依赖后，部分旧的镜像可能因兼容性问题需要重新构建。 |

**⚠️ 潜在风险**  
1. **MRU 驱逐误删活跃模型**：如果同一模型在同一测试会话中多次切换（如并行的 parametrize），最近使用的模型可能被驱逐导致后续请求重新启动，出现间歇性超时或 flaky。  
2. **多模型同一 GPU 需求冲突**：`ModelPool.get` 在缺少可用 GPU 时会尝试驱逐，但驱逐后仍可能不足（TP>1），此时抛出 `RuntimeError`，会导致测试直接失败。  
3. **`--is-embedding` 标志未被后端二进制识别**：如果底层 worker 未实现对应逻辑，启动会报未知参数错误，导致 CI 失败。  
4. **CI 中 `pip uninstall sglang-router || true`**：掩盖了卸载失败的情况，可能导致旧版 router 与新代码混用，造成不可预期行为。  
5. **禁用 `router‑benchmark` 作业**：临时关闭后，若忘记恢复，项目失去关键性能回归检测，风险累积。  

**💡 关注建议**  
- **验证 MRU 驱逐**：在 CI 中增加专门的 GPU 资源冲突场景测试（如并发请求 3‑4 个不同模型），确保驱逐逻辑不会导致无限循环或死锁。  
- **驱逐阈值监控**：在 `ModelPool._evict_for_gpus` 中记录被驱逐的模型及时间，建议在 CI 报表中加入统计，以便发现异常高频驱逐。  
- **Embedding 标志兼容性**：在本地或 CI 环境中手动启动 `sglang-router` 带 `--is-embedding`，确认二进制接受并正常启动；若不支持，添加后端兼容层或将标志作为 no‑op。  
- **清理 CI 临时改动**：在正式合并前恢复 `pr-test-pd-router.yml` 中的原始触发条件，并去掉 `if: false` 的注释。  
- **依赖管理**：把 `numpy` 迁移到项目根目录的 `requirements.txt`（或 `pyproject.toml`）中，以保持依赖统一，避免未来 CI 镜像因缺失而报错。  
- **卸载容错**：将 `pip uninstall sglang-router || true` 改为明确检查返回码，

---

#### 🟡 中重要度变更 (26)

### support page size large than 64 for mamba radix cache (#16657)
**SHA**: `7fc12e0` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/7fc12e0bfa3ae1808b7ae3c1afa3b4c979bac57e)

**🎯 变更类型**：功能增强  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：将 Mamba Radix Cache 的块大小从固定的 `FLA_CHUNK_SIZE (=64)` 放宽为 `max(FLA_CHUNK_SIZE, page_size)`，从而支持页面大小大于 64 的模型。相应地，在调度批处理、前缀匹配以及服务器参数校验处都改用了新变量 `MAMBA_CACHE_V2_CHUNK_SIZE`（或 `mamba_cache_v2_chunk_aligned_seqlen`），并放宽了对 `page_size` 与 `FLA_CHUNK_SIZE` 的整除约束。  

**🎯 影响范围**：  
- `python/sglang/srt/managers/schedule_batch.py`（批次准备逻辑）  
- `python/sglang/srt/mem_cache/mamba_radix_cache.py`（前缀匹配、分支序列长度计算）  
- `python/sglang/srt/server_args.py`（启动参数校验）  

**💡 关注建议**  
1. **兼容性检查**：确认在 `page_size < FLA_CHUNK_SIZE` 时仍保持原有行为，避免旧模型出现对齐错误。  
2. **整数除法**：所有 `// MAMBA_CACHE_V2_CHUNK_SIZE` 计算应在 `page_size` 为 0 或非常大时保持安全，建议加入断言或异常提示。  
3. **性能回归**：页面大小变大可能导致 KV 池分配更粗粒度，调研是否会影响显存利用率或吞吐量。  
4. **单元/集成测试**：新增对 `page_size=128,256` 等非 64 整数的覆盖测试，验证缓存命中、分支点及 `mamba_track_interval` 的对齐逻辑。  
5. **文档更新**：在模型部署说明中明确 “page_size 必须是 FLA_CHUNK_SIZE 的倍数或更大”，并解释 `max/min` 整除检查的含义。  

总体来说，此次改动解耦了块大小与固定 64 的限制，提升了对大页面模型的支持，但需在测试和参数校验上做好防护，以防出现对齐或内存碎片问题。

---

### [diffusion] bench: upgrade multimodal benchmarks for diverse applications and create a prettier, more intuitive logger. (#16179)
**SHA**: `4d902c8` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/4d902c82119cbe56b7faf0e6e6f46f1ef35dba38)

**🎯 变更类型**：功能增强、重构  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
1. 为 `bench_serving.py` 引入统一日志体系（`configure_logger`/`init_logger`），全部 `print` 替换为结构化日志。  
2. 任务类型不再由 `--backend/--task` 手工指定，而是通过 `huggingface_hub.model_info(pipeline_tag)` 自动推断；`--backend` 设为可选并在后续逻辑中被弃用。  
3. 依据任务自动选择对应的 SGLang API（`/v1/images/...`、`/v1/videos`），并在 CLI 中新增 `--log‑level` 参数。  

**🎯 影响范围**  
- `python/sglang/multimodal_gen/benchmarks/bench_serving.py`（核心执行入口）。  
- 新增/使用 `sglang.multimodal_gen.runtime.utils.logging_utils`。  
- 依赖 `huggingface_hub`（`model_info`）的环境。  

**💡 关注建议**  
- **兼容性**：旧版脚本仍可传 `--backend`、`--task`，但将被忽略；建议在发行说明中明确标记已废弃。  
- **依赖检查**：确保运行环境安装 `huggingface_hub`，否则会在入口处抛异常。可考虑在 `requirements.txt` 中加入或在代码里做降级提示。  
- **日志配置**：`configure_logger(args)` 必须在解析参数后立即调用，避免早期 `print` 信息丢失。  
- **错误提示**：`task_name` 与模型 `pipeline_tag` 不匹配时会发出 `warning`，但仍继续执行；若业务对任务严格，建议改为 `raise`。  
- **文档更新**：README 与 CLI 示例需改为 “`sglang serve … --port xxx` → `python -m … --port xxx`”，并说明 `--log-level` 用法。  

总体而言，此次改动提升了可观测性并简化了使用方式，但需留意依赖和向后兼容的迁移步骤。

---

### Handle Marlin weight restoration and shape recording (QAT INT4 Rollout Part1) (#15238)
**SHA**: `fd16c91` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/fd16c91cb8dff7afc68a4033dec047907d5ea1d1)

**🎯 变更类型**：功能增强（Marlin 量化权重的自动恢复与形状记录）  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：在 `compressed_tensors_moe.py` 中为 MoE 层新增了“原始形状”记录以及在 Marlin 格式与 GPT‑Q 格式之间来回切换的保护逻辑。主要改动包括：

1. **`_original_shapes` 字典**：在 `create_weights` 与 `process_weights_after_loading` 中首次出现时创建，用来保存 `w13_weight_packed、w2_weight_packed` 以及对应 scale 的原始 shape。  
2. **防止二次打包**：通过 `layer.is_marlin_converted` 标记，在再次进入 `process_weights_after_loading` 时直接返回。  
3. **统一 `replace_tensor`**：抹去原有的 `replace_parameter` 调用，改为直接对已有张量调用 `resize_`、`copy_`，并在第一次替换时把原 shape 写入 `_original_shapes`（防止被 Marlin shape 覆盖）。  
4. **`restore_weights_before_loading`**：在加载权重前强制把所有受影响的张量恢复到保存的原始形状，并重置 `is_marlin_converted`。  

---

### 影响范围
- **核心模块**：`sglang.srt.layers.quantization.compressed_tensors`（MoE 权重量化部分）。  
- **关联**：任何使用 `GPTQMarlinState.REPACK` 的 MoE Transformer（例如 `sglang` 的 LLM 推理路径），以及在模型保存/加载循环中依赖权重原始形状的代码。  

---

### 关注建议

| 方向 | 建议 |
|------|------|
| **语义一致性** | `replace_tensor` 仍然直接修改张量而不重新包装为 `torch.nn.Parameter`，这可能导致优化器在 `state_dict` 保存/恢复时失去参数信息。建议在替换后使用 `torch.nn.Parameter(new_tensor, requires_grad=False)` 并重新赋值。 |
| **属性冲突** | `layer._original_shapes` 与模型的其它自定义属性可能冲突。可考虑使用统一前缀（如 `__marlin_original_shapes`）或放到 `layer.__dict__` 中的专用命名空间。 |
| **线程安全** | 在多线程/多进程推理场景下，`is_marlin_converted` 与 `_original_shapes` 的写入未加锁。若模型在不同进程间共享内存，需加入简单的锁或确保转换仅在单例初始化阶段完成。 |
| **恢复完整性** | `restore_weights_before_loading` 只对 `_original_shapes` 中的键进行恢复，若后续新增了其它需要恢复的张量（比如 bias），需要同步更新。建议在 `create_weights` 中统一登记所有受影响的张量。 |
| **单元测试** | 为以下两点新增测试：<br>1. 连续两次 `process_weights_after_loading` → `restore_weights_before_loading` → `process_weights_after_loading`，保证 shape 不会被再次压缩且 `is_marlin_converted` 正确切换。<br>2. `state_dict` 保存后重新加载，确认权重恢复到 GPT‑Q shape。 |
| **兼容性** | 该改动在已有模型的 `state_dict` 中新增了两个属性（`_original_shapes`、`is_marlin_converted`）。加载旧模型时不会出错，但在 `torch.save` 时会额外存储这两个字段，建议在 `state_dict` 时有条件地过滤（`if not self.is_marlin_converted`）。 |
| **文档/注释** | 为 `process_weights_after_loading`、`restore_weights_before_loading` 增加函数级 docstring，说明何时应显式调用恢复函数，防止使用者误以为自动完成。 |

---

**总体结论**：本次提交为 Marlin 量化添加了必要的“回滚”机制，提升了模型在不同量化阶段间切换的鲁棒性。只要在参数包装、并发安全以及测试覆盖上做少量补充，即可平滑集成到现有推理流水线中。

---

### [Diffusion] Fix Ulysses/Ring process group construction under TP to enable correct Wan2.2 tensor parallelism (#16532)
**SHA**: `32a6540` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/32a6540afcd798d139163a0cd81b85d8f33169a6)

**🎯 变更类型**：功能增强 / Bug 修复  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
1. 在 `parallel_state.py` 中改为通过真实的 SP 子组构造 Ulysses/Ring 进程组，新增 `set_seq_parallel_pg_by_sp_groups`，解决 TP > 1 时 SP 组非连续导致的组构建错误。  
2. 将多个模块的 `ReplicatedLinear` 替换为 `ColumnParallelLinear`（并在需要时开启 `gather_output`），让模型在 Tensor‑Parallel 环境下使用列并行实现。  
3. 为暖启动请求保存原始 `num_inference_steps`，并在 `denoising`、`scheduler` 中使用该值，确保 Cache‑DIT 能正确初始化。  
4. 调整 `ServerArgs.adjust_offload` 的默认行为，避免在未显式设置时覆写用户配置；对 SP + TP 混合并行发出警告而非直接报错。  
5. 在 `cache_dit_integration.py` 中引入 `get_dit_group`，在 SP + TP 场景下为 Cache‑DIT 提供统一的 TP×SP 进程组。

**🎯 影响范围**  
- `sglang/multimodal_gen/runtime/distributed/*`（进程组管理）  
- `sglang/multimodal_gen/runtime/layers/linear.py`（列并行实现）  
- `visual_embedding.py、wanvideo.py、denoising.py`（模型层和推理路径）  
- `server_args.py`（离线/混合并行配置）  
- `cache_dit_integration.py`（Cache‑DIT 与 SGLang 的协同）

**💡 关注建议**  
1. **并行一致性**：在多机 TP > 1 + SP 场景下，所有进程必须使用相同的 `sp_groups` 顺序；建议在集群启动脚本中打印 `sp_groups` 供调试。  
2. **Cache‑DIT 验证**：开启 `cache_dit` 时，对比 TP = 1 与 TP > 1 的生成结果，确保 `tp_sp_group` 正确传递且不产生跨组同步错误。  
3. **兼容性回退**：若用户仍需使用 `ReplicatedLinear`（如仅跑单卡），确保 `ColumnParallelLinear` 的 `gather_output=True` 不引入额外通信开销。  
4. **配置检查**：`ServerArgs.adjust_offload` 现在只在参数为 None 时设置默认值，升级脚本时请确认旧配置不会被意外覆盖。  
5. **测试覆盖**：新增的进程组逻辑和暖启动字段应在 CI 中加入 TP × SP 混合并行的单元测试，防止潜在的 dead‑lock 或组不对称问题。  

总体来看，本次提交解决了原先在 TP > 1 时 Ulysses/Ring 进程组构建错误，提升了 Cache‑DIT 在张量并行下的可用性，同时对模型层实现进行了统一的列并行改造。上线后建议在多机多卡环境下做全链路压测，确认性能提升与正确性兼顾。

---

### [NPU] update docs (#16651)
**SHA**: `d4b717c` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/d4b717c01ead29bae6f73286d0df345a6a203908)

**🎯 变更类型**：其他（文档更新）  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
- 删除了 `docs/platforms/ascend_npu_best_practice.md`（约 3622 行），该文件原本提供 Ascend NPU 的最佳实践指南。  
- 同步在 `docs/platforms/ascend_npu_support.rst` 中去掉了对该文件的引用。  

**🎯 影响范围**  
- **文档站点**：导航结构、搜索索引、侧边栏会少一个条目；若有外部链接指向被删除的页会出现 404。  
- **使用者**：依赖该最佳实践的开发者将失去参考资料，可能导致部署或调优时缺少指导。  
- **CI/CD**：Sphinx 文档构建流程会因为文件缺失而更快完成，但需要确认没有残留的交叉引用。  

**💡 关注建议**  
1. **检查迁移**：若该最佳实践内容已合并到其他文档（如 `ascend_npu_support_features.md`），请在相应章节添加明确的说明和跳转链接。  
2. **更新索引**：运行 `make html` 或 CI 中的文档构建，确保侧边栏、搜索索引不再出现失效条目。  
3. **外部链接**：在项目的 README、博客或社区帖子中搜索旧文件的 URL，及时改为新的位置或添加重定向说明。  
4. **发布说明**：在 Release Notes 或文档更新日志中注明此文件已删除并提供替代入口，避免使用者困惑。  

整体来看，此次提交仅影响文档层面，未改动代码逻辑。只要做好迁移与链接检查，即可平稳发布。

---

### [AMD] Add 8-GPU MX35X test running DSR1-MXFP4 model for AMD CI (#13602)
**SHA**: `b86bbf8` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/b86bbf841e813716fa82c9e1cd08e3c267feb682)

**🎯 变更类型**：功能增强 / CI 扩展  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：为 AMD 平台新增 1‑GPU 与 8‑GPU（mi35x）CI 作业，完善镜像依赖安装流程，并新增 `test_deepseek_r1_mxfp4_8gpu.py`，在 `run_suite.py` 中注册对应测试套件。  

**🎯 影响范围**  
- `.github/workflows/pr-test-amd.yml`：CI 作业增删，跑 1‑GPU、8‑GPU mi35x 测例。  
- `scripts/ci/amd_ci_install_dependency.sh`、`amd_ci_exec.sh`：依赖安装与失败重试逻辑调整。  
- `test/srt/run_suite.py`、新增 `test_deepseek_r1_mxfp4_8gpu.py`：加入 DeepSeek‑R1‑MXFP4 8‑GPU 评估与吞吐测试。  

**💡 关注建议**  
1. **镜像准备**：确认 `mi35x` Docker 镜像已在 CI runner 中可用，否则作业会卡死。  
2. **依赖缓存**：`pip install -e "python[${EXTRAS}]"` 现在不带 `--no-deps`，首次跑 CI 时可能拉取较多包，建议检查 CI 缓存策略。  
3. **时长监控**：8‑GPU 作业超时时间设为 30 min，新增测试本身约 1800 s，需关注 CI 总时长是否突破配额。  
4. **本地复现**：若本地无 AMD GPU，可通过 `docker run --gpus all` 模拟跑 `run_suite.py --suite per-commit-8-gpu-amd-mi35x`，确保代码不依赖特定硬件路径。  
5. **回退路径**：`amd_ci_exec.sh` 在首次执行失败后记录 `$FIRST_EXIT_CODE`，若后续仍失败会直接退出，建议在 CI 记录完整日志以便排查。  

总体而言，此次改动提升了 AMD 多卡模型的持续集成覆盖，但也引入了对 mi35x 镜像和依赖缓存的新要求，建议在合并前在 CI 环境完成一次完整跑通验证。

---

### fix: update AMD CI estimated time for test_torch_compile (#16631)
**SHA**: `6b8a9d7` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/6b8a9d7058825c71f09a59cb31a46814aa35fd76)

**🎯 变更类型**：Bug 修复  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
本次提交仅在 `test/registered/backends/test_torch_compile.py` 中将 AMD CI 的预估执行时间从 **169 秒** 提高至 **993 秒**，保持相同的测试套件 `stage-b-test-small-1-gpu`。目的是纠正 CI 配置中对该测试实际耗时的低估，防止在 AMD 机器上因超时而误报失败。  

**🎯 影响范围**  
- CI 配置模块（`register_amd_ci` 调用）  
- 受影响的测试仅为 `TestTorchCompile`，即 Torch 编译相关的功能验证。  

**💡 关注建议**  
1. **CI 稳定性**：确认更新后的超时阈值足够覆盖最慢的 AMD 硬件路径，避免再次出现误判。若未来硬件/驱动升级导致耗时进一步波动，需同步调整 `est_time`。  
2. **文档同步**：如果项目维护有 CI 预估时间表或文档，请同步更新，以免新人误以为该值仍为 169 秒。  
3. **回归检查**：虽然代码改动仅为配置常量，仍建议在提交后跑一次完整的 AMD CI，验证该测试在新阈值下能够顺利完成且不会影响后续测试的并行调度。  
4. **对比其他平台**：当前 CUDA CI 仍保持 190 秒，若两平台的实际耗时差距继续扩大，考虑统一或分别记录，以便后续做更细粒度的资源分配。  

总体而言，此改动对功能实现没有直接影响，风险极低，主要提升 CI 的可靠性与可观测性。

---

### Clean Some Environment Variables for DeepSeek V32 (#15938)
**SHA**: `7d757d6` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/7d757d6f17ef3f48a3eb41257e3baecd89bf6e46)

**🛠️ 核心变更**  
1. **环境变量整合**：原先在 `nsa.utils` 中通过 `get_bool_env_var` 直接读取多个 `SGLANG_NSA_*` 变量，改为在 `sglang.srt.environ` 中统一声明 (`EnvBool`)，并在代码里统一使用 `envs.SGLANG_NSA_… .get()`。同时新增 `SGLANG_NSA_FUSE_TOPK`、`SGLANG_NSA_ENABLE_MTP_PRECOMPUTE_METADATA`，并在文档中说明。  
2. **功能路径简化**：`dequant_k_cache`、`quantize_k_cache`、`quantize_k_cache_separate` 直接走 **fast** Triton 实现，删除了原来的 “slow” 回退分支；`NSA_DUAL_STREAM` 环境变量被删除，改为仅通过 `self.alt_stream` 判断。  
3. **日志/提示文字更新**：在 `server_args` 中把 “NSA” 改为 “DSA”，并统一了 page‑size、kv‑cache dtype 的提示。  
4. **相关调用点同步**：在 `nsa_backend.py` 将所有原来使用 `NSA_FUSE_TOPK`、`NSA_ENABLE_MTP_PRECOMPUTE_METADATA` 的条件改为 `envs.SGLANG_NSA_… .get()`。

**⚡ 影响范围**  
- `sglang.srt.layers.attention.nsa.*`（量化/解量化、索引、后端调度）  
- 环境变量文档、`environ.py`、`server_args.py`  
- 依赖 Fast‑path Triton kernel 的平台（Hopper/Blackwell 等）  

**💡 关注建议**  
1. **兼容性检查**：删除慢路径后，若用户在不支持对应 Triton kernel 的 GPU（如未编译 fast kernel）会直接报错。建议保留一个安全回退或在初始化时检测 kernel 可用性并给出明确提示。  
2. **导入路径**：`nsa_backend.py` 现在引用 `envs`，但本次改动未显示对应的 `import`，请确认已在文件头部加入 `from sglang.srt import environ as envs`，防止 NameError。  
3. **环境变量文档同步**：文档已添加 `SGLANG_NSA_FUSE_TOPK`、`SGLANG_NSA_ENABLE_MTP_PRECOMPUTE_METADATA`，但旧的 `SGLANG_NSA_DUAL_STREAM` 等仍在历史说明中出现，建议统一删除或标记已废弃。  
4. **测试覆盖**：新增/修改的 env‑var 控制路径应加入单元测试，尤其是关闭 `SGLANG_NSA_FUSE_TOPK` 时的分支行为，以防回归。  
5. **日志信息**：`server_args` 将 “NSA” 改为 “DSA”，请在所有用户可见日志、README、release note 中同步更新，避免混淆。  

整体来看，此次提交旨在统一环境变量管理并简化 NSA（DSA）后端路径，若兼容性检测与导入声明均完善，可提升代码可维护性和启动速度。

---

### fix: remove performance testing from nightly dpsk v32 cp single node  (#16582)
**SHA**: `5c04088` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/5c04088b3a6b0ccae3992a11daec3424a789407d)

**🎯 变更类型**：Bug 修复  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：将 `test/registered/8-gpu-models/test_deepseek_v32_cp_single_node.py` 中对 DeepSeek‑V32‑CP 单节点的性能测试移除，仅保留准确性检查，防止该测试在 nightly CI 中因性能基准不稳定而导致失败。  

**🎯 影响范围**  
- CI 流水线：`register_cuda_ci` 注册的 nightly 测试集合。  
- 性能基准：相关的 `performance_profiles_deepseek_v32_cp` 目录不再生成。  
- 代码路径：`sglang/test/performance_test_runner.py` 仍然可用，只是此处不再调用。  

**💡 关注建议**  
1. **回归验证**：在本地或专用 CI 中手动运行一次完整的性能测试，确保去掉该用例后仍然能覆盖其他模型的性能基准。  
2. **文档同步**：在 README 或 CI 说明中注明 DeepSeek‑V32‑CP 已不再进行 nightly 性能评估，以免误导使用者。  
3. **后续清理**：若长期不再需要该模型的性能基准，可考虑删除对应的 `performance_profiles_deepseek_v32_cp` 目录和相关配置，保持仓库整洁。  
4. **监控影响**：观察后续 nightly 运行是否显著缩短，总体通过率是否提升，若有异常回滚此改动。  

此改动对核心功能无直接影响，仅优化 CI 稳定性和执行时长，风险较低。

---

### [diffusion] fix: fix ZImage SP sharding for 5D latents and unpad frames (#16418)
**SHA**: `f066036` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/f066036c8bac1970209551e1acfafc545af4bbd6)

**🎯 变更类型**：Bug 修复 / 功能增强  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
- 为 Z‑Image 流水线新增对 5 维 latent（`[B, C, T, H, W]`）的分片 / 合并逻辑，避免使用 `super()` 时出现维度不匹配。  
- 在 `post_denoising_loop` 中加入对多帧 latent 的裁剪（依据 `batch.raw_latent_shape`），并在帧数不为 1 时返回首帧，以防止后续解码错误。  
- 同时添加 2 GPU 环境下的性能基准测试及对应测试用例。  

**🎯 影响范围**  
- `sglang/multimodal_gen/pipeline/zimage.py`（核心生成流水线）  
- `sglang/multimodal_gen/configs/pipeline_configs/base.py` 中的 `PipelineConfig.shard_latents_for_sp/gather_latents_for_sp` 被间接调用。  
- 测试套件 `test/server/perf_baselines.json` 与 `test/server/testcase_configs.py` 以及整体 CI 性能基准。  

**💡 关注建议**  
1. **维度兼容性**：`shard_latents_for_sp` 与 `gather_latents_for_sp` 现在仅在 `latents.dim() == 5` 时使用 `PipelineConfig` 实现，确保其它 pipeline（如 4D latent）仍走原路径，防止意外覆盖。  
2. **属性检查**：`raw_latent_shape` 必须在 Batch 对象中可靠设置，否则会导致 `AttributeError` 或裁剪失效，建议在 Batch 构造入口加入显式赋值或默认值。  
3. **性能回归**：新增的 2‑GPU 基准显示单帧解码仍返回首帧，若后续业务需要完整时间序列，请在 `post_denoising_loop` 中提供开关或额外 API。  
4. **单元测试**：加入针对 5D latent 的独立单元测试，验证分片‑合并前后数值一致性，尤其在多 GPU 环境下的跨卡通信。  
5. **文档更新**：在 Z‑Image 模型使用指南中说明 “多帧（5D）latent” 支持情况、`raw_latent_shape` 的来源以及 2‑GPU 运行时的性能预期。  

总体来看，本次改动解决了 Z‑Image 在 5D latent 场景下的崩溃问题，并提供了对应的性能基准，影响范围局限于图像扩散流水线，风险可控。建议在合并前完成维度兼容性和属性校验的额外测试。

---

### Migrate profiling tests to test/registered/profiling/ (#16459)
**SHA**: `52de807` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/52de807dd7670d403810598f0a73d1c10988c62f)

**🎯 变更类型**：功能增强（CI 测试注册）  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
将原有的 profiling 相关单元测试迁移到 `test/registered/profiling/`，并在每个文件首部通过 `sglang.test.ci.ci_register` 为 CUDA 与 AMD 两类硬件分别注册 CI 信息（估算时长、所属套件）。与此同时，`test/srt/run_suite.py` 中对这些测试的显式 `TestFile` 条目被删除，改由注册机制统一管理。

**🎯 影响范围**  
- **测试框架**：`test/registered/profiling/*`、`test/srt/run_suite.py`  
- **CI 注册模块**：`sglang.test.ci.ci_register`  
- **Profiling 代码**：保持不变，仅影响测试入口  

**💡 关注建议**  
1. 确认 `ci_register` 在所有运行环境（CPU‑only、GPU、AMD）均可导入，避免因缺少依赖导致测试收集报错。  
2. 检查 `est_time` 与实际执行时长的匹配，防止 CI 超时或资源浪费。  
3. 运行一次完整的 CI（包括 CUDA 与 AMD）验证新注册的测试被正确发现并计入对应套件。  
4. 若项目仍保留手动 `TestFile` 列表的老版本，建议在文档中注明已迁移至自动注册，防止后续误删或重复添加。  
5. 考虑在 `run_suite.py` 中加入注释或兼容层，提示未来新增测试只需放入 `test/registered/*` 并调用 `register_*`。  

整体来看，此次改动提升了 profiling 测试的可维护性和跨硬件 CI 管理，但需确保注册入口的可靠性与文档同步。

---

### Migrate attention unit tests to test/registered/attention/ (#16465)
**SHA**: `70933f3` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/70933f34f173c43e43e1f95c70f9fa1e6d5384ad)

**🎯 变更类型**：其他（测试迁移 & CI 注册）

**⚡ 重要程度**：🟡 中

**📋 变更摘要**  
- 将注意力相关单元测试 `test_mamba_unittest.py`、`test_swa_unittest.py` 从原有的 `test/srt/run_suite.py` 列表中移除，改为使用统一的注册机制。  
- 在对应的测试文件里新增 `register_cuda_ci`（及 `register_amd_ci`）调用，声明预计执行时间和所属 CI 套件 `stage-b-test-small-1-gpu`。  

**🎯 影响范围**  
- **test/registered/attention/**：新增 CI 注册代码。  
- **test/srt/run_suite.py**：删除了上述两个测试的硬编码条目。  
- **CI 脚本**（`sglang.test.ci.ci_register`）：被调用以自动把这些测试加入对应的 CUDA / AMD 测试矩阵。  

**💡 关注建议**  
1. **CI 覆盖**：确认 `ci_register` 能在 CI 环境正确解析 `est_time` 与 `suite`，并在 GPU / AMD 机器上触发对应测试。  
2. **本地调试**：如果开发者在本地运行 `pytest`，需要注意这些测试已经不在 `run_suite`，可能需要手动指定或使用新的注册入口。  
3. **文档同步**：更新项目文档或 CONTRIBUTING 指南，说明注意力单元测试已迁移至注册机制，避免新人仍按旧方式添加/运行。  
4. **回归检查**：由于仅是测试结构变化，运行全套 CI（包括 stage‑b 小规模 GPU）验证所有测试仍能成功通过，防止遗漏的依赖或路径错误。  

整体来看，此次改动不影响库的运行时行为，仅优化了测试组织方式并提升了 CI 可维护性，确保后续新增注意力类测试可统一注册。

---

### [model-gateway] extract header extraction in policy and add (#16566)
**SHA**: `3be1e73` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/3be1e734eec1d5ac5fbc8391140cccffbf086fb1)

**🎯 变更类型**：重构 / 功能抽取  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
- 新增 `routers/header_utils.rs`，把 `x-smg-target-worker` 与 `x-smg-routing-key` 的读取封装为 `extract_target_worker`、`extract_routing_key` 两个公共函数。  
- `consistent_hashing.rs` 与 `manual.rs` 删除了原有的 `HeaderName` 常量和重复的提取代码，改为调用新工具函数。  
- 为提取函数补充单元测试，保证空值、缺失、非法字符等边界情况返回 `None`。

**🎯 影响范围**  
- **sgl-model-gateway/src/policies**：一致性哈希、手动路由策略的内部实现被修改。  
- **sgl-model-gateway/src/routers**：新增 `header_utils.rs`，并在模块层级对外公开。  

**💡 关注建议**  
1. **编译依赖**：确认 `routers::header_utils` 已在 `mod.rs` 中导出，否则外部 crate 无法引用。  
2. **行为兼容**：新函数仍保持原来的 O(1) 验证和空字符串过滤，建议跑一次全链路回归，以防因 `HeaderMap` 为 `None` 时的路径遗漏。  
3. **性能**：封装后没有额外分配，仍是零拷贝；若后续需要更复杂的路由键解析，可在此统一优化。  
4. **测试覆盖**：现有单元测试覆盖基本场景，建议在集成测试中加入真实请求路径，确保策略在实际流量下依旧选对 worker。  

总体而言，此次抽取提升了代码可读性与复用性，风险有限，只需检查模块导出与回归测试即可。

---

### fix: fill a meaningful tool_index (#16504)
**SHA**: `913b688` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/913b688f21fa2cb380713c879216d53f3eb4f651)

**🎯 变更类型**：Bug修复  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**：在 `base_format_detector.py` 中，`ToolCallItem` 的 `tool_index` 由固定的 `-1` 改为根据 `tool_indices` 映射动态填充，确保返回的工具调用记录能够指向实际的工具位置。  

**🎯 影响范围**：  
- `python/sglang/srt/function_call/base_format_detector.py`（工具调用解析）  
- 可能涉及 downstream 的 **tool dispatch / result 组装** 逻辑，依赖 `tool_index` 的模块将获得正确的索引信息。  

**💡 关注建议**：  
1. 确认在调用 `parse_base_json` 前，`tool_indices` 已完整构造（键为工具名，值为在 `tools` 列表中的下标），否则仍会得到 `-1`。  
2. 检查下游代码是否已有对 `tool_index == -1` 的容错处理，若已不再需要，可清理相关分支。  
3. 运行全套单元测试，特别是涉及多工具调用的模型推理路径，验证索引正确性不会导致数组越界或误匹配。  
4. 如有自定义 `Tool` 列表顺序变化，确保对应的 `tool_indices` 同步更新，防止旧缓存导致错误。  

此改动提升了工具调用的可追溯性，对功能完整性有正向影响，风险主要在映射构建过程，请重点关注映射的准确性和下游使用方式。

---

### fix: adjusting vlm accuracy thresholds (#16593)
**SHA**: `951d16c` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/951d16c8902849bee460d6cad4f16f1b00709d3d)

**🎯 变更类型**：Bug 修复  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：本次提交对 `test/registered/eval/test_vlms_mmmu_eval.py` 中的 VLM（视觉语言模型）评估阈值做了细微调整（如 `MiniCPM-o-2_6` 的 latency 从 29.3→29.5，`InternVL2_5-2B` 的 latency 从 17.0→18.0 等），以匹配最新的 MMMU 评测结果，避免因为阈值过紧导致 CI 误报。  
**🎯 影响范围**：  
- **测试体系**：仅影响 VLM 系列模型的自动化评估测试，特别是 `test_vlms_mmmu_eval.py`。  
- **CI/CD**：GitHub Actions/内部 CI 在运行该测试时会使用新的阈值；若模型实际表现下降，测试将更容易捕捉到回归。  
- **文档/基准报告**（间接）：阈值变更应同步到项目 README 中的基准说明或公开的模型排行表。  

**💡 关注建议**：  
1. **验证阈值来源**：确认这些数值是根据最新 MMMU 官方基准或内部复现结果得出，防止因手误写入不合理数值。  
2. **保持可追溯性**：在代码注释中记录每个阈值的来源（如 “2024‑12‑01 官方报告”），便于后续审计和更新。  
3. **同步文档**：若项目对外展示模型排行榜或推荐阈值，务必同步更新对应章节，防止文档与代码不一致。  
4. **回归测试**：在本地或 CI 中跑一遍全部 VLM 评测，确保新阈值不会导致已有模型误报失效。  

总体来看，此次改动属于测试数据的微调，风险较低，但需保证阈值的准确性与文档同步，以维持项目评测的可信度。

---

### Migrate FP8/TorchAO tests to test/registered/quant/ (#16453)
**SHA**: `90eac38` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/90eac38a12973231388f12f23055f0262aeff603)

**🎯 变更类型**：重构 / CI 测试迁移  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：将 FP8、TorchAO 等量化相关的测试从原有 `test/` 目录迁移到 `test/registered/quant/`，并统一使用 `sglang.test.ci.ci_register` 的 `register_cuda_ci / register_amd_ci` 接口向 CI 系统声明测试耗时、所属套件。相应地在 CI workflow 和 `test/srt/run_suite.py` 中删除了这些测试的显式调用，改为交由注册机制自动收集。

**🎯 影响范围**  
- CI 工作流：`.github/workflows/pr-test-amd.yml`（去掉了直接调用 `test_eval_fp8_accuracy.py`）。  
- 测试注册：`test/registered/quant/*`（9 个文件）新增或修改 `register_*` 调用。  
- 统一测试套件配置：`test/srt/run_suite.py` 删除了对应 `TestFile` 条目。  
- 相关依赖文件：`test/registered/quant/test_eval_fp8_accuracy.py`、`test_torchao.py` 等实现路径调整。

**💡 关注建议**  

1. **注册完整性**：确保每个迁移后的测试文件都已经添加了对应的 `register_cuda_ci`（以及必要的 `register_amd_ci`）声明，且 `est_time` 与实际耗时相符，防止 CI 超时或资源浪费。  
2. **套件名称一致**：`suite` 参数使用的 `"stage-b-test-small-1-gpu"`、`"stage-a-test-1"` 必须在 CI 配置中存在，否则测试会被忽略。建议在 CI 脚本或文档中统一列出所有套件名称。  
3. **AMD 支持审查**：部分原本仅 CUDA 的测试（如 `test_fp8_kernel.py`）仍只注册 CUDA，若未来需要在 AMD 上跑，应补充 `register_amd_ci`。相反，`test_fused_rms_fp8_group_quant.py` 仍只注册 AMD，确认这在项目需求中是有意为之。  
4. **回归验证**：本次仅迁移测试，不改动业务代码，但因为 `run_suite.py` 不再显式列出这些测试，需在 CI 完整跑一遍确保所有注册的测试被正确发现、执行且通过。  
5. **文档更新**：在项目的测试指南或 CI 说明中添加“量化测试已迁移至 `test/registered/quant/` 并通过注册机制运行”的提示，避免后续开发者误以为仍需手动加入 `run_suite.py`。  

总体来看，本次改动提升了测试组织的可维护性和 CI 可扩展性，只要上述注册、套件对应关系保持一致，即可平滑落地。

---

### Tiny support http headers in bench serving (#16606)
**SHA**: `d874c8b` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/d874c8bba4c2d2e5d65c1b95e005bffff7dbf980)

**🎯 变更类型**：功能增强  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
为 `bench_serving` 添加了 `--header` CLI 参数，支持在 benchmark 请求中自定义 HTTP Header（`Key=Value` 形式），并在所有请求构造路径中统一使用 `get_request_headers()` 合并认证 Header 与用户自定义 Header。相应单元测试也加入了 Header 解析与传递的验证。  

**🎯 影响范围**  
- `python/sglang/bench_serving.py`（请求构造、参数解析）  
- `python/sglang/test/test_utils.py`（增加 `header` 参数）  
- `test/registered/bench_fn/test_bench_serving_functionality.py`（新增解析函数测试、Mock HTTP server 验证）  

**💡 关注建议**  

1. **兼容性**：`get_auth_headers()` 仍保留，未改动已有调用；新增 `get_request_headers()` 只在 benchmark 中使用，外部 API 不受影响。  
2. **参数校验**：当前 `parse_custom_headers` 对缺失 `=`、空键或空值直接返回空字典，未抛异常。若用户误写会默 silently 被忽略，建议在 CLI 帮助或文档中注明 “无效的 Header 将被忽略”。  
3. **重复 Header**：若用户在 `--header` 中提供相同键，会后者覆盖前者，行为与 `dict.update` 相同，保持一致性即可。  
4. **安全性**：自定义 Header 直接拼接到请求中，无额外过滤，理论上可能被用于 HTTP Header 注入（如 `Key: value\r\nAnother: foo`），但 `partition("=")` 只取第一个等号，值中仍可能包含换行。若有安全要求，可在 `parse_custom_headers` 中加入 `value.replace("\r","").replace("\n","")`。  
5. **性能**：Header 合并在每个请求前执行，字典创建成本极低，对 benchmark 吞吐没有实质影响。  
6. **测试覆盖**：新增的 Mock HTTP Server 能捕获真实请求 Header，已覆盖基本解析与传递路径。建议在 CI 中保留该测试，以防后续改动意外移除 Header 合并逻辑。  
7. **文档/使用指南**：README 或 CLI help 需补充 `--header` 示例，避免用户对键值格式产生疑惑。  

总体来看，此次改动在保持原有功能的前提下，提供了灵活的 Header 定制能力，影响范围局限于 benchmark 入口，风险可控。后续若在其他模块需要相同功能，可复用 `get_request_headers` 或将其抽取为公共工具函数。

---

### Tiny add metrics for prefill delayer (#16603)
**SHA**: `9a21d89` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/9a21d89c5ba9d00c7db8b565a58d5937608e55cf)

**🎯 变更类型**：功能增强  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：为 `PrefillDelayer` 增加延迟统计，新增 `_DelayInfo` 记录延迟次数与起始时间，并在延迟结束或超时后向 `SchedulerMetricsCollector` 上报 “等待前向次数”、 “等待秒数” 和 “超时次数”。`Scheduler` 在实例化时把可选的 `metrics_collector` 传进去，`MetricsCollector` 新增相应的 `Histogram`、`Counter` 并实现 `observe_prefill_delayer_wait`。单元测试加入对 metrics 接口的检查及调试日志。

**🎯 影响范围**  
- `sglang/srt/managers/prefill_delayer.py`（核心逻辑及数据结构）  
- `sglang/srt/managers/scheduler.py`（构造时注入 metrics）  
- `sglang/srt/metrics/collector.py`（新增指标）  
- 测试 `test/srt/test_prefill_delayer.py`（验证指标曝光）  

**💡 关注建议**  
1. **打开指标开关**：默认未启用 `--enable-metrics`，确保在需要监控时显式传参，否则 `PrefillDelayer` 的 `_metrics_collector` 为 `None`，不会产生任何指标。  
2. **避免空指针**：`PrefillDelayer._record_metrics` 已检查 `self._metrics_collector`，但仍应确认在所有调度路径上都传入非 `None` 对象，以免遗漏关键数据。  
3. **指标桶配置**：`Histogram` 桶使用 `max_delay_passes - 1` 作为上界，若 `SGLANG_PREFILL_DELAYER_MAX_DELAY_PASSES` 被调高，需同步更新 buckets 防止出现 “bucket overflow”。  
4. **性能评估**：记录 `time.perf_counter()` 与 `Histogram.observe` 会在高频前向路径上产生微小开销，建议在生产环境通过采样或关闭 `DEBUG_LOG` 验证是否对吞吐有可接受影响。  
5. **文档与监控**：补全 README/用户手册中 “Prefill Delayer” 指标说明，并在监控平台添加对应告警（如 `sglang_prefill_delayer_timeouts_total` 激增）。  
6. **测试兼容**：CI 环境需保证 `requests` 包可用，且 `SGLANG_TEST_WORLD_SIZE` 与实际机器匹配，以免测试因网络或进程数不匹配导致误报。  

整体来说，本次改动为调度层提供了重要的可观测性，帮助定位 prefill 延迟导致的性能瓶颈。只要注意指标开关、桶配置以及可能的微幅性能开销，即可安全投入使用。

---

### [router][openai] Rename `prepare_mcp_payload_for_streaming` and `patch_streaming_response_json` (#16596)
**SHA**: `fb5b71d` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/fb5b71d015a24ea1786c10b1d41a5b36fd12d0de)

**🎯 变更类型**：重构 / 轻微功能增强  
**⚡ 重要程度**：🟡 中（不影响业务逻辑，但涉及多个模块的函数签名改动）  

**📋 变更摘要**  
1. 将原 `prepare_mcp_payload_for_streaming` 重命名为 `prepare_mcp_tools_as_functions`，并在注释中去掉“for streaming”的限定。  
2. 将 `patch_streaming_response_json` 重构为 `patch_response_with_request_metadata`，在原有的流式补丁基础上统一处理 **非流式** 与 **流式** 响应，并显式保留 `previous_response_id、instructions、metadata、store、model、safety_identifier` 等字段。  
3. 相应地更新了 `non_streaming.rs、streaming.rs、utils.rs` 中的调用点。

**🎯 影响范围**  
- `sgl-model-gateway/src/routers/openai/responses/mcp.rs`（工具转换函数）  
- `sgl-model-gateway/src/routers/openai/responses/utils.rs`（元数据补丁函数）  
- `sgl-model-gateway/src/routers/openai/responses/non_streaming.rs`、`streaming.rs`（调用点）  
- 可能影响其他自定义路由或插件若直接引用旧函数名。

**💡 关注建议**  
1. **编译检查**：确认项目中没有残余对 `prepare_mcp_payload_for_streaming` 或 `patch_streaming_response_json` 的引用，避免出现未定义错误。  
2. **单元/集成测试**：重点跑 OpenAI / MCP 工具链的流式与非流式用例，确保返回的 JSON 仍保留原请求的 `model`、`store` 等字段，不会因改名导致遗漏。  
3. **文档/示例更新**：如果对外暴露了这些函数（如在插件开发指南中），需要同步更新函数名及行为说明。  
4. **向后兼容**：当前改动仅在内部使用，外部用户感知不到。但若未来计划保留旧 API，建议提供一个薄包装的兼容函数，以免第三方代码直接依赖旧名称。  

总体来看，改动提升了代码语义一致性，降低了 “only‑streaming” 的误导含义，对业务行为无直接影响。完成上述检查后即可安全合并。

---

### [router][grpc] Replace `Vec<(String, String, String)>` with `ExtractedToolCall` (#16598)
**SHA**: `05b54b6` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/05b54b6d7bde70f5a46e228b48f92f1614efc906)

**🎯 变更类型**：重构 / 代码可读性提升  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：将原先在工具调用路径中使用的 `Vec<(String, String, String)>`（id、name、arguments）统一抽象为结构体 `ExtractedToolCall`，并在所有相关模块中完成迁移。结构体提供命名字段，提升代码可读性、可维护性及类型安全。

**🎯 影响范围**  
- `sgl-model-gateway/src/routers/grpc/regular/responses/common.rs`（新增 `ExtractedToolCall`，修改 `extract_all_tool_calls_from_chat` 返回类型）  
- `sgl-model-gateway/src/routers/grpc/regular/responses/non_streaming.rs`（更新 `use`、`partition`、遍历、日志、Metrics、状态记录的字段访问）  
- `sgl-model-gateway/src/routers/grpc/regular/responses/streaming.rs`（同上，涉及流式路径的全部调用）  

**💡 关注建议**  

1. **完整性检查**：在项目其余代码中搜索 `Vec<(String, String, String)>` 或直接使用 `(String, String, String)` 的模式，确认已全部替换为 `ExtractedToolCall`，避免编译遗漏。  
2. **派生 Trait**：当前只 `#[derive(Debug, Clone)]`，若后续需要相等比较或哈希（如测试、去重），可考虑再添加 `PartialEq, Eq, Hash`。  
3. **文档与注释**：结构体已加 `///` 注释，可在 `ToolLoopState::record_call` 等使用点补充说明，以帮助新成员快速理解字段语义。  
4. **错误路径兼容**：`extract_all_tool_calls_from_chat` 仍在 `None` 或无工具调用时返回 `Vec::new()`，行为未变，保持兼容。  
5. **性能影响**：结构体相比裸元组增加了字段名存储的微量开销，几乎可忽略；对并发或大量调用没有负面影响。  
6. **测试覆盖**：若仓库中已有针对工具调用解析的单元测试，请确认它们仍通过；若没有，建议新增针对 `extract_all_tool_calls_from_chat` 返回 `ExtractedToolCall` 的断言。  

总体而言，此次重构提升了代码可读性和安全性，改动范围局限于工具调用路径，风险低。只需确保全局迁移完成并补充相应测试即可。

---

### ci: migrate scheduler tests to test/registered/scheduler/ (#16442)
**SHA**: `399d528` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/399d5283f8a3eae7619be079b7edeb44b534fdae)

**🎯 变更类型**：CI/测试组织  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：将调度器相关的单元测试迁移至 `test/registered/scheduler/`，并在每个测试文件中新增 `register_cuda_ci / register_amd_ci` 调用，以便在 CI 中按 GPU 类型划分执行时间和套件。同步更新 `test/srt/run_suite.py`，将这些测试从原来的 `per‑commit-1‑gpu` 与 `per‑ci-gpu` 套件中剔除，转由新注册机制管理。  

**🎯 影响范围**  
- **测试目录**：`test/registered/scheduler/`（新增 6 份测试文件）  
- **CI 注册模块**：`sglang.test.ci.ci_register`（新增 import 与调用）  
- **测试调度脚本**：`test/srt/run_suite.py`（删除对应 `TestFile` 条目）  

**💡 关注建议**  
1. 确认 `ci_register` 中 `register_cuda_ci`、`register_amd_ci` 已实现并能正确写入 CI 配置；否则新加入的测试会被遗漏或超时。  
2. 检查 CI 流水线的套件名称（如 `stage-b-test-small-1-gpu`）是否与 `run_suite.py`、GitHub Action 或内部调度器保持一致，避免出现找不到套件的错误。  
3. 本次迁移删除了 `per-commit-1-gpu`、`per-ci-gpu` 中的条目，若有本地手动运行 `run_suite.py` 的习惯，需要更新文档或脚本提示，以免误以为这些测试仍被执行。  
4. 运行完整的单元测试，确保新路径下的测试能够被 `unittest discover` 正常发现；如果出现 `ImportError: cannot import name …`，检查 `__init__.py` 与相对路径。  
5. 若后续继续新增调度器测试，务必在对应文件中添加相同的 `register_*` 调用，保持 CI 统计的统一性。  

总体来说，此次改动旨在让调度器测试更好地融入多 GPU CI 流程，风险主要是注册流程不匹配导致测试被漏跑，需要在 CI 环境中验证一次完整的执行路径。

---

### Add v1/models endpoint to diffusion model APIs so that they can be discovered by model gateway (#16425)
**SHA**: `18e2ef0` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/18e2ef09d7e712ce4c14f4722b5d4b10967de0f6)

**🎯 变更类型**：功能增强（为 Diffusion 模型增加 OpenAI‑compatible `/v1/models` 接口）  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
1. 在 `http_server.py` 中将原 `/models` 接口标记为已废弃，并在文档中给出迁移提示。  
2. 新增 OpenAI 兼容的 `/v1/models` 与 `/v1/models/{model}` 两个路由，返回 `DiffusionModelCard`，含 `num_gpus、task_type、dit_precision、vae_precision、pipeline_name、pipeline_class` 等扩展字段。  
3. 为上述接口使用 `ORJSONResponse` 加速序列化，并在 `common_api.py` 中实现业务逻辑。  
4. 增加对应单元测试，验证列表、单模型以及 404 场景，并检查扩展字段与 `ServerArgs` 的一致性。  
5. 对 `run_suite.py` 的 pytest 调用做了小幅改动，确保只扫描指定文件。

**🎯 影响范围**  
- `sglang.multimodal_gen.runtime.entrypoints.http_server`（旧接口废弃）  
- `sglang.multimodal_gen.runtime.entrypoints.openai.common_api`（新增路由及模型卡）  
- `sglang.multimodal_gen.registry`（提供 `get_model_info`）  
- 测试目录 `sglang.multimodal_gen.test.server`（新增模型 API 测试）  

**💡 关注建议**  
1. **向后兼容**：虽然旧 `/models` 已标记 `deprecated=True`，仍保留该路由；确认文档、示例及外部依赖已更新为 `/v1/models`，避免突发 404。  
2. **响应一致性**：`DiffusionModelCard` 直接返回 `model_dump()`，确保字段命名与 OpenAI 标准保持一致（`object: "model"`），否则模型网关可能解析失败。  
3. **错误处理**：非匹配模型返回的 404 JSON 结构已硬编码，建议抽取为统一的错误响应函数，保持项目错误格式统一。  
4. **性能**：`ORJSONResponse` 已引入，可在高并发场景下受益；留意 `pydantic` `model_dump` 的深拷贝开销，如有必要可改为 `model.dict()`。  
5. **测试覆盖**：新增的端点在 CI 中已加入，但仍需在多 GPU、不同 pipeline_config 组合下跑一次，以防字段缺失或命名冲突。  
6. **文档更新**：在 README / API 文档中加入 `/v1/models` 的说明、示例请求与响应示例，提醒用户旧接口即将移除。  

整体来看，此次改动为模型网关提供了必需的发现接口，风险主要在接口兼容性与错误统一上，按上述建议完善即可顺利发布。

---

### fix: kimi k2 thinking accuracy threshold change (#16585)
**SHA**: `5349764` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/53497642985aa1184cfa63378612b6db10599782)

**🎯 变更类型**：Bug 修复  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
仅在 `test/registered/8-gpu-models/test_kimi_k2.py` 中把 Kimi‑K2‑Thinking 的 `baseline_accuracy` 从 **0.95** 降至 **0.94**，以匹配实际模型在 GSM8K 数据集上的表现，避免误报精度回归。

**🎯 影响范围**  
- 受影响的唯一模块是 **测试套件**（accuracy 测试）；业务代码、模型实现及部署逻辑不受影响。  
- CI/CD 运行时的阈值检查会相应放宽，导致该模型的 CI 通过率提升。

**💡 关注建议**  
1. **确认基准值来源**：建议在提交说明或文档中记录基准准确率的测得方式（硬件、随机种子、评估脚本），防止以后再次因基准漂移产生误报。  
2. **监控回归趋势**：虽然阈值已下调，但仍应在后续跑全量回归时关注该模型的实际表现，若出现显著下降再考虑进一步调低或改进模型。  
3. **保持测试独立性**：若其他模型共享同一基准参数，检查是否需要同步更新，避免出现不一致的阈值导致误判。  
4. **文档同步**：若仓库中有模型基准列表（如 README、模型卡），同步更新对应的准确率数值。  

此修改仅影响测试阈值，风险极低，但请确保基准数据的可追溯性，以提升后续维护的透明度。

---

### ci(test): migrate OpenAI server tests to registered CI system (#16326)
**SHA**: `0cbd8f3` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/0cbd8f3247b94fadfd9c6ba6861fcbb9dd4b47c6)

**🎯 变更类型**：CI/测试迁移（功能增强）  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
本次提交将原有的 OpenAI Server 相关单元测试从 `test/srt/openai_server/*` 迁移到新的 **registered CI** 目录下 (`test/registered/openai_server/*`)，并在每个测试文件顶部添加 `register_cuda_ci` / `register_amd_ci` 调用，以声明 GPU 型号、预计耗时以及 CI 套件名称。同时对 `test/srt/run_suite.py` 中的测试套件清单进行删减，去除这些 OpenAI Server 测试的硬编码条目，改由 CI 注册机制统一调度。为防止编译时缺失的依赖，将 `torch.utils.cpp_extension` 的导入位置从文件顶部移动到实际使用处。

**🎯 影响范围**  
- **测试框架**：`test/registered/openai_server/*` 及 `test/srt/run_suite.py`。  
- **CI 配置**：新加入的 `sglang.test.ci.ci_register` 注册函数，影响 CI 调度系统。  
- **核心代码**：仅涉及 `python/sglang/srt/distributed/device_communicators/pynccl_allocator.py` 中的 import 调整，不影响运行时逻辑。  

**💡 关注建议**  
1. **CI 环境**：确认 CI 系统已正确解析 `register_*_ci` 参数，否则新增测试可能被遗漏。  
2. **执行时长**：`est_time` 参数已硬编码，若实际运行时间波动大，可适当调宽阈值，以免 CI 误判超时。  
3. **兼容性**：在本地手动运行时，仍可使用 `pytest` 直接执行 `test/registered/...`，无需修改现有 `run_suite.py`。  
4. **后续维护**：新增或修改 OpenAI Server 测试时，请同步更新相应的 `register_*_ci` 调用，保持 CI 注册信息完整。  

总体来看，此次迁移提升了测试组织与 CI 调度的可维护性，对功能本身无实质影响，风险有限。

---

### fix: adding retries for server start and increasing hf read timeout (#16523)
**SHA**: `6e3fff1` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/6e3fff13521df33de34597c025ae6f7d9740cdd6)

**🎯 变更类型**：Bug修复 / 稳定性增强  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：在 CI 工作流中加入 `HF_HUB_DOWNLOAD_TIMEOUT` 与 `HF_HUB_ETAG_TIMEOUT` 环境变量，均设为 300 秒；同时在代码层面（虽未在 diff 中直接展示）为服务器启动过程增加重试机制，以缓解因 HuggingFace Hub 下载慢或临时网络波动导致的 CI 失效。  

**🎯 影响范围**  
- `.github/workflows/nightly-test-nvidia.yml`：所有 Nightly‑NVIDIA CI 任务。  
- 使用 `huggingface_hub` 的下载/etag 检查路径（启动脚本、模型拉取等），受环境变量控制的超时行为将被延长。  
- 启动服务器的入口脚本（可能在 `sglang/server/*`）现会在失败时进行多次重试。  

**💡 关注建议**  
1. **文档同步**：在项目 README 或 CI 文档中注明新增的两个环境变量及其默认值，防止本地调试时因未显式设置导致意外超时。  
2. **超时与资源消耗**：300 秒的超时会显著延长失败任务的执行时间，建议监控 CI 总时长，必要时在非关键分支降低阈值。  
3. **重试策略审查**：确认重试次数、间隔和退出条件合理，避免在网络长时间不可用时出现无限循环或占用过多 GPU 资源。  
4. **兼容性验证**：在本地或别的 CI 环境（如 CPU‑only）运行一次完整流程，确保新增环境变量不会意外覆盖已有的 `HF_HUB_*` 配置。  

该改动提升了 CI 的鲁棒性，主要影响服务器启动与模型下载环节，合理监控与文档更新即可平滑迁移。

---

### [ci] fix url strips in smg ci (#16548)
**SHA**: `a3656cb` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/a3656cbb96968fb7df291e8a26c865f460059eac)

**🎯 变更类型**：Bug 修复  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：修正模型网关测试中 URL 处理不当的问题。将健康检查日志中错误使用的 `instance.base_url` 替换为 `instance.worker_url`，统一在 `run_eval` 中去除结尾的斜杠并保证以 `/v1` 结尾；同时更新若干测试用例，使其直接使用 `client.base_url`，不再手动截去 `/v1`。  

**🎯 影响范围**：  
- `sgl-model-gateway/e2e_test/infra/model_pool.py`（健康检查日志）  
- `sgl-model-gateway/e2e_test/infra/run_eval.py`（URL 标准化）  
- `sgl-model-gateway/e2e_test/router/` 下的 `test_mmlu.py`、`test_pd_mmlu.py`（测试调用参数）  

**💡 关注建议**：  
1. 确认 `worker_url` 在所有实例中始终可用，避免再次出现属性缺失导致的运行时错误。  
2. `run_eval` 现在统一使用 `rstrip("/")`，若后续出现多层路径（如 `http://host/v1/extra`）需检查是否仍符合预期。  
3. 其他模块如生产代码中仍可能使用 `base_url` 进行日志或请求，建议统一抽象 URL 处理函数以避免重复错误。  
4. 运行完整的 CI 流程，确保所有 e2e 测试在不同部署模式下均通过。  

整体来看，此次改动消除了 URL 拼接导致的潜在 404/500 错误，风险有限，建议合并。

---

#### 🟢 低重要度变更 (22)

### Add SwapAB Optimization for triton fused_moe_kernel on SM90. (#15712)
**SHA**: `ee4d228` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/ee4d2287ab64a196adb316255eb768cdf826962a)

**🎯 变更类型**：代码重构  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 SM90（H20）GPU 上为 `fused_moe_triton` 添加 SwapAB 优化，新增 `should_enable_swap_ab` 检测逻辑并在 kernel 中根据 `swap_ab` 调整矩阵布局及转置。

---

### [CI] Enable dpsk v31 test on nightly H200 (#16660)
**SHA**: `153c69f` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/153c69f63d6b03bae2a0ae64a7991e8a80c88807)

**🎯 变更类型**：测试修改  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 `test_deepseek_v31.py` 中去除对 Blackwell 系统的限制，启用 DeepSeek‑V3.1 在 H200 GPU 的 nightly 测试。

---

### ci: adding llama4 placeholder test to nightly (#16599)
**SHA**: `2ff8723` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/2ff872311b4d3e8e5c0416e948dabbe6ff5adf87)

**🎯 变更类型**：测试修改  
**⚡ 重要程度**：🟢低  
**📋 摘要**：新增 nightly‑8‑gpu‑common CI 测试 `test_llama4.py`，在 TP=8 配置下统一执行 Llama‑4‑Scout 的性能基准和 gsm8k 准确率评估。

---

### Tiny fix readme (#16654)
**SHA**: `62d0280` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/62d0280f629cb96a4e57073db353d15eb52eb8d2)

**🎯 变更类型**：文档更新  
**⚡ 重要程度**：🟢低  
**📋 摘要**：将 README 中的链接列表改为居中 HTML 锚标签并加粗，优化页面布局和可读性，属于细微的文档修正。

---

### Re-enable temp_prefill_info assertion after pairing fix (#16203)
**SHA**: `98a107d` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/98a107d491f4cbb6bcbe1bb3f156a35f5d31c4f0)

**🎯 变更类型**：代码重构  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 `scheduler_metrics_mixin.py` 中重新启用 `temp_prefill_info` 为 `None` 的断言，以校验配对修复后临时前置信息的正确性。

---

### [AMD] suppress warning for amd (#16620)
**SHA**: `48381c3` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/48381c3b6da092a681798046db89609d2c7bf723)

**🎯 变更类型**：代码重构  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 AMD（HIP）平台上抑制原本对 fused_marlin_moe 与 GGUF 量化的警告，仅在非 HIP 环境下发出提示，并在相应类初始化时添加 HIP 警告。

---

### [AMD] CI - add 2 pp test cases to performance-test-2-gpu-amd (#16514)
**SHA**: `8bce085` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/8bce0853216264978c160dec7abae8ce2ad7cbb0)

**🎯 变更类型**：测试修改  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 AMD CI 工作流中新增两项 PP=2 的离线吞吐基准测试，并在对应单元测试中加入 `--mem-fraction-static` 参数及针对 AMD 环境的阈值调整。

---

### [Doc] Optimize pipeline parallelism doc (#16630)
**SHA**: `973116e` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/973116e6bb2262885ca0ffd0b683a8dc825979f2)

**🎯 变更类型**：文档更新  
**⚡ 重要程度**：🟢低  
**📋 摘要**：重写 pipeline_parallelism 文档，加入异步通信实现、微批事件循环、动态 Chunking 机制与平滑因子说明，并提供详细调参指南和示例命令。

---

### Upgrade aiter version (#16619)
**SHA**: `820e97d` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/820e97d6c9bf2b906a8e81414db3564412395a27)

**🎯 变更类型**：配置调整  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 `docker/rocm.Dockerfile` 中将 `AITER_COMMIT` 从 `v0.1.7.post5` 升级至 `v0.1.9.post1`。

---

### Only allocate encoder metadata for encoder-decoder models (#16527)
**SHA**: `4c85f9d` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/4c85f9d039a2d0848e91f06d53d84ceba3e97c49)

**🎯 变更类型**：代码重构  
**⚡ 重要程度**：🟢 低  
**📋 摘要**：在 `flashattention_backend.py` 中新增 `is_encoder_decoder` 标记，仅在编码‑解码模型下分配 `encoder_metadata`，避免解码器模型无意义的内存分配，提升资源利用率。

---

### Migrate backends tests to CI registration system (#16468)
**SHA**: `ce453fa` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/ce453fa43b4a80f0d76e1e3d7497f6bf504c484c)

**🎯 变更类型**：配置调整  
**⚡ 重要程度**：🟢低  
**📋 摘要**：将后端测试 `test_torch_compile` 从 `run_suite.py` 手动加入改为通过 `register_cuda_ci`、`register_amd_ci` 在 CI 注册系统中注册，并相应移除原有列表条目。

---

### ci: adjust partition counts for stage-b and unit tests (#16617)
**SHA**: `38895a0` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/38895a00642301ea0edd92057b1a23c60d0b4bce)

**🎯 变更类型**：配置调整  
**⚡ 重要程度**：🟢低  
**📋 摘要**：将 CI 工作流中 stage‑b 与 per‑commit 测试的分区数量从原来的 8/6 调整为 11/2，并相应修改矩阵范围，以优化测试并行度。

---

### [VLM] Fix CUDA IPC OOM (#16118)
**SHA**: `5384674` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/53846746bf76082855ad067912d5e1e9ab544515)

**🎯 变更类型**：代码重构  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 `schedule_batch.py` 中显式删除已转移的 `pixel_values`，防止 CUDA IPC 引起的 OOM；在 `base_processor.py` 中根据 `keep_mm_feature_on_device` 参数，将多模态特征和预计算嵌入移至 CPU，减少显存占用。

---

### [HiCacheStorage & PD] fix prefill bootstrap request host memory leaks (#15439)
**SHA**: `534ac38` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/534ac384db14cc382f6e7e813cd44500c9798fbd)

**🎯 变更类型**：其他  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 `prefill.py` 中，当预填充引导请求失败并被放入 `failed_reqs` 时，新增对 `self.scheduler.tree_cache.release_aborted_request(req.rid)` 的调用，以释放关联的预取事件，修复主机内存泄漏问题。

---

### PCG Unit Test Adjustment (#16609)
**SHA**: `2a8d549` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/2a8d5493f3a4c53f5e9ba457234e87d072f2b829)

**🎯 变更类型**：测试修改  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 `test_piecewise_cuda_graph_2_gpu.py` 中，将原 FusedMoE 相关的测试类重命名为普通 TP 测试，更新类说明，并删除启动参数 `--ep-size 2`，其余逻辑保持不变。

---

### [diffusion] chore: automatically enable dit_layerwise_offload for Wan (#16499)
**SHA**: `badcd02` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/badcd0289623ca18bc56e154bbdc961b789758f1)

**🎯 变更类型**：代码重构/配置调整  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 `server_args.py` 中引入 `envs`，当 `SGLANG_CACHE_DIT_ENABLED` 为 False 且 pipeline 为 Wan 时，自动启用 `dit_layerwise_offload`，并相应禁用冲突的 `dit_cpu_offload` / `fsdp_inference`。

---

### [NPU] fix command in npu best practice (#16576)
**SHA**: `4c9ac85` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/4c9ac8566cf5fcf000763934456de8c179689043)

**🎯 变更类型**：文档更新  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 Ascend NPU 最佳实践文档中，修正了环境变量、DP/TP 配置、CUDA 图批大小、HCCL 缓冲区大小等参数，并纠正了 dtype 拼写错误。

---

### [model-gateway][cleanup] Fix wrong comment in manager.rs (#16601)
**SHA**: `4f443f4` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/4f443f445acd0fdaa3afcb993977a215c98f7946)

**🎯 变更类型**：代码重构  
**⚡ 重要程度**：🟢低  
**📋 摘要**：将 `manager.rs` 中 `server_key` 的注释由 “生成唯一键” 修改为 “基于 transport 生成唯一键”，并删除冗余的旧注释，确保注释与实现保持一致。

---

### ci: migrate Debug Utils, Ops, and Rotary Embedding tests to test/registered/ (#16422)
**SHA**: `2e0527d` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/2e0527dd743a27b901746bc2ffbe5f11e2bff5dc)

**🎯 变更类型**：测试修改  
**⚡ 重要程度**：🟢低  
**📋 摘要**：将 Debug Utils、Ops、Rotary Embedding 的 CI 测试文件迁移至 `test/registered/` 目录，并在每个文件顶部新增 `register_cuda_ci`、`register_amd_ci` 注册声明。相应地，从原始 CI 套件配置 `test/srt/run_suite.py` 中移除这些测试的直接引用，统一由注册机制管理。

---

### Remove dllm-test-1-gpu-amd job (followup to DLLM migration) (#16589)
**SHA**: `3271e0e` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/3271e0e76d0e2cb3a43f654179b8af931571741c)

**🎯 变更类型**：配置调整  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 `.github/workflows/pr-test-amd.yml` 中删除了 `dllm-test-1-gpu-amd` CI 作业，并相应移除对该作业的依赖。此改动无需代码修改，仅精简工作流配置。

---

### [smg] clean up logs in mcp (should be info instead warn) (#16591)
**SHA**: `d57d8e7` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/d57d8e7e5f21c49b195775a90e44aaa1904a7674)

**🎯 变更类型**：代码重构  
**⚡ 重要程度**：🟢低  
**📋 摘要**：将 `McpManager` 中 “No static MCP servers connected” 的日志级别由 `warn` 调整为 `info`，以降低不必要的警告输出。

---

### ci: migrate DLLM tests to test/registered/dllm/ (#16420)
**SHA**: `2210155` | 🔗 [查看提交](https://github.com/sgl-project/sglang/commit/2210155a45105c6a08ca04f7efcd77f547c8c1e0)

**🎯 变更类型**：测试修改  
**⚡ 重要程度**：🟢低  
**📋 摘要**：将 DLLM 相关测试迁移至 `test/registered/dllm/`，新增 CUDA/AMD CI 注册装饰器并在 `run_suite.py` 中删除旧路径的引用。

---

