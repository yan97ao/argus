# 每日更新报告（2026-01-07）

## sgl-project/sglang

| 提交时间 | 作者 | 提交信息 |
|----------|------|----------|
| 2026-01-07 23:50:28 | Simo Lin | refactor(e2e): unify RouterInstance into Gateway class, split conftest.py into modular fixtures (#16671) |
| 2026-01-07 23:45:35 | Insideyyy | Add SwapAB Optimization for triton fused_moe_kernel on SM90. (#15712) |
| 2026-01-07 23:21:19 | Baizhou Zhang | [CI] Enable dpsk v31 test on nightly H200 (#16660) |
| 2026-01-07 22:59:49 | Simo Lin | refactor(e2e_test): fix smg ci e2e test code quality (#16664) |
| 2026-01-07 22:52:24 | Yi Zhang | support page size large than 64 for mamba radix cache (#16657) |
| 2026-01-07 22:35:15 | Simo Lin | fix(e2e_test): remove dead code and fix type annotations (#16661) |
| 2026-01-07 22:16:59 | Simo Lin | [smg][ci] preserve model launch order with test collected (#16618) |
| 2026-01-07 22:10:23 | Li Jinliang | [diffusion] bench: upgrade multimodal benchmarks for diverse applications and create a prettier, more intuitive logger. (#16179) |
| 2026-01-07 21:51:30 | Douglas Yang | ci: adding llama4 placeholder test to nightly (#16599) |
| 2026-01-07 21:11:24 | JiLi | Handle Marlin weight restoration and shape recording (QAT INT4 Rollout Part1) (#15238) |
| 2026-01-07 20:52:36 | Xiaoyu Zhang | [Diffusion] Fix Ulysses/Ring process group construction under TP to enable correct Wan2.2 tensor parallelism (#16532) |
| 2026-01-07 20:41:07 | Xiaoyu Zhang | Tiny fix readme (#16654) |
| 2026-01-07 20:20:01 | Even Zhou | [NPU] update docs (#16651) |
| 2026-01-07 18:05:17 | Hudson Xing | Re-enable temp_prefill_info assertion after pairing fix (#16203) |
| 2026-01-07 17:43:11 | Hubert Lu | [AMD] Add 8-GPU MX35X test running DSR1-MXFP4 model for AMD CI (#13602) |
| 2026-01-07 17:37:40 | YC Tseng | [AMD] suppress warning for amd (#16620) |
| 2026-01-07 15:52:46 | YC Tseng | [AMD] CI - add 2 pp test cases to performance-test-2-gpu-amd (#16514) |
| 2026-01-07 15:42:18 | Alison Shao | fix: update AMD CI estimated time for test_torch_compile (#16631) |
| 2026-01-07 14:52:42 | Shangming Cai | [Doc] Optimize pipeline parallelism doc (#16630) |
| 2026-01-07 14:20:42 | Thomas Wang | Upgrade aiter version (#16619) |
| 2026-01-07 14:17:04 | Minglei Zhu | Only allocate encoder metadata for encoder-decoder models (#16527) |
| 2026-01-07 14:00:16 | Baizhou Zhang | Clean Some Environment Variables for DeepSeek V32 (#15938) |
| 2026-01-07 13:38:31 | Douglas Yang | fix: remove performance testing from nightly dpsk v32 cp single node  (#16582) |
| 2026-01-07 13:24:04 | Chi McIsaac | [diffusion] fix: fix ZImage SP sharding for 5D latents and unpad frames (#16418) |
| 2026-01-07 13:04:48 | Alison Shao | Migrate profiling tests to test/registered/profiling/ (#16459) |
| 2026-01-07 12:50:54 | Alison Shao | Migrate attention unit tests to test/registered/attention/ (#16465) |
| 2026-01-07 12:31:52 | Alison Shao | Migrate backends tests to CI registration system (#16468) |
| 2026-01-07 12:18:44 | fzyzcjy | [model-gateway] extract header extraction in policy and add (#16566) |
| 2026-01-07 12:18:10 | Alison Shao | ci: adjust partition counts for stage-b and unit tests (#16617) |
| 2026-01-07 12:15:20 | Simo Lin | [smg][ci]: migrate benchmarks to e2e_test/benchmarks/, use parent conftest (#16597) |
| 2026-01-07 12:00:09 | Yingchun Lai | fix: fill a meaningful tool_index (#16504) |
| 2026-01-07 11:41:05 | Douglas Yang | fix: adjusting vlm accuracy thresholds (#16593) |
| 2026-01-07 11:30:35 | Yuan Luo | [VLM] Fix CUDA IPC OOM (#16118) |
| 2026-01-07 11:03:57 | MOHENOO | [HiCacheStorage & PD] fix prefill bootstrap request host memory leaks (#15439) |
| 2026-01-07 10:57:15 | Yuwei An | PCG Unit Test Adjustment (#16609) |
| 2026-01-07 10:27:43 | Alison Shao | Migrate FP8/TorchAO tests to test/registered/quant/ (#16453) |
| 2026-01-07 10:22:08 | Mick | [diffusion] chore: automatically enable dit_layerwise_offload for Wan (#16499) |
| 2026-01-07 10:15:17 | fzyzcjy | Tiny support http headers in bench serving (#16606) |
| 2026-01-07 09:53:52 | fzyzcjy | Tiny add metrics for prefill delayer (#16603) |
| 2026-01-07 09:37:27 | Hexq0210 | [NPU] fix command in npu best practice (#16576) |
| 2026-01-07 08:33:29 | Chang Su | [router][openai] Rename `prepare_mcp_payload_for_streaming` and `patch_streaming_response_json` (#16596) |
| 2026-01-07 08:32:59 | Chang Su | [router][grpc] Replace `Vec<(String, String, String)>` with `ExtractedToolCall` (#16598) |
| 2026-01-07 08:32:37 | Chang Su | [model-gateway][cleanup] Fix wrong comment in manager.rs (#16601) |
| 2026-01-07 07:05:08 | Simo Lin | refactor(e2e): keep only benchmark tests in e2e_http, remove redundant tests (#16594) |
| 2026-01-07 06:55:52 | Alison Shao | ci: migrate scheduler tests to test/registered/scheduler/ (#16442) |
| 2026-01-07 06:35:57 | Alison Shao | ci: migrate Debug Utils, Ops, and Rotary Embedding tests to test/registered/ (#16422) |
| 2026-01-07 06:34:16 | Yingchun Lai | feat: add .dockerignore to ignore files when build images (#16223) |
| 2026-01-07 06:28:24 | Kangyan-Zhou | Add v1/models endpoint to diffusion model APIs so that they can be discovered by model gateway (#16425) |
| 2026-01-07 06:27:37 | Alison Shao | Remove dllm-test-1-gpu-amd job (followup to DLLM migration) (#16589) |
| 2026-01-07 06:07:45 | Simo Lin | refactor(e2e): remove old embedding tests migrated to e2e_test/embeddings (#16592) |
| 2026-01-07 05:24:37 | Simo Lin | [model-gateway] add embedding tests (#16583) |
| 2026-01-07 05:18:43 | Douglas Yang | fix: kimi k2 thinking accuracy threshold change (#16585) |
| 2026-01-07 04:44:32 | Simo Lin | [smg] clean up logs in mcp (should be info instead warn) (#16591) |
| 2026-01-07 03:09:37 | Alison Shao | ci(test): migrate OpenAI server tests to registered CI system (#16326) |
| 2026-01-07 01:53:12 | Douglas Yang | fix: adding retries for server start and increasing hf read timeout (#16523) |
| 2026-01-07 01:44:26 | Alison Shao | ci: migrate DLLM tests to test/registered/dllm/ (#16420) |
| 2026-01-07 01:23:58 | Simo Lin | [ci] fix url strips in smg ci (#16548) |

## sgl-project/sglang 的LLM分析结果

### ee4d2287ab64a196adb316255eb768cdf826962a
https://github.com/sgl-project/sglang/commit/ee4d2287ab64a196adb316255eb768cdf826962a
Add SwapAB Optimization for triton fused_moe_kernel on SM90. (#15712)
**🎯 变更类型**：性能优化 / 功能增强  
**⚡ 重要程度**：🔴 高  
**📋 变更摘要**：在 `fused_moe_triton_kernels.py` 中引入 **SwapAB** 优化，仅在 SM90 系列（尤其是 H20）GPU、且块尺寸满足 `BLOCK_SIZE_M < 64 && BLOCK_SIZE_N >= 64` 时启用。实现包括硬件检测缓存函数 `should_enable_swap_ab`、 kernel 参数 `swap_ab`、以及在矩阵乘法前后的维度转置逻辑，从而改善 SM90 上的内存访问与 Tensor Core 利用率。  

**🎯 影响范围**：  
- `python/sglang/srt/layers/moe/fused_moe_triton/fused_moe_triton_kernels.py`（核心实现）  
- `sglang.srt.utils` 中的 `get_device_name`、`is_sm90_supported`（新增导入）  
- 任何调用 `invoke_fused_moe_kernel` 的上层代码（会自动传递 `swap_ab` 标志）  

**🔍 技术洞察**：  
- **架构影响**：  
  - 新增硬件感知层 `should_enable_swap_ab`（LRU 缓存），将 kernel 行为与具体 GPU 型号耦合，提升 SM90 系列的适配度。  
  - kernel 参数 `swap_ab` 将矩阵维度在内部调换，利用 `tl.trans` 在加载前后实现“AB 互换”。对已有调用接口保持向后兼容（仅在内部添加参数）。  
- **性能影响**：  
  - 对 `BLOCK_SIZE_M < 64 && BLOCK_SIZE_N >= 64` 的配置，SwapAB 能让矩阵的行列更贴合 Tensor Core 的最佳布局，预计在 H20 上提升 5%~15% 的吞吐（实际提升取决于工作负载）。  
  - 额外的 `tl.trans` 与 `tl.trans(accumulator)` 带来极小的算子开销，远低于整体加速收益。  
  - 使用 `functools.lru_cache` 限制检测开销，影响可以忽略不计。  
- **安全考虑**：  
  - 仅基于本地硬件信息进行分支，无外部输入，未引入新的安全风险。  
  - 需确保 `get_device_name` 不泄露敏感信息（属于内部实现，风险极低）。  

**⚠️ 潜在风险**：  
1. **硬件检测误判**：若 `get_device_name` 返回值不符合预期（例如自定义驱动改名），可能错误开启 `swap_ab`，导致维度不匹配或结果错误。  
2. **兼容性**：在非 SM90（或未通过检测的 SM90 如 H100/H200）上仍会走默认路径，理论上安全，但若未来在这些硬件上启用，需要额外验证。  
3. **数值差异**：转置操作在 FP16 环境下可能引入极小的舍入差异，需在回归测试中比对数值误差阈值。  
4. **代码维护**：新增硬件依赖会增加后续维护成本，需在文档中明确仅在 H20 验证通过。  

**💡 关注建议**：  
- **测试覆盖**：在 H20、H100、H200 等多款 SM90 GPU 上运行单元/集成测试，分别对比 `swap_ab` 开启与关闭的输出一致性及性能提升。  
- **回退机制**：提供环境变量（如 `SGLANG_DISABLE_SWAPAB=1`）让用户在遇到异常时手动关闭此优化。  
- **文档更新**：在 README/CHANGELOG 中注明 “SwapAB 仅在 H20（SM90）并满足特定 BLOCK_SIZE 配置时生效”。  
- **监控指标**：在生产部署中加入 GPU 型号与 `swap_ab` 开启状态的监控，便于快速定位因硬件差异导致的性能回退。  

---  

### 153c69f63d6b03bae2a0ae64a7991e8a80c88807
https://github.com/sgl-project/sglang/commit/153c69f63d6b03bae2a0ae64a7991e8a80c88807
[CI] Enable dpsk v31 test on nightly H200 (#16660)
**🎯 变更类型**：测试 / CI  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：在 `test_deepseek_v31.py` 中删除了对 `is_blackwell_system` 的依赖并取消了原来的 `skipIf` 条件，使 DeepSeek‑V3.1 的统一性能/准确性测试能够在 nightly H200（以及原先的 B200）上运行。  

**🎯 影响范围**：  
- `sglang/test/registered/8-gpu-models/test_deepseek_v31.py`  
- CI 夜跑套件 `nightly-8-gpu-common`（涉及 H200、B200 两类 GPU）  

**🔍 技术洞察**：  
- **架构影响**：无架构改动，仅调整测试入口，影响的是 CI 测试调度层。  
- **性能影响**：对代码本身无性能影响；但在 H200 上实际执行时可能出现不同的运行时特性（如 GPU 规格差异导致的执行时间变化），需要留意。  
- **安全考虑**：不涉及安全相关代码或数据，风险为“无”。  

**⚠️ 潜在风险**：  
- H200 与 B200 在硬件特性上有差异，模型加载或推理可能出现兼容性或性能回归，导致 CI 失败。  
- 取消 `skipIf` 可能引入 flaky test（间歇性失败），尤其在资源紧张的 nightly 环境下。  
- 若模型对特定硬件（如 Blackwell GPU）有专门的优化，移除检测后可能掩盖这些差异。  

**💡 关注建议**：  
1. **本地验证**：在 H200 实机或相应模拟环境中手动跑一次 `TestDeepseekV31Unified`，确认模型能够成功加载并完成预期的性能/准确性检查。  
2. **监控 CI**：上线后密切观察 nightly CI 结果，若出现不稳定或显著性能回退，考虑在测试代码中加入针对 H200 的容忍阈值或重新加回硬件检测。  
3. **文档更新**：在项目的 CI/测试文档中补充说明此测试已支持 H200，避免后续维护者误以为仍需 Blackwell 环境。  
4. **回滚机制**：保留原始 `is_blackwell_system` 检查的代码片段（如通过 Git 注释），以便在发现硬件兼容性问题时快速恢复。  

### 55b7936582eeace2953d12f972f512b403f7a5f1
https://github.com/sgl-project/sglang/commit/55b7936582eeace2953d12f972f512b403f7a5f1
refactor(e2e_test): fix smg ci e2e test code quality (#16664)
**🎯 变更类型**：重构 / 代码质量提升  

**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
本次提交对 `sgl-model-gateway/e2e_test` 目录下的测试框架进行全面的可读性、健壮性和可维护性提升。包括为 `genai‑bench` 子进程启动加入异常捕获和超时日志、统一日志分隔符宽度、抽取重试常量、将健康检查抽象为公共函数、简化工作节点信息转换、优化 GPU 名称解码以及将 MMLU 数据集 URL 抽离为常量。整体目标是提升 CI 中端到端测试的可靠性并降低后期维护成本。

**🎯 影响范围**  
- `sgl-model-gateway/e2e_test/benchmarks/conftest.py`（子进程管理）  
- `sgl-model-gateway/e2e_test/conftest.py`（日志分隔符、GPU 要求报错）  
- `sgl-model-gateway/e2e_test/fixtures/router_manager.py`（健康检查）  
- `sgl-model-gateway/e2e_test/infra/*`（常量、网关 API、GPU 检测、模型池启动、评估脚本）  
- 相关测试用例与 CI 脚本

**🔍 技术洞察**  

- **架构影响**  
  - **抽象化**：`infra.wait_for_health` 被提升为公共工具函数，解耦了 `router_manager` 中的健康检查实现，提升模块复用度。  
  - **统一常量**：`LOG_SEPARATOR_WIDTH`、`MAX_RETRY_ATTEMPTS` 统一放在 `constants.py`，降低硬编码传播，便于统一修改。  
  - **数据模型**：在 `gateway.py` 中新增 `_worker_from_api_response`，集中 WorkerInfo 的构造逻辑，遵循 **单一职责** 和 **DRY** 原则。  

- **性能影响**  
  - 对子进程启动和 GPU 检测逻辑的改动几乎不产生性能差异，仅在异常路径增加少量日志。  
  - 将每个 prefill worker 改为独占的 bootstrap 端口（原来是共享）可能导致端口占用稍增，但对测试执行时间影响可忽略。  
  - `decode('utf-8', errors='replace')` 对 GPU 名称解码的容错提升，避免因异常字符导致的抛出，提升整体稳定性。  

- **安全考虑**  
  - 新增对 `FileNotFoundError`、`PermissionError`、通用 `OSError` 的捕获，能够在 CI 环境中更友好地报告二进制缺失或权限问题，防止异常泄漏到测试框架。  
  - 使用 `pytest.fail` 直接报错，确保 CI 失败信息明确。  
  - 其他改动均未引入外部输入或网络安全风险，保持原有安全模型。  

**⚠️ 潜在风险**  

1. **行为变更**：原本 PD（prefill/decoding） worker 共享 bootstrap 端口的逻辑被改为每个 prefill worker **独占**端口，若测试用例或部署脚本依赖端口共享（例如跨进程通信假设），可能导致端口耗尽或网络冲突。  
2. **依赖缺失**：`infra.wait_for_health` 的引入要求 `infra/__init__.py` 正确导出该函数；若该模块未同步更新或在某些旧的 CI 镜像中缺失，可能导致 ImportError。  
3. **常量导入**：新常量 `MAX_RETRY_ATTEMPTS`、`LOG_SEPARATOR_WIDTH` 的导入路径修改可能导致其他未同步更新的文件仍使用硬编码值，引起不一致的日志或重试行为。  
4. **异常路径测试缺失**：新增的 `subprocess.Popen` 异常捕获路径未必在现有 CI 中被触发，缺少相应的测试覆盖可能在生产/CI 环境中出现未预料的失败。  

**💡 关注建议**  

- **回归测试**：在本地与 CI 环境分别执行包含 PD worker 的完整 E2E 流程，确认端口分配不会冲突，必要时在 `model_pool.py` 中加入端口冲突检测或回退到共享模式的配置开关。  
- **新增单元/集成测试**：为 `router_manager.start_router` 的健康检查路径、`infra.wait_for_health` 添加异常场景测试（如 404、超时），确保失败信息符合预期。  
- **文档同步**：更新 README 或 CI 文档，说明 `MAX_RETRY_ATTEMPTS` 与 `LOG_SEPARATOR_WIDTH` 可通过 `constants.py` 调整，避免误用硬编码。  
- **兼容性检查**：确认所有依赖 `conftest.py`、`gateway.py` 的旧插件或第三方脚本在导入新常量后仍能正常运行。  
- **监控日志**：CI 中开启 `--log-level=DEBUG` 运行一次，以验证新日志输出（如超时、错误信息）是否如预期展示，防止因日志格式改变导致后续日志解析工具失效。  

通过上述措施可以最大化本次重构带来的可维护性提升，同时降低因行为细微变化引起的回归风险。

### 8729ad5e6c389f495f1cce9dc8c11f15b3ec0cba
https://github.com/sgl-project/sglang/commit/8729ad5e6c389f495f1cce9dc8c11f15b3ec0cba
fix(e2e_test): remove dead code and fix type annotations (#16661)
**🎯 变更类型**：重构 / 代码清理  
**⚡ 重要程度**：🟢低  
**📋 变更摘要**：本次提交删除了 `e2e_test` 目录中一批未使用的常量与 GPU 检测辅助函数，统一并修正了若干函数的类型注解（如使用 `Any`、`list[str]`），并将默认测试超时时间的硬编码提升为直接字符串常量。目标是提升代码可读性、消除死代码、确保类型检查通过，功能上保持不变。  

**🎯 影响范围**：  
- `sgl-model-gateway/e2e_test/conftest.py`（类型注解调整）  
- `sgl-model-gateway/e2e_test/infra/simple_eval_common.py`（列表类型注解统一）  
- `sgl-model-gateway/e2e_test/utils.py`（删除未使用的常量与函数，简化超时获取）  

**🔍 技术洞察**：  
- **架构影响**：仅限测试层代码，未改变生产代码模块的依赖关系或接口。删除的常量与 `skip_if_no_gpu` 方法属于单独的测试工具集合，不影响核心业务逻辑。  
- **性能影响**：去除约 40 行未使用的全局常量与函数定义，略微降低模块的 import 时间和内存占用，但对整体性能影响可忽略不计。  
- **安全考虑**：无新增安全相关代码，亦未引入外部依赖。删除的 GPU 检测逻辑本身不涉及权限或外部调用，移除后安全面保持不变。  

**⚠️ 潜在风险**：  
1. **兼容性**：`list[str]` 语法要求 Python ≥ 3.9。若项目在更低版本的解释器上运行，将导致语法错误。  
2. **外部引用**：若有第三方脚本或 CI 配置直接引用已删除的 `DEFAULT_TIMEOUT`、`DEFAULT_STARTUP_TIMEOUT`、`DEFAULT_PORT_BASE`、`STDOUT_FILENAME`、`STDERR_FILENAME` 或 `skip_if_no_gpu`，将触发 `ImportError`/`AttributeError`。  
3. **隐式依赖**：`get_test_timeout` 现在硬编码默认值为 `"600"`，若后续需要统一管理超时配置，需自行修改此函数或恢复环境变量读取逻辑。  

**💡 关注建议**：  
- 确认 CI/CD 环境使用的 Python 版本 ≥ 3.9，或将 `list[str]` 改写为 `List[str]`（已在 `typing` 中导入）以兼容旧版本。  
- 在项目根目录或文档中标明已删除的测试常量与函数，避免外部脚本依赖它们。若必须保留，可考虑提供向后兼容的别名或阻止删除。  
- 运行完整的单元/集成测试套件，特别是涉及 `e2e_test` 的流程，确保没有因常量缺失导致的隐藏错误。  
- 若后续需要自定义测试超时，仍可通过环境变量 `E2E_TEST_TIMEOUT` 覆盖默认值，无需额外改动。  

### 2ff872311b4d3e8e5c0416e948dabbe6ff5adf87
https://github.com/sgl-project/sglang/commit/2ff872311b4d3e8e5c0416e948dabbe6ff5adf87
ci: adding llama4 placeholder test to nightly (#16599)
**🎯 变更类型**：测试/CI 增强  
**⚡ 重要程度**：🟢低  
**📋 变更摘要**：在 nightly‑8‑gpu‑common 测试套件中新增 `test_llama4.py`，为 Llama‑4‑Scout（17B）模型添加统一的性能与准确率验证。通过 `register_cuda_ci` 注册为夜间 CI，预计运行时长约 12000 秒。  

**🎯 影响范围**：  
- `test/registered/8-gpu-models/` 目录下的 CI 测试框架  
- `sglang.test` 包中的统一测试 runner（`run_combined_tests`、`AccuracyTestParams`、`PerformanceTestParams`）  

**🔍 技术洞察**：  
- **架构影响**：无代码路径改动，仅在 CI 注册层面新增一个测试模块，遵循现有的 “统一性能+准确率” 测试模式。对产品代码无侵入，保持模块解耦。  
- **性能影响**：该测试将在 CI 环境完整跑一次性能基准，预计耗时 2 小时左右（`est_time=12000`），会延长 nightly CI 总时长。对生产运行时不产生影响。  
- **安全考虑**：不涉及网络、权限或外部输入，仅使用模型路径 `meta-llama/Llama-4-Scout-17B-16E-Instruct`，若模型托管在私有仓库需确保 CI 环境具备相应访问凭证。  

**⚠️ 潜在风险**：  
1. **模型可获取性**：如果 CI 环境无法拉取 Llama‑4‑Scout 模型，测试将直接失败。  
2. **资源占用**：TP=8 配置需要 8 张 GPU，若 CI 集群资源紧张，可能导致排队或节点争用。  
3. **基准回归**：`baseline_accuracy=0.9`、性能基准未设定阈值，首次运行可能出现误报，需要后续根据实际结果调优。  

**💡 关注建议**：  
- 在提交合并前本地验证模型下载与启动脚本，确保 `trust-remote-code` 与 `chat-template=llama-4` 正常工作。  
- 检查 CI 集群的 GPU 配额，必要时在 CI 配置中加入资源预留或并发限制。  
- 首次运行后记录实际的准确率和性能指标，适时更新 `baseline_accuracy` 与性能阈值，以避免不必要的回归报警。  
- 如模型体积过大导致磁盘/网络压力，可考虑在 CI 中使用模型缓存或分层镜像。  

整体来看，此次改动对代码库功能没有直接影响，主要提升了对新模型的 CI 覆盖度，风险可通过上述检查降低。

### 62d0280f629cb96a4e57073db353d15eb52eb8d2
https://github.com/sgl-project/sglang/commit/62d0280f629cb96a4e57073db353d15eb52eb8d2
Tiny fix readme (#16654)
**🎯 变更类型**：文档  
**⚡ 重要程度**：🟢低  
**📋 变更摘要**：将 README 中的链接列表从原始的 Markdown 表格形式改为使用 `<p>` 与 `<a>` 包裹的 HTML 行内链接，以提升在不同渲染环境下的显示效果和可读性。  
**🎯 影响范围**：`README.md`（项目主页文档）  

**🔍 技术洞察**：  
- **架构影响**：无，属于纯文档层面，不涉及代码或模块依赖。  
- **性能影响**：无，文档渲染不影响运行时性能。  
- **安全考虑**：无，未引入执行代码或外部脚本，仅使用安全的 HTML 超链接。  

**⚠️ 潜在风险**：  
- 某些文档渲染工具（如部分 CI 文档检查、简化的 Markdown 预览器）可能会过滤或忽略原生 HTML，导致链接不可见或排版异常。  
- HTML 标签的使用可能在旧版 Git 客户端或非 GitHub 平台（如某些内部 Wiki）中出现兼容性问题。  

**💡 关注建议**：  
- 在主要的文档浏览平台（GitHub、GitLab、Bitbucket）以及 CI 文档检查工具上确认渲染效果是否符合预期。  
- 若项目计划在其他 Markdown 渲染器中展示（如 MkDocs、Docusaurus），建议额外验证这些环境对内嵌 HTML 的支持情况。  
- 保持原有的 Markdown 链接形式的备份，以便在兼容性问题出现时快速回退。

### d4b717c01ead29bae6f73286d0df345a6a203908
https://github.com/sgl-project/sglang/commit/d4b717c01ead29bae6f73286d0df345a6a203908
[NPU] update docs (#16651)
**🎯 变更类型**：文档  
**⚡ 重要程度**：🟢低  
**📋 变更摘要**：本次提交删除了 `docs/platforms/ascend_npu_best_practice.md`（约 3.6k 行），并同步在 `docs/platforms/ascend_npu_support.rst` 中移除对该文件的引用。目的是清理已废弃或不再维护的最佳实践文档，保持平台文档的整洁与一致性。  

**🎯 影响范围**：  
- `docs/platforms/ascend_npu_best_practice.md`（已删除）  
- `docs/platforms/ascend_npu_support.rst`（引用行已删除）  
- 依赖该文档的 CI 检查、自动化文档生成流程以及阅读该文档的终端用户。  

**🔍 技术洞察**：  
- **架构影响**：无。仅涉及文档文件层面的变更，不触及代码或系统架构。  
- **性能影响**：无。文档大小的减少对构建、打包或运行时性能没有实际影响。  
- **安全考虑**：无。文档不包含执行代码或安全敏感信息。  

**⚠️ 潜在风险**：  
- 如果该最佳实践文档仍在外部渠道（如教程、博客、论坛）被引用，用户可能会遇到 404 或找不到相应指引的情况。  
- 可能导致部分使用者在升级后失去原有的实践指导，需另行寻找替代资料。  

**💡 关注建议**：  
1. 在项目的发布说明或迁移指南中注明已删除 “Ascend NPU Best Practice” 文档，并提供新的参考链接（如官方社区、最新的使用手册等）。  
2. 检查 CI/CD 流程中是否有硬编码的路径指向该文件，确保构建不因缺失文件而报错。  
3. 如有外部文档或网站仍链接至该文件，及时更新或设置适当的重定向（如 GitHub Pages 重定向）。  
4. 若该文档的内容仍具价值，考虑将关键部分迁入其他维护良好的文档章节，而不是直接删除。  

总体而言，此次变更风险极低，主要是对文档的清理工作，建议按照上述事项做好通知与兼容性检查即可。

### 98a107d491f4cbb6bcbe1bb3f156a35f5d31c4f0
https://github.com/sgl-project/sglang/commit/98a107d491f4cbb6bcbe1bb3f156a35f5d31c4f0
Re-enable temp_prefill_info assertion after pairing fix (#16203)
**🎯 变更类型**：Bug 修复 / 代码可靠性提升  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：在 `scheduler_metrics_mixin.py` 中将原本被注释的 `assert self.temp_prefill_info is None` 重新启用。该断言确保在记录本次 prefill 统计信息前，`temp_prefill_info` 已被清空，防止旧数据残留导致统计错误。此改动伴随配对（pairing）逻辑的修复，使断言能够安全通过。  
**🎯 影响范围**：`python/sglang/srt/managers/scheduler_metrics_mixin.py`（调度器度量管理），间接受影响的可能是使用该调度器的 SGLang 推理服务及其监控/日志模块。  

**🔍 技术洞察**  
- **架构影响**：无结构性改动，仅在运行时加入一次性检查，保持原有模块耦合不变。  
- **性能影响**：断言在普通解释模式下执行一次布尔检查，开销极低；在生产环境若使用 `python -O`（禁用断言）则不产生任何影响。  
- **安全考虑**：不涉及安全功能或外部接口，唯一风险是断言触发导致 `AssertionError`，从而中断调度器线程，可能导致服务短暂不可用。  

**⚠️ 潜在风险**  
1. **运行时崩溃**：如果在某些异常路径下 `temp_prefill_info` 未被显式清除，断言会抛异常，导致调度器进程退出。  
2. **断言被禁用**：在优化模式（`-O`）下断言失效，潜在的残留状态检查将不生效，可能仍会出现统计错误。  
3. **回归测试不足**：缺少对 `temp_prefill_info` 生命周期的专门单元/集成测试，可能遗漏边界情况。  

**💡 关注建议**  
- **测试覆盖**：补充针对 `log_prefill_stats` 的单元测试，验证在正常、异常以及并发调用情况下 `temp_prefill_info` 始终为 `None`。  
- **显式清理**：考虑在 `log_prefill_stats` 结束后加入 `self.temp_prefill_info = None`（或在适当的清理阶段），以防止在断言被禁用时出现隐蔽 bug。  
- **错误处理**：如果断言触发属于可预期的异常情况，改为显式抛出自定义异常并记录上下文日志，便于运维定位。  
- **部署检查**：在生产环境升级前，确认调度器的日志中不出现 `AssertionError`；如有，需回滚或修复导致 `temp_prefill_info` 未清空的代码路径。  

> **结论**：此改动通过断言提升了代码的自检能力，帮助提前捕获状态管理错误，风险主要在于断言触发导致的服务中断。建议在充分的测试和可能的显式清理后上线，以确保可靠性。

### b86bbf841e813716fa82c9e1cd08e3c267feb682
https://github.com/sgl-project/sglang/commit/b86bbf841e813716fa82c9e1cd08e3c267feb682
[AMD] Add 8-GPU MX35X test running DSR1-MXFP4 model for AMD CI (#13602)
**🎯 变更类型**：功能增强 / 测试扩展  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：  
在 AMD CI 工作流中新增针对 **mi35x 8‑GPU**（MX35X）平台的测试任务，包含 1‑GPU、8‑GPU 两套作业；同步调整依赖安装脚本以兼容 mi35x；在测试套件中加入 `per-commit-8-gpu-amd-mi35x` 入口并实现对 DeepSeek‑R1‑MXFP4 模型的功能、MTP（多路径推理）以及吞吐性能的完整验证。  

**🎯 影响范围**：  
- `.github/workflows/pr-test-amd.yml`（CI 工作流）  
- `scripts/ci/amd_ci_exec.sh`、`scripts/ci/amd_ci_install_dependency.sh`（CI 脚本）  
- `test/srt/run_suite.py`（测试入口配置）  
- `test/srt/test_deepseek_r1_mxfp4_8gpu.py`（新增测试实现）  

**🔍 技术洞察**：  
- **架构影响**：  
  - 在 CI 架构上新增 **mi35x‑gpu‑1** 与 **mi35x‑gpu‑8** 两类 runner，完善对新硬件平台的覆盖。  
  - `amd_ci_install_dependency.sh` 对 mi35x 的依赖安装流程去掉 `--no-deps`，改为统一的 `install_with_retry` 调用，保持与其他 AMD 架构（mi30x/mi300/mi325）一致的安装路径。  
  - 新增的 `per-commit-8-gpu-amd-mi35x` 测试套件在 `run_suite.py` 中注册，使后续 CI 只需通过 `--suite` 参数即可触发。  

- **性能影响**：  
  - CI 执行时长会因 8‑GPU 运行而显著提升（单个 job 超时设为 30 分钟），但对代码库本身的运行时性能无直接影响。  
  - 测试本身在服务器端使用 `--tp 8`、`--chunked-prefill-size 131072` 等高并发配置，可帮助发现多卡并行的潜在瓶颈。  

- **安全考虑**：  
  - 脚本仍然会在 CI 容器中 `git clone` 第三方仓库 `lmms-eval`，该仓库已在旧 CI 中使用，风险保持不变。  
  - 新增的测试代码仅通过本地 HTTP 接口与服务器交互，未引入外部网络请求或文件写入，安全风险低。  

**⚠️ 潜在风险**：  
1. **Runner 可用性**：若 `linux-mi35x-gpu-8` 或 `linux-mi35x-gpu-1` 资源不足，CI 会卡顿或失败。  
2. **依赖冲突**：移除 `--no-deps` 可能拉取额外的依赖，导致与现有包版本冲突（尤其在 `mi35x` 镜像中）。  
3. **测试不确定性**：8‑GPU 多卡环境的性能波动较大，可能出现间歇性超时或 flaky 测试。  
4. **CI 时间成本**：新增 30 分钟的 job 将拉长 PR 的整体检查时间，对开发者反馈速度有影响。  

**💡 关注建议**：  
- **资源准备**：确保 GitHub 自托管或云端的 `linux-mi35x-gpu-*` runner 已配置完毕，并且镜像保持最新。  
- **本地验证**：在本地或预备的 CI 环境中跑一次 `per-commit-8-gpu-amd-mi35x`，确认依赖安装无冲突后再合并。  
- **监控 CI 时长**：观察首次运行的实际耗时，必要时可适当调低 `timeout-per-file` 或拆分测试用例。  
- **回滚方案**：若出现大面积 CI 失败，可暂时在工作流中注释掉 `unit-test-backend-8-gpu-amd-mi35x`，待资源恢复后再打开。  
- **文档同步**：在项目的 CI 说明或硬件支持文档中补充 mi35x 8‑GPU 的使用方法和已知限制。  

### 48381c3b6da092a681798046db89609d2c7bf723
https://github.com/sgl-project/sglang/commit/48381c3b6da092a681798046db89609d2c7bf723
[AMD] suppress warning for amd (#16620)
**🎯 变更类型**：Bug修复 / 功能增强（抑制 AMD/HIP 环境下不必要的警告）  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：在 `awq.py` 与 `gguf.py` 两个量化实现中，针对 HIP（AMD GPU）平台的警告逻辑进行了调整。原先在非 HIP 环境统一抛出警告的实现被改为仅在实际不支持的情况下（即非 CUDA 且非 HIP）才发出提示，并在类初始化时对 HIP 环境单独给出声明。目标是降低在 AMD 环境下的噪声日志，同时保持对不支持平台的明确提示。  

**🎯 影响范围**：  
- `python/sglang/srt/layers/quantization/awq.py`  
- `python/sglang/srt/layers/quantization/gguf.py`  

**🔍 技术洞察**：  
- **架构影响**：无结构性改动，仅在两处加入条件判断 (`_is_hip`) 并移动警告位置，保持原有模块依赖不变。  
- **性能影响**：警告本身的开销极小，改动对运行时性能、内存占用或时间复杂度不存在可感知影响。  
- **安全考虑**：不涉及安全相关逻辑；唯一风险是可能误导用户认为 HIP 已支持而实际功能仍缺失。  

**⚠️ 潜在风险**：  
1. **误报/漏报风险**：在 HIP 环境下，警告被延迟到类实例化阶段，若实例化路径未被触发，用户可能看不到 “HIP does not support …” 的提示，导致在运行时才遇到功能缺失。  
2. **兼容性回归**：原先在模块导入时即抛出警告，帮助开发者快速发现不支持的后端。现在警告出现时机变化，可能影响已有自动化测试或 CI 中对警告的检测脚本。  

**💡 关注建议**：  
- **测试覆盖**：在 AMD GPU（HIP）环境下跑完整的单元/集成测试，确保即使警告被抑制，功能仍按预期报错或返回明确的异常信息。  
- **文档同步**：更新 README/CHANGELOG，明确说明 HIP 仍不支持 `fused_marlin_moe` 与 GGUF 量化，且仅在实例化时会给出警告。  
- **CI 检查**：如果项目使用日志/警告检测，调整检测规则以兼容警告位置的变化，防止误判为回归。  
- **未来规划**：若计划在 HIP 上实现对应特性，建议在警告中加入 “TODO” 标记或使用 `DeprecationWarning`，便于后续追踪实现进度。

### 8bce0853216264978c160dec7abae8ce2ad7cbb0
https://github.com/sgl-project/sglang/commit/8bce0853216264978c160dec7abae8ce2ad7cbb0
[AMD] CI - add 2 pp test cases to performance-test-2-gpu-amd (#16514)
**🎯 变更类型**：性能优化 / CI 配置 / 测试  

**⚡ 重要程度**：🟡 中  

**📋 变更摘要**：在 AMD GPU CI 流水线中新增两条针对 PP=2（Pipeline Parallelism 为 2）的离线解码与 Prefill 吞吐量基准测试，用以评估多卡并行情况下的性能表现；同时在相应的单元测试中加入 AMD 环境专属的 `--mem-fraction-static 0.7` 参数，并将吞吐阈值下限从 4000 ms 调整为 3000 ms（仅在 AMD CI 环境）。  
预期效果是能够更完整地监控 PP=2 场景的性能，并避免因硬件差异导致的误报。

**🎯 影响范围**：  
- `.github/workflows/pr-test-amd.yml`（AMD CI 工作流）  
- `test/srt/test_bench_serving.py`（性能基准测试用例）  
- 受影响的 CI 运行时长和资源占用  

**🔍 技术洞察**：  
- **架构影响**：无代码业务层面的架构改动，仅在 CI 流水线与测试套件中加入新任务，保持现有模块的解耦。  
- **性能影响**：  
  - **CI 时长**：新增两段 `unittest` 步骤，每段设定 10 分钟超时，预计整体 CI 时长增加约 15–20 分钟（视实际执行时间而定）。  
  - **资源占用**：PP=2 需要额外的 GPU 资源与显存，若 CI 节点资源不足可能导致 OOM 或调度延迟。  
- **安全考虑**：无涉密或权限相关改动；仅增加了 CLI 参数 `--mem-fraction-static`，不涉及安全风险。  

**⚠️ 潜在风险**：  
1. **CI 资源瓶颈**：PP=2 需要更高的显存占用，若 AMD CI 环境的 GPU 显存不足，可能导致测试失败或被 Kill。  
2. **不稳定的基准**：不同硬件批次、驱动版本或系统负载可能导致 `input_throughput` 在 3000 ms 附近波动，产生间歇性失败。  
3. **阈值宽松**：将阈值从 4000 降至 3000 可能掩盖实际性能回退，导致回归检测失效。  

**💡 关注建议**：  
- **资源预留**：确保 AMD CI 节点分配至少两块 GPU 且显存 ≥ 24 GB（视模型大小而定），必要时在 CI 配置中添加显存检查。  
- **稳定性验证**：在合并前本地或专用的预提交环境多次运行新增测试，观察吞吐波动范围，必要时加入 `retry` 机制或更灵活的阈值策略（如相对基准的 ±10%）。  
- **文档更新**：在项目的 CI 文档或性能基准说明中补充 PP=2 测试的目的、运行要求以及阈值解释，避免后续维护者误解。  
- **监控 CI 时长**：关注 CI 总时长是否超出既定阈值（如 60 分钟），如有必要考虑并行执行或仅在特定分支/标记下运行这两项基准。  

---  

### 6b8a9d7058825c71f09a59cb31a46814aa35fd76
https://github.com/sgl-project/sglang/commit/6b8a9d7058825c71f09a59cb31a46814aa35fd76
fix: update AMD CI estimated time for test_torch_compile (#16631)
**🎯 变更类型**：配置/CI 调度  
**⚡ 重要程度**：🟢低  
**📋 变更摘要**：将 AMD GPU CI（`stage-b-test-small-1-gpu`）中 `test_torch_compile` 的预估执行时间从 169 秒提升至 993 秒，以更贴合实际运行时长，避免 CI 调度超时。  
**🎯 影响范围**：  
- `test/registered/backends/test_torch_compile.py`（仅 CI 注册参数）  
- AMD GPU CI 流水线（涉及该测试用例的调度）  

**🔍 技术洞察**：  
- **架构影响**：无，代码逻辑未变，仅修改了 CI 元数据。  
- **性能影响**：无直接性能影响；间接上，由于调度更准确，避免了因超时导致的重试或中止，提升整体 CI 稳定性。  
- **安全考虑**：不适用。  

**⚠️ 潜在风险**：  
- 预估时间大幅提升（约 5 倍），可能导致 CI 资源占用时间增加，影响整体流水线的并发度与成本。  
- 若实际执行时间远低于 993 秒，可能出现 CI 队列等待时间不必要的延长。  

**💡 关注建议**：  
1. 监控实际运行时长，若发现持续低于新估计值，可适当下调，保持资源利用率。  
2. 与其他测试用例的 `est_time` 保持一致的评估方法，防止出现单点时间误差导致的调度失衡。  
3. 在 CI 报表中记录该更改，以便后续审计和时间基准的统一管理。  

### 820e97d6c9bf2b906a8e81414db3564412395a27
https://github.com/sgl-project/sglang/commit/820e97d6c9bf2b906a8e81414db3564412395a27
Upgrade aiter version (#16619)
**🎯 变更类型**：依赖更新  

**⚡ 重要程度**：🟡中  

**📋 变更摘要**：在 `docker/rocm.Dockerfile` 中，将 AITER 的固定提交版本从 `v0.1.7.post5` 升级至 `v0.1.9.post1`。该更改影响基于 ROCm 的 Docker 镜像构建流程，旨在使用新版 AITER 带来的功能改进或 bug 修复。

**🎯 影响范围**：  
- `docker/rocm.Dockerfile`（用于构建 ROCm 环境的 Docker 镜像）  
- CI/CD 流程中依赖该镜像的所有服务或组件  
- 本地开发者使用该 Dockerfile 进行环境搭建时

**🔍 技术洞察**：  
- **架构影响**：无结构性改动，仅在镜像构建阶段拉取不同的 AITER 源码/二进制。若 AITER 与其他内部库有版本耦合，可能需要确认兼容性。  
- **性能影响**：一般情况下，升级库的性能变化取决于 AITER 自身的实现更新。若新版包含优化，可能带来微小的性能提升；若引入了额外功能，构建时间或运行时负载可能略有上升。  
- **安全考虑**：升级至 `v0.1.9.post1` 可获得之前版本中可能已修复的安全漏洞修补，属于安全增强。需确认新版没有引入新的安全风险（如依赖的外部库升级）。  

**⚠️ 潜在风险**：  
1. **向后兼容性**：若 AITER 在 0.1.9 中更改了公开 API 或行为，使用旧版 API 的代码可能出现运行时错误。  
2. **构建失败**：新版 AITER 可能对构建环境（例如 Python 版本、系统库）有更高要求，导致 Docker 镜像构建失败。  
3. **隐藏依赖升级**：AITER 可能在内部升级了其他第三方依赖，进而影响整体镜像大小或安全基线。  

**💡 关注建议**：  
- **回归测试**：在升级镜像后，运行完整的单元/集成测试套件，重点关注调用 AITER 接口的模块。  
- **检查变更日志**：阅读 AITER `v0.1.9.post1` 的 release notes，确认是否有破坏性变更或新特性需要适配。  
- **兼容性验证**：在本地或 CI 环境中使用旧镜像和新镜像进行对比测试，确保功能一致性。  
- **构建日志审查**：留意 Docker 构建过程中的警告或错误信息，尤其是与 Python 包或系统库相关的。  
- **文档同步**：如果项目文档中提及使用的 AITER 版本，及时更新对应说明。  

如暂无发现兼容性问题，可以直接在 CI 中推送使用新版镜像；若发现问题，建议保留对旧版本的回退路径（例如通过构建参数），并在修复后再正式切换。

### 4c85f9d039a2d0848e91f06d53d84ceba3e97c49
https://github.com/sgl-project/sglang/commit/4c85f9d039a2d0848e91f06d53d84ceba3e97c49
Only allocate encoder metadata for encoder-decoder models (#16527)
**🎯 变更类型**：性能优化 / 重构  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：  
- 在 `flashattention_backend.py` 中新增 `self.is_encoder_decoder` 标志，仅在模型为 encoder‑decoder 时分配 encoder 相关的元数据。  
- 对于 decoder‑only 模型，`self.encoder_metadata` 设为空 dict，避免不必要的 GPU 内存分配。  
- 通过条件化分配，降低显存占用并加快模型初始化速度。

**🎯 影响范围**：  
- `python/sglang/srt/layers/attention/flashattention_backend.py`（FlashAttention 后端实现）  
- 可能波及使用 `FlashAttentionMetadata`、`encoder_metadata` 的所有上层调用（如模型加载、推理调度等）。

**🔍 技术洞察**：  
- **架构影响**：  
  - 引入 `self.is_encoder_decoder` 标志，保持与已有 `model_runner.model_config.is_encoder_decoder` 的一致性。  
  - 逻辑上将 encoder 元数据的生命周期限定在 encoder‑decoder 场景，保持模块职责清晰。  
- **性能影响**：  
  - 对 decoder‑only 模型，省去约 `(max_bs * max_context_len * 4bytes)` + 额外几张 `int32` 张量的显存分配，可提升大批量推理时的显存利用率。  
  - 初始化阶段少创建张量，略微降低启动开销。  
- **安全考虑**：  
  - 无直接安全风险。  
  - 需要确保后续代码在访问 `self.encoder_metadata` 前检查其内容或键是否存在，防止因空 dict 引发的 `KeyError`。

**⚠️ 潜在风险**：  
- 其他模块或自定义插件可能默认假设 `encoder_metadata` 始终包含上述键，未做防护会导致运行时异常。  
- 若未来在 decoder‑only 场景加入跨注意力（cross‑attention）实现，需重新评估此处的条件分配逻辑。  
- 初始化路径的分支变化可能影响已有的单元测试覆盖率。

**💡 关注建议**：  
- **代码审查**：检查所有对 `self.encoder_metadata` 的读取位置，加入 `if self.encoder_metadata:` 或键存在性判断。  
- **测试**：  
  - 新增或扩充 decoder‑only 模型的初始化单元测试，验证不会因缺少 `encoder_metadata` 抛异常。  
  - 对 encoder‑decoder 模型保持原有行为的回归测试。  
- **文档**：在模块说明或配置文档中注明，仅在 encoder‑decoder 模型下分配 encoder 元数据，以帮助使用者了解显存需求的变化。  
- **发布注意**：若用户自行在外部代码中直接访问 `backend.encoder_metadata`，需提醒其在 decoder‑only 场景做好空值检查。  

### 5c04088b3a6b0ccae3992a11daec3424a789407d
https://github.com/sgl-project/sglang/commit/5c04088b3a6b0ccae3992a11daec3424a789407d
fix: remove performance testing from nightly dpsk v32 cp single node  (#16582)
**🎯 变更类型**：配置 / 测试  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：在 `test_deepseek_v32_cp_single_node.py` 中移除了对 `PerformanceTestParams` 的引用，并将 `performance_params` 设置为 `None`，从而在 nightly CI 中不再执行 DeepSeek V32 CP 单节点的性能基准测试。目的是缩短 CI 时长、避免不必要的资源占用。  

**🎯 影响范围**：  
- `sglang/test/registered/8-gpu-models/test_deepseek_v32_cp_single_node.py`  
- CI 注册与调度模块 `sglang.test.ci.ci_register`  
- 可能影响 `run_combined_tests` 对 `performance_params` 的处理路径  

**🔍 技术洞察**：  
- **架构影响**：无结构性改动，仅是测试配置层面的调整，不影响生产代码或模型运行时架构。  
- **性能影响**：显著降低 nightly CI 的执行时间与 GPU 资源消耗；对实际模型推理性能无直接影响。  
- **安全考虑**：不涉及安全相关代码，风险极低。  

**⚠️ 潜在风险**：  
- 若 `run_combined_tests` 或后续代码未正确处理 `performance_params=None`，可能导致运行时异常或测试误报。  
- 失去一次 nightly 性能回归检测机会，可能延迟发现性能下降问题。  

**💡 关注建议**：  
- 确认 `run_combined_tests` 对 `performance_params` 为 `None` 的分支已完备并加入单元测试，防止空指针错误。  
- 在其他关键模型的 CI 中保留性能基准，以弥补此处移除带来的回归盲区。  
- 如后续需重新启用，建议通过配置开关而非直接删除代码，提升可维护性与灵活性。  

### f066036c8bac1970209551e1acfafc545af4bbd6
https://github.com/sgl-project/sglang/commit/f066036c8bac1970209551e1acfafc545af4bbd6
[diffusion] fix: fix ZImage SP sharding for 5D latents and unpad frames (#16418)

Signed-off-by: Chi <chixie.mcisaac@gmail.com>
**🎯 变更类型**：Bug修复 / 性能基准更新  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：  
- 解决 ZImage 文本‑图像生成管线在处理 5 维 latent 张量（即包含帧维度的 video‑style latents）时的分片（sharding）和拼接错误，新增对 5D 张量的专门处理并在后处理阶段去除多余帧。  
- 同步更新端到端性能基准 `perf_baselines.json` 与对应的测试用例，使其覆盖 2 GPU 的 ZImage 场景，确保改动后指标可度量。  

**🎯 影响范围**：  
- `python/sglang/multimodal_gen/configs/pipeline_configs/zimage.py`（核心管线配置）  
- `python/sglang/multimodal_gen/test/server/perf_baselines.json`（性能基准）  
- `python/sglang/multimodal_gen/test/server/testcase_configs.py`（新增 2 GPU 测试用例）  

**🔍 技术洞察**：  
- **架构影响**：  
  - 在 `ZImagePipelineConfig` 中通过 `isinstance` 检查 `latents.dim()`，对 5 维张量直接委托 `PipelineConfig` 的 `shard_latents_for_sp` / `gather_latents_for_sp` 实现，实现了 **“条件多态”** 而不影响已有的 4 维路径。  
  - 引入 `raw_latent_shape` 检查，在 `post_denoising_loop` 中裁剪多余帧并在非单帧情况下返回第一帧的切片，保持原有 `latent` 形状向后兼容。  

- **性能影响**：  
  - 改动主要是 **正确性** 修复，理论上不应增加额外计算开销；实际运行时避免了因错误帧数导致的后续解码或显存浪费，可能略微提升整体吞吐。  
  - 基准数据新增了 2‑GPU 场景（`zimage_image_t2i_2_gpus`），其中 DenoisingStage 占用约 1304 ms，符合预期，说明改动未造成明显回归。  

- **安全考虑**：  
  - 无直接安全相关改动。唯一需关注的是 `latents.dim()` 判断的鲁棒性；若出现未预料的维度（如 6D），代码会退回到 `super()` 实现，保持安全失效路径。  

**⚠️ 潜在风险**：  
1. **兼容性**：如果其他模型（非 ZImage）意外产生 5D latent 并走到此路径，可能触发 `PipelineConfig` 的分片逻辑，导致不一致的 sharding 行为。  
2. **回归风险**：`super().shard_latents_for_sp` 与 `PipelineConfig` 的实现必须保持兼容；任何对 `PipelineConfig` 的后续改动都需要验证不影响 ZImage。  
3. **测试覆盖不足**：当前仅在性能基准中加入了 2‑GPU 场景，缺少针对 **多帧（>1）且非 2‑GPU** 的单元测试。  

**💡 关注建议**：  
- **单元测试**：在 `testcase_configs.py` 或专门的 pipeline 单元测试中加入 5D latent（多帧） 的 **正确性断言**，验证 `shard_latents_for_sp` / `gather_latents_for_sp` 与 `post_denoising_loop` 的输出尺寸。  
- **回归检测**：在 CI 中保留对所有现有 4D latent 场景的基准，确保改动不会意外影响旧模型的性能或输出。  
- **文档说明**：更新 pipeline 文档，注明 ZImage 现在支持 **视频帧维度**（5D latent），并说明 `raw_latent_shape` 用途与限制。  
- **监控**：上线后监控显存占用和推理时延，特别是采用多 GPU（>2）或大帧数的部署，确保不会出现意外的显存泄漏或切片错误。  

---  
*总体来看，此次提交解决了关键的 5D latent 处理错误，提升了 ZImage 在多帧/多 GPU 场景下的可靠性，风险可控，建议尽快合入并补充相应的单元测试与文档。*

### 52de807dd7670d403810598f0a73d1c10988c62f
https://github.com/sgl-project/sglang/commit/52de807dd7670d403810598f0a73d1c10988c62f
Migrate profiling tests to test/registered/profiling/ (#16459)
**🎯 变更类型**：配置 / 测试  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
1. 为 `test/registered/profiling/` 目录下的 Profiling 相关测试新增 CI 注册调用，分别在 CUDA 与 AMD 环境中注册预估执行时间与测试套件标签。  
2. 将这些 Profiling 测试从 `test/srt/run_suite.py` 中的默认测试列表移除，避免在通用 CI 流程中自动执行。  

**🎯 影响范围**  
- `test/registered/profiling/` 下的三个测试文件  
- CI 注册模块 `sglang.test.ci.ci_register`  
- 测试调度脚本 `test/srt/run_suite.py`  

**🔍 技术洞察**  
- **架构影响**：仅限于测试层面的配置变化，无业务代码或运行时逻辑改动。通过 `register_cuda_ci` / `register_amd_ci` 将特定测试显式标记为 “stage‑b‑test‑small‑1‑gpu(‑amd)”，使 CI 能够按需调度。  
- **性能影响**：不影响产品代码性能；对 CI 耗时的影响取决于新增的 profiling 测试是否被调度执行。移除默认调度可降低日常 CI 时长。  
- **安全考虑**：无安全相关改动，唯一风险是若 `ci_register` 模块缺失或接口变更，会导致测试加载错误，进而中断 CI。  

**⚠️ 潜在风险**  
1. **CI 注册失效**：如果 `sglang.test.ci.ci_register` 在未来的代码重构中被移动或接口签名改变，当前的 `register_*` 调用会抛异常，导致测试阶段直接失败。  
2. **覆盖率下降**：将 profiling 测试从默认 suite 中移除后，除非 CI 明确包含对应 suite，否则这些测试可能在日常回归中被遗漏，导致潜在回归未被捕获。  
3. **平台兼容性**：AMD 与 CUDA 的预估时间不同（8 s vs 41/60 s），若 CI 环境未分别配置相应的 GPU 类型，可能出现超时或资源浪费。  

**💡 关注建议**  
- **CI 配置审查**：确认 CI 流程已添加对 `stage-b-test-small-1-gpu` 与 `stage-b-test-small-1-gpu-amd` 两个 suite 的调度，否则这些 profiling 测试将被遗漏。  
- **回归测试**：在本地或预备 CI 环境中手动运行 `test/registered/profiling/` 下的所有测试，确保 `ci_register` 能正确注册并被 CI 识别。  
- **文档同步**：在项目的 CI/测试文档中注明 profiling 测试已从通用 suite 中剔除，需要通过对应 suite 手动触发。  
- **监控执行时间**：CI 运行后观察实际耗时是否与 `est_time` 参数相符，必要时调整预估值以优化调度。  
- **兼容性防护**：若未来对 `ci_register` 做重大改动，考虑添加兼容层或在测试文件中加入异常捕获，以免因注册失败导致 CI 中断。

### 70933f34f173c43e43e1f95c70f9fa1e6d5384ad
https://github.com/sgl-project/sglang/commit/70933f34f173c43e43e1f95c70f9fa1e6d5384ad
Migrate attention unit tests to test/registered/attention/ (#16465)
**🎯 变更类型**：测试 / 重构  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：将注意力模块（Mamba、SWA）的单元测试迁移至统一的 CI 注册机制 `test/registered/attention/`，并在相应测试文件中加入 `register_cuda_ci`、`register_amd_ci` 的调用以声明预估运行时间和 CI 套件。目前在 `test/srt/run_suite.py` 中删除了对这些测试的硬编码条目，改为通过注册机制统一调度。  
**🎯 影响范围**：  
- `test/registered/attention/` 目录下的 Mamba 与 SWA 单元测试  
- CI 注册模块 `sglang.test.ci.ci_register`  
- 测试套件调度脚本 `test/srt/run_suite.py`  

**🔍 技术洞察**：  
- **架构影响**：无。此变更仅涉及测试层代码，未改动业务代码或系统架构。仅改变了测试用例的组织方式，从手动列入 `run_suite.py` 到通过注册函数自动发现。  
- **性能影响**：无直接影响。测试执行时间估算 (`est_time`) 仅用于 CI 调度优化，不会影响运行时性能。  
- **安全考虑**：无。变更不涉及生产代码或安全敏感路径。  

**⚠️ 潜在风险**：  
1. **CI 注册不完整**：若忘记在新测试文件中调用 `register_*_ci`，对应测试将不会被 CI 触发，导致回归漏测。  
2. **注册参数错误**：`est_time` 或 `suite` 名称写错可能导致 CI 资源分配不合理，出现超时或调度冲突。  
3. **老旧脚本残留**：`test/srt/run_suite.py` 中仍可能保留对已迁移测试的注释或误删，影响维护人员对测试目录结构的认知。  

**💡 关注建议**：  
- **本地验证**：在提交前本地运行 `pytest -m registered`（或项目自定义的 CI 注册入口），确认新注册的测试能被发现并执行。  
- **CI 配置同步**：检查 CI 配置文件（如 GitHub Actions、Jenkins）是否有对应的 `stage-b-test-small-1-gpu` 套件定义，确保新注册的测试能够被调度。  
- **文档更新**：在项目的测试贡献指南中添加 “如何使用 `register_cuda_ci` / `register_amd_ci` 添加新测试” 的说明，防止未来出现遗漏。  
- **持续监控**：在后续 CI 运行报告中关注这两个测试的执行时间和成功率，若出现异常可及时调整 `est_time` 或排查注册逻辑。

### 38895a00642301ea0edd92057b1a23c60d0b4bce
https://github.com/sgl-project/sglang/commit/38895a00642301ea0edd92057b1a23c60d0b4bce
ci: adjust partition counts for stage-b and unit tests (#16617)
**🎯 变更类型**：配置 / CI 调整  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：将 `stage-b-test-small-1-gpu` 的自动分区总数从 8 扩展到 11，以提升并行度；同时将 `per-commit-1-gpu` 的分区总数从 6 缩减到 2，降低并行任务数。此改动旨在更均衡 CI 资源使用、加快关键测试套件的执行速度。  

**🎯 影响范围**：  
- `.github/workflows/pr-test.yml`（CI 工作流定义）  
- `run_suite.py` 调用的分区参数（所有使用 `--auto-partition-id/--auto-partition-size` 的测试）  

**🔍 技术洞察**：  
- **架构影响**：无。仅修改 GitHub Actions 的矩阵配置，不涉及代码库业务逻辑或系统架构。  
- **性能影响**：  
  - `stage-b-test-small-1-gpu` 分区数从 8→11，理论上可将该套件的总运行时间缩短约 27%（取决于各分区负载均衡）。  
  - `per-commit-1-gpu` 分区数从 6→2，单个分区的执行时间会增长，整体 CI 时长可能略有上升，但可释放并发槽位供其他作业使用。  
  - 若分区划分不均匀，可能出现某些分区负载过重导致 “瓶颈”。  
- **安全考虑**：无。修改仅限 CI 环境，未引入外部依赖或凭证变更。  

**⚠️ 潜在风险**：  
1. **分区不均导致 flaky**：增加分区数后，若 `run_suite.py` 对分区大小的假设仍为固定值，可能出现测试遗漏或重复执行。  
2. **资源争用**：更多并行分区会占用更多 GPU/CPU 实例，若 CI 资源配额不足，可能导致其他作业被 throttled 或排队。  
3. **兼容性**：若已有脚本或监控系统硬编码了分区上限（如 0‑5），需要同步更新。  
4. **执行时间波动**：将 `per-commit-1-gpu` 的分区数降至 2，单次作业时间变长，可能导致超时或占用更久的 runner。  

**💡 关注建议**：  
- **验证分区划分**：在 PR 或主分支上运行一次完整的 CI，检查 `stage-b-test-small-1-gpu` 各分区的执行时长是否相对均衡。  
- **监控资源使用**：关注 GitHub Actions 中 GPU/CPU 使用率，确保新增并行度不会触及配额上限。  
- **更新文档/监控**：若有内部文档或监控仪表板记录分区数量，及时同步修改。  
- **回滚计划**：保留原始分区配置在 commit 历史中，若出现显著的 flaky 或资源瓶颈，可快速回滚到 8 与 6 的设置。  
- **渐进式 rollout**：可考虑先在 `stage-b-test-small-1-gpu` 使用 9‑10 分区进行实验，逐步观察效果后再推广至 11。  

### 913b688f21fa2cb380713c879216d53f3eb4f651
https://github.com/sgl-project/sglang/commit/913b688f21fa2cb380713c879216d53f3eb4f651
fix: fill a meaningful tool_index (#16504)
**🎯 变更类型**：Bug修复  

**⚡ 重要程度**：🟡 中  

**📋 变更摘要**：在 `python/sglang/srt/function_call/base_format_detector.py` 中，将 `ToolCallItem.tool_index` 的默认值从固定的 `-1` 改为依据 `tool_indices` 字典动态获取。这样在解析基于 JSON 的函数调用时，能够为每个工具调用填入对应的真实索引，提升调用链的可追溯性和后续处理的准确性。  

**🎯 影响范围**：  
- `sglang/srt/function_call` 模块中的 `BaseFormatDetector` 类  
- 依赖 `ToolCallItem.tool_index` 的下游业务逻辑（如日志、监控、调度器）  

**🔍 技术洞察**：  
- **架构影响**：无大幅度的架构改动，只是局部数据填充逻辑的修正。保持了原有模块边界，兼容性好。  
- **性能影响**：增加一次字典查询 (`tool_indices.get(name, -1)`) 的微小开销，几乎可以忽略。  
- **安全考虑**：不涉及安全相关的改动；使用安全的 `.get` 方法，仍然在找不到映射时回退到 `-1`，避免抛异常。  

**⚠️ 潜在风险**：  
- 如果 `tool_indices` 在调用方未正确构建或遗漏某些工具的映射，仍会得到 `-1`，可能导致下游依赖真实索引的逻辑误判。  
- 现有单元测试若未覆盖 `tool_index` 的使用场景，可能出现未检测的回归。  

**💡 关注建议**：  
1. **测试覆盖**：新增或完善针对 `parse_base_json` 的单元测试，验证在正常、缺失映射两种情况下 `tool_index` 的取值。  
2. **日志审计**：在生成 `ToolCallItem` 前后加入调试日志（可选），帮助快速定位因映射缺失导致的 `-1`。  
3. **升级注意**：对使用 `ToolCallItem.tool_index` 进行业务判断的旧版本代码，需要确认是否已准备好处理非 `-1` 的真实索引，以免出现逻辑分支遗漏。  

---  

### 951d16c8902849bee460d6cad4f16f1b00709d3d
https://github.com/sgl-project/sglang/commit/951d16c8902849bee460d6cad4f16f1b00709d3d
fix: adjusting vlm accuracy thresholds (#16593)
**🎯 变更类型**：测试 / 配置  
**⚡ 重要程度**：🟢低  
**📋 变更摘要**：在 `test/registered/eval/test_vlms_mmmu_eval.py` 中调整了多个 Vision‑Language Model（VLM）的期望准确率阈值和 FLOPs（或其他指标）数值，以匹配最新的模型表现。此修改旨在防止因阈值偏差导致 CI 测试误报失败。  

**🎯 影响范围**：  
- `test/registered/eval/test_vlms_mmmu_eval.py`（VLM 评估相关单元测试）  
- 受影响的 CI/CD 流水线及任何使用该测试文件验证模型表现的项目  

**🔍 技术洞察**：  
- **架构影响**：无，未触及业务逻辑或模块接口，仅修改测试数据。  
- **性能影响**：无直接性能变化，唯一影响是测试执行时的断言检查范围略有扩大/缩小。  
- **安全考虑**：无安全相关改动，也未引入新的依赖或外部交互。  

**⚠️ 潜在风险**：  
- 若阈值调高过度，可能掩盖模型实际退化的情况，导致质量回归不易被发现。  
- 反向调低阈值会导致本该不合格的模型被误判为合格，降低测试的可信度。  
- 只修改了测试文件，若实际模型代码或评估脚本未同步更新，仍可能出现不一致的文档/代码状态。  

**💡 关注建议**：  
1. **验证阈值准确性**：在本地或 CI 环境跑一次完整的 VLM 评估，确认新的阈值与实际模型表现一致。  
2. **记录变更原因**：在代码注释或相关文档中说明阈值调整的依据（如模型更新、数据集变动），便于后续追溯。  
3. **持续监控**：在后续的评估基准更新时，重新审视这些阈值，防止“阈值漂移”。  
4. **不影响用户**：此更改仅影响开发者/CI 环境，向终端用户无需做任何升级或兼容性处理。  

### 53846746bf76082855ad067912d5e1e9ab544515
https://github.com/sgl-project/sglang/commit/53846746bf76082855ad067912d5e1e9ab544515
[VLM] Fix CUDA IPC OOM (#16118)

Co-authored-by: luoyuan.luo <luoyuan.luo@antgroup.com>
**🎯 变更类型**：Bug修复 / 性能优化  
**⚡ 重要程度**：🟡中  
**📋 变更摘要**：  
- 修复在多模态推理时因 CUDA IPC 引用未及时释放导致的显存 OOM（Out‑Of‑Memory）问题。  
- 在 `schedule_batch.py` 中显式 `del pixel_values`，提前销毁跨进程共享的 CUDA 张量。  
- 在 `base_processor.py` 中当服务器参数 `keep_mm_feature_on_device` 为 false 时，将多模态特征和预计算嵌入从 GPU 移动到 CPU，进一步降低显存占用。  

**🎯 影响范围**：  
- `python/sglang/srt/managers/schedule_batch.py`（调度批次管理）  
- `python/sglang/srt/multimodal/processors/base_processor.py`（多模态数据处理）  

**🔍 技术洞察**：  
- **架构影响**：无结构性改动，仅在已有的多模态处理流水线中加入资源回收与迁移逻辑，不影响模块间接口。  
- **性能影响**：  
  - 正面：显存占用显著下降，防止 OOM，提升系统并发能力。  
  - 负面：当 `keep_mm_feature_on_device=False` 时，会产生 GPU→CPU 的数据拷贝，可能增加 CPU 内存使用和拷贝延迟，尤其在大批量特征上。  
- **安全考虑**：无新增安全风险，删除对象仅影响本进程内存管理。  

**⚠️ 潜在风险**：  
1. **功能回退**：如果下游代码仍假设特征保持在 GPU 上，而 `keep_mm_feature_on_device` 被误设为 `False`，可能导致额外的 `device mismatch` 错误。  
2. **性能回归**：频繁的 CPU‑GPU 拷贝在高吞吐场景下可能成为瓶颈，尤其在网络 I/O 已经是瓶颈的情况下。  
3. **兼容性**：`del pixel_values` 依赖于 Python 垃圾回收及时执行，若有循环引用仍可能导致显存未释放。  

**💡 关注建议**：  
- **配置审查**：确认生产环境的 `keep_mm_feature_on_device` 参数与业务需求匹配，默认保持为 `True` 以获得最佳吞吐。  
- **性能测试**：在开启/关闭 `keep_mm_feature_on_device` 两种模式下，分别跑大批量推理基准，关注显存占用、CPU 内存以及端到端延迟；若拷贝成本显著，考虑仅在内存紧张时临时切换。  
- **回归验证**：增加单元/集成测试，验证在 `keep_mm_feature_on_device=False` 时模型仍能正常推理，并检查是否出现 `device mismatch` 或 `CUDA illegal memory access`。  
- **监控告警**：在部署后监控显存使用峰值和 GC 频率，一旦出现异常回收行为，可快速定位是否因 `del pixel_values` 未生效导致的残留引用。  

---  
*以上分析基于代码差异，建议结合实际运行环境进行验证。*

### 534ac384db14cc382f6e7e813cd44500c9798fbd
https://github.com/sgl-project/sglang/commit/534ac384db14cc382f6e7e813cd44500c9798fbd
[HiCacheStorage & PD] fix prefill bootstrap request host memory leaks (#15439)

Co-authored-by: yangjia1 <yangjia1@kingsoft.com>
**🎯 变更类型**：Bug修复 / 性能优化  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
在 `prefill.py` 中，针对 bootstrap 失败的请求新增了在 HiCache 存储开启时调用 `tree_cache.release_aborted_request(req.rid)` 的逻辑。此举在请求被标记为失败后立即释放与之关联的预取事件，修复了因未及时清理导致的 host 端内存泄漏问题。  

**🎯 影响范围**  
- `python/sglang/srt/disaggregation/prefill.py`（prefill bootstrap 处理）  
- 调度器 (`scheduler`) 中的 `tree_cache` 与 `enable_hicache_storage` 开关  
- 可能影响使用 HiCache 存储（PD）功能的所有模型推理服务实例  

**🔍 技术洞察**  
- **架构影响**：  
  - 新增了调度器与 HiCache 存储的耦合点：在请求失败路径中显式调用 `tree_cache.release_aborted_request`。  
  - 该调用仍受 `enable_hicache_storage` 控制，不会影响未开启 HiCache 的部署，保持向后兼容。  

- **性能影响**：  
  - **正向**：及时释放预取事件的内存，降低长期运行时的 host 内存占用，防止 OOM。  
  - **负向**：在每次 bootstrap 失败时多执行一次 `release_aborted_request`，但该操作本身是 O(1) 的哈希表/链表删除，几乎可以忽略不计。  

- **安全考虑**：  
  - 无直接安全影响。唯一需关注的是 `release_aborted_request` 的实现是否安全（例如是否会误删仍在使用的资源），但该函数已在现有代码库中使用，风险较低。  

**⚠️ 潜在风险**  
1. **函数副作用**：若 `tree_cache.release_aborted_request` 未做好幂等或异常处理，异常路径可能导致缓存状态不一致。  
2. **兼容性**：开启 `enable_hicache_storage` 的旧版部署若依赖于未释放的预取事件（极少见），可能出现行为变化。  
3. **遗漏的错误处理**：若 `release_aborted_request` 抛异常，当前代码未捕获，可能导致调度器线程异常退出。  

**💡 关注建议**  
- **测试**：在开启 HiCache 的环境下，增加 **bootstrap 失败** 场景的单元/集成测试，验证内存使用随时间恢复正常且不会出现意外的缓存错误。  
- **回滚准备**：若在生产环境中观察到异常行为，可通过关闭 `enable_hicache_storage` 快速回滚。  
- **代码审查**：确认 `tree_cache.release_aborted_request` 实现具备异常安全（不抛异常或已捕获），并在必要时在调用处添加 try/except 防护。  
- **监控**：部署后开启内存监控指标，关注 `tree_cache` 相关的内存占用曲线，确保泄漏已被根除且没有新的回归。  

### 2a8d5493f3a4c53f5e9ba457234e87d072f2b829
https://github.com/sgl-project/sglang/commit/2a8d5493f3a4c53f5e9ba457234e87d072f2b829
PCG Unit Test Adjustment (#16609)

Signed-off-by: Oasis-Git <ayw.sirius19@gmail.com>
**🎯 变更类型**：测试  
**⚡ 重要程度**：🟢低  
**📋 变更摘要**：将 `test_piecewise_cuda_graph_2_gpu.py` 中的测试类从 *FusedMoE* 场景改为普通 *TP* 场景，重命名类名并更新文档说明，删除了 `--ep-size 2` 参数，以简化测试配置。  

**🎯 影响范围**：  
- `test/registered/cuda_graph/test_piecewise_cuda_graph_2_gpu.py`（CUDA 图单元测试）  
- 可能影响 CI 中的 CUDA 图相关测试套件  

**🔍 技术洞察**：  
- **架构影响**：无。仅修改测试代码，不涉及生产模块或架构层面的变更。  
- **性能影响**：无直接影响。删除 `--ep-size 2` 后，测试执行的并行配置会有所不同，可能导致运行时间略有下降。  
- **安全考虑**：不适用。  

**⚠️ 潜在风险**：  
- 重命名后的测试类如果不符合项目的自动发现规则（例如类名需以 `Test` 开头），可能导致该测试被遗漏。  
- 删除 `--ep-size` 参数会导致不再覆盖 *FusedMoE* 场景的代码路径，若该路径在实际产品中仍被使用，可能导致回归风险未被检测到。  

**💡 关注建议**：  
1. 确认 CI 的测试发现机制能够识别新的类名 `TestPiecewiseCudaGraphTP`。  
2. 若 *FusedMoE* 场景仍需验证，建议单独保留或新建对应的测试用例，避免覆盖盲区。  
3. 在下一轮回归测试中留意与 *expert parallel* 相关的功能是否受到影响。  

### badcd0289623ca18bc56e154bbdc961b789758f1
https://github.com/sgl-project/sglang/commit/badcd0289623ca18bc56e154bbdc961b789758f1
[diffusion] chore: automatically enable dit_layerwise_offload for Wan (#16499)
**🎯 变更类型**：功能增强 / 配置  

**⚡ 重要程度**：🟡 中  

**📋 变更摘要**：  
在 `server_args.py` 中新增对环境变量 `SGLANG_CACHE_DIT_ENABLED` 的检查，若该变量为 `False` 且推理 pipeline 名称中包含 “wan”，则自动开启 `dit_layerwise_offload` 以获得最佳性能。此改动还对相关冲突检查逻辑做了同步更新。

**🎯 影响范围**：  
- `python/sglang/multimodal_gen/runtime/server_args.py`（服务器启动参数校验）  
- `sglang.multimodal_gen.envs`（环境变量统一入口）  
- 受 `wan` 系列 pipeline（如 `WanPipeline`）影响的推理路径  

**🔍 技术洞察**：  
- **架构影响**：`dit_layerwise_offload` 属于模型层级的显存/CPU 分层卸载机制，开启后会在推理时动态释放已计算完的层权重，减少显存占用，对支持 `Wan` pipeline 的运行时资源调度产生正向影响。  
- **性能影响**：  
  - **正面**：显存需求明显下降，尤其在显存受限的 GPU 环境下，可避免 OOM，提升 `Wan` 推理的吞吐与可用性。  
  - **负面**：层级卸载伴随 CPU‑GPU 数据迁移，若 CPU 带宽或内存不足，可能出现轻微的延迟增长。总体预计收益 > 5%（视模型大小而定）。  
- **安全考虑**：无直接安全风险；仅涉及环境变量读取和内部状态修改。  

**⚠️ 潜在风险**：  
1. **配置冲突**：当 `SGLANG_CACHE_DIT_ENABLED=true` 时仍可能误触发 `dit_layerwise_offload`，导致 `ValueError` 抛出，影响启动流程。  
2. **兼容性**：旧版脚本或自定义 pipeline 可能未预期自动开启卸载，若未考虑层级卸载带来的 CPU 负载，可能出现性能回退。  
3. **调试难度**：自动开启的行为在日志中仅有 `info` 级别提示，若用户未打开足够日志级别，可能难以追踪配置来源。  

**💡 关注建议**：  
- **测试覆盖**：在 CI 中加入针对 `wan` pipeline 的两组测试：`SGLANG_CACHE_DIT_ENABLED=false`（期望 `dit_layerwise_offload=True`）以及 `true`（期望抛异常或保持关闭）。  
- **文档更新**：在项目 README 或参数手册中明确说明该自动开启行为及其前置条件（`wan` pipeline + cache‑dit 关闭）。  
- **日志强化**：建议在 `logger.info` 中加入当前 `dit_layerwise_offload` 的最终取值，以便用户快速确认生效状态。  
- **升级注意**：生产环境升级前，确认机器的 CPU‑内存能够承担层级卸载产生的额外数据搬迁负载，必要时进行性能基准测试。

### d874c8bba4c2d2e5d65c1b95e005bffff7dbf980
https://github.com/sgl-project/sglang/commit/d874c8bba4c2d2e5d65c1b95e005bffff7dbf980
Tiny support http headers in bench serving (#16606)
**🎯 变更类型**：功能增强  

**⚡ 重要程度**：🟡 中  

**📋 变更摘要**：  
1. 为 `sglang/bench_serving.py` 新增 `--header` CLI 参数，支持以 `Key=Value` 形式传入任意自定义 HTTP 请求头。  
2. 实现 `parse_custom_headers` 与 `get_request_headers` 两个辅助函数，将自定义头与身份验证头合并后在所有请求中使用。  
3. 相应地在测试帮助函数 `get_benchmark_args` 中加入 `header` 参数，并补充单元测试验证头部解析及实际发送情况。  

**🎯 影响范围**：  
- `python/sglang/bench_serving.py`（请求构造、CLI 参数解析）  
- `python/sglang/test/test_utils.py`（基准运行参数生成）  
- `test/registered/bench_fn/test_bench_serving_functionality.py`（新增单元测试）  

---

### 🔍 技术洞察

- **架构影响**：  
  - 只在 **bench_serving** 这一基准测试工具层面增加了可配置的 HTTP Header 处理，未触及核心推理、模型加载或路由层代码，保持了原有模块边界。  
  - 新增的 `parse_custom_headers` 采用 **列表推导 + `str.partition`** 实现，依赖 Python 标准库，代码简洁且易于维护。  

- **性能影响**：  
  - 解析自定义头部仅在 CLI 启动时一次性完成，时间复杂度 O(N)（N 为 header 列表长度），对整体基准吞吐几乎无影响。  
  - 请求头的大小直接随用户输入线性增长，对网络带宽和服务器处理时间的影响也属于线性且可预期。  

- **安全考虑**：  
  - 直接把用户提供的字符串拼接进 HTTP Header，可能导致 **Header Injection**（如在值中植入换行/回车），但 `http.client` / `requests` 在发送时会自动规范化，仍建议在未来加入更严格的校验（如禁止 `\r\n`、限制关键头字段如 `Host`、`Content-Length`、`Authorization`）。  
  - 该功能仅用于基准测试，默认不在生产环境开启，风险相对可控。  

---

### ⚠️ 潜在风险

1. **向后兼容性**：新增 `--header` 参数若在旧版脚本/CI 环境中误拼写或传入不符合 `Key=Value` 格式的字符串，`parse_custom_headers` 会返回空字典，不会导致错误，但可能让用户误以为头已生效。  
2. **非法或冲突头部**：用户可以覆盖内部使用的身份验证头（如 `Authorization`），导致请求失败或产生安全隐患。  
3. **测试依赖**：单元测试启动本地 HTTPServer，若运行环境限制端口绑定或多线程（如在沙箱 CI 中），可能导致测试 flaky。  

---

### 💡 关注建议

| 角色 | 建议 |
|------|------|
| **开发者** | - 在 `parse_custom_headers` 中加入对非法字符（`\r`, `\n`）的过滤或抛异常，防止 Header Injection。<br>- 对关键系统头（`Host`, `Authorization`, `Content-Type` 等）加白名单或直接忽略用户覆盖。 |
| **使用者** | - 使用时确保 `Key=Value` 格式正确，避免在值中包含换行符或空格。<br>- 如需发送敏感凭证，仍建议使用 `--auth-header`（已有）而非通用 `--header`。 |
| **CI/测试** | - 确认运行环境允许打开随机端口的本地 HTTPServer。<br>- 若出现端口冲突，可在 `HTTPServer(("127.0.0.1", 0), ...)` 保持不变，或在 CI 中显式设置可用端口范围。 |
| **文档** | - 在官方使用说明中补充 `--header` 示例及注意事项（不可覆盖系统关键头、不要包含换行等）。 |

--- 

**结论**：此次改动为 `sglang` 基准测试工具提供了灵活的 HTTP Header 定制能力，提升了对多样化后端服务的适配性。风险主要集中在输入校验和关键头的冲突上，建议在后续版本中加入更严格的检查，以确保安全性与用户体验的双重保障。

### 4c9ac8566cf5fcf000763934456de8c179689043
https://github.com/sgl-project/sglang/commit/4c9ac8566cf5fcf000763934456de8c179689043
[NPU] fix command in npu best practice (#16576)
**🎯 变更类型**：文档/配置  
**⚡ 重要程度**：🟡中  
**📋 变更摘要**：更新 `docs/platforms/ascend_npu_best_practice.md` 中的 NPU 运行示例，纠正了环境变量取值、`dp-size`、`cuda-graph-bs`、`HCCL_BUFFSIZE` 等参数，并删减/调整了部分不再使用的选项（如 `DEEP_NORMAL_MODE_USE_INT8_QUANT`、`base-gpu-id`），以匹配最新的 SGLang/NPU 运行最佳实践。  

**🎯 影响范围**：  
- `docs/platforms/ascend_npu_best_practice.md`（文档）  
- 参考该文档编写的部署脚本或 CI/CD 流程（间接影响）  

**🔍 技术洞察**：  
- **架构影响**：无直接代码改动，仅是运行指令的说明，未改变系统模块关系或设计模式。  
- **性能影响**：文档中更改的参数会直接影响实际运行时的性能，例如：  
  - `dp-size` 从 16 降至 8、从 32 降至 8，减小了数据并行度，可能降低吞吐但降低显存占用。  
  - `cuda-graph-bs` 调整为更细粒度的批次大小（如 `2 4 6`），有助于在 NPU 上寻找更合适的图执行规模。  
  - `HCCL_BUFFSIZE` 增大（1600 → 2100），提升了通信缓冲，可能改善跨卡通信延迟。  
- **安全考虑**：无。  

**⚠️ 潜在风险**：  
1. **文档与实现不一致**：如果 SGLang 代码已经废弃或重命名了某些参数（如 `--moe-a2a-backend deepep` 与 `ascend_fuseep`），用户照搬文档可能导致启动失败。  
2. **性能回归**：调小 `dp-size` 或批次大小可能在某些场景下导致显著的吞吐下降，用户若未重新评估配置可能误以为是最佳值。  
3. **兼容性**：部分环境变量（如 `SGLANG_DEEPEP_NUM_MAX_DISPATCH_TOKENS_PER_RANK`）的取值从 12 → 4，若在旧版本中不被支持，可能引发警告或错误。  

**💡 关注建议**：  
- **同步检查**：在更新文档后，快速跑通一次全链路测试（包括 `sglang.launch_server` 启动和一次推理请求），确保所有参数在当前主分支均可被解析。  
- **版本标注**：在文档显著位置注明适用的 SGLang 版本号，防止用户在旧版本上使用新参数。  
- **提供回退示例**：保留原始（旧）参数示例或给出“如果出现启动错误请尝试恢复至原始 `dp-size` / `cuda-graph-bs`”的说明。  
- **监控指标**：建议在实际部署后，通过监控 `max-running-requests`、`mem-fraction-static`、`HCCL_BUFFSIZE` 等关键指标，评估新配置是否真的提升了 NPU 运行效果。  

---  

### fb5b71d015a24ea1786c10b1d41a5b36fd12d0de
https://github.com/sgl-project/sglang/commit/fb5b71d015a24ea1786c10b1d41a5b36fd12d0de
[router][openai] Rename `prepare_mcp_payload_for_streaming` and `patch_streaming_response_json` (#16596)
**🎯 变更类型**：重构 / 功能增强  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
- 将 `prepare_mcp_payload_for_streaming` 重命名为 `prepare_mcp_tools_as_functions`，同时更新所有调用点，使语义更准确。  
- 将原先仅用于流式响应的 `patch_streaming_response_json` 合并并改名为 `patch_response_with_request_metadata`，统一在非流式、流式以及工具拦截路径中补齐原始请求的元数据（`previous_response_id`、`instructions`、`metadata`、`store`、`model`、`safety_identifier`）。  
- 相关文件 `mcp.rs`、`non_streaming.rs`、`streaming.rs`、`utils.rs` 均同步调整。

**🎯 影响范围**  
- `sgl-model-gateway/src/routers/openai/responses/*`（所有响应处理模块）  
- 可能涉及的公共工具库 `utils.rs` 中的函数签名变更  

**🔍 技术洞察**  

- **架构影响**：  
  - 重命名属于内部 API 调整，对外部接口没有变化，保持了模块间的低耦合。  
  - `patch_response_with_request_metadata` 将元数据补全职责从 “仅流式” 扩展到 “所有响应”，提升了代码复用，降低了重复实现的风险。  
  - 仍然保持原有的 `mask_tools_as_mcp`、`prepare_mcp_tools_as_functions` 等模块职责不变。

- **性能影响**：  
  - 重命名本身不产生运行时开销。  
  - `patch_response_with_request_metadata` 通过一次遍历 `response_json` 并写入少量字段，时间复杂度 O(1)（字段数量固定），对整体请求处理性能影响可以忽略。

- **安全考虑**：  
  - 新增的元数据写入（如 `model`、`safety_identifier`）均来源于原始请求，未引入外部数据或加密／验证逻辑，安全风险可视为 **无**。  
  - 注意确保原始请求中的敏感字段在需要时仍受平台的访问控制或审计机制约束。

**⚠️ 潜在风险**  

1. **编译/链接错误**：若还有未更新的调用方（例如其他分支、外部插件）仍使用旧函数名，会导致编译失败。  
2. **行为回归**：`patch_response_with_request_metadata` 现在会在所有响应中补全元数据，若业务方原本依赖“缺失”这些字段的旧行为（比如前端根据缺失字段判断是否需要额外请求），可能出现兼容性问题。  
3. **测试覆盖不足**：原有的单元/集成测试可能只覆盖流式路径的 `patch_streaming_response_json`，重新命名后需要确保新函数在非流式和工具拦截路径也被验证。  

**💡 关注建议**  

- **代码审查**：确认项目中没有遗漏的旧函数引用（搜索 `prepare_mcp_payload_for_streaming`、`patch_streaming_response_json`）。  
- **回归测试**：增加或更新以下场景的测试：  
  - 非流式响应中元数据是否完整回写。  
  - 流式响应中元数据回写与原有 SSE 处理不冲突。  
  - 工具拦截（tool calls）路径的完整性。  
- **文档同步**：更新内部文档或 API 说明，明确 `patch_response_with_request_metadata` 已统一处理所有响应的元数据补全。  
- **发布注意**：在发布新版本时，提供迁移说明（函数名更改），并在发布 notes 中标注此变更，以防用户自行调用旧函数。  

---

*总体来看，此次提交提升了代码可读性和复用性，风险主要集中在未完全迁移的调用方和潜在的业务兼容性，建议在 CI 中加入对应的覆盖测试后再上线。*

### 4f443f445acd0fdaa3afcb993977a215c98f7946
https://github.com/sgl-project/sglang/commit/4f443f445acd0fdaa3afcb993977a215c98f7946
[model-gateway][cleanup] Fix wrong comment in manager.rs (#16601)
**🎯 变更类型**：文档  
**⚡ 重要程度**：🟢低  
**📋 变更摘要**：把 `McpManager::server_key` 函数的文档注释从 “Generate a unique key for a server config” 修正为 “Generate a unique key for a server config based on its transport”，并删除了函数体中一行冗余且误导的注释。目的是让代码意图更清晰，避免误解。

**🎯 影响范围**：  
- `sgl-model-gateway/src/mcp/manager.rs` 中的 `McpManager::server_key` 方法。  
- 受影响的模块仅限于模型网关（model‑gateway）内部，未涉及外部 API。

**🔍 技术洞察**  
- **架构影响**：无。仅是文档层面的改动，对模块耦合或设计模式没有影响。  
- **性能影响**：无。代码逻辑保持不变，函数仍是简单的模式匹配与 `String` 克隆。  
- **安全考虑**：无。未涉及安全相关的实现或数据处理。

**⚠️ 潜在风险**：  
- 由于没有实际代码行为变化，风险几乎为零。唯一需要关注的是文档生成或自动化工具是否依赖旧的注释内容；但这类工具通常不影响运行时行为。

**💡 关注建议**：  
- 对于使用 `McpManager::server_key` 的调用方，确认仍按照返回的 URL 作为唯一键使用即可，无需额外适配。  
- 若项目中有基于代码注释的文档生成（如 rustdoc），建议重新生成文档以确保描述与实现保持一致。  
- 继续保持代码注释的准确性，避免出现类似“误导性注释”在后续维护中造成困惑。

### dce8b0606c06d3a191a24c7b8cbe8e238ab316c9
https://github.com/sgl-project/sglang/commit/dce8b0606c06d3a191a24c7b8cbe8e238ab316c9
refactor(e2e): keep only benchmark tests in e2e_http, remove redundant tests (#16594)
**🎯 变更类型**：重构 / 测试  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**：  
此次提交对 `sgl-model-gateway/e2e_test/e2e_http` 下的大量端到端（e2e）测试进行了精简，只保留下用于基准测试（benchmark）的案例，删除了诸如 MMLU、TLS、动态扩容、故障恢复等冗余或重复的测试文件与代码。  

**🎯 影响范围**：  
- `sgl-model-gateway/e2e_test/e2e_http/test_pd_router.py`  
- `sgl-model-gateway/e2e_test/e2e_http/test_regular_router.py`  
- `sgl-model-gateway/e2e_test/e2e_http/test_tls.py`（已完整删除）  

**🔍 技术洞察**：  
- **架构影响**：无。删除的均是测试代码，对生产代码、模块依赖关系或接口设计没有任何改动。  
- **性能影响**：显著降低 CI/CD 中 e2e 测试的执行时长，尤其在多节点或多 GPU 场景下，可节省数分钟至十几分钟的资源占用。  
- **安全考虑**：无。删除的 TLS 测试本身不涉及生产安全，仅是本地自签证书的验证；由于已不再执行，不会产生新的安全风险。  

**⚠️ 潜在风险**：  
1. **回归检测缺失**：被删除的测试覆盖了 worker 动态添加/删除、故障注入、API Key 认证、TLS 启动等功能。若后续代码改动涉及这些特性，缺少对应的 e2e 验证可能导致回归未被及时捕获。  
2. **文档/示例同步**：部分 README 或开发文档可能仍引用这些已删除的测试用例，导致新手阅读时产生困惑。  
3. **CI 依赖**：如果项目的 CI 配置显式指定了这些文件的执行（例如通过路径过滤），删除后可能触发“找不到文件”的错误。  

**💡 关注建议**：  
- **补充关键场景的单元/集成测试**：将被删除的核心业务场景（如 worker 扩容、API Key 校验、TLS 启动）迁移到更轻量的集成测试中，确保关键路径仍有自动化验证。  
- **更新 CI 配置**：检查 GitHub Actions、GitLab CI 等流水线脚本，移除对已删除测试文件的显式引用或路径过滤。  
- **文档同步**：在项目文档、示例代码或贡献指南中同步删除或标记相关测试，避免误导贡献者。  
- **监控测试覆盖率**：在代码合并后通过覆盖率报告确保整体测试覆盖率未出现异常下降。  

---  

*以上分析基于提交的 diff 内容，对业务功能本身未产生直接影响，但需关注因测试覆盖度降低可能带来的回归风险。*

### 399d5283f8a3eae7619be079b7edeb44b534fdae
https://github.com/sgl-project/sglang/commit/399d5283f8a3eae7619be079b7edeb44b534fdae
ci: migrate scheduler tests to test/registered/scheduler/ (#16442)
**🎯 变更类型**：CI/测试组织迁移、配置更新  

**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
将原先位于 `test/registered/scheduler/` 的调度器相关单元测试文件移动并改名，同时在每个测试文件中加入 `register_cuda_ci` / `register_amd_ci` 调用，以让 CI 系统能够根据估算时长和目标套件自动调度这些测试。对应地，从 `test/srt/run_suite.py` 中剔除了这些调度器测试的硬编码 `TestFile` 条目，使其不再被旧的 suite 配置显式加载。  

**🎯 影响范围**  
- `test/registered/scheduler/` 目录下的全部调度器测试文件  
- CI 注册模块 `sglang.test.ci.ci_register`  
- 测试套件配置文件 `test/srt/run_suite.py`  

**🔍 技术洞察**  

- **架构影响**：  
  - 仅涉及测试层组织和 CI 注册机制，未改动业务代码或库内部结构。  
  - 通过在测试文件内部调用 `register_*_ci`，实现了 **声明式** 的 CI 入口，降低了 `run_suite.py` 对测试文件路径的耦合度。  

- **性能影响**：  
  - **时间复杂度**：无运行时代码变化，性能不受影响。  
  - **空间复杂度**：新增的注册函数调用在导入阶段略增开销（微乎其微），对 CI 资源消耗没有实质性影响。  

- **安全考虑**：  
  - 仅添加了对 `sglang.test.ci.ci_register` 的 import 与函数调用，并未引入外部依赖或执行安全敏感操作，安全风险可以视为 **无**。  

**⚠️ 潜在风险**  

1. **测试发现失效**  
   - 如果 CI 环境仍依赖旧的 `run_suite.py` 配置而未加载新的注册信息，相关调度器测试将被漏跑。  
2. **重复注册或冲突**  
   - 在同一文件中多次调用 `register_*_ci`（如误删或拷贝导致）可能导致 CI 框架报错或产生重复的测试条目。  
3. **本地运行不一致**  
   - 开发者在本地使用 `python -m unittest discover` 仍能发现这些测试，但如果仍参考 `run_suite.py` 手动挑选测试，可能会误认为这些测试被排除。  

**💡 关注建议**  

- **CI 配置核对**：确认 CI 流程（GitHub Actions、Jenkins 等）已改为通过 `ci_register` 动态加载测试，而不是硬编码的 suite 列表。  
- **本地验证**：在本地运行一次完整的 `pytest -q`（或对应的 unittest 命令），确保所有迁移后的调度器测试均被执行且通过。  
- **文档同步**：在项目的测试指南或 CI 文档中注明调度器测试已迁移至 `test/registered/scheduler/`，并解释 `register_*_ci` 的作用和使用方法。  
- **回滚预案**：若出现 CI 失踪或报错，快速回滚 `run_suite.py` 中对应条目或在 CI 脚本中手动加入缺失的测试文件，以保证关键回归测试不受影响。  

---  

*整体来看，此次变更主要是提升 CI 可维护性和可扩展性，对业务代码没有风险，唯一需要关注的是 CI 环境是否已同步更新注册机制。*

### 2e0527dd743a27b901746bc2ffbe5f11e2bff5dc
https://github.com/sgl-project/sglang/commit/2e0527dd743a27b901746bc2ffbe5f11e2bff5dc
ci: migrate Debug Utils, Ops, and Rotary Embedding tests to test/registered/ (#16422)
**🎯 变更类型**：配置 / CI 测试迁移  

**⚡ 重要程度**：🟡 中  

**📋 变更摘要**：  
- 将 Debug Utils、Ops、Rotary Embedding 相关的单元测试迁移到 `test/registered/` 目录下，并在文件头部加入 CI 注册装饰器，以声明在 AMD 与 CUDA 环境下的预估执行时间与所属测试套件。  
- 同步更新 `test/srt/run_suite.py`，从原先的 “per‑commit‑1‑gpu” 与 “per‑commit‑amd” 套件中移除这些测试的显式条目，避免重复注册。

**🎯 影响范围**：  
- `test/registered/debug_utils/*`  
- `test/registered/ops/*`  
- `test/registered/rotary/*`  
- CI 测试调度逻辑（`test/srt/run_suite.py`）  

**🔍 技术洞察**：  
- **架构影响**：仅涉及测试框架层面的组织方式变化，不影响业务代码或核心库的运行时架构。  
- **性能影响**：通过 `register_*_ci` 提供的 `est_time` 信息，CI 系统能够更精准地进行资源分配和并行调度，潜在提升整体 CI 耗时的预测准确性。  
- **安全考虑**：无安全相关改动，风险主要限于 CI 测试覆盖率的意外下降。  

**⚠️ 潜在风险**：  
1. **测试遗漏**：若 CI 注册装饰器或 `run_suite.py` 中的移除操作未同步到所有 CI 环境，可能导致这些测试在某些平台上未被执行。  
2. **兼容性**：旧的 CI 配置仍可能引用已移动的相对路径，导致 “文件未找到” 错误。  
3. **套件划分误差**：`suite="stage-b-test-small-1-gpu"` 的标签如果在后续的套件筛选逻辑中未被正确解析，可能使这些测试被排除在预期的套件之外。  

**💡 关注建议**：  
- **CI 验证**：在 CI 服务器上跑一次完整的 “stage‑b‑test‑small‑1‑gpu” 套件，确保新注册的三类测试均被发现并执行。  
- **回退方案**：保留原始路径的软链接或在 `run_suite.py` 中添加注释，易于在出现路径错误时快速恢复。  
- **文档更新**：在项目的测试指南或 CI 贡献文档中加入 “测试迁移至 `test/registered/`” 的说明，防止后续贡献者误将新测试放在旧目录。  
- **监控覆盖率**：在 CI 中加入覆盖率报告的阈值检查，确保迁移后整体测试覆盖率没有意外下降。  

---

### 6beb50d612eff067307d8a090d036aa4a7283db8
https://github.com/sgl-project/sglang/commit/6beb50d612eff067307d8a090d036aa4a7283db8
feat: add .dockerignore to ignore files when build images (#16223)
**🎯 变更类型**：功能增强 / 文档（新增 `.dockerignore`）  
**⚡ 重要程度**：🟢低  
**📋 变更摘要**：  
- 新增 `.dockerignore` 文件，使 Docker 构建镜像时排除 `.gitignore` 中列出的文件，减小镜像体积并加速构建。  
- 同时对 `.gitignore` 进行细化，改为使用 `**/` 前缀的全路径通配符，以在多层目录结构下统一排除构建产物。  

**🎯 影响范围**：  
- Docker 镜像构建流程（CI/CD、本地 `docker build`）。  
- 项目根目录及所有子目录的 `.gitignore` 行为。  

**🔍 技术洞察**：  
- **架构影响**：无直接代码层面的架构变动，仅影响构建层面的资源打包方式。  
- **性能影响**：  
  - 正面：`.dockerignore` 能显著减少上下文传输的文件数量，缩短镜像构建时间。  
  - 负面：若 `.dockerignore` 未覆盖所有大文件或临时产物，可能仍会出现不必要的传输，需确保规则完整。  
- **安全考虑**：  
  - `.dockerignore` 防止将源码仓库中的敏感文件（如 `.git`、凭证）误打包进镜像，提升镜像安全性。  
  - 仍应检查项目中是否存在未被忽略的机密文件（如 `.env`、私钥），防止泄漏。  

**⚠️ 潜在风险**：  
- **行为差异**：`.gitignore` 采用了 `**/` 前缀，部分旧版 Git 客户端或工具（如某些 IDE 的文件监视插件）在解析该通配符时可能表现不一致，导致本地文件仍被误提交或未被忽略。  
- **遗漏文件**：`.dockerignore` 目前仅列出 `.gitignore`，若有人在 `.gitignore` 中添加但忘记同步到 Docker 的排除规则，仍可能将不该打包的文件带入镜像。  
- **CI/CD 缓存**：若 CI 环境缓存了旧的 Docker 构建上下文，可能出现 “构建仍包含已忽略文件” 的误报，需要清理缓存。  

**💡 关注建议**：  
1. **本地验证**：在本地执行 `docker build .` 并观察构建上下文大小，确认 `.dockerignore` 生效（可使用 `docker build --progress=plain .` 查看传输的文件列表）。  
2. **CI 测试**：在持续集成流水线中加入构建上下文大小检查或 `docker build --no-cache`，防止旧缓存导致误判。  
3. **安全审计**：定期审查 `.gitignore` 与 `.dockerignore`，确保所有敏感文件（如 `.env`、`.pem`）均被排除。  
4. **兼容性**：如果团队使用的 Git 版本低于 2.13，`**/` 前缀的通配符可能不被支持，建议在 README 中注明最低 Git 版本要求或提供回退规则。  
5. **文档同步**：保持项目文档（如 CONTRIBUTING.md）中关于忽略文件的说明与实际 `.gitignore` / `.dockerignore` 内容一致，避免新贡献者产生混淆。  

### 3271e0e76d0e2cb3a43f654179b8af931571741c
https://github.com/sgl-project/sglang/commit/3271e0e76d0e2cb3a43f654179b8af931571741c
Remove dllm-test-1-gpu-amd job (followup to DLLM migration) (#16589)
**🎯 变更类型**：配置 / CI 工作流调整  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：在 `pr-test-amd.yml` 中删除了 `dllm-test-1-gpu-amd` Job，作为 DLLM 迁移的后续工作。此举会让该 CI 步骤不再执行 DLLM（LLaDA2）在 AMD GPU 环境下的测试，从而缩短 PR 检查时长并节约 GPU 资源。  

**🎯 影响范围**：  
- `.github/workflows/pr-test-amd.yml`（AMD GPU CI 流程）  
- 依赖该工作流的 Pull Request 自动化检查  

**🔍 技术洞察**  
- **架构影响**：仅限 CI 配置层面，不影响项目运行时代码或模块依赖。  
- **性能影响**：CI 运行时间约减少 5‑10 分钟（取决于对应 GPU 节点的排队情况），资源占用（GPU、CI 并发）相应下降。  
- **安全考虑**：无直接安全影响；删除的步骤不涉及凭证或网络访问。  

**⚠️ 潜在风险**  
1. **测试覆盖缺失**：DLLM（LLaDA2）在 AMD GPU 上的回归测试不再自动执行，可能导致代码改动引入的性能或功能回归未被及时捕获。  
2. **迁移误判**：如果 DLLM 已经迁移到其他 CI Job 或平台，但迁移不完整，删除此 Job 可能导致遗漏关键验证。  
3. **文档/沟通不一致**：团队成员若仍假设该 Job 存在，可能在本地调试或 CI 调度时产生困惑。  

**💡 关注建议**  
- **确认迁移完成**：确保所有 DLLM 相关测试已迁移到其他 Job（如新的 GPU/CPU 测试或专门的 DLLM CI 流程），并在 CI 状态页或文档中明确标注。  
- **补充覆盖**：若暂未有替代测试，建议新增对应的测试到现有的 AMD GPU 流程或在 CPU/通用平台上加入相同逻辑的验证。  
- **监控回归**：在接下来几轮 PR 合并后，关注模型相关功能（尤其 LLaDA2）是否出现异常，可通过手动跑一次完整的 DLLM 测试确认。  
- **更新文档**：在项目的 CI 说明或贡献指南中记录此 Job 的移除原因和后续的测试位置，避免新贡献者误解。  

总体来说，此次变更属于低风险的 CI 配置清理，关键在于确认 DLLM 测试已在其他路径得到充分覆盖后再正式删除。若确认迁移完成，可视为对 CI 效率的正面优化。  

### d415d22daa370104eb064570b6345dc5c2b71d5f
https://github.com/sgl-project/sglang/commit/d415d22daa370104eb064570b6345dc5c2b71d5f
refactor(e2e): remove old embedding tests migrated to e2e_test/embeddings (#16592)
**🎯 变更类型**：重构 / 测试  
**⚡ 重要程度**：🟢 低  
**📋 变更摘要**：此次提交删除了 `sgl-model-gateway/e2e_test` 目录下的三个旧的 Embedding 端到端（E2E）测试文件，包括 gRPC、HTTP 以及完整的嵌入正确性对比测试。目的在于清理已迁移至 `e2e_test/embeddings` 新位置的测试代码，避免重复运行、加速 CI 并保持测试目录结构的统一。  
**🎯 影响范围**：  
- `sgl-model-gateway/e2e_test/e2e_grpc/basic/test_embedding_correctness.py`  
- `sgl-model-gateway/e2e_test/e2e_grpc/basic/test_embedding_server.py`  
- `sgl-model-gateway/e2e_test/e2e_http/test_e2e_embeddings.py`  

**🔍 技术洞察**  
- **架构影响**：无。仅删除了测试文件，不涉及业务代码或服务组件的接口、协议或部署方式。  
- **性能影响**：删除约 435 行冗余测试后，CI 测试执行时间将相应缩短，尤其是在 GPU 受限的 CI 环境中，避免了不必要的 worker 启停和模型加载。  
- **安全考虑**：无。删除的测试代码不包含任何安全敏感逻辑，也不会导致新的安全风险。  

**⚠️ 潜在风险**  
1. **覆盖率回退**：如果迁移到新位置的测试未能完整覆盖原有的语义相似性、相关性评分、批量嵌入维度等检查，可能导致回归缺失。  
2. **误删风险**：若这些文件中仍有未迁移或未同步到新测试套件的特殊场景（例如特定的异常路径、错误处理），删除后可能失去对应的验证。  

**💡 关注建议**  
- **验证迁移完整性**：在 CI 中确保 `e2e_test/embeddings` 目录下的测试覆盖了原始测试的全部功能点（相似度、批量、维度一致性、错误码等）。可通过代码覆盖率报告或手动比对测试用例列表确认。  
- **回归测试**：在下一个发布周期前，执行一次完整的端到端验证（包括手动或脚本调用）以确认嵌入服务在 gRPC 与 HTTP 两条路径上仍然行为一致。  
- **文档同步**：更新项目的测试文档或 CONTRIBUTING 指南，说明已迁移的测试位于 `e2e_test/embeddings`，避免新贡献者误以为旧路径仍然有效。  
- **监控 CI 时长**：观察删除后 CI 的执行时间是否如预期下降，若仍有显著耗时，进一步检查是否还有其他冗余或重复的测试用例。  

**结论**：此提交属于低风险的代码清理工作，主要提升 CI 效率。唯一需要关注的是确保新位置的测试已完整覆盖原有功能，以防止意外的回归缺失。建议在合并前通过覆盖率对比和功能验证确保迁移的完整性。

### 53497642985aa1184cfa63378612b6db10599782
https://github.com/sgl-project/sglang/commit/53497642985aa1184cfa63378612b6db10599782
fix: kimi k2 thinking accuracy threshold change (#16585)
**🎯 变更类型**：测试 / Bug修复  
**⚡ 重要程度**：🟢 低  
**📋 变更摘要**：将 `Kimi‑K2‑Thinking` 模型在 GSM8K 数据集上的基准准确率阈值从 **0.95** 降低至 **0.94**。此修改旨在匹配模型当前实际表现，避免因阈值设置过高导致测试失败。  

**🎯 影响范围**：  
- `test/registered/8-gpu-models/test_kimi_k2.py`（唯一受影响的测试文件）  
- CI/CD 流水线中依赖该测试的 **模型评估** 阶段  

**🔍 技术洞察**：  
- **架构影响**：无。仅更改了测试用例的阈值配置，不涉及业务代码、模块依赖或设计模式。  
- **性能影响**：无。该改动不影响运行时代码的时间或空间复杂度。  
- **安全考虑**：无。阈值数值的调整不涉及安全逻辑或数据处理。  

**⚠️ 潜在风险**：  
- **误报风险**：阈值下降可能掩盖模型实际退化的情况，导致后续对模型质量的判断过于宽松。  
- **CI 可信度**：若其他测试依赖统一的基准阈值策略，此改动可能导致阈值不一致，需要在文档或配置中心统一说明。  

**💡 关注建议**：  
1. **回归验证**：在本地或预发布环境运行完整的模型评估套件，确认所有相关模型仍满足各自的业务要求。  
2. **文档更新**：在模型基准文档或测试规范中记录此阈值调整的原因与新基准值，以防团队成员误用旧阈值。  
3. **监控告警**：若 CI 中已有基准阈值的监控告警，考虑同步更新阈值规则，防止误触发。  
4. **定期复审**：建议在下一次模型升级或性能回顾时重新评估该阈值，确保仍与实际表现相匹配。

### d57d8e7e5f21c49b195775a90e44aaa1904a7674
https://github.com/sgl-project/sglang/commit/d57d8e7e5f21c49b195775a90e44aaa1904a7674
[smg] clean up logs in mcp (should be info instead warn) (#16591)
**🎯 变更类型**：日志清理 / 代码改进  
**⚡ 重要程度**：🟢低  
**📋 变更摘要**：将 `McpManager` 在没有连接到任何静态 MCP 服务器时的日志等级从 `warn!` 调整为 `info!`，意在降低不必要的警告噪音，提升日志可读性。此改动仅影响日志输出，不改变业务逻辑。  

**🎯 影响范围**：  
- `sgl-model-gateway/src/mcp/manager.rs`（`McpManager` 初始化路径）  

**🔍 技术洞察**：  
- **架构影响**：无。仅修改局部日志语句，不触及模块接口或依赖关系。  
- **性能影响**：无。日志等级切换对运行时性能影响微乎其微。  
- **安全考虑**：无。此改动不涉及安全控制或敏感信息泄露。  

**⚠️ 潜在风险**：  
- 监控或运维系统可能基于 `warn` 级别的日志触发告警，如仍期望在“未连接任何静态 MCP 服务器”时收到警报，改为 `info` 可能导致告警缺失。  
- 开发者或运维人员在排查问题时可能错过该信息的显著性，需要确认日志审计策略。  

**💡 关注建议**：  
- 检查已有的日志监控/告警规则，确认是否对 `warn` 级别的 “No static MCP servers connected” 消息有依赖，若有请相应调整阈值或规则。  
- 在升级或部署后，可通过一次性运行集成测试验证 `McpManager` 的行为未受影响（尤其是返回值和错误路径）。  
- 如团队希望保留对该情况的显著提醒，可考虑在 `info!` 消息中加入特定标记（如 `[MCP-INFO]`），便于后续过滤或搜索。  

### 0cbd8f3247b94fadfd9c6ba6861fcbb9dd4b47c6
https://github.com/sgl-project/sglang/commit/0cbd8f3247b94fadfd9c6ba6861fcbb9dd4b47c6
ci(test): migrate OpenAI server tests to registered CI system (#16326)

Co-authored-by: Kangyan-Zhou <zky314343421@gmail.com>
**🎯 变更类型**：配置 / 测试 / 代码组织  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：  
1. 将 OpenAI Server 相关的单元测试迁移到统一的 CI 注册机制，新增 `register_cuda_ci`、`register_amd_ci` 调用并删除旧的 `__init__.py` 包结构。  
2. 更新 `run_suite.py`，从默认测试套件中移除这些 OpenAI Server 测试，使其仅在注册的 CI 环境中运行。  
3. 在 `pynccl_allocator.py` 中把 `torch.utils.cpp_extension` 的导入延迟到实际使用时，避免在模块加载阶段不必要的依赖。  

**🎯 影响范围**：  
- `python/sglang/srt/distributed/device_communicators/pynccl_allocator.py`  
- 所有 `test/registered/openai_server/**` 下的测试文件（基本、特性、函数调用、验证等）  
- `test/srt/run_suite.py`  
- 删除的 `test/srt/openai_server/**/__init__.py` 包文件  

**🔍 技术洞察**：

- **架构影响**：  
  - 仅涉及测试层面的组织变更，不影响生产代码的模块依赖或运行时架构。  
  - 通过显式的 CI 注册函数，将测试与 CI 配置解耦，提升了多平台（CUDA/AMD）测试的可维护性。

- **性能影响**：  
  - `pynccl_allocator.py` 的延迟导入可略微降低模块首次加载的时间和内存占用，特别是在不需要 NCCL allocator 的环境下。  
  - 对测试执行本身的性能影响几乎为零，唯一可能的开销是增加的注册函数调用（微秒级）。

- **安全考虑**：  
  - 无生产代码逻辑变更，未引入新的安全风险。  
  - 删除的 `__init__.py` 文件仅涉及测试包路径，若 CI 环境仍依赖旧路径可能导致 ImportError，需确保 CI 配置同步更新。

**⚠️ 潜在风险**：

1. **测试遗漏**：`run_suite.py` 已移除这些测试的显式列举，若 CI 注册未能成功（例如 `register_*` 函数异常），相应测试将被完全跳过，导致回归风险未被捕获。  
2. **平台兼容性**：部分测试在 AMD 平台被标记为 `disabled`（如隐藏状态测试），但仍会在 CI 注册列表中出现，可能导致 CI 误报或非预期的失败。  
3. **导入顺序**：`pynccl_allocator.py` 现在在函数内部才导入 `torch.utils.cpp_extension`，如果某些代码在模块加载前已经期待该导入成功（例如在模块级别使用相关函数），可能触发运行时异常。  

**💡 关注建议**：

- **CI 验证**：在提交 CI 运行后，确认所有 `register_*` 调用均已成功注册并执行相应测试；可在 CI 日志中加入打印或统计注册数量的语句。  
- **回退路径**：保留旧的 `run_suite` 配置（如通过分支或注释）作为紧急回滚手段，以防 CI 注册失效导致测试全失。  
- **文档更新**：在项目的测试文档或 CONTRIBUTING 指南中说明新的 CI 注册方式，提醒贡献者在新增或修改 OpenAI Server 相关测试时同步更新 `register_*` 调用。  
- **兼容性检测**：在本地或 CI 环境中分别跑一次完整的测试套件（包括已移除的列表），确保没有因路径更改导致的 ImportError。  
- **延迟导入审查**：确认 `pynccl_allocator.py` 中所有使用 `torch.utils.cpp_extension` 的入口都在函数体内部，以免出现未定义引用。  

总体来看，此次提交的主要价值在于统一测试管理并提升 CI 可维护性，风险主要集中在 CI 注册机制的可靠性和旧路径的残留，需要在 CI 环境和文档上做好配套工作。

### 6e3fff13521df33de34597c025ae6f7d9740cdd6
https://github.com/sgl-project/sglang/commit/6e3fff13521df33de34597c025ae6f7d9740cdd6
fix: adding retries for server start and increasing hf read timeout (#16523)
**🎯 变更类型**：配置  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：在 Nightly‑Test‑NVIDIA CI 工作流中新增 `HF_HUB_DOWNLOAD_TIMEOUT` 与 `HF_HUB_ETAG_TIMEOUT` 环境变量，均设为 300 秒，以提升对 HuggingFace Hub 下载的容错能力并配合服务器启动的重试机制。预计能减少因网络波动导致的 CI 失败。  
**🎯 影响范围**：`.github/workflows/nightly-test-nvidia.yml`（CI 流程）；所有依赖 HuggingFace Hub 进行模型或数据下载的测试用例。  

**🔍 技术洞察**：  
- **架构影响**：无结构性改动，仅在 CI 环境层面设置超时阈值，对业务代码或服务架构无直接影响。  
- **性能影响**：超时时间延长至 300 s，单次下载阻塞时间可能增长；但通过配合服务器启动重试，整体 CI 成功率预计提升，整体耗时略有上升。  
- **安全考虑**：不涉及安全功能；仅是环境变量的超时配置，风险极低。  

**⚠️ 潜在风险**：  
1. CI 运行时间可能显著增加，导致资源占用成本上升。  
2. 若网络问题根源未解决，超时设置过大可能掩盖真实的连接故障，使调试变得困难。  
3. 其他未显式使用这些变量的脚本仍会采用默认（可能更短）的超时，导致行为不一致。  

**💡 关注建议**：  
- 在 CI 监控中加入单次下载耗时统计，评估是否出现异常长时延。  
- 如项目中有本地开发或其他 CI 环境（如 CPU 测试），同步更新相同的超时配置，保持一致性。  
- 在文档或 CI 注释中说明新增环境变量的目的和取值依据，便于后续维护。  
- 若发现 CI 总耗时显著增长，可考虑在关键下载前加入重试逻辑，而非单纯延长超时。  

### 2210155a45105c6a08ca04f7efcd77f547c8c1e0
https://github.com/sgl-project/sglang/commit/2210155a45105c6a08ca04f7efcd77f547c8c1e0
ci: migrate DLLM tests to test/registered/dllm/ (#16420)
**🎯 变更类型**：测试 / 配置  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
- 将 DLLM（Diffusion Language Model）相关的 CI 测试文件迁移至 `test/registered/dllm/` 目录，并在文件头部添加 CI 注册装饰器，以便在 CI 流水线中自动识别和调度。  
- 同时在 `test/srt/run_suite.py` 中移除对旧路径测试文件的显式引用，避免重复执行。

**🎯 影响范围**  
- `test/registered/dllm/`（新增/改动）  
- `test/srt/run_suite.py`（CI 测试套件配置）  

**🔍 技术洞察**  
- **架构影响**：无业务代码改动，仅影响测试框架的组织方式。采用统一的 `ci_register` 注册方式后，测试模块之间的耦合度降低，后续新增/迁移测试更易维护。  
- **性能影响**：不涉及运行时代码，仅影响 CI 运行时的调度。注册信息中 `est_time=520` 与原始预估保持一致，预计对 CI 时长无显著变化。  
- **安全考虑**：无安全相关改动或风险。  

**⚠️ 潜在风险**  
1. **CI 失效风险**：如果 `ci_register` 装饰器或其加载机制出现异常，新迁移的测试可能不会被加入 CI 运行列表，导致回归覆盖下降。  
2. **路径漏写**：`run_suite.py` 中已手动删除旧路径引用，若后续有人误将新文件再加入旧列表，可能导致同一测试被执行两次，耗时翻倍。  
3. **AMD 与 CUDA 注册分离**：新增 `register_amd_ci` 与 `register_cuda_ci`，需确保对应的 CI 环境变量或标签正确配置，否则对应平台的测试可能被遗漏。  

**💡 关注建议**  
- **CI 验证**：在提交合并后，立即在 CI 环境（CUDA 与 AMD）运行一次完整的 `stage-b-test-small-1-gpu` 套件，确认新注册的测试被正确调度。  
- **文档同步**：更新项目的测试目录结构文档（如 `CONTRIBUTING.md` 或内部测试手册），说明迁移原因以及新增的注册方式。  
- **回归检查**：在后续合并涉及 `run_suite.py` 的 PR 时，审查是否误删或误添加 DLLM 测试路径，防止测试覆盖缺失。  
- **持续监控**：监控 CI 运行时的测试时长统计，确保 `est_time=520` 的预估仍然合理，若出现显著偏差，及时调整。  

### a3656cbb96968fb7df291e8a26c865f460059eac
https://github.com/sgl-project/sglang/commit/a3656cbb96968fb7df291e8a26c865f460059eac
[ci] fix url strips in smg ci (#16548)

Co-authored-by: Chang Su <chang.s.su@oracle.com>
**🎯 变更类型**：Bug修复  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：本次提交修正了 CI 环境中 URL 处理不当导致的测试失败。主要做了三件事：① 将 `model_pool` 中日志输出的 URL 从 `base_url` 改为 `worker_url`；② 在 `run_eval.py` 中统一去除 `base_url` 的尾部斜杠；③ 删除了测试代码中对 `client.base_url` 手动裁剪 “/v1” 的逻辑，直接使用完整的 URL。目的在于消除因 URL 多余或缺失斜杠导致的健康检查与评估脚本误判。  

**🎯 影响范围**：  
- `sgl-model-gateway/e2e_test/infra/model_pool.py`  
- `sgl-model-gateway/e2e_test/infra/run_eval.py`  
- `sgl-model-gateway/e2e_test/router/test_mmlu.py`  
- `sgl-model-gateway/e2e_test/router/test_pd_mmlu.py`  

**🔍 技术洞察**：  
- **架构影响**：仅涉及测试基础设施和路由层的 CI 脚本，未触及生产代码或核心业务逻辑，架构上无连锁影响。  
- **性能影响**：`rstrip("/")` 的字符串操作开销极低，对测试执行时间无实质影响。  
- **安全考虑**：无安全相关改动，亦未引入新的安全风险。  

**⚠️ 潜在风险**：  
- 若业务代码中仍假设 `client.base_url` 不含尾部斜杠，而测试用例直接使用该 URL，可能在某些自定义环境下出现路径拼接错误。  
- 修改日志输出字段（从 `base_url` 到 `worker_url`）后，若有外部监控或日志聚合规则依赖旧字段，可能导致日志可视化失效。  

**💡 关注建议**：  
1. **回归测试**：在本地或独立 CI 环境中运行完整的 e2e 测试套件，确保去除斜杠后仍能正确访问所有 `/v1` 接口。  
2. **日志兼容**：检查是否有监控/告警系统依赖 `model_pool` 中的 `base_url` 字段，如有需同步更新相应的解析规则。  
3. **文档同步**：在项目文档或 README 中注明 `run_eval` 脚本现在会自动去除尾部斜杠，避免用户手动处理导致的混淆。  
4. **未来扩展**：若计划在非 CI 环境复用这些测试工具，建议将 URL 规范化的逻辑抽象为统一的函数，以免出现类似重复修复的情况。  

