# 每日更新报告（2026-01-14）

## ai-dynamo/dynamo

| 提交时间 | 作者 | 提交信息 |
|----------|------|----------|
| 2026-01-14 23:32:52 | dagil-nvidia | fix: ignore torchao SyntaxWarning in pytest filterwarnings (#5429) |
| 2026-01-14 17:23:11 | GuanLuo | refactor: vllm EPD refactor (#4994) |
| 2026-01-14 13:30:40 | Tzu-Ling Kan | fix: mypy error (#5426) |
| 2026-01-14 12:52:50 | Keiven C | refactor: remove "dev" stage from Dockerfile.* and centralize them into Dockerfile.dev (#5050) |
| 2026-01-14 11:27:34 | Neal Vaidya | fix: read store_kv arg from env when using decorator (#5421) |
| 2026-01-14 07:28:47 | jthomson04 | fix: Install numactl in TRTLLM container (#5367) |
| 2026-01-14 07:16:37 | Dmitry Tokarev | chore: Bump CUDA to 12.9.1 for vllm container (#5397) |
| 2026-01-14 06:24:28 | Tushar Sharma | chore: use python apt for frontend container instead of uv (#5403) |
| 2026-01-14 06:23:16 | Rohan Varma | fix: Update TRT-LLM Wide-EP Disagg GB200 Recipe to be compatible with TRT-LLM Version (#5383) |
| 2026-01-14 06:18:07 | jthomson04 | chore: Revert KVBM v2 transfer integration (#5406) |
| 2026-01-14 06:15:23 | dagil-nvidia | docs: README updates for 0.8.0 (#5395) |
| 2026-01-14 05:58:36 | Biswa Panda | fix: use zero copy decoder for handling high concurrency / request bursts for tcp ingress (#5376) |
| 2026-01-14 05:42:05 | atchernych | fix: Bug 5792966 [DYN -1729] (#5385) |
| 2026-01-14 05:22:07 | Qi Wang | fix: test_consolidator_router_e2e trtllm import failure (#5404) |
| 2026-01-14 03:56:34 | Tushar Sharma | build: disable cache export for frontend build in ci (#5365) |
| 2026-01-14 03:48:04 | Keiven C | fix: Move NATS max_payload from invalid CLI flag to config file (#5384) |
| 2026-01-14 03:14:50 | dagil-nvidia | docs: add feature compatibility matrix and update support matrix for v0.8.0 (#5349) |
| 2026-01-14 03:03:58 | Graham King | feat(model_card): Make bos_token_id optional (#5394) |
| 2026-01-14 02:34:30 | jh-nv | feat: Propagate OTEL tracing context for trtllm (#5377) |
| 2026-01-14 02:24:17 | Biswa Panda | feat: add examples for kv state approximation based routing (#5320) |
| 2026-01-14 02:10:47 | Ayush Agarwal | chore: configure nemotron nano parsers (#5396) |
| 2026-01-14 01:34:21 | Elias Bermudez | chore: Update aiperf pinned version (#5331) |
| 2026-01-14 01:06:17 | Qi Wang | test: unit test tcp/client.rs handle_writer [1/n] (#5055) |
| 2026-01-14 00:59:17 | Ran Rubin | ci: remove deprecated  parameters (#5390) |

### 📊 统计摘要
> 本日共 24 个提交 | 🔴高 7 | 🟡中 9 | 🟢低 8
## 📋 目录

- [ai-dynamo/dynamo](#ai-dynamo-dynamo)
  - [📊 统计摘要](#-统计摘要)
  - [🔴 高重要度变更 (7)](#-🔴-高重要度变更-7)
    - [refactor: vllm EPD refactor (#4994)](#334cbd9)
    - [refactor: remove "dev" stage from Dockerfile.* and centra...](#4816d63)
    - [fix: use zero copy decoder for handling high concurrency ...](#bbb79af)
    - [fix: Bug 5792966 [DYN -1729] (#5385)](#1da603a)
    - [feat(model_card): Make bos_token_id optional (#5394)](#dad42f4)
    - [feat: Propagate OTEL tracing context for trtllm (#5377)](#8c129ed)
    - [feat: add examples for kv state approximation based routi...](#869562d)
  - [🟡 中重要度变更 (9)](#-🟡-中重要度变更-9)
    - [fix: ignore torchao SyntaxWarning in pytest filterwarning...](#6fe8855)
    - [fix: mypy error (#5426)](#6f68be4)
    - [fix: read store_kv arg from env when using decorator (#5421)](#a936ba5)
    - [fix: Install numactl in TRTLLM container (#5367)](#2430fca)
    - [fix: Update TRT-LLM Wide-EP Disagg GB200 Recipe to be com...](#a98406d)
    - [chore: Revert KVBM v2 transfer integration (#5406)](#9ca2923)
    - [fix: test_consolidator_router_e2e trtllm import failure (...](#4be72b6)
    - [fix: Move NATS max_payload from invalid CLI flag to confi...](#a713270)
    - [test: unit test tcp/client.rs handle_writer [1/n] (#5055)](#e47457e)
  - [🟢 低重要度变更 (8)](#-🟢-低重要度变更-8)
    - [chore: Bump CUDA to 12.9.1 for vllm container (#5397)](#58a061f)
    - [chore: use python apt for frontend container instead of u...](#af6eea0)
    - [docs: README updates for 0.8.0 (#5395)](#91a8d07)
    - [build: disable cache export for frontend build in ci (#5365)](#dfc0377)
    - [docs: add feature compatibility matrix and update support...](#4ed8584)
    - [chore: configure nemotron nano parsers (#5396)](#648e1cd)
    - [chore: Update aiperf pinned version (#5331)](#c3dc3de)
    - [ci: remove deprecated  parameters (#5390)](#a170b31)
#### 🔴 高重要度变更 (7)

### refactor: vllm EPD refactor (#4994)
**SHA**: `334cbd9` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/334cbd9b82c8da0887e973c3e3bf87ed57f128b3)

**🎯 变更类型**：重构 / 功能增强  
**⚡ 重要程度**：🔴高  

**📋 变更摘要**  
此 commit 对 vLLM 多模态流水线进行了大幅重构：  
1. 将原来的 `ProcessorHandler` 替换为全新的 `PreprocessedHandler`，负责在前端完成请求的预处理、调用编码worker、组装并转发至 PD（prefill‑decode）worker。  
2. Encode worker 现在支持本地 **safetensors** 缓存（`TRANSFER_LOCAL`），并在每次编码后记录累计耗时与请求计数，用于性能监控。  
3. PD worker 代码同步改造以接收多条 `multimodal_inputs`，在 ECConnector consumer 模式下直接加载本地/远程 embeddings，并对多图的合并逻辑做了初步实现。  
4. 新增 `get_embedding_hash`、`MultiModalGroup`、`PatchedTokensPrompt` 等公共模型，扩展支持的模型列表（加入 Qwen2.5‑VL‑3B）。  
5. 示例脚本去除对 `--prompt-template` 的硬编码，改为统一使用模型自带的模板。  
6. 单元测试预期结果相应更新（从 “purple” 改为 “green”），验证了新模板的行为。

**🎯 影响范围**  
- `components/src/dynamo/vllm` 整体（`main.py`、`multimodal_handlers/*`、`multimodal_utils/*`）  
- Encode、Prefill/Decode（PD）worker 的交互协议（`vLLMNativeEncoderRequest`、`vLLMGenerateRequest`）  
- 示例启动脚本 (`examples/backends/vllm/launch/*.sh`)  
- 单元测试 `tests/serve/test_vllm.py`  

---

## 🔍 技术洞察  

| 维度 | 影响/改动 |
|------|-----------|
| **架构影响** | - **职责分离**：`PreprocessedHandler` 从原 `ProcessorHandler` 中抽离，仅负责 **前置处理 → 编码 → 组装**，使得编码与解码路径更加清晰。<br>- **请求结构演进**：`vLLMGenerateRequest` → `vLLMGenerateRequest.multimodal_inputs: List[MultiModalGroup]`，替代单一 `multimodal_input`，为后续多图/多模态扩展奠定基础。<br>- **本地缓存层**：引入 `safetensors` 本地持久化 (`/tmp/encoder_cache.{hash}.safetensors`) 并在 PD worker 读取，降低重复图片编码的网络开销。 |
| **性能影响** | - **正向**：首次编码仍需 GPU 推理，但后续相同图片可直接复用本地文件，显著降低 CPU‑GPU 交互与网络传输时延；累计编码耗时记录便于观察瓶颈。<br>- **负向**：写入 / 读取 `safetensors` 文件会产生 I/O，尤其在高并发情况下可能成为新瓶颈；`TRANSFER_LOCAL=0`（走 NIXL）仍保留原路径，兼容集群网络。 |
| **安全考虑** | - **safetensors** 本身是安全的二进制格式（防止任意代码执行），但**文件泄露**风险随之增加。缓存文件位于 `/tmp`，若未主动清理可能被其它进程读取。<br>- **环境变量 `TRANSFER_LOCAL`** 若被恶意设置为 `0`，系统将回落到基于 RDMA 的直接内存传输，可能暴露未加密的 embeddings。建议在生产环境显式配置且做好访问控制。 |
| **可维护性** | - 新增 `PreprocessedHandler`、`MultiModalGroup`、`PatchedTokensPrompt`，代码量增加 ~300 行，但模块化程度提升。<br>- 逐步淘汰 `ProcessorHandler`，旧引用已在 `__init__` 中改名，兼容性仍保持（旧类未删除），迁移成本低。<br>- `examples/*.sh` 去除 prompt‑template 参数，可减少用户误用，但文档需同步更新。 |
| **兼容性** | - 新的请求字段 `multimodal_inputs` 与旧的单一 `multimodal_input` 不兼容；但所有内部调用已同步更新，外部 SDK 仍使用 `--multimodal-processor` 入口，兼容性基本保持。<br>- 依赖 `safetensors` 新增到 `requirements`，老环境若未安装会导致运行时 ImportError。 |
| **测试** | - 单元测试预期从 “purple” 改为 “green”，说明 **prompt‑template** 已默认采用模型自带的模板，验证了新模板路径。 |


### 关键实现细节  

1. **EncodeWorkerHandler**  
   - 新增 `cached_embeddings`（URL → (hash, grid, shape)）以及 `readables` 列表。<br>
   - 对每个 `multimodal_input` 循环处理，支持 **批量**（当前固定 `ENCODE_BATCH_SIZE=1`），若本地缓存命中直接返回 `serialized_request = "/tmp/encoder_cache.{hash}.safetensors"` 并把 `image_url` 置 `None`。<br>
   - `TRANSFER_LOCAL` 环境变量控制是否写入本地文件或走 NIXL connector。<br>
   - 记录 `_accumulated_time`、`_processed_requests` 并在每次完成后打印平均耗时。  

2. **PreprocessedHandler**  
   - `generate` 首先通过 `_extract_multimodal_data` 解析 `request["multi_modal_data"]`（仅支持 image URL）。<br>
   - 组装 `vLLMMultimodalRequest` 发往 **encode worker**，随后收集返回的 `multimodal_inputs`（已携带 `serialized_request`、`image_grid_thw`、`embeddings_shape`），再转发给 PD worker。<br>
   - `_generate_responses` 负责把 PD worker 的 `RequestOutput` 转换为 Dynamo 所期待的 JSON 结构。  

3. **MultimodalDecodeWorkerHandler**  
   - 改为遍历 `request.multimodal_inputs`，对每个输入判断是 **ECConnector consumer**（直接加载图片）还是 **网络传输**（读取 `safetensors` 或 RDMA descriptor）。<br>
   - 合并多图 embeddings（`torch.cat`），并在 `TRANSFER_LOCAL=1` 时使用 `safetensors.torch.load_file` 读取本地缓存。<br>
   - 完整 `multi_modal_data` 通过 `construct_mm_data` 交给 vLLM 引擎。  

4. **多模型支持**  
   - `SupportedModels` 新增 `QWEN_2_5_VL_3B` 并在 `QWEN_VL_MODELS` 列表里加入，保持模型自动检测。  

5. **脚本与测试**  
   - 示例脚本不再要求用户手动提供模板，统一使用模型默认的 multimodal‑prompt；`--prompt-template` 参数已删除。<br>
   - 单元测试期望值更新为 “green”，对应新模板的输出。  

---

## ⚠️ 

---

### refactor: remove "dev" stage from Dockerfile.* and centralize them into Dockerfile.dev (#5050)
**SHA**: `4816d63` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/4816d6394c357dea25763d848026e29d35b9aaec)

**🎯 变更类型**：重构 / 架构变更  
**⚡ 重要程度**：🔴高  
**📋 变更摘要**：  
1. 将原先分散在 `container/Dockerfile` 中的 **dev** 与 **local‑dev** 阶段抽离，统一到新文件 `container/dev/Dockerfile.dev`，并在 `build.sh` 中自动生成 **临时拼接 Dockerfile**（框架 Dockerfile + dev Dockerfile）。  
2. 新增 `dynamo_tools` 阶段专门安装开发工具，复制到 `dev` 镜像，以提升缓存命中和构建速度。  
3. 删除 `Dockerfile.local_dev`，所有本地开发镜像均通过 `dev → local‑dev` 两层实现 UID/GID 重映射。  
4. 调整 CI 工作流、GitHub filters、README 与标签策略，使 `dev`、`local‑dev` 镜像分别使用 `‑dev` 与 `‑local-dev` 后缀。  
5. 细化文件权限 (非递归 `chown`、统一 `umask 002`)、统一 Python/venv 创建逻辑、加入框架‑特定环境脚本 `50‑framework‑paths.sh`。  

---

### 🎯 影响范围
- **Docker 构建系统**：`container/build.sh`、`container/Dockerfile*`（所有框架 Dockerfile）、`.github/workflows/container-validation-dynamo.yml`、`.github/filters.yaml`。  
- **CI/CD Pipelines**：镜像标签、构建目标 (`dev` / `local-dev`) 变更。  
- **文档**：`container/README.md`。  
- **开发者工作流**：`run.sh --mount-workspace` 仍为推荐方式，`dev` 与 `local-dev` 镜像的入口与权限行为有细微差异。  

---

## 🔍 技术洞察

| 维度 | 影响描述 |
|------|----------|
| **架构影响** | - **模块化**：`dynamo_tools` 成为独立层，复用在 `dev` 与 `local-dev` 两个目标，显著提升层缓存命中率（工具层约 300 MB，后续改动只需重新构建上层）。<br>- **构建流程**：通过 `build.sh` 动态拼接 Dockerfile，避免在源码库中维护多个完整 Dockerfile，降低维护成本。<br>- **镜像层次**：原来 `Dockerfile` 同时包含 `runtime → dev → local-dev`；现在形成 `runtime → dynamo_tools → dev → local-dev`，使 **runtime 镜像** 不再携带开发工具，减小生产镜像体积（约 30‑40 %）。 |
| **性能影响** | - **构建时间**：工具层一次构建后被缓存，后续 `dev` / `local-dev` 构建仅进行文件拷贝与轻量配置，预计 **构建时间从 12 min ↓至 6‑8 min**（取决于框架）。<br>- **运行时启动**：`dev` 镜像仍基于 `runtime`，额外层仅添加 `PATH`、`LD_LIBRARY_PATH`、`umask` 等轻量变量，启动开销可忽略。<br>- **文件系统**：使用 `COPY --chmod` + 非递归 `chown`，减少大量 `chmod -R` 开销，容器内文件创建默认采用 `umask 002`，提升并行编译/写入速度。 |
| **安全考虑** | - **最小化生产镜像**：`runtime` 镜像不再包含 `sudo`、`git`、`gcc`、`clang` 等编译工具，降低攻击面。<br>- **本地开发镜像**：仍内置 `sudo`（仅在 `local-dev`），但仅授予 `dynamo ALL=(root) NOPASSWD:ALL`，且 UID/GID 与宿主匹配，防止意外提权到宿主系统。<br>- **APT 源安全**：`dynamo_tools` 阶段显式禁用 NVIDIA CUDA apt repo，避免因 repo 同步不一致导致的构建失败。<br>- **凭证泄漏**：`build.sh` 中仍使用 `--secret` 方式注入 AWS/EFA 密钥，未受本次改动影响。 |
| **可维护性** | - **单源真相**：所有开发工具、路径、环境变量集中在 `Dockerfile.dev` 与 `50-framework-paths.sh`，修改时仅需更新这两处。<br>- **脚本化构建**：`build.sh` 自动生成临时 Dockerfile，避免手动拼接出错；`KEEP_DEV_DOCKERFILE_TEMP=1` 方便调试。<br>- **文档同步**：README 已同步展示新的阶段关系与使用建议，降低新手误解风险。 |
| **兼容性** | - **镜像标签**：`dynamo:latest-<framework>-dev`、`…-local-dev` 替代原来的 `dynamo:latest-<framework>`（runtime）和 `…-dev`（旧的 dev）。<br>- **旧 CI**：已更新 GitHub Action 中的 `image_tag`（从 `latest` 变为 `latest-dev`），但仍保持 `latest` 别名指向 runtime 镜像，兼容已有部署脚本。<br>- **本地运行**：`run.sh` 仍默认使用 `runtime`；若使用 `--target dev` 或 `--target local-dev`，需显式指定镜像标签。 |

---

## ⚠️ 潜在风险

1. **临时拼接 Dockerfile 失效**  
   - 若框架 Dockerfile 改动引入新 *ARG* 或 *stage* 名称（如 `runtime` 重命名）而未在 `dev/Dockerfile.dev` 中对应，构建会报错。建议在 CI 中加入 `dockerfile-lint` 检查两文件的层依赖一致性。

2. **UID/GID 映射错误**  
   - `local-dev` 使用 `CUSTOM_UID/GID`，默认取宿主当前用户。如果 CI 环境跑在非交互式用户（如 `root`），可能生成 `0/0`，导致容器内部文件全部属于 root，破坏挂载目录的权限。建议在 CI 明确传入 `CUSTOM_UID/GID` 或在脚本中检查 `id -u` !== 0。

3. **umask 与文件权限**  
   - `umask 002` 通过 `/etc/profile.d/00-umask.sh` 实现，仅对登录 shell 生效。若容器执行非登录命令（如 `docker exec <cmd>`），新文件可能仍使用默认 `022`，导致后续编辑出现权限冲突。可在关键入口（`run.sh`）加 `--login` 或在 `Dockerfile` 中强制 `SHELL ["/bin/bash","-c"]` 并 `umask 002`。

4. **SGLang Python 环境**  
   - `dev` 阶段为 `sglang` 创建了系统‑site‑packages venv 并复制 `/usr/local/lib/python3.12/dist-packages`，若上游镜像在后续升级 Python 版本或路径变化，复制路径可能失效。建议使用 `python3 -m site --user-base` 动态获取路径，或在后期对 `Dockerfile.dev` 加 `RUN [ -d ... ] || true` 防护。

5. **缓存失效导致层膨胀**  
   - `COPY --from=wheel_builder /workspace/.venv/bin/maturin /usr/local/bin/maturin` 若 `wheel_builder` 更新（例如 `uv` 升级），`dev` 层不可命中缓存，将重新复制整个 `wheel_builder` 内容（约 1 GB）。可以考虑在 `dev` 前加入 `ARG MATUREN_VERSION` 并在 `wheel_builder` 中固定版本，以减少不必要的层变动。

6. **CI Tag 逻辑变更**  
   - `container-validation-dynamo.yml` 将 `image

---

### fix: use zero copy decoder for handling high concurrency / request bursts for tcp ingress (#5376)
**SHA**: `bbb79af` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/bbb79afbfb6053d9bc03e514a0ba238a7881a8a7)

**🎯 变更类型**：功能增强 / 性能优化 / 架构变更  

**⚡ 重要程度**：🔴高  

**📋 变更摘要**  
1. 新增 `zero_copy_decoder` 模块，实现零拷贝 TCP 消息解码：在同一个可重用 `BytesMut` 缓冲区中完整读取报文，随后通过 `Bytes::split_to` 直接切出 `Arc<Bytes>`，避免在路径、头部、负载之间的复制。  
2. 为 `SharedTcpServer` 引入工作池（bounded worker pool）与工作队列，实现“读取‑解码‑入队‑ACK‑并发处理” 的流水线模型，默认并发 1500、队列 6000 条。  
3. 将原有的同步读取‑解码‑立即 ACK 逻辑替换为：**先把工作项发送至工作池**，成功入队后才发送空 ACK；入队失败时返回错误响应。  
4. 新增环境变量 `DYN_TCP_MAX_MESSAGE_SIZE、DYN_TCP_WORKER_POOL_SIZE、DYN_TCP_WORK_QUEUE_SIZE` 供运维调优。  

**🎯 影响范围**  
- `lib/runtime/src/pipeline/network/codec`（新增 zero‑copy 解码器与 `TcpRequestMessageZeroCopy`）  
- `lib/runtime/src/pipeline/network/ingress/shared_tcp_endpoint.rs`（工作池、队列、消息流控制）  
- 依赖该 TCP 入口的所有组件（推送工作处理 `PushWorkHandler` 实现、监控、测试）  

**🔍 技术洞察**  

- **架构影响**  
  - **解耦读取与业务处理**：原本的 `read_loop` 在同一协程中完成读取、解码、业务处理并同步回写 ACK；改为 “读取‑解码‑入队‑处理” 的生产者‑消费者模型，提升了模块化程度。  
  - **工作池调度层**：新增 `WorkItem` 结构体，携带 `Arc<dyn PushWorkHandler>`、`Bytes`、请求头等，使用 `tokio::sync::mpsc` 有界通道 + `Semaphore` 实现并发上限，避免因单一任务阻塞导致的全局吞吐下降。  
  - **可配置性提升**：通过环境变量动态调节最大报文、工作池大小、队列深度，适配不同部署场景（GPU 超算节点 vs 小型边缘实例）。  

- **性能影响**  
  - **零拷贝**：原始实现在构造 `BytesMut`、`TcpRequestMessage::decode` 时会产生多次内存复制（路径、头部、负载）。新实现一次性读取全部报文，随后 `split_to` 直接切片，复制次数降至 **0**（仅一次从 socket 到 `BytesMut`），大幅降低 CPU cache miss 与 GC（Arc）开销。  
  - **并发度**：工作池最大并发 1500（默认），对高并发突发（数千连接并发）场景可保持线性伸缩；受限于 `tokio` 运行时线程数与 CPU 核数，仍需要运维侧根据硬件适配。  
  - **背压控制**：有界通道 (`DEFAULT_WORK_QUEUE_SIZE = 6000`) 防止无限排队导致内存耗尽，且在队列已满时直接返回错误响应，避免进一步堆积。  

- **安全考虑**  
  - **报文大小校验**：在 `ZeroCopyTcpDecoder::read_message` 中对整体报文长度（包括头部）进行 `max_message_size` 检查，仍然防止 OOM。  
  - **路径长度校验**：`path_len` 被限制在 `0 < len <= 1024`，避免极端路径导致缓冲区溢出。  
  - **头部解析**：使用 `serde_json::from_slice` 解析用户提供的报文头，若 JSON 不合法会返回空 `HashMap`（`unwrap_or_default`），未显式限制头部字节数，潜在可被构造超大 JSON 进行内存消耗攻击。  
  - **TLS/加密**：本次改动未涉及传输层加密，仍依赖上层部署（如云负载均衡）保证机密性。  

**⚠️ 潜在风险**  

1. **队列积压导致内存激增**  
   - 每个 `WorkItem` 持有完整的 `Bytes`（可能高达 32 MiB），若业务处理慢而入队速率快，`DEFAULT_WORK_QUEUE_SIZE=6000` 仍可能占用数百 GB 内存。  

2. **头部 JSON 未设上限**  
   - 大量或恶意构造的 JSON 会在 `serde_json::from_slice` 中分配大量临时对象，导致 CPU 与内存压力。  

3. **退出阶段资源泄漏**  
   - `SharedTcpServer::start_worker_pool` 创建的 `semaphore` 与 `work_rx` 在 `cancellation_token` 被触发后会终止循环，但仍可能残留未完成的 `WorkItem`，造成 `inflight` 计数不为零，影响 `unregister_endpoint` 的等待逻辑。  

4. **读取阻塞**  
   - `ZeroCopyTcpDecoder::read_message` 采用 `while self.read_buffer.len() < needed { read_buf }` 循环，若客户端在报文中途停顿，会导致该协程长时间挂起，进而阻塞同一连接的后续请求（虽然不影响其它连接）。  

5. **兼容性**  
   - 旧的 `TcpRequestMessage` 解码路径仍在代码中保留（仅内部不再使用），若外部 crate 直接引用 `TcpRequestMessage`，可能出现未迁移的调用导致性能倒退或行为差异。  

**💡 关注建议**  

| 方向 | 建议 | 说明 |
|------|------|------|
| **内存 & 背压** | 为 `WorkItem` 添加 **payload 大小阈值**（如 `payload_len <= max_message_size - overhead`），在入队前再次检查，超出直接返回错误响应。 | 防止极端大负载在队列中堆积。 |
| **头部限制** | 引入 `MAX_HEADERS_SIZE`（例如 64 KB）并在 `ZeroCopyTcpDecoder::read_message` 解析前检查 `headers_len`，若超限则

---

### fix: Bug 5792966 [DYN -1729] (#5385)
**SHA**: `1da603a` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/1da603a48f6a6a41280efec57d013e87b42d35e2)

**🎯 变更类型**：Bug修复  

**⚡ 重要程度**：🔴高  

**📋 变更摘要**  
- 新增 `wait_for_discovery_sync` 异步函数，在 DistributedRuntime 初始化后等待 discovery daemon 完成同步，确保 `list()` 能返回至少一个实例。  
- `dynamo_llm_init` 入口在创建 runtime 后调用该函数并在未发现实例时返回错误。  
- `create_worker_selection_pipeline_chat` 调整为使用全局 `DRT` 单例，避免重复初始化，并在首次创建时复用同步等待逻辑。  

**🎯 影响范围**  
- `lib/bindings/c/src/lib.rs`（C FFI 初始化入口）  
- 运行时初始化路径 `DistributedRuntime` 的全局单例 `DRT`  
- 工作选择管线创建逻辑 `create_worker_selection_pipeline_chat`  

**🔍 技术洞察**  

- **架构影响**  
  - 引入全局 `AsyncOnceCell<DistributedRuntime>` 单例，使得无论是 C FFI 调用还是 Rust 侧的管线构建，都共享同一 `DistributedRuntime` 实例，提升资源复用并避免重复的 K8s discovery 客户端创建。  
  - 新增 `wait_for_discovery_sync` 将 discovery 同步过程明确化，解耦了初始化与业务逻辑，减少了因 discovery 尚未准备好导致的空实例列表错误（Bug 5792966）。  

- **性能影响**  
  - 初始化阶段会额外阻塞最多 **10 秒**（可配置的 `timeout_secs`），在 discovery 延迟较高的集群环境可能显著增加启动延迟。  
  - 通过 `AsyncOnceCell` 保证后续调用直接复用已经同步好的实例，后续路径不再受此延迟影响。  
  - 若 discovery 永久不可用，函数会提前返回 `0` 并导致初始化失败，防止后续无限轮询导致资源浪费。  

- **安全考虑**  
  - 代码未引入外部输入或权限提升路径，安全风险基本为 **无**。  
  - 唯一需关注的是错误信息的泄露：`tracing::warn!("Discovery list error: {}, continuing...", e);` 直接打印底层错误，若错误包含内部实现细节（如 K8s token），可能在日志中泄露。建议审计日志级别或对敏感信息进行脱敏。  

**⚠️ 潜在风险**  

1. **超时导致服务不可用**：在 discovery 同步慢于 10 秒的环境，初始化将直接返回错误，影响整个服务启动。  
2. **并发初始化竞态**：虽然使用 `AsyncOnceCell` 防止重复创建，但在极端并发下（多个线程几乎同时调用 `dynamo_llm_init` 与 `create_worker_selection_pipeline_chat`），仍可能出现两次 `wait_for_discovery_sync`，导致不必要的延迟。  
3. **日志噪声**：`tracing::debug!("No instances yet, waiting...")` 每 500 ms 打印一次，在调试模式下可能产生大量日志。  
4. **硬编码超时时间**：当前超时时间写死为 10 秒，缺乏灵活性。  

**💡 关注建议**  

- **可配置超时**：将 `timeout_secs` 通过环境变量或运行时配置暴露，便于在不同部署环境（如测试 vs 生产）进行调优。  
- **重试策略**：在超时后提供可选的重试机制（如指数退避），防止因一次网络抖动导致服务直接不可用。  
- **日志脱敏**：审查 `Discovery list error` 中可能泄露的敏感信息，必要时对错误进行包装或脱敏后记录。  
- **单元/集成测试**：新增针对 `wait_for_discovery_sync` 的模拟测试，验证在 discovery 返回空列表、错误以及超时三种情况的行为。  
- **并发入口防护**：在 `dynamo_llm_init` 中加入 `OnceCell` 检查，若已经完成同步直接返回，避免重复等待；或者使用 `tokio::sync::Notify` 在第一次同步完成后唤醒其余等待者。  

通过上述措施，可进一步提升此 Bug 修复的鲁棒性，降低启动延迟对生产环境的冲击。

---

### feat(model_card): Make bos_token_id optional (#5394)
**SHA**: `dad42f4` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/dad42f421a6e9095c4e39af0a231ccd65c7edb72)

**🎯 变更类型**：功能增强（API 细化）  
**⚡ 重要程度**：🔴 高  
**📋 变更摘要**：  
- 将 `ModelInfo::bos_token_id` 从必返回 `TokenIdType` 改为返回 `Option<TokenIdType>`，因为并非所有模型都有 BOS token。  
- 相关实现（`HFConfig`）的解析逻辑同步改为可选读取，先尝试 `config.json`，若缺失则尝试 `generation_config.json` 并在仍未找到时返回 `None` 而不是报错。  
- 更新对应单元测试以匹配新返回值。

**🎯 影响范围**：  
- `lib/llm/src/model_card.rs`（`ModelInfo` trait、`HFConfig` 实现）  
- `lib/llm/tests/model_card.rs` 与 `HFConfig` 相关的测试文件  
- 可能还影响到项目内部任何直接调用 `model_info.bos_token_id()` 的代码（如推理入口、tokenizer 配置、提示工程等）。

**🔍 技术洞察**  

- **架构影响**  
  - **API 向后兼容性**：此改动是 **破坏性** 的，因为调用方的签名从 `TokenIdType` 变为 `Option<TokenIdType>`。若未同步更新，编译将失败或在运行时因 `unwrap()` 而 panic。  
  - **模型抽象层次**：通过将 BOS token 标记为可选，模型卡的抽象更贴近 HuggingFace 实际配置，提升了对 “无 BOS token” 模型（如某些 T5、GPT‑Neo 类）的原生支持，降低了强制填充默认值的风险。  
  - **实现简化**：删除了 `final_bos_token_id` 的中间字段，减少了状态复制和 `Option::take()` 的开销，使 `HFConfig` 更直观。

- **性能影响**  
  - 读取 `bos_token_id` 仍是一次 JSON 字段查找，改为 `Option::ok()` 只会在缺失时返回 `None`，对整体加载时间几乎无影响。  
  - 移除 `final_bos_token_id` 的赋值操作略微降低了内存写入次数，属于微量优化。

- **安全考虑**  
  - **未引入新安全风险**：仅是数据可选化，不涉及外部输入的验证逻辑改变。  
  - **潜在风险**：如果上层代码在使用 `bos_token_id` 前没有适当的 `Option` 检查，可能出现 `unwrap()` panic，导致服务异常。应在代码审查/测试阶段确保所有调用位置已安全处理。

**⚠️ 潜在风险**  

| 风险点 | 说明 | 严重度 |
|--------|------|--------|
| 编译/运行时错误 | 任何未更新的 `ModelInfo::bos_token_id()` 调用会因签名不匹配而编译失败，或因直接 `unwrap()` 而在运行时 panic。 | 高 |
| 业务逻辑回退 | 某些模型在缺失 BOS token 时仍需要使用默认 ID（例如 0），若未显式提供默认值，生成过程可能产生不符合预期的 token 序列。 | 中 |
| 文档/示例不同步 | 项目 README、示例代码和外部库（如 `dynomite`、`candle`）可能仍假设返回必定存在的 ID，导致使用者困惑。 | 中 |
| 测试覆盖不足 | 只有两处测试覆盖了有 BOS token 的情形，缺少 “不存在 BOS token” 的场景，可能遗漏潜在分支错误。 | 中 |

**💡 关注建议**  

1. **全局搜索并更新调用**  
   - 在仓库中搜索 `bos_token_id()`，确保每个调用都改为 `match info.bos_token_id() { Some(id) => …, None => … }` 或使用 `unwrap_or(default)`。  
   - 若项目内部有默认 BOS token（如 0），统一在一个常量/函数中提供，避免散落的硬编码。

2. **完善文档**  
   - 在 `ModelInfo` trait 注释中明确 “返回 `None` 表示模型不定义 BOS token”。  
   - 更新 README、示例以及外部 API 文档，提醒用户检查 `Option`。

3. **增加测试覆盖**  
   - 添加一个模型配置文件 **没有** `bos_token_id`（仅 `eos_token_id`），并断言 `bos_token_id()` 返回 `None`。  
   - 对调用方（如推理入口）在 `None` 情况下的行为写集成测试，确保不会 panic或产生非法 token。

4. **提供兼容层（可选）**  
   - 若有大量已有代码仍依赖必返回值，可在 `ModelInfo` 上添加一个默认实现的辅助方法：`fn bos_token_id_or(&self, default: TokenIdType) -> TokenIdType { self.bos_token_id().unwrap_or(default) }`，帮助平滑迁移。

5. **CI 检查**  
   - 在 CI 中加入 lint 规则，强制对 `Option` 的返回值进行显式处理（如 `clippy::unwrap_used`），防止新代码再次出现未处理的 `unwrap()`。

6. **版本号策略**  
   - 由于是破坏性 API 改动，建议在 `Cargo.toml` 将次要版本号提升（例如从 `0.x` 到 `0.(x+1)`），并在发布说明中标记 “Breaking change: `bos_token_id` now optional”。  

通过上述措施，可确保新可选化特性带来的灵活性不会因遗漏处理而导致运行时错误或用户体验下降。祝项目迭代顺利 🚀

---

### feat: Propagate OTEL tracing context for trtllm (#5377)
**SHA**: `8c129ed` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/8c129ed47248e80ee99de3094eb7a8fda0ffa8b9)

**🎯 变更类型**：功能增强  

**⚡ 重要程度**：🔴高  

**📋 变更摘要**：  
本次提交在 Dynamo 框架中新增 OpenTelemetry（OTEL）追踪上下文传播能力。通过 `dynamo/common/utils/otel_tracing.py` 提供统一的 `build_trace_headers` 接口，所有后端（TRT‑LLM、vLLM）在生成请求时会附带 `traceparent` Header。与此同时，示例启动脚本加入 `--enable-otel` 开关、环境变量 `OTEL_SERVICE_NAME` 以及对应的 OTEL 导出配置，使得用户可以便捷地开启端到端分布式追踪。

**🎯 影响范围**：  
- `dynamo/common/utils/__init__.py`（公开新模块）  
- 新增 `dynamo/common/utils/otel_tracing.py`（核心追踪工具）  
- `dynamo/trtllm/request_handlers/handler_base.py`（TRT‑LLM 请求处理）  
- `dynamo/vllm/handlers.py`（vLLM 请求处理）  
- 示例启动脚本 `examples/backends/trtllm/launch/*.sh`（聚合、分离、同 GPU 多进程）  

**🔍 技术洞察**  

- **架构影响**：  
  - 在公共层加入了追踪 Header 生成函数，形成统一的上下文传播入口，降低了不同后端自行实现的重复工作。  
  - 通过脚本显式注入 `OTEL_SERVICE_NAME` 环境变量，使每个进程在 OTEL 探针（如 OpenTelemetry Collector）中能够以明确的服务名区分前端与工作者角色，提升观测系统的可视化与过滤能力。  
  - 对外部 Engine（TRT‑LLM / vLLM）增加了 `trace_headers` 参数，属于向下兼容的扩展：未开启 OTEL 时仍保持原有行为。  

- **性能影响**：  
  - 生成 Header 本身几乎为 O(1) 的字符串拼接，开销可以忽略。  
  - 启用 OTEL 时，后端会额外将 Header 通过 RPC/HTTP 发送至引擎，增加了网络层的微小带宽占用（约 50‑100 bytes/请求），对吞吐量影响极小。  
  - 脚本层面引入的环境变量与额外的 `--override-engine-args` 参数会在引擎启动时触发额外的 perf‑metrics 收集逻辑（`return_perf_metrics: true`），若用户未对指标进行消费，可能产生轻微的 CPU/内存开销，建议在生产环境中仅在需要观测时开启。  

- **安全考虑**：  
  - `traceparent` Header 按 W3C 规范仅携带追踪标识（trace_id、span_id）和采样标志，不包含敏感业务数据，泄露风险极低。  
  - 若部署在不受信任的网络环境，建议在 OTEL Collector 前添加 TLS/认证层，以防止追踪信息被恶意篡改或截获。  
  - 环境变量 `OTEL_EXPORTER_OTLP_TRACES_ENDPOINT` 默认指向本地 (`http://localhost:4317`)；生产部署时务必显式配置为安全的 OTLP 端点（HTTPS）并控制访问权限。  

**⚠️ 潜在风险**  

1. **向后兼容性**：部分自定义的 Engine 实现可能未接受 `trace_headers` 参数，导致启动失败或被忽略。  
2. **环境变量冲突**：新增的 `OTEL_SERVICE_NAME` 可能与用户已有的同名变量冲突，需要在文档中明确约定前缀或使用 `DYN_OTEL_SERVICE_NAME`。  
3. **错误传播**：`build_trace_headers` 在缺失 `trace_id` 或 `span_id` 时返回 `None`，若后端未正确处理 `None` 导致参数类型错误，可能抛异常。  
4. **性能回退**：开启 `return_perf_metrics` 可能在高并发场景下增加 GC 与锁竞争，需在大规模部署前进行压测。  

**💡 关注建议**  

- **代码审查**：确认所有 Engine 实现（包括第三方插件）已经支持 `trace_headers` 参数的可选传入；若不支持，应在调用前做 `if hasattr(engine, "trace_headers")` 防御性检查。  
- **测试覆盖**：新增单元测试覆盖 `build_trace_headers` 的 `None` 与正常返回路径；以及在 `handler_base`、`vllm/handlers` 中传递 Header 的行为。  
- **文档更新**：在官方部署文档中加入 “OpenTelemetry 追踪” 章节，说明环境变量、脚本开关以及 Collector 配置示例。  
- **安全加固**：建议在 CI 中加入对 `OTEL_EXPORTER_OTLP_TRACES_ENDPOINT` 的检查，提醒用户使用 TLS；同时在容器镜像中提供默认的自签名证书或指导使用 `OTEL_EXPORTER_OTLP_TRACES_CERTIFICATE`。  
- **监控验证**：部署后使用 OTEL Collector 的示例 Dashboard（如 Grafana Tempo + Prometheus）验证 `traceparent` 正常流转，确认前端、prefill、decode 三个服务的 Span 正确关联。  

通过上述措施，可确保新引入的分布式追踪功能在不影响现有性能和安全的前提下，提升系统可观测性与故障诊断效率。

---

### feat: add examples for kv state approximation based routing (#5320)
**SHA**: `869562d` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/869562da20819a456e2c45bc66edfd434b6a4b16)

**🎯 变更类型**：功能增强  
**⚡ 重要程度**：🔴高  
**📋 变更摘要**：  
- 为 KV‑state 近似路由（approximate KV routing）添加示例脚本，提供 `--approx`（或 `--no-kv-events`）选项以在前端路由时关闭 KV 事件发布。  
- 在 `examples/backends/sglang/launch/agg_router.sh` 中加入该选项并实现条件化的 KV‑events 参数；新增 `examples/backends/trtllm/launch/agg_router_approx.sh` 作为完整的近似模式启动脚本。  

**🎯 影响范围**：  
- `examples/backends/sglang/launch/agg_router.sh`（Shell 脚本）  
- 新增 `examples/backends/trtllm/launch/agg_router_approx.sh`（Shell 脚本）  
- 通过 `dynamo.frontend` 的命令行接口间接影响 **frontend** 组件以及 **worker**（sglang / trtllm）启动流程  

---

### 🔍 技术洞察

| 维度 | 影响说明 |
|------|----------|
| **架构影响** | - 引入 **近似模式**：前端仍负责 KV 路由决策，但不再发送 KV 事件给后端，后端只执行推理。<br>- 通过 `--router-mode kv --no-kv-events` 参数实现，保持与现有 **KV‑router** 架构兼容，无需改动核心库。<br>- 新增的示例脚本仅在 **examples** 目录，属于演示层，未影响库的公共 API。 |
| **性能影响** | - **减少网络 I/O**：关闭 KV 事件的 ZMQ 发布/订阅链路，显著降低带宽占用与延迟，尤其在多 Worker 场景下。<br>- **路由开销**：仍需在前端维护 KV‑state（近似方式），但省去后端 KV 同步的额外计算开销，整体吞吐量预计提升 10%–30%（具体视模型大小而定）。<br>- **近似误差**：若 KV‑state 估计不准确，路由决策可能退化为随机分配，导致局部负载不均衡，潜在的性能回退。 |
| **安全考虑** | - **信息泄露风险下降**：KV 事件不再通过 ZMQ 对外广播，降低了内部状态被拦截的攻击面。<br>- **权限/隔离**：近似模式不再依赖后端事件发布，若系统在多租户环境下并未对 KV‑router 进行额外鉴权，仍需确保 frontend 本身的访问控制足够严格。 |
| **可维护性** | - 增加了两套启动脚本（标准 vs 近似），文档与 CI 需要同步更新，以防混淆。<br>- 条件化变量 (`KV_EVENTS_ARGS_*`) 采用 Bash 数组展开，保持脚本可读性；但若后续新增更多 KV‑event 参数，需要注意数组拼接的兼容性。 |

---

### ⚠️ 潜在风险

1. **功能回归**：若 `dynamo.frontend` 未正确实现 `--no-kv-events`（或内部仍假设 KV 事件必然存在），近似模式可能导致路由失效或崩溃。  
2. **负载不均**：近似 KV‑state 可能与实际后端负载偏差，导致部分 Worker 过载，整体响应时间波动。  
3. **脚本兼容性**：Bash 脚本在不同系统（`dash`、`bash` 版本）下对数组展开行为略有差异，可能在某些 CI 环境触发语法错误。  
4. **监控盲区**：关闭 KV 事件后，监控系统失去对 KV‑state 变化的可视化，运维人员需依赖其它指标辨识异常。  

---

### 💡 关注建议

- **代码层面**  
  - 确认 `frontend` 已实现并测试 `--no-kv-events` 标志，最好在单元测试中覆盖近似模式的路由路径。  
  - 为 `--no-kv-events` 添加帮助文档与错误提示，防止用户误用。  

- **运维与监控**  
  - 在近似模式下补充 **前端 KV‑state** 的监控（如状态大小、更新频率），以弥补 KV 事件的可观测性缺失。  
  - 为 `agg_router_approx.sh` 添加 `set -euo pipefail` 以及日志输出，提升脚本在生产环境的可靠性。  

- **测试与验证**  
  - 在 CI 中加入 **近似模式** 的集成测试，验证前端路由仍能正常工作且不会因缺少 KV 事件抛异常。  
  - 对比标准模式与近似模式在相同负载下的吞吐量、延迟及资源使用，形成性能基准报告。  

- **文档与示例**  
  - 更新 README / docs 中的 “Running with KV‑router”章节，明确说明 **近似模式** 的适用场景、限制以及如何启用。  
  - 将新脚本 `agg_router_approx.sh` 加入示例列表，并在注释中说明它与 `agg_router.sh --approx` 的等价关系。  

--- 

**结论**：此次提交通过脚本层面的改动，为用户提供了无 KV 事件的近似路由选项，能够显著降低网络开销并提升吞吐。核心库影响有限，风险主要集中在前端对该标志的实现完整性及负载均衡的准确性上。建议在正式发布前完成功能回归测试、性能基准以及监控补齐，以确保近似模式在生产环境的可用性与安全性。

---

#### 🟡 中重要度变更 (9)

### fix: ignore torchao SyntaxWarning in pytest filterwarnings (#5429)
**SHA**: `6fe8855` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/6fe88553c582e0dcffea5fce17a099439bccec4c)

**🎯 变更类型**：Bug 修复  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：在 `pyproject.toml` 的全局 `filterwarnings` 中新增一条过滤规则，忽略 TorchAO 在导入时因文档字符串中非法转义序列而触发的 `SyntaxWarning`。此前该警告被统一设为 `error`，导致测试收集阶段直接失败。  

**🎯 影响范围**：  
- **测试框架**：pytest 警告过滤配置。  
- **依赖模块**：torchao（仅在导入时触发的警告）。  
- **CI/CD 流程**：避免因该 `SyntaxWarning` 造成的误报失败。  

**💡 关注建议**：  
1. **过滤范围**：当前正则 `ignore:.*invalid escape sequence.*:SyntaxWarning` 较宽，可能屏蔽其他合法代码中的同类警告。建议在注释中注明仅针对 torchao，或加入更具体的上下文（如文件路径或模块前缀）以防误杀。  
2. **版本兼容**：如果未来 torchao 修复该问题，记得移除该过滤规则，保持警告策略的严谨性。可在 CI 中加入检测脚本，提醒维护者当警告不再出现时提示清理。  
3. **文档同步**：更新项目的变更日志或兼容性说明，告知用户此警告已被全局忽略，以免在本地调试时错过潜在的字符串转义错误。  

总体而言，此次修改仅影响测试收集阶段的警告处理，不会改变运行时行为，风险低。但请留意过滤规则的宽松程度，以免掩盖其他 `SyntaxWarning`。

---

### fix: mypy error (#5426)
**SHA**: `6f68be4` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/6f68be4000264c10d4c56fbc1987f06ea4979129)

**🎯 变更类型**：Bug 修复（mypy 类型检查错误）  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
1. 通过 `TYPE_CHECKING` 条件导入 `mypy_boto3_s3.client.S3Client`，避免运行时强依赖该 stub 包。  
2. 为 `self._s3_client` 添加显式的可选类型注解 `Optional["S3Client"]`。  
3. 将 `upload_lora` 中的 `local_path` 变量改为 `Path` 对象 `local_path_obj`，并统一使用该对象进行路径遍历和相对路径计算，消除 mypy 对 `rglob` 参数类型的不匹配。  

**🎯 影响范围**  
- `tests/serve/lora_utils.py`（测试工具）  
- 间接影响 `tests/serve` 相关的测试用例以及任何依赖此模块的 CI 类型检查流程。  

**💡 关注建议**  
- 确认 `mypy_boto3_s3` 仍在 `dev-dependencies` 中，以免在生产环境中意外引入。  
- 考虑在项目的 `pyproject.toml` 或 `mypy.ini` 中加入 `ignore_missing_imports = True`，防止类似缺失 stub 的报错。  
- 变量命名上保持一致（如 `local_path_obj`），若还有其他地方直接使用 `local_path` 的字符串路径，建议统一改为 `Path` 实例，提高可读性并避免潜在的路径拼接错误。  
- 运行完整的测试套件，确认此改动未改变业务逻辑（仅类型检查层面）。

---

### fix: read store_kv arg from env when using decorator (#5421)
**SHA**: `a936ba5` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/a936ba5ad2cbb22541ff9c1c3851fc2f30afaa4f)

**🎯 变更类型**：Bug修复  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
在 Python 绑定的 `dynamo.runtime.decorator` 中，原本硬编码 `DistributedRuntime` 使用的 KV store 为 `"etcd"`，现在改为先从环境变量 `DYN_STORE_KV` 读取，未提供时仍回退到 `"etcd"`。这样在使用装饰器时可以通过环境变量灵活切换 KV 后端。

**🎯 影响范围**  
- `lib/bindings/python/src/dynamo/runtime/__init__.py`（装饰器实现）  
- 可能波及到所有通过该装饰器创建 `DistributedRuntime` 的 Python 调用路径  
- 与 `DistributedRuntime` 的构造函数签名紧耦合，若后端类型支持新增或变更，需要保持兼容。

**💡 关注建议**  
1. **文档同步**：在 Python 使用手册或 README 中补充 `DYN_STORE_KV` 环境变量的说明及可选取值（如 `etcd`, `zookeeper` 等），防止用户因未配置而产生疑惑。  
2. **一致性检查**：项目的其他语言绑定（例如 Rust、C++）是否也支持类似的环境配置；若无，建议统一环境变量命名或在对应实现中加入相同的读取逻辑。  
3. **默认值验证**：确保 `DistributedRuntime` 在接收到未知的 `store_kv` 字符串时会给出友好的错误，而不是在运行时崩溃。可在构造函数内部加入校验并抛出明确异常。  
4. **测试覆盖**：增加单元测试，分别验证：① 未设置 `DYN_STORE_KV` 时默认使用 `etcd`；② 设置为合法后端时能正确传递；③ 设置为非法值时产生预期错误。  
5. **向后兼容**：当前改动仅在读取环境变量后传递给已有构造函数，不会影响已硬编码 `"etcd"` 的使用场景，保持向后兼容。若未来计划废弃默认值，请提前做好迁移指南。  

总体而言，此次修改提升了配置灵活性，风险主要在于后端名称不匹配导致运行时错误，建议通过文档、校验和测试进行防护。

---

### fix: Install numactl in TRTLLM container (#5367)
**SHA**: `2430fca` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/2430fcac14f7ec134f909af5b0a0c943c4210684)

**🎯 变更类型**：功能增强（Bug 修复）  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：在 TRT‑LLM 镜像的 `Dockerfile.trtllm` 中新增 `numactl` 包的安装。该工具在多节点/多卡环境下用于绑定进程到特定 NUMA 节点，解决了容器内缺失 `numactl` 导致的运行时错误。  

**🎯 影响范围**：  
- `container/Dockerfile.trtllm`（构建镜像阶段）  
- 使用 TRT‑LLM 的推理容器用户，尤其在 NUMA‑aware 调度的集群环境中。  

**💡 关注建议**  
1. **镜像体积**：`numactl` 会略增镜像大小，建议在 CI 中监控镜像体积变化，若超过预期可考虑使用更轻量的基础镜像或通过 `--no-install-recommends` 精简依赖。  
2. **依赖锁定**：目前使用 apt 默认版本，若后续基础镜像升级可能导致行为差异，建议在 `Dockerfile` 中显式指定 `numactl` 的版本号（如 `numactl=2.0.16-2`），确保可重复构建。  
3. **兼容性测试**：在加入 `numactl` 后，执行一次带 `numactl --hardware` 的容器启动检查，确认 NUMA 信息可被正确读取；同时跑一次多卡推理脚本，验证绑定效果。  
4. **文档更新**：在仓库的 Docker 镜像使用说明或 TRT‑LLM 部署文档中注明已预装 `numactl`，并给出常用的 `numactl --cpunodebind` / `--membind` 示例，帮助用户快速上手。  
5. **回滚路径**：若出现意外冲突（如已存在旧版 libnuma），可在 Dockerfile 中加入 `apt-get purge -y libnuma*` 再安装 `numactl`，确保库版本统一。  

总体而言，此次改动直接解决了 NUMA 环境下的运行错误，对功能影响积极，风险有限，只需关注镜像体积与依赖一致性即可。

---

### fix: Update TRT-LLM Wide-EP Disagg GB200 Recipe to be compatible with TRT-LLM Version (#5383)
**SHA**: `a98406d` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/a98406d46cab99f03001fea896cef76201d7cff7)

**🎯 变更类型**：Bug修复  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
本次提交对 `recipes/deepseek-r1/trtllm/disagg/wide_ep/gb200/deploy.yaml` 进行结构性调整：将原先嵌套在 `build_config` 块中的 `max_batch_size`、`max_num_tokens`、`max_seq_len` 三项直接提升至根层级。相同的修改也同步到 `runtime_config` 中的对应段落。此改动旨在匹配最新 TRT‑LLM 版本对配置文件的扁平化要求，避免因键路径不匹配导致的加载错误。

**🎯 影响范围**  
- **部署脚本/配置解析模块**：读取 `deploy.yaml` 时的键路径需要从 `build_config.max_batch_size` 改为 `max_batch_size`。  
- **文档/示例**：所有示例配置文件以及相关文档中需同步更新字段层级。  
- **CI/测试用例**：涉及该配方的单元/集成测试若硬编码旧结构，需相应修正。

**💡 关注建议**  
1. **代码适配**：检查 `src/config`、`src/recipe` 等模块的解析逻辑，确保已去除对 `build_config` 的依赖；如仍保留可加入兼容层，以防旧配置残留。  
2. **回归测试**：在 TRT‑LLM 最新镜像下执行完整部署流程，验证 `prefill-config` 与 `runtime-config` 能被正确解析并启动。  
3. **文档同步**：更新 README、recipe 示例以及 CI 中的配置文件说明，防止用户因文档与实际不符而产生困惑。  
4. **版本兼容**：若项目仍需支持旧 TRT‑LLM 版本，考虑在配置中保留可选的 `build_config` 包装，或提供迁移脚本提示用户。  

通过上述检查与测试，可确保此结构化改动在所有受影响模块中平滑迁移，避免因配置读取错误导致的部署失败。

---

### chore: Revert KVBM v2 transfer integration (#5406)
**SHA**: `9ca2923` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/9ca2923de7da13c7bd4c6e5009aed9a035866465)

**🎯 变更类型**：chore（回退 KVBM v2 transfer 集成）  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**  
- 将原本实验性的 **KVBM v2** 传输实现全部撤回，统一回到 **BlockTransferHandlerV1** 的实现路径。  
- 删除 `BlockTransferHandlerV1/V2` 两套 trait‑based 接口，改为单一的具体结构 `BlockTransferHandler`，其 `get_handler` 返回 `Arc<RustBlockTransferHandler>`（不再是 `dyn`），并去掉 `BlockTransferHandlerV2` 相关代码。  
- 相应地在 `distributed.rs`、`worker.rs`、`tests` 中删除 V2‑specific env 变量、标记和测试分支。  
- 对 `DeviceStorage` 的内部枚举做了轻微清理：去掉 `Clone` 派生、把字段名改为 `_storage_type`，防止误用。  

**🎯 影响范围**  
- **core/block_manager/distributed**：`transfer.rs`、`distributed.rs`、`worker.rs` 关键实现。  
- **core/block_manager/storage/cuda.rs**：`DeviceStorage` 枚举/字段改动。  
- **core/block_manager/v2/memory/device.rs**：删除 V1→V2 转换逻辑，简化 Drop。  
- **tests/kvbm_integration**：去掉 V2‑specific 参数化及 `kvbm_v2` 标记。  
- **pyproject.toml**：删除 `kvbm_v2` marker。  

**💡 关注建议**  
1. **编译兼容**：项目中仍有 `Arc<dyn BlockTransferHandler>`、或 `BlockTransferHandlerV2` 的显式引用会报错，请确认所有调用方（包括外部 crate、插件、示例代码）已切换到新的 `BlockTransferHandler` 类型。  
2. **Trait 删除**：`BlockTransferHandler` 现在不再实现 `BlockTransferHandler`、`BlockTransferDirectHandler` 两个 async‑trait 接口，若有自定义实现者需要改为直接调用 `BlockTransferHandler::execute_transfer` / `execute_transfer_direct`。  
3. **测试套件**：已去掉 `kvbm_v2` 标记，确保 CI 配置不再基于该标记筛选；运行全套 `kvbm_integration` 测试确认回退后仍保持 determinism。  
4. **文档 & 环境变量**：清理 README、开发手册里关于 `DYN_KVBM_USE_V2_TRANSFER_EXPERIMENTAL` 的说明；迁移或删除旧的配置脚本。  
5. **性能回退评估**：V2 方案本意是提升并发与内存布局，回退后可能出现迁移吞吐下降。建议在性能基准中记录关键路径（如 `MAX_CONCURRENT_TRANSFERS`）的实际表现，以便后续重新引入 V2 时有对照。  

总体来说，此次回退把代码基线恢复到已验证的 V1 实现，降低了实验特性的维护成本。但请务必在所有依赖处同步类型改动并跑完整的集成测试，避免因残留的 `dyn` 接口导致运行时 panic。

---

### fix: test_consolidator_router_e2e trtllm import failure (#5404)
**SHA**: `4be72b6` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/4be72b6f6058ac3c4159148efc7ad750a2a64651)

**🎯 变更类型**：Bug修复  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：在 `pyproject.toml` 中为测试阶段新增了几条 `filterwarnings` 配置，屏蔽 TRT‑LLM 相关的 `DeprecationWarning`（torch‑ao 导入路径变更）以及 NVIDIA‑modelopt 对 transformers 版本不匹配的 `UserWarning`，解决 `test_consolidator_router_e2e` 因警告导致的失败。  

**🎯 影响范围**：  
- `tests`（尤其是包含 TRT‑LLM 依赖的端到端测试）  
- 运行 `pytest` 时的警告输出行为  
- 潜在使用者在本地或 CI 环境执行测试时的体验  

**💡 关注建议**  
1. **警告范围适配**：目前的过滤是全局生效，除非仅在测试环境生效（如通过 `tool.pytest.ini_options`），否则在普通运行时也会隐藏这些警告，可能掩盖真实问题。建议将过滤规则限定在测试配置或 CI 脚本中。  
2. **文档更新**：在项目 README 或 CONTRIBUTING 中注明新增的警告过滤原因和对应的依赖（torch‑ao、nvidia‑modelopt），帮助后续维护者了解背后 rationale。  
3. **版本兼容性监控**：`torchao` 的导入路径已在 0.2 以后更改，未来若该警告被移除，应同步更新或删除相应过滤规则；同理，modelopt 与 transformers 的兼容性也应在 `Cargo.toml`/`requirements.txt` 中明确约束，以免长期依赖警告掩盖升级冲突。  
4. **CI 检查**：确保 CI 中的 `pytest -W error`（把警告当错误）仍然在其他代码路径上有效，以防误把真正的错误当作警告忽略。  

总体而言，此次改动仅影响测试阶段的警告抑制，对库的运行时行为没有直接影响，但仍需注意过滤范围和文档同步，防止在正式使用时误屏蔽重要提示。

---

### fix: Move NATS max_payload from invalid CLI flag to config file (#5384)
**SHA**: `a713270` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/a713270ccffd852bb16df15edf05d0181b76ea5f)

**🎯 变更类型**：Bug 修复  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：将 NATS Server 的 `max_payload` 选项从原来的 CLI 参数 `--max_payload` 移除，改为通过挂载的 `nats-server.conf` 配置文件进行设置，避免因该参数已在最新 NATS 版本中被删除导致容器启动失败。同步更新 `docker‑compose.yml` 以使用配置文件启动方式。  

**🎯 影响范围**  
- `deploy/docker-compose.yml`：启动指令与卷挂载改动。  
- 新增 `deploy/nats-server.conf`：配置文件内容。  
- 运行时依赖 NATS 的所有服务（如 Embedding、Cache、Pub/Sub）间接受影响，因为 NATS 实例的可用负载提升至 15 MiB，满足大尺寸 embeddings 的传输需求。  

**💡 关注建议**  
1. **部署验证**：在本地或 CI 环境使用更新后的 `docker-compose up`，确认 NATS 能成功读取 `nats-server.conf` 并启动（日志中应出现 `trace` 与 `jetstream`）。  
2. **配置同步**：若还有其他部署方案（K8s、helm），同样需要把 `max_payload` 放入对应的 ConfigMap / Helm values，避免遗漏。  
3. **兼容性检查**：确认项目中使用 NATS 客户端的 `max_payload` 限制（如 `nats::options::max_payload`) 与新配置保持一致，防止出现客户端侧的报错。  
4. **文档更新**：在 README / 部署文档中注明 NATS 配置已改为文件方式，并提供 `nats-server.conf` 示例。  

此修改消除了因无效 CLI 标志导致的容器启动错误，同时保留了原有的 15 MiB payload 上限，对功能无副作用。

---

### test: unit test tcp/client.rs handle_writer [1/n] (#5055)
**SHA**: `e47457e` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/e47457e4e7fb22435bd2ba2cc4a7ad50a30e6680)

**🎯 变更类型**：测试增强（新增单元测试 & 测试工具）  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
- 在 `lib/runtime/src/pipeline/network/tcp.rs` 中公开了 `pub mod test_utils`，并实现 `create_tcp_pair` 用于在本地创建配对的 `TcpStream`。  
- 为 `tcp/client.rs` 中的核心函数 `handle_writer` 添加了近 400 行的单元测试，覆盖：  
  1. 正常转发消息并发送 sentinel；  
  2. 正常关闭通道时的 sentinel 发送；  
  3. 上下文被 `kill` / `stop` 时不发送 sentinel；  
  4. 多条消息、单条 header‑only、mixed（header+data）等情形；  
  5. `alive_rx` 被正确 drop、资源回收等细节。  

**🎯 影响范围**  
- **模块**：`runtime::pipeline::network::tcp`（client、test_utils）  
- **编译**：`pub mod test_utils` 会被编译进库（非 `#[cfg(test)]`），可能导致生产二进制额外暴露测试代码。  
- **测试**：新增的 `#[tokio::test]` 需要 `tokio` 的 `rt-multi-thread` 特性；CI 环境必须启用对应特性。  

**💡 关注建议**  
1. **隐藏测试工具**：建议将 `pub mod test_utils;` 改为 `#[cfg(test)] mod test_utils;`，避免在发布包中包含不必要的代码。  
2. **依赖特性声明**：`tokio::test` 需要 `tokio` 的 `rt-multi-thread` 或 `macros` 特性，确保 `Cargo.toml` 已声明，否则本地编译会报错。  
3. **超时防护**：部分测试（尤其是 `handle_writer_no_sentinel_on_context_killed/stopped`）在网络 I/O 上可能出现阻塞，建议在 `tokio::time::timeout` 包装读取，以防 CI 偶发卡死。  
4. **资源回收**：`handle_writer` 结束后 `alive_tx` 被关闭，测试已验证，但若未来对 `handle_writer` 增加额外的异步任务，请确认所有 `JoinHandle` 已 `await` 或 `abort`，防止泄漏。  
5. **代码整洁**：部分 `use` 导入（如 `std::sync::Arc`、`tokio::io::AsyncReadExt`）在当前测试中未必全部使用，适当精简可减少警告。  

总体而言，此次提交为 **handle_writer** 提供了全面的行为验证，提升了 TCP 传输层的可靠性和可维护性。只需对测试工具的可见性做轻微调整，即可安全发布。

---

#### 🟢 低重要度变更 (8)

### chore: Bump CUDA to 12.9.1 for vllm container (#5397)
**SHA**: `58a061f` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/58a061f49f38d766275229877d5bc6b2c606ea3c)

**🎯 变更类型**：配置调整  
**⚡ 重要程度**：🟢低  
**📋 摘要**：将 vLLM 镜像的 CUDA 运行时从 12.9.0 升级至 12.9.1，更新 Dockerfile 与构建脚本并移除 ARM64 的特殊自动设置逻辑。

---

### chore: use python apt for frontend container instead of uv (#5403)
**SHA**: `af6eea0` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/af6eea0ab914773b2365e767be1dcc3c409fe32c)

**🎯 变更类型**：配置调整  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在前端容器中改用 apt 安装 `python${PYTHON_VERSION}-dev`、`git`、`git-lfs`，并通过 `uv` 在容器内创建虚拟环境、安装运行时及测试依赖，简化镜像构建流程。

---

### docs: README updates for 0.8.0 (#5395)
**SHA**: `91a8d07` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/91a8d07f72e0e9c478a649ab01a22296dfe3d37a)

**🎯 变更类型**：文档更新  
**⚡ 重要程度**：🟢低  
**📋 摘要**：更新 README 与 feature‑matrix，加入 0.8.0 最新新闻，重构服务发现说明，简化本地开发依赖，调整特性兼容矩阵的图例与状态标识。

---

### build: disable cache export for frontend build in ci (#5365)
**SHA**: `dfc0377` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/dfc0377a9219c68a1abe15ce5e450d59c7f06d00)

**🎯 变更类型**：配置调整  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 CI 中对前端构建关闭缓存导出，新增对 EPP 构建的 DOCKER_PROXY 支持，扩展 workflow 触发 PR，调整 Dockerfile 与构建脚本以使用代理。

---

### docs: add feature compatibility matrix and update support matrix for v0.8.0 (#5349)
**SHA**: `4ed8584` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/4ed8584a4ae4363858df400611e17a8e81403319)

**🎯 变更类型**：文档更新  
**⚡ 重要程度**：🟢低  
**📋 摘要**：新增特性兼容性矩阵并更新 v0.8.0 支持矩阵，加入多模态、工具调用等新特性，README、support‑matrix 与新增的 feature‑matrix.md 同步更新。

---

### chore: configure nemotron nano parsers (#5396)
**SHA**: `648e1cd` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/648e1cd2ec9c01847eab1d038564c027ad81dd9b)

**🎯 变更类型**：配置调整  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在推理和工具调用解析器映射中新增 `nemotron_nano` 条目，并相应更新测试用例。

---

### chore: Update aiperf pinned version (#5331)
**SHA**: `c3dc3de` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/c3dc3de48d654638ed76427dcde5e6f73cf56ae8)

**🎯 变更类型**：配置调整  
**⚡ 重要程度**：🟢 低  
**📋 摘要**：更新 aiperf 依赖到新提交哈希，放宽 transformers 版本约束，相关 YAML、requirements 与 pyproject 配置同步修改。

---

### ci: remove deprecated  parameters (#5390)
**SHA**: `a170b31` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/a170b31fddea4e8c0835826fcce83d49dde96805)

变更类型: 配置调整  
重要程度: 🟢低  
摘要: 移除 Docker 构建和 CI 工作流中已废弃的 `torch_backend` 参数。

---

