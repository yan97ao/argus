# 每日更新报告（2026-01-20）

## ai-dynamo/dynamo

| 提交时间 | 作者 | 提交信息 |
|----------|------|----------|
| 2026-01-20 23:28:44 | Michael Feil | feat: typing - Add py.typed support for typing (#4913) |
| 2026-01-20 22:16:52 | Graham King | test: Auto-start services for prompt_embed_tests.py  (#5491) |
| 2026-01-20 20:17:58 | Schwinn Saereesitthipitak | feat: add endpoint instance registration/unregistration for sleep/wake (#5203) |

### 📊 统计摘要
> 本日共 3 个提交 | 🔴高 2 | 🟡中 1 | 🟢低 0
## 📋 目录

- [ai-dynamo/dynamo](#ai-dynamo-dynamo)
  - [📊 统计摘要](#-统计摘要)
  - [🔴 高重要度变更 (2)](#-🔴-高重要度变更-2)
    - [feat: typing - Add py.typed support for typing (#4913)](#fa66f65)
    - [feat: add endpoint instance registration/unregistration f...](#d953f9d)
  - [🟡 中重要度变更 (1)](#-🟡-中重要度变更-1)
    - [test: Auto-start services for prompt_embed_tests.py  (#5491)](#e076f3a)
#### 🔴 高重要度变更 (2)

### feat: typing - Add py.typed support for typing (#4913)
**SHA**: `fa66f65` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/fa66f654379c048094b2b2d1c92ddddbeb741794)

**🎯 变更类型**：功能增强（为 Python 绑定加入 typing 支持）  
**⚡ 重要程度**：🔴 中  

**📋 变更摘要**  
- 在 `dynamo` 项目的 Python 绑定目录 `lib/bindings/python/src/dynamo/` 新增空文件 `py.typed`，标记该模块为已提供类型信息。  
- 该文件使得在使用 `mypy`、`pyright` 等静态类型检查工具时，能够直接读取模块内部的类型注解，而无需额外的 `.pyi` stub 包。  
- 目标是提升 Python 使用者的开发体验，降低类型检查配置成本，进一步完善项目的可用性与生态兼容性。  

**🎯 影响范围**  
- **Python 绑定层**（`lib/bindings/python/src/dynamo/`）  
- **包装发布流程**（`sdist` 与 `wheel` 打包）  
- **使用 `dynamo` Python 包的下游项目**（尤其是开启类型检查的项目）  

**🔍 技术洞察**  

- **架构影响**：  
  - 仅在文件系统层面添加标记文件，对运行时代码、C/Rust 侧实现没有任何介入。  
  - 需要在 `setup.py` / `pyproject.toml` 中确保 `py.typed` 被包含进发行包（`include_package_data=True` 或 `package_data={"dynamo": ["py.typed"]}`），否则标记文件可能在发布后缺失。  

- **性能影响**：  
  - 完全没有运行时开销；`py.typed` 只在导入阶段被解释器读取一次，用于告诉类型检查器该目录已经自带类型信息。  
  - 对二进制文件大小的影响极小（单文件 < 1 KB）。  

- **安全考虑**：  
  - 无直接安全风险。唯一需要注意的是，若后续在同一目录下误加入不受信任的 `.pyi` 或源码，可能在类型检查时误导开发者，但这属于代码治理层面的问题。  

**⚠️ 潜在风险**  

1. **发布遗漏**：如果打包配置未显式包含 `py.typed`，发布的 `sdist`/`wheel` 将缺失该文件，导致下游项目仍然看不到类型信息。  
2. **类型不完整**：当前仅添加标记文件，实际类型注解仍依赖于代码本身的完整性。若代码缺少注解或注解错误，用户仍会在类型检查时遇到问题。  
3. **文档/CI 不同步**：项目文档或 CI 未更新，可能导致开发者不清楚已提供 typing 支持，从而错失使用机会。  

**💡 关注建议**  

- **打包确保**：在 `pyproject.toml`/`setup.cfg` 中添加 `include = ["py.typed"]` 或 `package_data = {"dynamo" = ["py.typed"]}`，并在 CI 中增加检查，验证构建产物确实包含该文件。  
- **类型覆盖**：逐步在 Python 绑定代码中补全类型注解，尤其是公共 API（函数签名、类属性），以配合 `py.typed` 带来真正的类型安全。  
- **CI 检验**：在 CI 流程里加入 `mypy`（或 `pyright`）检查，确保新增的标记文件能够被正确识别，且现有代码通过基础的类型检查。  
- **文档更新**：在 README 或 Python 包的使用指南中说明已支持 typing，并提供示例 `mypy` 配置，帮助用户快速上手。  

通过上述措施，可最大化此小幅度改动的价值，提升项目在 Python 生态的可用性和开发者体验。

---

### feat: add endpoint instance registration/unregistration for sleep/wake (#5203)
**SHA**: `d953f9d` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/d953f9d0381e2a3a51aa248012df9001d396f57b)

**🎯 变更类型**：功能增强（Endpoint 实例的注册/注销）  
**⚡ 重要程度**：🔴高  
**📋 变更摘要**：  
- 在 Rust 核心库 `Endpoint` 中新增 `unregister_endpoint_instance` 与 `register_endpoint_instance` 两个异步接口，实现对工作实例在 discovery 服务中的删除与重新加入。  
- 为 Python 绑定层补齐对应的异步方法，使用户能够在 worker 进入休眠或唤醒时主动控制路由行为。  
- 新增的实现会在内部构造 `DiscoveryInstance` / `DiscoverySpec` 并调用 discovery 客户端的 `unregister` / `register`，同时在成功/失败时记录结构化日志并返回 `anyhow::Result<()>`。  

**🎯 影响范围**：  
- `lib/runtime/src/component/endpoint.rs`（核心业务逻辑）  
- `lib/bindings/python/rust/lib.rs` 与 `lib/bindings/python/src/dynamo/_core.pyi`（Python 对外 API）  
- 依赖 discovery 服务的路由层（Router）以及任何基于 `Endpoint` 的运行时实例。  

**🔍 技术洞察**：  
- **架构影响**  
  - 引入了 **主动的实例生命周期管理**：原本实例在创建时自动注册，关闭时注销；现在可以在业务层面自行控制，适配 “sleep / wake” 场景。  
  - 新增的调用链：`Endpoint → build_transport_type → DiscoveryClient.{register,unregister}`，使 `Endpoint` 与 discovery 之间的耦合度略有提升。若后续想做 discovery 抽象或多实现，需考虑接口抽象层。  
  - 对 Python 绑定层的改动保持了一致的 async 接口，兼容现有 `Endpoint` 使用模式。  

- **性能影响**  
  - 每次注册/注销都会执行一次网络 RPC（调用 discovery 服务），并在内部重新计算 transport 类型。相较于启动时的单次注册，这在频繁 sleep/wake 场景下会产生额外的网络延时和 CPU 开销。  
  - 代码使用 `pyo3_async_runtimes::tokio::future_into_py` 将 Rust Future 包装为 Python Awaitable，开销与普通 async 调用相当，不会阻塞 Python 解释器。  
  - 日志记录使用 `tracing::info!` 与 `tracing::error!`，对性能影响微乎其微。  

- **安全考虑**  
  - 方法本身不涉及敏感数据处理，仅是向 discovery 报告实例状态，安全风险有限。  
  - 仍需确保 **discovery 服务的身份验证/授权** 正确配置，防止恶意 worker 冒充其他实例进行注册/注销，导致路由污染或拒绝服务。  
  - 错误路径使用 `anyhow::bail!` 向上抛出，若上层未捕获可能导致进程异常退出，需在调用方做好异常捕获与回退策略。  

**⚠️ 潜在风险**：  
1. **路由漂移**：如果实例在 sleep 状态未成功注销，router 仍可能把请求发送至不可用 worker，导致超时或错误返回。  
2. **并发竞争**：在同一实例上并发调用 `register_endpoint_instance` / `unregister_endpoint_instance` 可能产生 race 条件，使 discovery 中的实例状态不一致。  
3. **发现服务不可达**：注册/注销依赖 discovery RPC，若 service 暂时不可用，将导致 `anyhow::bail!` 抛错，可能影响业务流程（尤其是 wake‑up 时）。  
4. **错误传播**：当前实现直接 `bail!`，未对 transient 错误做重试，可能因网络抖动导致不必要的失败。  
5. **跨语言一致性**：Python 侧仅提供了声明（`...`），若文档或示例未更新，开发者可能误以为方法已实现。  

**💡 关注建议**：  
- **幂等性 & 防重入**：在 `register`/`unregister` 前查询 discovery 中当前实例状态，或在 discovery 客户端实现幂等的 `register`/`unregister` 接口，以降低并发风险。  
- **重试机制**：在网络错误或临时不可用时加入指数退避重试，或在上层（Python）提供可配置的重试策略。  
- **监控与告警**：在 `tracing` 日志外加入统一的指标（如 `endpoint_register_success_total`、`endpoint_unregister_failure_total`），便于监控 sleep/wake 流程的健康度。  
- **文档与示例**：在 README / Python SDK 文档显式说明何时应调用这两个方法（例如 `worker.sleep()`、`worker.wake()`），并提供完整的 async 示例。  
- **测试覆盖**：增加单元/集成测试，验证：  
  1. 正常注册/注销成功后 router 行为变化；  
  2. 发现服务不可达时错误类型与信息；  
  3. 并发调用时不会产生重复注册或泄漏实例。  
- **安全加固**：确认 discovery 客户端在与服务交互时使用 TLS + 可信身份凭证，并在请求体中携带实例签名，以防恶意伪造注册/注销。  

通过上述措施，可以最大化该功能的业务价值（灵活的 worker sleep/wake 支持），同时将潜在的可靠性与安全风险控制在可接受范围内。

---

#### 🟡 中重要度变更 (1)

### test: Auto-start services for prompt_embed_tests.py  (#5491)
**SHA**: `e076f3a` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/e076f3a265862b1269d19250e4cb53bf028cde81)

**🎯 变更类型**：功能增强（新增端到端测试）  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
- 为 `tests/frontend/test_prompt_embeds.py` 添加了完整的集成测试，用于验证 VLLM worker 在 **prompt‑embeds** 场景下的端到端工作流。  
- 新增 `VllmPromptEmbedsWorkerProcess` 与 `start_services` fixture，自动启动 Dynamo 前端和 VLLM worker（使用文件 KV、TCP 请求平面），省去 NATS/etcd 依赖，提升 CI 稳定性与速度。  
- 调整 `dynamo_client` fixture，使其通过动态分配的前端端口创建 OpenAI 客户端。  

**🎯 影响范围**  
- **tests/frontend**：新增大量测试代码。  
- **tests/utils/managed_process.py、tests/utils/port_utils.py**：间接依赖，确保进程管理与端口分配能支撑新 fixture。  
- **dynamo/vllm**（运行时）：使用 `--enable-prompt-embeds` 参数，若后端未实现该标志可能导致测试失败。  

**💡 关注建议**  
1. **CI 环境**：确保容器或 runner 中已装好 `python3`、`torch`、`openai` 等依赖，并且模型 `Qwen/Qwen3-0.6B` 能被预先下载（`predownload_models` fixture）。  
2. **进程健康检查**：`VllmPromptEmbedsWorkerProcess.is_ready` 依赖 `/health` 返回 `"ready"`，若未来更改健康接口，请同步更新。  
3. **日志目录**：每个测试会在 `"{node_name}_vllm-prompt-embeds-worker"` 下创建日志，注意磁盘清理，防止 CI 磁盘爆满。  
4. **兼容性**：本次修改仅影响测试层，不会改变生产代码。但若在本地运行全部测试，请确保已有 `file_storage_backend` fixture（提供 `DYN_FILE_KV` 环境变量），否则进程启动会报错。  

总体来看，此提交通过自动化启动必要服务，大幅提升 Prompt‑Embeds 功能的回归可靠性，风险主要集中在外部依赖（模型下载、GPU/torch 环境）和健康检查兼容性上。建议在 CI 中加入对这些前置条件的显式校验。

---

