# æ¯æ—¥æ›´æ–°æŠ¥å‘Šï¼ˆ2026-02-02ï¼‰

## ai-dynamo/dynamo

| æäº¤æ—¶é—´ | ä½œè€… | æäº¤ä¿¡æ¯ |
|----------|------|----------|
| 2026-02-02 15:20:29 | ishandhanani | fix: enable DP attention KV events for multi-node deployments (#5589) |

### ğŸ“Š ç»Ÿè®¡æ‘˜è¦
> æœ¬æ—¥å…± 1 ä¸ªæäº¤ | ğŸ”´é«˜ 1 | ğŸŸ¡ä¸­ 0 | ğŸŸ¢ä½ 0
## ğŸ“‹ ç›®å½•

- [ai-dynamo/dynamo](#ai-dynamo-dynamo)
  - [ğŸ“Š ç»Ÿè®¡æ‘˜è¦](#-ç»Ÿè®¡æ‘˜è¦)
  - [ğŸ”´ é«˜é‡è¦åº¦å˜æ›´ (1)](#-ğŸ”´-é«˜é‡è¦åº¦å˜æ›´-1)
    - [fix: enable DP attention KV events for multi-node deploym...](#c5f5ab6)
#### ğŸ”´ é«˜é‡è¦åº¦å˜æ›´ (1)

### fix: enable DP attention KV events for multi-node deployments (#5589)
**SHA**: `c5f5ab6` | ğŸ”— [æŸ¥çœ‹æäº¤](https://github.com/ai-dynamo/dynamo/commit/c5f5ab605660eed9fdb10f4a335a85d5bea39c44)

**ğŸ¯ å˜æ›´ç±»å‹**ï¼šåŠŸèƒ½å¢å¼º / Bugä¿®å¤  
**âš¡ é‡è¦ç¨‹åº¦**ï¼šğŸ”´é«˜  
**ğŸ“‹ å˜æ›´æ‘˜è¦**ï¼š  
æ­¤æ¬¡æäº¤ä¸º SGLang ç»„ä»¶åœ¨å¤šèŠ‚ç‚¹ï¼ˆmultiâ€‘nodeï¼‰éƒ¨ç½²ä¸‹çš„ DPï¼ˆDataâ€‘Parallelï¼‰æ³¨æ„åŠ›æ¨¡å¼å¯ç”¨äº† KV äº‹ä»¶çš„å‘å¸ƒã€‚æ ¸å¿ƒæ”¹åŠ¨åŒ…æ‹¬ï¼š  
1. åœ¨é Leader èŠ‚ç‚¹ä¸Šä¹Ÿåˆå§‹åŒ– KV äº‹ä»¶çš„ ZMQ è®¢é˜…å¹¶åœ¨è¿›ç¨‹é€€å‡ºæ—¶å®Œæˆæ¸…ç†ã€‚  
2. `DynamoSglangPublisher` æ‹†åˆ†äº†æŒ‡æ ‡æ¥æ”¶ä¸ KV äº‹ä»¶å‘å¸ƒé€»è¾‘ï¼Œæ”¯æŒæŒ‰æœ¬åœ° DP rank åˆ›å»ºå¤šè·¯ ZMQ è®¢é˜…ï¼Œå¹¶åœ¨é Leader èŠ‚ç‚¹è·³è¿‡ä»… Leader æ‰€éœ€çš„æŒ‡æ ‡ socketã€‚  
3. å°† DPâ€‘rank ä¿¡æ¯é€šè¿‡ `routing` å­—æ®µä¼ é€’ç»™ SGLang å¼•æ“çš„ `async_generate`ï¼Œå¹¶åœ¨æ³¨å†Œé˜¶æ®µæš´éœ² `data_parallel_size` ä¾›è·¯ç”±å™¨ä½¿ç”¨ã€‚  
4. ç»Ÿä¸€äº†èµ„æºæ¸…ç†ï¼ˆpublisherã€metrics ä»»åŠ¡ï¼‰ä»¥åŠåœ¨æ‰€æœ‰è¯·æ±‚å¤„ç†å™¨ä¸­è°ƒç”¨åŸºç±» `cleanup`ã€‚  

**ğŸ¯ å½±å“èŒƒå›´**ï¼š  
- `components/src/dynamo/sglang/*`ï¼ˆmainã€publisherã€registerã€request_handlersï¼‰  
- `lib/bindings/python/rust/llm/kv.rs`ï¼ˆPythonâ€‘Rust KV ç›‘å¬å™¨ç­¾åï¼‰  
- `lib/llm/src/kv_router/publisher.rs`ï¼ˆZMQ è¿æ¥æ—¥å¿—ä¸æ³¨é‡Šï¼‰  

**ğŸ” æŠ€æœ¯æ´å¯Ÿ**ï¼š

- **æ¶æ„å½±å“**  
  - **å¤šèŠ‚ç‚¹ DP Attention æ”¯æŒ**ï¼šåŸå…ˆåªæœ‰ Leaderï¼ˆ`node_rank == 0`ï¼‰ä¼šè®¢é˜… KV äº‹ä»¶ï¼Œå¯¼è‡´è·¨èŠ‚ç‚¹çš„ DPâ€‘rank äº§ç”Ÿçš„ KV å˜æ›´æ— æ³•è¢«ä¼ æ’­ã€‚ç°åœ¨æ¯ä¸ªèŠ‚ç‚¹ä»…é’ˆå¯¹æœ¬åœ° DPâ€‘rank åˆ›å»º `ZmqKvEventPublisher`ï¼Œé€šè¿‡ NATS å®ç°è·¨èŠ‚ç‚¹åˆ†å‘ï¼Œä½¿å¾— KV è·¯ç”±å±‚èƒ½å¤Ÿåœ¨å…¨å±€è§†å›¾ä¸‹å·¥ä½œã€‚  
  - **Publisher è§’è‰²ç»†åˆ†**ï¼š`DynamoSglangPublisher` ç°åœ¨æŒæœ‰ `kv_publishers` åˆ—è¡¨å’Œ `_running` æ ‡è¯†ï¼Œåˆ†ç¦»äº†â€œæŒ‡æ ‡æ¥æ”¶â€ï¼ˆä»… Leaderï¼‰å’Œâ€œKV äº‹ä»¶å‘å¸ƒâ€ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰ï¼Œæå‡äº†èŒè´£å•ä¸€æ€§ã€‚  
  - **è¿è¡Œæ—¶é…ç½®**ï¼šåœ¨ `register.py` ä¸­åŠ å…¥ `data_parallel_size`ï¼Œä¸º KV router æä¾›æ¯ä¸ª workerâ€‘id + dp_rank çš„å”¯ä¸€æ ‡è¯†ï¼Œç¡®ä¿è·¯ç”±è¡¨æ„å»ºæ­£ç¡®ã€‚  
  - **æ¸…ç†æœºåˆ¶ç»Ÿä¸€**ï¼š`BaseWorkerHandler.cleanup` ç°åœ¨ä¼šè°ƒç”¨ `publisher.cleanup()`ï¼Œæ‰€æœ‰å­ç±»åœ¨ `cleanup` ä¸­åªéœ€ `super().cleanup()`ï¼Œé¿å…èµ„æºæ³„æ¼ã€‚  

- **æ€§èƒ½å½±å“**  
  - **é¢å¤–çš„æœ¬åœ° ZMQ è®¢é˜…**ï¼šæ¯ä¸ªæœ¬åœ° DPâ€‘rank ä¼šåˆ›å»ºä¸€ä¸ª ZMQ SUB socketï¼ˆä½¿ç”¨ `ZmqEventPublisher.offset_endpoint_port` å¯¹é½ç«¯å£ï¼‰ï¼Œä½†è¿™äº›éƒ½æ˜¯æœ¬æœºå†…éƒ¨é€šä¿¡ï¼Œç½‘ç»œå¼€é”€æä½ã€‚  
  - **Metrics è´Ÿè½½**ï¼šé Leader èŠ‚ç‚¹ä¸å†åˆ›å»ºæŒ‡æ ‡ socketï¼Œå‡å°‘æ— ç”¨çš„ ZMQ æ¶ˆè´¹å¾ªç¯ï¼Œä»…ä¿ç•™ KV äº‹ä»¶å‘å¸ƒï¼Œæ•´ä½“ CPU ä½¿ç”¨ç•¥æœ‰ä¸‹é™ã€‚  
  - **è·¨èŠ‚ç‚¹ KV ä¼ æ’­**ï¼šKV äº‹ä»¶ä»é€šè¿‡ NATSï¼ˆå·²åœ¨ç³»ç»Ÿä¸­ä½¿ç”¨ï¼‰è¿›è¡Œè·¨èŠ‚ç‚¹å¹¿æ’­ï¼Œå¸¦æ¥çš„é¢å¤–ç½‘ç»œæµé‡ä¸åŸå…ˆ KV äº‹ä»¶å¹¿æ’­ç›¸åŒï¼Œæœªå‡ºç°æ–°ç“¶é¢ˆã€‚  
  - **Graceful Shutdown**ï¼šåœ¨é Leader èŠ‚ç‚¹åŠ å…¥ `metrics_task.cancel()` ä¸ `await metrics_task`ï¼Œä»¥åŠ ZMQ èµ„æºçš„æ˜¾å¼å…³é—­ï¼Œé¿å…å› é˜»å¡è€Œå¯¼è‡´è¿›ç¨‹å¡æ­»ã€‚  

- **å®‰å…¨è€ƒè™‘**  
  - ä»£ç æœªæ–°å¢å¤–éƒ¨ç½‘ç»œç›‘å¬ï¼Œåªæ˜¯æœ¬æœºå†…éƒ¨ ZMQ è¿æ¥ï¼Œå®‰å…¨é£é™©åŸºæœ¬ä¸å˜ã€‚  
  - `publisher.cleanup()` åœ¨å¼‚å¸¸è·¯å¾„ä¸­æ•è·å¹¶è®°å½•é”™è¯¯ï¼Œé˜²æ­¢å› å¼‚å¸¸å¯¼è‡´èµ„æºæœªé‡Šæ”¾ï¼Œä»è€Œé™ä½æ½œåœ¨çš„èµ„æºè€—å°½æ”»å‡»é¢ã€‚  
  - å¯¹ `kv_events_config` çš„è§£æä¿æŒåŸæœ‰ json ç»“æ„ï¼Œæœªå¼•å…¥æ–°å¯æ§å…¥å£ï¼Œä»ç„¶ä¾èµ–ç”¨æˆ·é€šè¿‡å¯åŠ¨å‚æ•°é…ç½®ã€‚  

**âš ï¸ æ½œåœ¨é£é™©**ï¼š

| é£é™©ç‚¹ | æè¿° | ç¨‹åº¦ |
|--------|------|------|
| **DPâ€‘rank åˆ†é…ä¸å‡** | å½“ `dp_size` ä¸èƒ½è¢« `nnodes` æ•´é™¤æ—¶ï¼Œ`local_dp_size = dp_size // nnodes` å¯èƒ½å¯¼è‡´éƒ¨åˆ† DPâ€‘rank æœªè¢«ä»»ä½•èŠ‚ç‚¹è®¢é˜…ã€‚ | ä¸­ |
| **`node_rank`/`nnodes` å‚æ•°ç¼ºå¤±** | éƒ¨åˆ†éƒ¨ç½²è„šæœ¬å¯èƒ½æœªæ˜¾å¼ä¼ é€’ `node_rank`ï¼Œå¯¼è‡´é»˜è®¤ 0ï¼Œè¿›è€Œè¯¯è®¤ä¸ºæ˜¯ Leaderï¼Œå‡ºç°é‡å¤æŒ‡æ ‡ socket æˆ–é—æ¼ KV è®¢é˜…ã€‚ | ä¸­ |
| **å¼‚å¸¸é€€å‡ºæ—¶çš„æ¸…ç†ç«äº‰** | `metrics_task.cancel()` åç«‹å³ `await metrics_task`ï¼Œè‹¥ `run()` æ­£åœ¨æ‰§è¡Œ `await self._sock.recv_pyobj()`ï¼Œå¯èƒ½äº§ç”Ÿ `CancelledError`ï¼Œå·²æ•è·ï¼Œä½†ä»éœ€ç¡®ä¿ä¸ç•™ä¸‹æ‚¬æŒ‚çš„ ZMQ çº¿ç¨‹ã€‚ | ä½ |
| **å‘å¼•æ“ä¼ é€’ `dp_rank`**ï¼šä¾èµ–è¯·æ±‚ä½“ä¸­ `routing.dp_rank` å­—æ®µï¼Œè‹¥ä¸Šæ¸¸è·¯ç”±å™¨æœªå¡«å……ï¼Œ`data_parallel_rank=None` å¯èƒ½å¯¼è‡´ SGLang å¼•æ“è¯¯åˆ¤ã€‚ | ä¸­ |
| **å‘åå…¼å®¹æ€§**ï¼šæ—§ç‰ˆä¸æ”¯æŒ `dp_size>1` çš„éƒ¨ç½²åœ¨æœªè®¾ç½®å¯¹åº” env/args æ—¶ä»èƒ½æ­£å¸¸å·¥ä½œï¼Œä½† `runtime_config.data_parallel_size` é»˜è®¤ 1ï¼Œéœ€ç¡®è®¤å…¶å®ƒç»„ä»¶ä¸ä¼šå› è¯¥å­—æ®µçš„å­˜åœ¨è€Œæ”¹å˜è¡Œä¸ºã€‚ | ä½ |

**ğŸ’¡ å…³æ³¨å»ºè®®**ï¼š

1. **éƒ¨ç½²éªŒè¯**  
   - åœ¨å¤šèŠ‚ç‚¹ï¼ˆâ‰¥2ï¼‰ä¸” `dp_size > 1` çš„ç¯å¢ƒä¸‹ï¼Œæ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹æ—¥å¿—ï¼Œç¡®ä¿å‡ºç° â€œSubscribing to local DP ranks â€¦â€ ä¿¡æ¯ã€‚  
   - ä½¿ç”¨ `kubectl logs`ï¼ˆæˆ–ç­‰ä»·å·¥å…·ï¼‰ç¡®è®¤æ‰€æœ‰ DPâ€‘rank éƒ½æœ‰å¯¹åº”çš„ `ZmqKvEventPublisher` å®ä¾‹å¯åŠ¨ã€‚  

2. **DPâ€‘rank åˆ†é…æ£€æŸ¥**  
   - åœ¨å¯åŠ¨è„šæœ¬ä¸­åŠ å…¥ `dp_size % nnodes == 0` çš„æ–­è¨€æˆ–è­¦å‘Šï¼Œé˜²æ­¢é—æ¼ã€‚è‹¥å¿…é¡»ä¸å‡åŒ€åˆ’åˆ†ï¼Œéœ€åœ¨ `publisher.init_kv_event_publish` ä¸­è¡¥å…¨ä½™æ•°çš„åˆ†é…é€»è¾‘ã€‚  

3. **å¼‚å¸¸ä¸èµ„æºå›æ”¶**  
   - åœ¨å•å…ƒ/é›†æˆæµ‹è¯•ä¸­æ¨¡æ‹Ÿ SIGTERMã€SIGINT åœºæ™¯ï¼Œç¡®è®¤ `publisher.cleanup()` èƒ½æˆåŠŸå…³é—­ ZMQ socketã€context ä»¥åŠæ‰€æœ‰ `kv_publishers`ã€‚  
   - å¦‚æœ‰éœ€è¦ï¼Œå¯åœ¨ `run()` å¾ªç¯é‡ŒåŠ å…¥ `asyncio.wait_for` è¶…æ—¶ï¼Œä»¥å…åœ¨æç«¯ç½‘ç»œå¼‚å¸¸ä¸‹æ— é™é˜»å¡ã€‚  

4. **è·¯ç”±å­—æ®µä¿éšœ**  
   - åœ¨ Dynamo KV routerï¼ˆ`kv_router`ï¼‰å±‚é¢ï¼Œç¡®ä¿åœ¨ç”Ÿæˆè¯·æ±‚æ—¶å§‹ç»ˆå¡«å…… `routing.dp_rank`ï¼ˆå³ `local_dp_rank`ï¼‰ï¼Œå¦åˆ™åç«¯ SGLang å¼•æ“ä¼šæ”¶åˆ° `None`ã€‚å¯ä»¥åœ¨ `router` ä¸­åŠ å…¥é»˜è®¤ fallback ä¸º `0` çš„é€»è¾‘ã€‚  

5. **ç›‘æ§æŒ‡æ ‡**  
   - ç”±äºé Leader èŠ‚ç‚¹ä¸å†æš´éœ²å†…éƒ¨ scheduler æŒ‡æ ‡ï¼Œè‹¥ä¸šåŠ¡éœ€è¦å…¨å±€å¯è§†åŒ–ï¼Œéœ€è¦åœ¨ Prometheus ä¸­èšåˆå„èŠ‚ç‚¹é€šè¿‡ NATS è½¬å‘çš„ KV æŒ‡æ ‡ã€‚å»ºè®®åœ¨ `metrics_labels` ä¸­åŠ å…¥ `node_rank` æ ‡è®°ã€‚  

6. **æ–‡æ¡£ä¸ç¤ºä¾‹æ›´æ–°**  
   - åœ¨é¡¹ç›®æ–‡æ¡£ä¸­æ³¨æ˜ï¼š`dp_size > 1` æ—¶å¿…é¡»ä½¿ç”¨ `--node-rank`ã€`--nnodes` å‚æ•°ï¼Œå¹¶ç¡®ä¿ `kv_events_config.endpoint` æŒ‰ç…§ SGLang `ZmqEventPublisher.offset_endpoint_port` æ–¹å¼é…ç½®ã€‚  
   - æä¾›ä¸€ä¸ªæœ€å°åŒ–çš„å¤šèŠ‚ç‚¹ DPâ€‘attention ç¤ºä¾‹ï¼ˆDockerâ€‘Compose / K8sï¼‰å¸®åŠ©ç”¨æˆ·å¿«é€Ÿä¸Šæ‰‹ã€‚  

æ€»ä½“æ¥çœ‹ï¼Œæ­¤æ¬¡æ”¹åŠ¨æ˜¾è‘—æå‡äº† Dynamo åœ¨å¤šèŠ‚ç‚¹ DP æ³¨æ„åŠ›

---

