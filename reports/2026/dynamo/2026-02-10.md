# 每日更新报告（2026-02-10）

## ai-dynamo/dynamo

| 提交时间 | 作者 | 提交信息 |
|----------|------|----------|
| 2026-02-10 22:46:01 | Harrison Saturley-Hall | fix: sanitize docker tags on main to arm64/amd64 removing 'linux/...' (#6108) |
| 2026-02-10 21:56:17 | Dillon Cullinan | feat: Dockerfile templating (#5633) |
| 2026-02-10 09:13:02 | Keiven C | fix: increase router E2E timeouts in preparation for enabling xdist (parallel pytest) later (#6085) |
| 2026-02-10 09:12:31 | Keiven C | fix: test_router_decisions async fix race condition (#6084) |
| 2026-02-10 09:11:37 | Keiven C | feat: add NIXL check to sanity_check (#6087) |
| 2026-02-10 09:10:37 | Keiven C | feat: expose Python Prometheus metric via DynamoComponentMetrics (#5817) |
| 2026-02-10 09:03:45 | William Arnold | feat: Add SGLang /engine weight update endpoints (#6094) |
| 2026-02-10 08:04:34 | orangeng | docs: Fix service name in port-forward command (#5527) |
| 2026-02-10 07:57:59 | MatejKosec | fix: profiler deployment timeout handling for MoE models (#6086)<br>Wrap wait_for_deployment_ready() in try/except TimeoutError for both prefill and decode profiling sweeps<br>On timeout: log error, record via add_profiling_error(), clean up the timed-out deployment, and continue to the next parallelization mapping<br>Previously, a single deployment timeout would crash the entire profiler job |
| 2026-02-10 07:19:27 | Ayush Agarwal | feat: text to image vLLM Omni (#5912) |
| 2026-02-10 06:11:33 | dagil-nvidia | docs: improve Fern sidebar titles, add guide subtitles, and replace ASCII diagrams with D2 (#6069) |
| 2026-02-10 06:08:39 | dagil-nvidia | docs: sync fern/ with local indexer default changes from #5941 (#6073) |
| 2026-02-10 05:44:03 | dagil-nvidia | refactor: use tempfile module instead of hardcoded /tmp paths (#5789) |
| 2026-02-10 04:45:28 | dagil-nvidia | chore: add --no-install-recommends to apt-get install commands (#5774) |
| 2026-02-10 04:44:39 | dagil-nvidia | ci: add doc exclusions to all CI-triggering filter groups (#6020) |
| 2026-02-10 02:57:47 | Vladislav Nosivskoy | fix: DeepSeek V3.2 chat template FC and SO support (#6034) |
| 2026-02-10 02:09:22 | muskansh-google | docs: Update command to build Dynamo + SGLang container (#5908) |
| 2026-02-10 01:38:04 | Hongkuan Zhou | fix: add watchdog timeout for sglang dsr1 recipe (#6076) |
| 2026-02-10 01:20:03 | dagil-nvidia | refactor: optimize regex patterns in docs scripts (#5777) |
| 2026-02-10 00:41:13 | Harrison Saturley-Hall | ci: update premerge to check the cargo-deny ban list (#5699) |

### 📊 统计摘要
> 本日共 20 个提交 | 🔴高 7 | 🟡中 7 | 🟢低 6
## 📋 目录

- [ai-dynamo/dynamo](#ai-dynamo-dynamo)
  - [📊 统计摘要](#-统计摘要)
  - [🔴 高重要度变更 (7)](#-🔴-高重要度变更-7)
    - [feat: Dockerfile templating (#5633)](#ac02062)
    - [feat: add NIXL check to sanity_check (#6087)](#241cc78)
    - [feat: expose Python Prometheus metric via DynamoComponent...](#027d265)
    - [feat: Add SGLang /engine weight update endpoints (#6094)](#56a1b6e)
    - [fix: profiler deployment timeout handling for MoE models ...](#67329d1)
    - [feat: text to image vLLM Omni (#5912)](#9f76d06)
    - [fix: DeepSeek V3.2 chat template FC and SO support (#6034)](#7202ced)
  - [🟡 中重要度变更 (7)](#-🟡-中重要度变更-7)
    - [fix: sanitize docker tags on main to arm64/amd64 removing...](#d8feb93)
    - [fix: increase router E2E timeouts in preparation for enab...](#5755a8d)
    - [fix: test_router_decisions async fix race condition (#6084)](#f51ec24)
    - [docs: improve Fern sidebar titles, add guide subtitles, a...](#d14d6ff)
    - [refactor: use tempfile module instead of hardcoded /tmp p...](#0ef41ff)
    - [fix: add watchdog timeout for sglang dsr1 recipe (#6076)](#1585244)
    - [refactor: optimize regex patterns in docs scripts (#5777)](#bf270c2)
  - [🟢 低重要度变更 (6)](#-🟢-低重要度变更-6)
    - [docs: Fix service name in port-forward command (#5527)](#98eb6b7)
    - [docs: sync fern/ with local indexer default changes from ...](#d48de15)
    - [chore: add --no-install-recommends to apt-get install com...](#3c9ca3f)
    - [ci: add doc exclusions to all CI-triggering filter groups...](#0b05c4c)
    - [docs: Update command to build Dynamo + SGLang container (...](#4520b8f)
    - [ci: update premerge to check the cargo-deny ban list (#5699)](#59d20d1)
#### 🔴 高重要度变更 (7)

### feat: Dockerfile templating (#5633)
**SHA**: `ac02062` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/ac0206293ca3f9c879587cc2e22acfe69f3d9cca)

**🎯 变更类型**：🛠️ **架构变更 / 重构**  
（引入 Dockerfile 模板化渲染、删除单体 `Dockerfile*` 与 `build.sh`，改用 `render.py` 生成一次性 Dockerfile，CI/Workflow 亦同步改写）

---

## 📋 变更摘要  
- **核心**：新增 `container/render.py`（基于 Jinja2/YAML），把所有原有的 **Dockerfile**、`build.sh`、`dev/Dockerfile.dev` 等逻辑抽离到 **模板目录 `container/templates/`**。  
- **生成流程**：`render.py --framework=<f> --target=<t> --platform=<p> --cuda-version=<v> [--make-efa]` → 渲染出 `rendered.Dockerfile`（或完整文件名），随后使用普通 `docker buildx build -f rendered.Dockerfile …` 构建。  
- **CI/Workflow**：所有原有 `container/build.sh` 调用被替换为 **GitHub Action** 步骤（`.github/actions/docker‑build`、`.github/actions/docker‑remote‑build`）——先运行 Python 渲染，再直接调用 `docker buildx`，并把缓存/推送逻辑搬进 Action。  
- **文档/例子**统一改写为调用 `render.py + docker build`。  
- **大量冗余 Dockerfile（vllm、sglang、trtllm、runtime、dev、local‑dev、frontend 等）被删除，改为 **模板化** 复用同一套 `args.Dockerfile`、`dynamo_base.Dockerfile`、`wheel_builder.Dockerfile`、框架‑specific 模板等。  
- **新增**：`container/context.yaml`（默认 ARG 值的单一来源），以及 `container/.dockerignore` 加入 `*rendered.Dockerfile` 防止意外提交。  

---

## 🎯 影响范围  

| 受影响模块/组件 | 说明 |
|----------------|------|
| `container/` (Dockerfile、build.sh、dev scripts) | 全面重构，所有 CI、文档、示例、README 已改为使用 `render.py` |
| CI workflow (`.github/workflows/*`) | 依赖新 Action 与渲染脚本，原 `build.sh` 失效 |
| `docs/`、`fern/pages/`、`examples/**/README.md` | 文档链接、命令全部更新 |
| `tests/` | `tests/ci/test_build_sh.py` 被删除（不再测试旧脚本） |
| `container/templates/` | 新增 12+ 模板文件，涉及 `Dockerfile.template`、`dev.Dockerfile`、`local_dev.Dockerfile`、`aws.Dockerfile`、框架‑specific（vllm、sglang、trtllm）|
| `container/context.yaml` | 统一默认 ARG，帮助渲染时保持单一数据源 |
| `container/.gitignore` | 防止 `rendered.Dockerfile` 误入源码库 |

---

## 🔍 技术洞察  

### 1️⃣ 架构影响  
- **模块化 + 单一来源**：所有 Dockerfile 逻辑统一在模板中，`render.py` 负责把 **YAML** 参数（`context.yaml`）与 CLI 参数注入。  
  - **好处**：删掉 5 k+ 行重复 Dockerfile，降低维护成本、避免不同框架间的同步错误。  
  - **风险**：渲染层成为单点故障；模板语法错误或 `render.py` 回退会导致所有镜像构建不可用。  
- **构建入口统一**：CI、文档、手动构建均只需要 `python container/render.py …` + `docker build`，无须记忆复杂 `build.sh` 参数集合。  
- **兼容旧工作流**：虽然 `render.py` 可以通过 `--framework`、`--target` 完全复现旧行为，但 **所有外部脚本**（如自定义 CI、内部 dev‑container 配置）必须同步更新，否则会出现 “找不到 build.sh”的错误。  

### 2️⃣ 性能影响  
| 项目 | 老方案 | 新方案 | 预期影响 |
|------|--------|--------|----------|
| **Dockerfile 解析** | 每个框架都有独立文件，`docker build` 读取完整文件 (≈ 5 k 行) | 采用 **模板渲染** → 生成单文件（≈ 300 行）后构建 | 解析时间微降（几毫秒），对整体构建时间影响不大。 |
| **层缓存** | 多个 Dockerfile 中重复的 `FROM`、`RUN` 产生多份相同层，导致 **缓存失效**。<br>（每个框架都有自己的 `dynamo_base`、`wheel_builder`） | 通过 **统一模板**，相同 `ARG`、`RUN` 被统一在同一层；**多阶段**（base → wheel_builder → runtime）复用**相同的缓存键**。| 预计 **构建时间 15‑30%** ↓，尤其在 CI 多平台（amd64/arm64）下缓存复用更佳。 |
| **CI 编排** | `build.sh` 负责生成临时合并 Dockerfile、处理缓存、`--load`、`--push`，脚本里有大量 `set -e`/`PIPESTATUS` 检查，维护成本高。 | 迁移到 **GitHub Action**（`docker-build`/`docker-remote-build`），使用 `docker buildx` 原生命令，**缓存、push、no‑load** 统一通过 Action 参数控制。| CI 步骤更稳定（官方 Action 已经经过大量测试），减小脚本维护风险。 |
| **构建并行** | `build.sh` 在 `dev` 阶段会 *concatenate* 两个 Dockerfile，导致一次性上传大量中间层。 | 渲染后一次性 `docker buildx`，借助 **BuildKit** 自动并行化。| 并行度提升，尤其在多核 CI 节点上更快。|

### 3️⃣ 安全影响  

| 维度 | 老方案 | 新方案 | 评估 |
|------|--------|--------|------|
| **脚本注入** | `build.sh` 只接受 **固定** 参数，风险低。 | `render.py` 使用 **Jinja2** 渲染，可在模板中执行任意 Python 表达式（如果模板被恶意篡改）。 | 只在 **受信任的源码仓库** 中使用；建议在 CI 中使用 `pip install "jinja2<4"`（避免未锁定的外部代码），并在 PR 审查中严格审查 `container/templates/`。 |
| **参数泄露** | `build.sh` 会在 `docker run` 中直接传递 `--build-arg`，若 CI 环境变量泄露可能暴露 **AWS secret**、`SCCACHE` 密钥。 | `render.py` 同样通过 `--build-arg` 传递，但 **GitHub Action** 已经使用 `--secret` 机制（如 `AWS_KEY_ID`）在 `docker buildx` 中安全注入。 | 保持相同安全等级，且新方案更明确地使用 `--secret`（见 `docker-build` Action）。 |
| **镜像完整性** | 通过 `docker build` + `--load` 后立即推送，无法在本地校验。 | CI 现在在 **build** 步骤中先 **`--load`**（本地镜像）再通过 `docker push`，可以在推送前执行 `docker image inspect` 或安全

---

### feat: add NIXL check to sanity_check (#6087)
**SHA**: `241cc78` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/241cc7833a3f9b73f877c7b9eed5c6c8b98245ff)

**🎯 变更类型**：功能增强  
**⚡ 重要程度**：🔴高  
**📋 变更摘要**：在 `deploy/sanity_check.py` 中新增 `NixlInfo` 节点，用于检测 NIXL（Python wheel + 原生共享库）是否已正确安装以及库文件 `libnixl.so` 能否加载。该信息会在 san­ity‑check 输出中以 “✅ NIXL: <version>” 形式呈现，帮助运维快速定位因 NIXL 缺失或加载异常导致的运行时错误。  

**🎯 影响范围**：  
- `deploy/sanity_check.py`（健康检查脚本）  
- 依赖该脚本的部署/CI 流程、运维监控平台  
- 与 NIXL 相关的可选功能（如 CUDA 加速的推理）间接受影响  

**🔍 技术洞察**：  
- **架构影响**：  
  - 属于 *观察层*（diagnostic layer），不侵入 Dynamo 核心业务逻辑或模型推理路径。  
  - 通过 `importlib.metadata` 动态发现所有以 `nixl*` 为名的分发包，避免硬编码 CUDA 版本，提升对未来 NIXL 变体的兼容性。  
  - 添加的 `NixlInfo` 通过父节点 `PythonInfo` 自动嵌入到整体 sanity‑check 树中，保持一致的报告结构。  

- **性能影响**：  
  - 检测过程主要是读取 Python 包元数据和一次 `ctypes.CDLL("libnixl.so")` 调用，耗时极低（毫秒级），对健康检查脚本的整体执行时间影响可忽略。  
  - 若系统缺少 `libnixl.so`，`ctypes.CDLL` 将抛出 `OSError`，捕获后仅返回错误信息，仍然是常数时间路径。  

- **安全考虑**：  
  - 脚本仅 **加载**（不执行） `libnixl.so`，不涉及调用任何函数，风险极低。  
  - 采用 `try/except` 捕获 `OSError`，防止加载失败导致脚本崩溃，保证检查的鲁棒性。  
  - 读取环境变量 `NIXL_PREFIX` 属于信息展示，不泄露敏感数据。  

**⚠️ 潜在风险**：  
1. **误报/漏报**：在非标准库路径（例如通过 `LD_LIBRARY_PATH` 指定的自定义位置）下，`ctypes.CDLL("libnixl.so")` 可能加载失败，导致 “warning” 状态，即便库实际可用。  
2. **跨平台兼容性**：当前仅检查 Linux 下的 `libnixl.so`，在 Windows/macOS 环境（若未来支持）会产生 `OSError` 并误报。  
3. **依赖 `importlib.metadata`**：Python 3.7 以下不提供此模块，脚本在极旧环境中会得到空的 `dist_versions`，状态会显示为 “UNKNOWN”。  
4. **环境变量冲突**：若用户自行定义 `NIXL_PREFIX` 指向错误路径，报告会误导运维。  

**💡 关注建议**：  
- **运维侧**：在部署机器上确认 `LD_LIBRARY_PATH` 或系统默认库搜索路径包含 NIXL 的安装目录，必要时在 `sanity_check` 前通过 `export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/nvidia/nvda_nixl/lib` 进行补齐。  
- **CI/CD**：加入对 `sanity_check` 输出的断言，确保在需要 NIXL 功能的镜像中报告为 `OK`，否则阻止镜像发布。  
- **代码层面**：  
  1. 考虑在 `NixlInfo` 中加入对 `LD_LIBRARY_PATH` 的可视化检查，帮助定位库搜索路径问题。  
  2. 为跨平台做好预留（如 `libnixl.dylib`、`nixl.dll`），或在脚本开头检测平台并相应切换名称。  
  3. 在文档中注明 `sanity_check` 只做“可加载性”检测，不代表库功能完整可用，实际运行时仍需进行业务级验证。  
- **回滚策略**：如果出现大量误报，可通过环境变量 `DISABLE_NIXL_CHECK=1`（在脚本中自行实现）临时关闭该节点，保持健康检查的可用性。  

---  

*此分析基于代码差异，仅涉及 `sanity_check.py` 的诊断功能，不影响 Dynamo 核心运行时行为。*

---

### feat: expose Python Prometheus metric via DynamoComponentMetrics (#5817)
**SHA**: `027d265` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/027d2653a5bbcc24be9cb668e45baa5379eec632)

**🎯 变更类型**：功能增强  

**⚡ 重要程度**：🔴 高  

**📋 变更摘要**  
本次提交在 Dynamo 项目中新增并公开了 Python 侧的 Prometheus 度量，用以监控 LLM 后端（SGLang、TensorRT‑LLM、vLLM）关键资源。核心实现为 `LLMBackendMetrics` 类及一套专用的 `CollectorRegistry`，暴露 `total_blocks`、`gpu_cache_usage_percent`、`model_load_time_seconds` 三个指标，并在各后端初始化、运行时以及统计日志中注入相应的 gauge 更新逻辑。  

**🎯 影响范围**  
- `components/src/dynamo/common/utils/prometheus.py`（新增 `LLMBackendMetrics`）  
- 各后端入口：`sglang/main.py`、`trtllm/main.py`、`vllm/main.py`  
- 各后端 Publisher 实现：`sglang/publisher.py`、`trtllm/publisher.py`、`vllm/publisher.py`  
- 相关注册与回调函数：`prometheus.py`、`sglang/publisher.py`、`trtllm/publisher.py`、`vllm/publisher.py`  
- 新增常量定义：`lib/bindings/python/src/dynamo/prometheus_names.py`、`lib/runtime/src/metrics/prometheus_names.rs`  
- 单元测试扩展：`tests/utils/payloads.py`  

---

### 🔍 技术洞察  

| 维度 | 影响描述 |
|------|----------|
| **架构影响** | 1. 引入 **专用 Registry** `DYNAMO_COMPONENT_REGISTRY`，将 Dynamo 组件的度量与后端（sglang/trtllm/vllm）度量解耦，避免 MultiProcessCollector 与外部后端 collector 冲突。<br>2. `LLMBackendMetrics` 将 gauge 的创建与标签绑定（`model`、`component`、`dp_rank`），统一入口提供给所有后端 Publisher，提升度量统一性。<br>3. 各后端 `init` 流程被改写：在模型加载完成后立即记录 `model_load_time_seconds`，并在运行时将 `total_blocks` 与 `gpu_cache_usage_percent` 随 KV 事件或统计日志实时更新。|
| **性能影响** | - **采集开销**：Gauge 更新是原子写操作，耗时在微秒级；在高并发 KV 事件（如每 batch）下额外增加一次 dict‑lookup 与写入，整体影响可忽略 (<0.1% CPU)。<br>- **内存占用**：每个 `dp_rank`、`model`、`component` 组合会产生一个时间序列。若模型/组件数量和 DP‑rank 较多，需监控卡片基数，防止 OOM。<br>- **多进程兼容**：使用 `multiprocess_mode="max"` 的 Gauge，兼容 `PROMETHEUS_MULTIPROC_DIR`，但仅在 SGLang 启用 `--enable-metrics` 时才会创建 MultiProcessCollector，避免不必要的文件 I/O。|
| **安全考虑** | - **信息泄露**：Metric 中带有 `model` 名称（如 `"Qwen/Qwen3-0.6B"`），在公开的 Prometheus 端点时会暴露模型资产信息，需在生产环境通过网络层或指标路由进行访问控制。<br>- **注册冲突**：若外部组件错误复用相同 metric 名称或标签集合，会导致 `ValueError: duplicated timeseries`，建议在文档或代码中明确前缀 `dynamo_component_`。 |
| **可维护性** | - **统一接口**：`LLMBackendMetrics` 抽象出所有后端共同需要的 gauge，后续新增后端仅需实例化一次并调用 `set_*`，降低重复代码。<br>- **测试覆盖**：通过 `tests/utils/payloads.py` 扩展对新指标的正则校验，确保指标格式（包括科学计数法）正确解析。<br>- **代码分散**：各后端的 `component_gauges` 参数需要在多处显式传递，易出现忘记注入的 bug；建议在 `get_publisher` 系列函数中统一返回包含 gauge 的对象或使用工厂模式封装。 |

---

### ⚠️ 潜在风险  

1. **标签基数爆炸**  
   - `dp_rank`、`model`、`component` 组合若在大规模集群（数百个 DP‑rank、数十种模型）中使用，会导致指数级时间序列，Prometheus 存储和查询开销显著上升。  
2. **多进程模式误配置**  
   - `PROMETHEUS_MULTIPROC_DIR` 未设置或设置错误时，`multiprocess_mode="max"` 的 Gauge 会报错或返回 0，导致监控缺失。  
3. **遗漏 `component_gauges` 注入**  
   - 某些初始化路径（如单元测试或未来新后端）若未传入 `component_gauges`，在 `create_stat_logger` 中会触发断言，导致服务启动失败。  
4. **Metric 名称冲突**  
   - 其他第三方库若使用相同前缀 `dynamo_component_`，Prometheus 注册阶段会抛出 `ValueError: duplicated timeseries`。  
5. **模型名称泄露**  
   - 对外开放的 `/metrics` 端点会直接展示模型全名，可能被外部抓取用于攻击或版权争议。  

---

### 💡 关注建议  

| 方向 | 建议 |
|------|------|
| **监控运营** | - 在生产环境对 `/metrics` 进行网络层 ACL 限制，只允许内部监控系统访问。<br>- 定期审计 Prometheus 中 `dp_rank`、`model`、`component` 组合的基数，若超过阈值（如 5000）需考虑聚合或拆分。 |
| **配置与部署** | - 在启动脚本中明确 `PROMETHEUS_MULTIPROC_DIR`（如 `/tmp/prometheus_multiproc`）并在容器退出前清理该目录，以防残留旧文件导致重复采集。<br>- 为所有后端统一 `--enable-metrics` 开关，确保 MultiProcessCollector 与 `LLMBackendMetrics` 同步开启/关闭。 |
| **代码质量** | - 将 `LLMBackendMetrics` 的实例化封装进一个工厂函数 `create_component_metrics(model, component, registry)`，并在 `get_publisher` 系列统一调用，避免忘记注入。<br>- 为 `set_total_blocks`、`set_gpu_cache_usage`、`set_model_load_time` 添加异常捕获并记录到日志，防止异常导致指标不更新。 |
| **安全** | - 在 `prometheus_names.prometheus_names` 中为 `model`、`component` 标签添加正则白名单（只允许字母数字、下划线），防止标签注入攻击。 |
| **测试** | - 扩展 CI 中的指标验证，覆盖科学计数法（e.g., `8.34e-05`）以及边界值（0、1.0、极大块数）。<br>- 为多进程场景编写集成测试：启动两个子进程分别写入相同 gauge，验证 `multiprocess_mode="max"` 合并后值为最大值（符合业务需求）。 |
| **文档** | - 在项目 README 或 Prometheus 章节中说明新指标的含义、标签约定以及推荐的告警阈值（如 `gpu_cache_usage_percent > 0.9`）。 |



---

### feat: Add SGLang /engine weight update endpoints (#6094)
**SHA**: `56a1b6e` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/56a1b6e3141fdc8145cd8bda20a6a289d9d944bd)

**🎯 变更类型**：功能增强  
**⚡ 重要程度**：🔴高  
**📋 变更摘要**：在 `handler_base.py` 中为 SGLang 引擎新增一组权重更新相关的 HTTP 接口（磁盘、张量、分布式、IPC、版本切换），实现无重启在线热更新模型权重，并在路由表中注册对应路由。目标是提升模型迭代和部署效率，降低服务停机时间。  

**🎯 影响范围**：  
- `components/src/dynamo/sglang/request_handlers/handler_base.py`（新增 API 实现与路由）  
- `engine.tokenizer_manager`（权重加载、切换、请求中止等逻辑）  
- 可能涉及的底层 SGLang `srt.managers.io_struct` 结构体及其实现  

**🔍 技术洞察**：  
- **架构影响**：  
  - 在原有的 Engine → TokenizerManager 调度链上加入了多条“热更新”路径，使权重管理从单一启动时加载转为多种运行时来源（磁盘、张量、分布式、IPC）。  
  - 新增的 `update_weight_version` 通过直接修改 `server_args.weight_version` 实现版本切换，属于全局状态变更，需要确保所有子模块能够感知并使用最新版本。  
  - 通过 `runtime.register_engine_route` 将这些 API 暴露给外部调用，意味着外部系统（如模型管理平台）可以直接驱动模型热更新。  

- **性能影响**：  
  - **暂停请求**：`update_weights_from_disk` 返回 `num_paused_requests`，暗示在加载过程中会暂停正在执行的请求。大量并发请求时可能导致短暂的吞吐下降或请求排队。  
  - **内存占用**：从磁盘/张量加载新权重时需在内存中保留旧权重直至切换完成，短时间内可能出现峰值内存增长。  
  - **分布式同步**：`update_weights_from_distributed` 依赖网络通信与多节点协调，潜在的网络抖动会影响更新时延。  
  - **IPC**：若用于 checkpoint‑engine 交互，IPC 读取速度快但需要注意跨进程同步开销。  

- **安全考虑**：  
  - 这些接口直接接受用户提供的 JSON 并实例化 `Update*ReqInput`，若缺乏严格的字段校验或权限控制，攻击者可能利用不当的路径注入、路径遍历或恶意张量数据导致任意文件读取或内存破坏。  
  - `update_weight_version` 可在不更换权重的情况下修改全局版本号，若被未授权调用者滥用，可能导致业务逻辑误判（例如日志、监控、路由依据版本号）。  
  - 需要确保调用链路（如 HTTP/REST）已加固鉴权（OAuth、API‑Key）并在内部网络或 VPN 中运行，防止外部未授权访问。  

**⚠️ 潜在风险**：  
1. **并发一致性**：在权重切换期间，正在进行的推理请求可能仍使用旧权重，引发结果不一致或异常。  
2. **资源泄漏**：如果加载新权重失败或中途异常退出，旧权重可能未被释放，导致内存泄漏。  
3. **死锁/请求阻塞**：`abort_all_requests` 只在 `update_weight_version` 中使用，若其他路径未妥善处理挂起请求，可能导致请求永远卡住。  
4. **异常安全**：缺少对 `Update*ReqInput` 构造时可能抛出的异常捕获，异常会导致整个 handler 协程崩溃。  
5. **安全绕过**：未在路由层面加入权限校验，任何能够访问 Engine Runtime 的客户端均可触发权重更新。  

**💡 关注建议**：  
- **加固鉴权**：在 `register_engine_route` 前后统一加入权限校验中间件，限制只有可信的运维或 CI 系统能够访问。  
- **参数校验**：为每个 `Update*ReqInput` 添加 Pydantic（或类似）校验，限制文件路径、张量维度、版本号格式，防止恶意输入。  
- **事务化更新**：实现“加载 → 验证 → 切换”三阶段，确保新权重完整且可用后再正式切换，避免半成品权重导致推理错误。  
- **监控 & 报警**：在更新入口记录 `num_paused_requests`、内存使用峰值、成功/失败率，并在异常时触发告警。  
- **回滚机制**：若更新失败，自动恢复到上一次成功加载的权重，并恢复被暂停的请求。  
- **并发控制**：使用读写锁或原子引用计数，确保在权重切换期间新请求只能使用“新”或“旧”权重的统一版本。  
- **单元/集成测试**：新增针对每个更新路径的测试，用模拟高并发请求验证暂停、恢复以及异常恢复的正确性。  

通过以上措施可以在保持在线热更新便利性的同时，降低对服务可用性、性能和安全的潜在冲击。

---

### fix: profiler deployment timeout handling for MoE models (#6086)
**SHA**: `67329d1` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/67329d10234c760b8aedbf1e3611821b4a49cabe)

**🎯 变更类型**：Bug修复  
**⚡ 重要程度**：🔴高  
**📋 变更摘要**：在 Profiler 基准测试的 prefill 与 decode 两个阶段，为 `client.wait_for_deployment_ready()` 增加超时异常捕获。超时时记录错误、清理对应的部署并跳过该并行映射，防止单个部署超时导致整个 profiler 任务崩溃。  
**🎯 影响范围**：`benchmarks/profiler/profile_sla.py`（profiling 逻辑）以及 `benchmarks/profiler/utils/config_modifiers/parallelization_mapping.py`（函数签名格式化，仅代码可读性改动）。  

---

### 🔍 技术洞察

| 维度 | 影响描述 |
|------|----------|
| **架构影响** | - 为 Profiler 引入了 **容错层**：超时不再抛至最外层，使得 profiler 作业能够在多 GPU 并行映射中继续执行。<br>- 通过 `add_profiling_error` 将错误写入统一的错误收集点，保持错误信息在后续报告或分析阶段可见。<br>- 清理逻辑 (`await client.delete_deployment()`) 防止因超时留下悬挂的部署实例，避免资源泄漏。 |
| **性能影响** | - 额外的 `try/except` 与日志写入开销极小，几乎可以忽略不计。<br>- 通过及时删除超时部署，能够释放 GPU 与网络资源，间接提升后续成功部署的启动速度。 |
| **安全考虑** | - 此次改动不涉及安全敏感功能或权限变更。<br>- 通过捕获特定的 `TimeoutError` 防止异常信息泄露至调用栈外部，降低意外暴露内部实现细节的风险。 |
| **可维护性** | - 增强了代码可读性：在 `get_candidate_parallel_mappings` 的函数参数上采用换行格式，保持与 `profile_sla.py` 调用风格一致。<br>- 错误处理路径统一，后续若需扩展至重试或告警，只需在该块中添加即可。 |

---

### ⚠️ 潜在风险

1. **异常捕获范围过窄**  
   - 只捕获 `TimeoutError`，若 `wait_for_deployment_ready` 抛出子类异常或其他异常（如网络错误），仍会导致整个 profiler 任务中断。  
2. **删除部署的幂等性**  
   - 若部署已经在其他线程/进程中被删除或进入错误状态，`await client.delete_deployment()` 可能再次抛异常，未被捕获。  
3. **错误累计导致报告失真**  
   - 多次超时仅记录为错误信息，若后续分析未考虑这些缺失的映射，可能误判模型性能。  
4. **并发列表修改安全性**  
   - `deployment_clients.remove(client)` 在遍历 `deployment_clients` 之外进行，一般安全，但若后续代码对该列表再次迭代，需确认未产生竞争条件。  

---

### 💡 关注建议

1. **扩展异常捕获**  
   - 建议捕获 `Exception`（或至少 `ClientError`、`NetworkError`）并在日志中记录堆栈，以防意外中断。  
2. **实现删除部署的容错**  
   - 在 `await client.delete_deployment()` 外层再加一次 `try/except`，记录删除失败但继续执行清理。  
3. **加入重试机制（可选）**  
   - 对于可恢复的超时（如短暂的资源争用），可以在捕获后尝试一次或两次重试，以提升成功率。  
4. **错误统计与监控**  
   - 将 `add_profiling_error` 的调用与统一的监控系统（Prometheus/Datadog）对接，便于观察超时频率并及时优化部署配置。  
5. **文档与用户提示**  
   - 在 Profiler 使用文档中注明 `--deployment-timeout` 参数的作用与默认值，提醒用户在高负载环境下适当调大。  
6. **单元/集成测试**  
   - 增加针对超时路径的测试，模拟 `wait_for_deployment_ready` 抛 TimeoutError，验证日志、错误收集、部署清理的完整流程。  

通过上述改进，Profiler 将在面对不稳定的部署环境时保持更高的鲁棒性，避免单点故障导致的大规模任务中断，同时保持资源的及时回收。

---

### feat: text to image vLLM Omni (#5912)
**SHA**: `9f76d06` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/9f76d0606c95778fb084b5ea59b1eb0f30dc650e)

**🎯 变更类型**：功能增强 / 多模态支持（text‑to‑image）  
**⚡ 重要程度**：🔴 高  

**📋 变更摘要**  
- 在 `vllm` 组件中加入对 **vLLM‑Omni** 的集成，使 Dynamo 能够以 OpenAI‑compatible 接口运行多阶段 **text‑to‑image**（以及已有的 text‑to‑text）模型。  
- 重构 `args.py`、`main.py`、`omni_handler.rs`；在后端实现 **AsyncOmni** 调用、输出格式从纯 token‑IDs 迁移到 **OpenAI‑style chat chunks**，并在返回中支持 **base64 PNG**（图片）以及未来的 video/audio。  
- 扩展公共协议：在 `async-openai` 中新增 `ChatCompletionMessageContent`（Text | Parts），并在 `llm` 相关层面加入 `OutputType`、`ContentPart`、`ImageUrlData` 等结构。  
- 增加 **Images** 模型类型，修改模型发现/热更新逻辑、Python 绑定、文档与示例脚本，提供 `--omni` 与可选 `--stage-configs-path` 标志。  

**🎯 影响范围**  
| 模块/层级 | 受影响文件/功能 |
|-----------|----------------|
| **CLI & 启动脚本** | `components/src/dynamo/vllm/args.py`, `components/src/dynamo/vllm/main.py` |
| **Omni 业务逻辑** | `components/src/dynamo/vllm/omni/omni_handler.py` |
| **协议层** | `lib/async-openai/src/types/chat.rs`, `lib/llm/src/protocols/openai/*`（aggregator、delta、jail、responses） |
| **后端引擎** | `lib/llm/src/protocols/common/llm_backend.rs`（新增 OutputType & ContentPart） |
| **模型发现/热更新** | `lib/llm/src/discovery/*`（加入 Images 模型） |
| **Python 绑定** | `lib/bindings/python/rust/lib.rs` |
| **文档 & 示例** | `docs/backends/vllm/vllm-omni.md`, `examples/backends/vllm/launch/*` |
| **测试套件** | 大量单元/集成测试更新以适配新枚举 |

---

## 🔍 技术洞察

| 维度 | 影响分析 |
|------|----------|
| **架构影响** | 1. **新增模型类别 `Images`**：模型管理器、热更新、路由器全部需要感知该类型，导致向上兼容的代码路径(例如 `ModelType::as_endpoint_types`) 需要重新评审。<br>2. **Omni 控制流**：`OmniHandler` 现在同时处理 **文本** 与 **图像** 两类 `final_output_type`，并在 `generate` 中分流到 `_generate_openai_mode` 与 `_generate_token_mode` 两套实现，保持向后兼容但增加了分支复杂度。<br>3. **协议统一**：所有 OpenAI‑compatible responses改为 `ChatCompletionMessageContent`（Text | Parts），在底层 **LLMEngineOutput** 加入 `output_type` 与 `content_parts`，对上层所有流处理（聚合、jail、reasoning、tool‑call）均需适配。<br>4. **后端抽象**：`AsyncOmni` 使用 `OmniTextPrompt`（而非旧的 `TokensPrompt`），意味着 token‑based前端仍可走 `--omni`‑off 但内部代码必须验证 `use_vllm_tokenizer` 与 `omni` 的耦合关系。 |
| **性能影响** | - **图片生成**：返回的 PNG 经过 `base64` 编码后会在内存中产生约 1.33×（4/3）膨胀的字符串。对**流式**返回的首块仍是文本，直到最后一个 `image` 阶段才产生大块 payload，可能导致 **网络 RTT** 增大，尤其在高并发场景下需评估 `MAX_MESSAGE_SIZE` 与 `grpc`/`http` 传输限制。<br>- **Omni 调度**：`AsyncOmni.generate` 现在遍历多阶段输出，每个阶段都会触发一次 `await`，增加了 **CPU 上下文切换**，对单模型单 GPU 的吞吐率有轻微下降（预计 5‑10%），但获得的多模态能力值得此代价。<br>- **日志与 Base64 编码**：在 `OmniHandler._format_image_chunk` 中对每张图片 `PNG` 进行 `save` → `BytesIO` → `base64`，若一次生成多张图片（如 diffusion 多步），CPU 编码成本会显著上升。建议在生产环境开启 **异步/分片** 编码或直接返回原二进制流（如 `multipart/mixed`)。 |
| **安全考虑** | - **模型加载**：`--stage-configs-path` 仍是可选，但如果提供了恶意 YAML，可能导致 **任意代码执行**（vLLM‑Omni 支持 `trust_remote_code`，默认可关闭）。现在默认 `trust_remote_code` 仍从 `engine_args` 传递，仍需在部署规范中限制。<br>- **图片数据泄露**：返回的 `data:image/png;base64,…` 在日志或监控系统中会被原样记录，可能泄露敏感生成内容。建议在 `log_level=info` 时过滤 `image_url` 字段，或在生产环境只返回图片 **URL**（指向对象存储）而非直接嵌入。<br>- **输入验证**：`_extract_text_prompt` 只取 `messages.role == "user"` 的 `content`，但未对 **HTML/JS** 进行清洗，若前端直接把返回 content 渲染到网页，可能产生 **XSS**。<br>- **资源隔离**：Omni 可能调度多个阶段（LLM + diffusion），每个阶段消耗显存。若未对显存进行统一调度，单用户请求可能导致 **OOM**，影响其它请求。 |
| **可维护性** | - 大量 **枚举改动**（`ChatCompletionMessageContent`, `OutputType`, `ContentPart`）已在全库迁移，代码路径被分散至多个 `match` 分支，容易遗漏。未来如果再加入 **video/audio**，需要再次同步更新所有 `*_content.as_ref()` 检查。<br>- 测试文件已大量改写，覆盖了文本路径，但对 **图片** 路径的单元测试仅覆盖了 **base64** 转换，缺少 **多阶段管线错误传播** 场景。<br>- `OmniHandler` 中的 `_generate_token_mode` 已标记 “Not used right now”，若后续需要保留，建议标注 `#[allow(dead_code)]` 或直接删除以免产生误导。 |

---

## ⚠️ 潜在风险

| 风险点 | 可能后果 | 触发条件 |
|--------|----------|----------|
| **向后兼容性破坏** | 老的客户端仍然期望 `content: String`，在收到 `content: {type:"image_url", …}` 时解析失败。 | 客户端未升级到支持 `ChatCompletionMessageContent`（尤其是第三方 SDK）。 |
| **显存 / OOM** | 多阶段 pipeline（LLM → Diffusion）在同一 GPU 上并行占用显存 → 进程被杀。 | 大模型 + 高分辨率图片，或并发请求数 > 1。 |
| **网络/带宽压迫** | 大批量图片返回导致

---

### fix: DeepSeek V3.2 chat template FC and SO support (#6034)
**SHA**: `7202ced` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/7202ced7b46d91d71ef677aff6612ca2792244a0)

**🎯 变更类型**：Bug 修复 / 功能完善  
**⚡ 重要程度**：🔴 高  
**📋 变更摘要**：  
1. 为 `OAIChatLikeRequest` trait 新增 `response_format()` 方法，并在 OpenAI‑compatible `NvCreateChatCompletionRequest` 实现中返回相应字段，以支持结构化输出。  
2. 在 DeepSeek V3.2 Prompt Formatter 中加入对 `tools` 与 `response_format` 的注入逻辑：在首个 system 消息中嵌入这两块信息，若不存在则自动创建 system 消息。  
3. 大量单元测试覆盖工具注入、响应格式注入以及两者共存的场景，确保实现的正确性。  

**🎯 影响范围**：  
- `lib/llm/src/preprocessor/prompt.rs`（Trait 定义）  
- `lib/llm/src/preprocessor/prompt/template/oai.rs`（OpenAI 请求实现）  
- `lib/llm/src/preprocessor/prompt/deepseek_v32.rs`（DeepSeek V3.2 Prompt 渲染）  
- 相关单元测试文件（覆盖 DeepSeek V3.2）  

**🔍 技术洞察**  
- **架构影响**  
  - **扩展性**：通过在统一的 `OAIChatLikeRequest` trait 中加入 `response_format`，所有实现（包括未来自定义请求）天然获得结构化输出能力，无需在每个实现里单独加入。  
  - **解耦**：DeepSeek V3.2 Formatter 只依赖 `tools()` 与 `response_format()` 接口，不再硬编码请求结构，提升了模型‑formatter 的耦合度。  
  - **向后兼容**：默认实现返回 `None`，对未使用该特性的旧模型不产生影响。  

- **性能影响**  
  - 仅在渲染阶段多做一次 JSON 序列化 (`serde_json::to_value`) 与对象克隆，开销在毫秒级别，可忽略。  
  - 由于在 `messages_array` 上使用 `clone()`（深拷贝），如果单条请求的消息体极大（数千条、每条数 KB），会产生额外的内存开销。建议在后续优化时考虑 `Arc` 或原地修改（在确保不破坏共享数据的前提下）。  

- **安全考虑**  
  - **输入校验**：`tools` 与 `response_format` 直接序列化为 JSON 并写入 prompt，理论上若用户提供恶意 JSON（如循环引用、极大嵌套深度），可能导致序列化卡顿或内存膨胀。当前依赖 `serde_json` 的安全性，但建议在 API 边界加上大小/深度限制。  
  - **信息泄露**：注入的 `response_format` 会被模型看到，确保该字段不包含敏感信息（如内部 schema 名称、凭证等）。  

**⚠️ 潜在风险**  
1. **消息顺序变化**：当原始请求缺失 `system` 消息时，Formatter 会在数组头部插入一个空 `system` 消息，可能影响部分依赖严格消息顺序的后端模型（尽管 DeepSeek 文档要求如此），需要在文档中明确说明。  
2. **与其它 Formatter 冲突**：其他模型的 Prompt Formatter 仍会使用 `messages_array.clone()`，如果后续有人在通用路径上修改 `messages_array`，可能导致意外副作用。  
3. **序列化失败**：如果 `tools` 或 `response_format` 包含不被 `serde` 支持的类型，`to_value` 将返回错误并导致整个渲染失败。当前已使用 `context` 包装错误，调用方需要捕获。  

**💡 关注建议**  
- **文档更新**：在 DeepSeek V3.2 使用手册中说明：*当请求包含 `tools` 或 `response_format` 时，它们会被写入系统消息；若不存在系统消息，库会自动创建空的系统消息并填充这些字段*。  
- **API 限额**：在接受外部 `tools`/`response_format` 参数的入口（如 HTTP API）加上大小限制（如 ≤ 32KB）和深度限制，防止 DoS。  
- **回归测试**：将上述单元测试加入 CI（已提交），并在未来新添加的模型 formatter 中确保不遗漏对 `response_format` 的处理。  
- **性能监控**：如果项目对大批量、多轮对话有高吞吐需求，考虑对 `messages_array.clone()` 进行基准测试并在必要时改为浅拷贝或就地修改。  

总体而言，此次变更完善了对 DeepSeek V3.2 “function calling (FC)” 与 “structured output (SO)” 的支持，提升了库的模型兼容性和功能完整度，风险可控。

---

#### 🟡 中重要度变更 (7)

### fix: sanitize docker tags on main to arm64/amd64 removing 'linux/...' (#6108)
**SHA**: `d8feb93` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/d8feb93ca3003265c4bd823d8051ce0b911fef20)

**🎯 变更类型**：Bug 修复  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：在 GitHub Actions 工作流 `build-test-distribute-flavor.yml` 中，将 Docker 镜像标签拼接时的平台变量从硬编码的 `"$PLATFORM"` 替换为工作流输入 `${{ inputs.platform }}`，避免出现 `linux/arm64`、`linux/amd64` 等前缀，确保生成的标签符合 ECR 规范。  

**🎯 影响范围**：  
- `.github/workflows/build-test-distribute-flavor.yml`（CI/CD 构建、发布流程）  
- 依赖该工作流的镜像推送与标签生成过程  

**💡 关注建议**：  
1. **验证 inputs 定义**：确认工作流 `inputs.platform` 已在 `on.workflow_dispatch` 或 `workflow_call` 中正确定义，且默认值为 `arm64`、`amd64` 等，以防止空值导致标签错误。  
2. **兼容性测试**：在本地或测试分支运行一次完整的 CI，检查生成的镜像标签是否形如 `.../ai-dynamo/dynamo:<tag>-arm64`，并确认 ECR 能接受。  
3. **文档同步**：更新项目 README 或 CI 文档，说明平台参数的来源及取值范围，避免使用者误将 `linux/` 前缀写入 `inputs.platform`。  
4. **回退方案**：若出现旧标签仍被使用的情况，保留旧的 `${{ secrets.AWS_ACCOUNT_ID }}…:${tag}-${PLATFORM}` 逻辑作为 fallback，或在脚本中加入简单的前缀清理（如 `sed 's/linux\///'`）。  

总体而言，此次修改仅影响 CI 中的标签拼接，不会改变业务代码，但需确保工作流输入的正确性与文档同步，以避免发布异常。

---

### fix: increase router E2E timeouts in preparation for enabling xdist (parallel pytest) later (#6085)
**SHA**: `5755a8d` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/5755a8dec365b6d13765db18498a4e8ba76fa377)

**🎯 变更类型**：Bug 修复（防止并行化后测试因超时而失败）  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
本次提交把 `tests/router/test_router_e2e_with_mockers.py` 中多个 E2E 测例的 `@pytest.mark.timeout` 从原来的 20 ~ 90 秒提升至 90 ~ 180 秒，注释中说明是为后续使用 `xdist`（并行 pytest）预留足够的时间。  

**🎯 影响范围**  
- 仅影响 **router E2E 测试**（核心模块 `router` 与 `kv` 交互的端到端场景）。  
- CI/CD 中执行这些测试的作业时长将显著增长。  

**💡 关注建议**  
1. **CI 超时配置**：确认 GitHub Actions、GitLab CI 等流水线的全局超时足够覆盖单次运行的累计时长，避免因整体作业超时而导致误报。  
2. **性能基线**：延长 timeout 会掩盖性能退化。建议在 CI 中保留单独的“性能基准”作业，记录实际耗时，若出现显著增长及时告警。  
3. **并行化准备**：在开启 `pytest -n X` 前，确保所有占用共享资源（端口、临时文件等）的 fixture 已实现并发安全，否则即使 timeout 增大，也可能出现竞争导致 flaky。  
4. **文档同步**：更新 CONTRIBUTING/README 中关于 E2E 测试运行时长的说明，提醒贡献者在本地执行时相应增大 `pytest` 超时或使用 `-n`。  
5. **回滚阈值**：若未来发现某些测试经常接近新上限，考虑拆分或优化对应业务路径，而不是继续无限提升 timeout。  

总体而言，此次改动仅是测试元数据的放宽，对生产代码无直接影响，但会拉长 CI 时间并可能掩盖潜在性能问题，请按上面建议进行相应的 CI 调整和并发安全检查。

---

### fix: test_router_decisions async fix race condition (#6084)
**SHA**: `f51ec24` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/f51ec24d6fcda650ca32a5475d903ef3bbed7a7b)

**🎯 变更类型**：Bug 修复（启动阶段 race 条件）  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：在 `MockVllmEngine::direct` 中加入异步等待逻辑，防止在 `start_schedulers` 尚未完成时就访问 `request_senders` 导致 panic；通过环境变量 `DYN_MOCKER_SYNC_DIRECT` 保留旧的直接路径以供回退或对比。  
**🎯 影响范围**：`mocker` 模块（`lib/llm/src/mocker.rs`）以及运行时配置 (`lib/runtime/src/config/environment_names.rs`)；`AsyncEngine` 调用链也被改为 `await`。  

**💡 关注建议**  
1. **同步方式**：当前使用轮询 + `sleep(50ms)` 实现，虽然能解决 race，但会增加启动延迟并消耗线程。建议后续改为基于 `Notify`/`oneshot` 的信号机制，避免不必要的轮询。  
2. **超时配置**：硬编码 10 s 超时可能在 CI 环境足够，但在资源紧张的生产环境可能导致不必要的 panic。可以把超时阈值抽成可配置的 env 变量。  
3. **向后兼容**：保留 `DYN_MOCKER_SYNC_DIRECT=1` 的老路径已经实现，但文档需明确默认值为 `0`，并提醒用户仅在调试 race‑condition 场景下使用。  
4. **测试覆盖**：确认已有的 `test_router_decisions` 在两种路径下都通过；若还有并发启动的场景，补充相应的集成测试。  
5. **性能监控**：开启 `DYN_MOCKER_KV_CACHE_TRACE` 时，新增的等待逻辑可能掩盖性能瓶颈，建议在高负载下监控启动时长。  

总体而言，此次改动消除了因调度器初始化未完成导致的偶发 panic，提升了稳定性，后续可进一步优化等待实现和可配置性。

---

### docs: improve Fern sidebar titles, add guide subtitles, and replace ASCII diagrams with D2 (#6069)
**SHA**: `d14d6ff` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/d14d6ff49bda91215375e1752c6763e1d255d9e5)

**🎯 变更类型**：文档增强  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
- 新增 D2 源文件并生成 SVG 图（event‑plane‑coordination、event‑plane‑lease、planner‑architecture），替换原有 ASCII 框图。  
- 为 10+ Markdown 页面加入 `subtitle` Front‑matter，用于 Fern 侧栏标题/子标题显示。  
- 调整导航文件 `versions/next.yml` 中的页面名称，保持与实际文件对应。  

**🎯 影响范围**  
- `fern/` 目录下所有文档、侧栏导航、生成的站点页面。  
- CI/CD 中的文档构建步骤（D2 → SVG、Markdown → HTML）。  

**💡 关注建议**  
1. **构建验证**：确保 CI 环境已安装 D2 并在文档生成前执行 `d2 render`，否则 SVG 会缺失导致页面渲染错误。  
2. **路径一致**：检查 Markdown 中引用的图片路径（如 `/assets/img/event-plane-coordination.svg`）与 `fern/assets/img/` 实际路径保持一致，避免 404。  
3. **Front‑matter 兼容**：确认 Fern 站点生成脚本已识别并渲染 `subtitle` 字段；若未支持，需更新模板或删除该字段。  
4. **导航同步**：`versions/next.yml` 中的 `page` 与实际文件名必须一一对应，建议在 CI 加入链接检查，防止因拼写或路径错误导致侧栏失效。  
5. **回退方案**：若新 SVG 导致页面体积显著增加，可考虑压缩或使用 `viewBox` 优化；保持原 ASCII 图作为备选。  

整体而言，此次提交仅影响文档渲染，不会修改业务代码。请在本地和 CI 环境完整跑一次文档构建，确认所有新图、子标题以及侧栏链接均正常展示后再合并。

---

### refactor: use tempfile module instead of hardcoded /tmp paths (#5789)
**SHA**: `0ef41ff` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/0ef41ffe03c2f96701bb7705887a8e7d0e8740c8)

**🎯 变更类型**：重构  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
本次提交把项目中散落的硬编码 `/tmp` 路径改为使用 Python `tempfile` 模块获取系统临时目录，并在相应位置创建子目录。涉及的文件有 `encode_worker_handler.py`（编码缓存文件）、`dynamo_deployment.py`（日志目录）以及 `utils.py`（GPU‑Memory‑Service socket 路径）。

**🎯 影响范围**  
- `components/src/dynamo/vllm/multimodal_handlers/encode_worker_handler.py`：缓存文件位置从 `/tmp/encoder_cache.*.safetensors` 迁移到 `tempfile.gettempdir()/encoder_cache/`。  
- `deploy/utils/dynamo_deployment.py`：默认日志根目录从固定 `/tmp/dynamo_logs` 改为 `tempfile.gettempdir()/dynamo_logs`。  
- `lib/gpu_memory_service/common/utils.py`：socket 文件名从 `/tmp/gms_*.sock` 改为 `tempfile.gettempdir()/gms_*.sock`。  

**💡 关注建议**  

1. **清理机制**  
   - `EncodeWorkerHandler.cleanup` 仍是空实现，新的临时目录可能会留下大量 `.safetensors` 文件。建议在 `cleanup` 中递归删除 `self._cache_dir` 或提供显式的清理 API。  
   - `gpu_memory_service` 的 socket 文件在进程结束后也应被移除，防止残留导致端口冲突。  

2. **跨平台兼容**  
   - `tempfile.gettempdir()` 在 Windows 返回诸如 `C:\\Users\\<User>\\AppData\\Local\\Temp`，路径分隔符与 Linux 不同。代码已统一使用 `os.path.join`，但请在后续使用 `pathlib.Path` 进一步简化并避免手动拼接。  

3. **可配置性**  
   - 有时用户希望将缓存、日志或 socket 放到自定义位置（如 SSD 挂载点）。可以考虑通过环境变量或 CLI 参数覆盖 `tempfile` 默认值，而不是硬编码。  

4. **安全/权限**  
   - 虽然系统临时目录权限已由 OS 管理，但子目录（如 `encoder_cache`）仍应使用 `mode=0o700` 创建，以防其他用户读取敏感嵌入向量。  

5. **测试覆盖**  
   - 添加针对临时目录创建、写入、清理的单元测试，尤其是在 CI 环境下验证不同平台的路径正确性。  

**结论**  
改用 `tempfile` 提升了可移植性和安全性，但需补齐清理逻辑、提供可配置选项并确保跨平台路径处理一致。完成这些后，改动对现有功能的影响将基本为正向提升。

---

### fix: add watchdog timeout for sglang dsr1 recipe (#6076)
**SHA**: `1585244` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/1585244bc7004d4fc4f0f40d9c53994083251e25)

**🎯 变更类型**：Bug 修复  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
在 DeepSeek‑R1 sglang disagg 部署脚本（8 GPU、16 GPU 两套）中为 `prefill` 与 `worker` 两个子组件统一加入 `--watchdog-timeout "3600"` 参数，防止因长时间无心跳导致容器被 K8s 或外部 watchdog 误杀。

**🎯 影响范围**  
- `recipes/deepseek-r1/sglang/disagg-8gpu/deploy.yaml`  
- `recipes/deepseek-r1/sglang/disagg-16gpu/deploy.yaml`  

这两个 YAML 直接影响模型服务的启动脚本，属于运行时配置层面。

**💡 关注建议**  
1. **参数可配置化**：目前硬编码为 3600 s，建议抽成变量或放入统一的 recipe 参数，以便不同部署环境（如短任务或资源受限）灵活调节。  
2. **文档同步**：更新对应的 recipe README/CHANGELOG，说明新增 watchdog 机制及默认超时时间，避免使用者误以为行为未变。  
3. **回归测试**：添加一次启动‑停机的集成测试，验证加入 `--watchdog-timeout` 不会影响已有的负载均衡逻辑（如 `--prefill-round-robin-balance`、`--load-balance-method`）。  
4. **兼容性检查**：确认 sglang 运行时版本在不支持该 flag 时能够优雅失败或忽略，以免在旧镜像上部署导致启动错误。  

整体改动简洁且目标明确，只要做好配置指引和兼容性验证，就能平滑提升服务的鲁棒性。

---

### refactor: optimize regex patterns in docs scripts (#5777)
**SHA**: `bf270c2` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/bf270c2825057af82b6b02d51e3bf4b9197a8aec)

**🛠 变更类型**：重构 / 性能优化  
**⚡ 重要程度**：🟡 中  
**📋 变更摘要**：在 `docs/_extensions/github_alerts.py` 与 `docs/generate_docs.py` 中优化了正则表达式。  
- 将 GitHub 警报的 `.*?` 替换为 `[^\]]*`，避免在遇到 `]` 时产生回溯。  
- 将 Markdown 超链接的懒惰匹配 `[^\)]*?` 改为贪婪 `[^\)]+`，并在提取后用 `rstrip()` 去除多余空白。  

**🎯 影响范围**  
- `docs/_extensions/github_alerts.py`（GitHub 警报块检测）  
- `docs/generate_docs.py`（Markdown 超链接解析、文档自动生成）  

**💡 关注建议**  

1. **功能验证**  
   - 运行一次完整的文档生成流程，确认生成的 HTML 与之前保持一致。特别检查包含 `]` 的警报块（如 `[!NOTE]`、`[!WARNING]`）以及链接后面带有空格的 Markdown 行是否仍然被正确渲染。  
   - 对比 `exclusions.txt` 中的路径，确保未因正则更改导致误删或误保。

2. **单元测试**  
   - 为 `GitHubAlertsTransformer.is_github_alert_blockquote` 添加覆盖边界情况的测试，例如：  
     ```text
     [!NOTE] some text
     [!TODO]   // trailing spaces
     [!Complex]Content with ] inside
     ```  
   - 为 `replace_hyperlink` 编写测试，覆盖：  
     - 链接后有多余空格的情况；  
     - 链接中出现 `)`（如 URL 参数）时的匹配；  
     - 采用感叹号 `!` 开头的图片语法不被误匹配。  

3. **性能评估**  
   - 使用 `timeit` 对比旧、新华正则在大体积 Markdown（如数千行）下的执行时间，确保优化带来可观的回溯削减。  

4. **兼容性检查**  
   - 正则写法在 Python 3.8+ 均可正常工作，若项目仍支持更早版本，请确认 `re` 模块行为一致（尤其是非捕获组 `(?:…)`）。  

5. **文档更新**  
   - 在项目的贡献指南或正则说明页面记录此处实现细节，方便后续维护者了解为何使用 `[^\]]*` 与贪婪匹配，以及 `rstrip()` 的必要性。  

通过上述验证和测试，可确保此次正则优化在提升文档生成速度的同时不引入解析错误，保持项目的可靠性。

---

#### 🟢 低重要度变更 (6)

### docs: Fix service name in port-forward command (#5527)
**SHA**: `98eb6b7` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/98eb6b7e037987566943ee8d6f2e4b410b277603)

**🎯 变更类型**：文档更新  
**⚡ 重要程度**：🟢 低  
**📋 摘要**：修正了 Kubernetes 安装指南中 `kubectl port-forward` 命令的服务名称，由 `svc/agg-vllm-frontend` 更正为 `svc/vllm-agg-frontend`，确保端口转发指向正确的 Service。

---

### docs: sync fern/ with local indexer default changes from #5941 (#6073)
**SHA**: `d48de15` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/d48de155db7e08af69aa01a55c8b82590919060c)

**🎯 变更类型**：文档更新  
**⚡ 重要程度**：🟢 低  
**📋 摘要**：同步了 router 设计文档，默认将 KV 事件同步改为 NATS Core/事件平面 + 本地索引器，并说明 JetStream 为可选模式，更新了相关说明及示例代码。

---

### chore: add --no-install-recommends to apt-get install commands (#5774)
**SHA**: `3c9ca3f` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/3c9ca3fcb2670af4bc4f989708c85e77fa723c10)

**🎯 变更类型**：配置调整  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在多个 Dockerfile 的 apt‑get 安装命令中加入 `--no-install-recommends`，避免安装推荐包，降低镜像体积。

---

### ci: add doc exclusions to all CI-triggering filter groups (#6020)
**SHA**: `0b05c4c` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/0b05c4c7122ab790c69dc262de4e5aa0ad06f8a9)

**🎯 变更类型**：配置调整  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 CI 过滤配置 `.github/filters.yaml` 中为所有触发组新增排除 `*.md` 与 `*.rst` 文档文件，避免文档改动触发不必要的 CI。

---

### docs: Update command to build Dynamo + SGLang container (#5908)
**SHA**: `4520b8f` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/4520b8f636c37f22f67512695382e5ded5e78097)

**🎯 变更类型**：文档更新  
**⚡ 重要程度**：🟢低  
**📋 摘要**：更新 SGLang 后端 README 中的容器构建命令，统一 `--tag` 参数的写法。

---

### ci: update premerge to check the cargo-deny ban list (#5699)
**SHA**: `59d20d1` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/59d20d1e9cfa95b0d850109d284d7f944c44a811)

**🎯 变更类型**：配置调整  
**⚡ 重要程度**：🟢 低  
**📋 摘要**：CI 流水线中 pre‑merge 工作流改为使用 `cargo-deny --all-features` 检查所有特性，并在 deny.toml 中新增 `WTFPL` 许可至允许列表。

---

