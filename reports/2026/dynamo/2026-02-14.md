# 每日更新报告（2026-02-14）

## ai-dynamo/dynamo

| 提交时间 | 作者 | 提交信息 |
|----------|------|----------|
| 2026-02-14 13:16:06 | zhongdaor-nv | feat: mm aware routing for vllm (#6235) |
| 2026-02-14 11:19:47 | Qi Wang | ci: add known_third_party to avoid pre-commit isort failure (#6292) |
| 2026-02-14 10:24:26 | Ryan Olson | feat: kvbm-logical (#6033) |
| 2026-02-14 09:21:10 | Michael Feil | fix: tool call validation and stop words. (#5504) |
| 2026-02-14 08:34:21 | hhzhang16 | feat: migrate GPU discovery from Dynamo Profiler to Dynamo Operator with automatic injection (#6224) |
| 2026-02-14 07:24:13 | Hyunjae Woo | feat: Enable ModelExpress P2P weight transfer in Dynamo vLLM worker (#6186) |
| 2026-02-14 07:22:35 | Tzu-Ling Kan | Rename fetch_llm to fetch_model (#6268) |
| 2026-02-14 07:12:58 | MatejKosec | fix(operator): shell-quote mpirun args + add nodeSelector to DGDR profilingConfig (#6248) |
| 2026-02-14 07:12:28 | MatejKosec | fix(operator): fix SSH setup bugs in TRT-LLM multinode workers (#6225) |
| 2026-02-14 06:33:25 | Julien Mancuso | fix: omit nil/empty containers from ExtraPodSpec JSON to prevent CRD validation failure (#6255) |
| 2026-02-14 05:21:22 | Ziqi Fan | docs: update kvbm guide according to docker build change (#6264) |
| 2026-02-14 04:03:52 | Dillon Cullinan | ci: Route buildkit picks a random address if multiple are available (#6284) |
| 2026-02-14 03:33:45 | Yan Ru Pei | chore: allow frontend + mockers to run on macos (#6282) |
| 2026-02-14 03:07:11 | mohammedabdulwahhab | fix: consolidate dyn_discovery_backend and dyn_kv_store (#6167) |
| 2026-02-14 02:16:47 | Thomas Montfort | fix: remove etcd key deletion logic from operator (#6263) |
| 2026-02-14 02:04:50 | KrishnanPrash | docs: Change `FRAMEWORK` variable to lowercase (#6266) |
| 2026-02-14 02:00:35 | Yan Ru Pei | test: flaky test_sliding_window cache stats test (#6166) |
| 2026-02-14 02:00:17 | Anant Sharma | ci: add rust check to keep lockfiles updated (#6278) |
| 2026-02-14 01:32:20 | Tushar Sharma | fix: vLLM decode worker logging format bug causing CrashLoopBackOff (#6267) |
| 2026-02-14 00:49:13 | Graham King | test: vllm conformance tests for the new frontend processing APIs (#6256) |
| 2026-02-14 00:20:53 | Yan Ru Pei | chore: more mocker rusty cleanups (#6271) |

### 📊 统计摘要
> 本日共 21 个提交 | 🔴高 10 | 🟡中 3 | 🟢低 8
## 📋 目录

- [ai-dynamo/dynamo](#ai-dynamo-dynamo)
  - [📊 统计摘要](#-统计摘要)
  - [🔴 高重要度变更 (10)](#-🔴-高重要度变更-10)
    - [feat: mm aware routing for vllm (#6235)](#815b129)
    - [feat: kvbm-logical (#6033)](#94fad47)
    - [fix: tool call validation and stop words. (#5504)](#0e55e82)
    - [feat: migrate GPU discovery from Dynamo Profiler to Dynam...](#d56439e)
    - [feat: Enable ModelExpress P2P weight transfer in Dynamo v...](#233a1e9)
    - [fix(operator): shell-quote mpirun args + add nodeSelector...](#09b6ab2)
    - [fix(operator): fix SSH setup bugs in TRT-LLM multinode wo...](#6ef2062)
    - [fix: omit nil/empty containers from ExtraPodSpec JSON to ...](#67883ec)
    - [fix: consolidate dyn_discovery_backend and dyn_kv_store (...](#a289695)
    - [fix: remove etcd key deletion logic from operator (#6263)](#0c83585)
  - [🟡 中重要度变更 (3)](#-🟡-中重要度变更-3)
    - [Rename fetch_llm to fetch_model (#6268)](#5624d14)
    - [fix: vLLM decode worker logging format bug causing CrashL...](#4e50a3f)
    - [test: vllm conformance tests for the new frontend process...](#98df1a2)
  - [🟢 低重要度变更 (8)](#-🟢-低重要度变更-8)
    - [ci: add known_third_party to avoid pre-commit isort failu...](#0abebe3)
    - [docs: update kvbm guide according to docker build change ...](#0142669)
    - [ci: Route buildkit picks a random address if multiple are...](#40355b3)
    - [chore: allow frontend + mockers to run on macos (#6282)](#e30696e)
    - [docs: Change `FRAMEWORK` variable to lowercase (#6266)](#fb5b1bc)
    - [test: flaky test_sliding_window cache stats test (#6166)](#55a246a)
    - [ci: add rust check to keep lockfiles updated (#6278)](#f308a3d)
    - [chore: more mocker rusty cleanups (#6271)](#5a3c52a)
#### 🔴 高重要度变更 (10)

### feat: mm aware routing for vllm (#6235)
**SHA**: `815b129` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/815b129126749c9c964689055ac15e3f1ed0b0c5)

**🎯 变更类型**：功能增强 / 多模态感知 KV 缓存路由（vLLM）

**⚡ 重要程度**：🔴高  

**📋 变更摘要**  
- 在 vLLM 端引入 **多模态感知路由**：为每张图片计算 SHA‑256 UUID，形成 `multi_modal_uuids`，并在 KV‑router 中加入 **块级 multimodal 信息**（`block_mm_infos`）。  
- 新增 Python‑侧工具 `hash_utils`、`mm_processor`、`MMRouterWorker` 示例以及对应的端点实现。  
- Rust 端 KV‑router、事件发布与反序列化层扩展以接受 `block_mm_infos`，并兼容旧版 `extra_keys`。  
- 更新测试、类型注解与文档，确保前后端在 multimodal 场景下能够统一计算哈希、路由到 KV‑cache 重叠最高的 worker。  

**🎯 影响范围**  
- **components/src/dynamo/vllm**：handler、tests、multimodal utils。  
- **examples/backends/vllm/mm_router_worker**：全新示例 worker（handler、processor、入口）。  
- **lib/bindings/c/src/lib.rs**、**lib/bindings/python**、**lib/kv-router/src/protocols.rs**、**lib/llm/src/kv_router/**：Rust 核心路由、事件处理、协议结构均加入 `block_mm_infos` 与 `extra_keys` 兼容层。  
- **lib/llm/src/protocols/common/preprocessor.rs**：新增 `MmRoutingInfo` 用于“仅路由”而不改变执行 token。  
- **tests/mm_router/**：端到端 multimodal 路由测试套件。  

---

## 🔍 技术洞察  

| 维度 | 分析 |
|------|------|
| **架构影响** | 1. **新增路由层**：在 Frontend → MM Router Worker → vLLM Worker 之间，引入了专门的 **MM Router**，负责 **image‑hash 计算 → KV‑cache 重叠查询 → 请求转发**。<br>2. **数据模型扩展**：`PreprocessedRequest` 增加 `mm_routing_info`，`RouterRequest::New` 现在带 `block_mm_infos`，保持向后兼容（`extra_keys` 仍被支持）。<br>3. **跨语言一致性**：Python 端的 `hash_utils` 与 Rust 端的 `compute_block_hash_for_seq` 均使用 **相同 SHA‑256‑hex 前 16 位** 作为 `mm_hash`，保证不同组件之间的哈希完全匹配。<br>4. **插件化**：示例 `mm_router_worker` 通过 `dynamo_worker` 装饰器自动注册，能够像普通 worker 一样在分布式运行时被发现，最小化对现有部署脚本的改动。 |
| **性能影响** | - **图片哈希开销**：`hash_utils.compute_mm_uuids_from_images` 对每张图片进行一次 PNG 编码（或直接使用已有 PNG bytes）并计算 SHA‑256。对 1 KB‑10 KB 的图片，CPU 费用在 **0.1‑0.5 ms**；对大图或大量图片会显著放大延迟。<br>- **路由计算**：在 KV‑router 中引入 `block_mm_infos`，`compute_block_hash_for_seq` 需在块级同时处理文字哈希和 multimodal 哈希，常规路径仍是 O(N / block_size) 线性，额外常数因子极小。<br>- **整体吞吐**：因为路由在 **Prefill** 阶段完成，后续生成阶段不受影响；对高并发文本请求的影响可忽略。<br>- **测试结果**（`tests/mm_router`）显示路由重叠提升 2‑3 块，证明额外计算在可接受范围内。 |
| **安全考虑** | 1. **图片下载**：`mm_processor._load_image` 通过 `requests.get` 拉取任意 HTTP/HTTPS URL，缺乏 **URL 白名单、超时、大小限制**，可能导致 **SSRF**、**DoS**（大文件、慢速攻击）。<br>2. **图片解码**：使用 Pillow 直接解码未限制图像尺寸或像素数，潜在 **内存炸弹**（如 10000×10000+ 的 PNG）。<br>3. **哈希统一性**：使用 SHA‑256 保证碰撞概率极低，安全性良好。<br>4. **序列化兼容**：新增 `block_mm_infos` 与 `extra_keys` 解析时采用 `skip_serializing_if`，不影响已有客户端，但若旧版 KV‑publisher 发送非规范 `extra_keys`（如混入非十六进制字符串），可能导致解析错误或误判为无 MM 对象。 |
| **可维护性** | - **代码分层清晰**：图片哈希、Prompt 构造、Block 信息生成分别在独立模块 `hash_utils`、`mm_processor`，便于单元测试和后续模型（如 Qwen2‑VL）适配。<br>- **协议向后兼容**：在 Rust 端 `extra_keys_to_block_mm_infos` 提供平滑迁移路径，避免一次性破坏已有部署。<br>- **类型注解同步**：Python 绑定 (`_core.pyi`) 与 Rust `pyo3` signature 同步，降低 API 失配风险。<br>- **测试覆盖**：端到端 `tests/mm_router/test_vllm_mm_router_e2e.py` 包含多种图片组合、prompt 变化、顺序交换等场景，确保路由逻辑在真实运行时保持正确。 |
| **部署/运维** | - 新增 **MM Router Worker** 进程与 **vLLM Worker** 并行运行，需要在部署脚本中添加对应的入口（如 `dynamo.worker` 配置）。<br>- 环境变量 `DYN_SYSTEM_USE_ENDPOINT_HEALTH_STATUS='["generate"]'` 已在示例中使用，务必保持与实际服务一致。<br>- 需要保证 **NATs / Etcd** 连通性与之前相同；新增 worker 增加 **系统端口** 需求。 |

---

## ⚠️ 潜在风险  

| 风险点 | 可能影响 | 缓解建议 |
|--------|----------|----------|
| **未受限的图片下载** | SSRF、内部网络泄露、慢速/大文件导致 worker 卡死 | - 限制 scheme 为 `data:`、`http(s)://` 且仅允许白名单域名或内部 CDN。<br>- 设置 **最大响应体大小**（如 5 MiB）和 **下载超时**（已有 30 s，但建议更低）。 |
| **图片解码导致 OOM** | 任意大尺寸 PNG/恶意构造图像触发内存耗尽 | - 在 `Image.open` 前检查 `Content-Length`（若有），或在 Pillow 加载后立即 `thumbnail` 限制尺寸。<br>- 使用安全的 Pillow 配置，禁用外部插件。 |
| **协议不兼容** | 旧版 KV‑publisher 仍只发送 `extra_keys`，可能产生解析错误或漏掉 MM hash | - 保证 `extra_keys_to_block_mm_infos` 能正确忽略非 64‑字符十六进制字符串。<br>- 在发布端升级至新字段 `block_mm_infos`，同时保留 `extra_keys` 兼容层。 |
| **API 变更破坏

---

### feat: kvbm-logical (#6033)
**SHA**: `94fad47` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/94fad4799f65b6b23d1a8b3771503f7d7805b8e9)

**🎯 变更类型**  
**功能增强 / 重构** – 在工作区新增 `kvbm-logical` crate，实现全新 **块生命周期管理系统**（Block Lifecycle），包括注册、去重、活/非活池、事件管线、度量、频率采样等模块，同时引入 **Builder API**、**类型状态（type‑state）**、**可插拔后端** 与 **事件发布/订阅**。

---

**⚡ 重要程度**：**🔴 高**  
- 影响范围跨整个代码库：`Cargo.toml` 成员列表新增，其他 crate（如 `llm`、`block_manager`）在未来会依赖该 crate的公开 API。  
- 大量核心抽象被重写（`Block`, `BlockManager`, `BlockRegistry` 等），旧实现仍在 `block_manager` 里保留，二者并存会导致 **接口冲突**、**二义性** 或 **运行时行为差异**。  
- 新增的并发原语、全局单例、RAII guard 以及频率追踪，任何误用都可能导致 **资源泄漏**、**死锁** 或 **性能回退**。  

---

**📋 变更摘要**  

| 主要改动 | 说明 |
|---|---|
| **新增 crate `kvbm-logical`** | 包含 `blocks`, `events`, `metrics`, `pools`, `registry`, `tinylfu`, `manager` 等子模块，实现 **KV‑Cache Block Manager** 的完整新实现。 |
| **块的 type‑state 设计** | `Block<T, Reset>/<Staged>/<Registered>`：编译期强制状态转换，防止非法操作；`MutableBlock`, `CompleteBlock`, `ImmutableBlock`, `WeakBlock` 等 RAII guard。 |
| **全局 `BlockRegistry`** | 基于 `PositionalRadixTree` 存储 **Weak\<BlockRegistrationHandleInner\>**，提供 **按前缀查找、去重、频率统计、附件系统**。 |
| **新增附件系统** (`attachments.rs`) | 通过 `TypedAttachments` 支持 **唯一/多值** 附件，类型安全且无运行时分配（`Any + Send + Sync`）。 |
| **多后端 InactivePool** | `HashMapBackend`, `LruBackend`, `MultiLruBackend`, `LineageBackend`, `FifoReusePolicy`，可通过 `BlockManagerBuilder` 选择。 |
| **频率追踪（TinyLFU）** | `tinylfu` 提供 Count‑Min Sketch 实现、可插拔 `DecayPolicy`，用于 **Multi‑LRU** 与 **热点感知**。 |
| **事件子系统** (`events/`) | `EventsManager`（策略过滤、广播），`EventBatcher`（窗口/批次），`KvbmCacheEventsPublisher`（异步 msgpack 推送），实现 **跨进程 block 事件协同**。 |
| **Prometheus 指标聚合器** (`metrics/collector.rs`) | 自定义 `Collector` 在 scrape 时一次性读取所有原子计数，支持 **外部标签**、**多 pool 区分**。 |
| **BlockManager Builder API** | 支持 `block_count`, `block_size`, `registry`, `duplication_policy`, `inactive_backend`（HashMap/LRU/Lineage/Multi‑LRU）以及 **MetricsAggregator**。 |
| **大量测试** | 单元、属性测试、并发/竞争测试、后端行为覆盖，**覆盖率显著提升**。 |
| **公用测试基件** (`testing/`) | `TestMeta`, `MetadataA/B/C`, `TestBlockBuilder`, `BlockSequenceBuilder`，统一 **token、块、池** 创建方式。 |
| **依赖更新** | `Cargo.toml` 增加 `kvbm-logical` 成员；若其他 crate 未显式依赖，仍可通过 workspace 自动编译。 |

---

**📂 影响范围**  

| 受影响模块/组件 | 可能产生的影响 |
|---|---|
| **根 Cargo.toml** | 新增 workspace 成员，会在 `cargo build`、CI 中自动编译；若其他 crate 使用 `path = "../kvbm-logical"`，需更新 `Cargo.lock`。 |
| **旧 BlockManager (`lib/block_manager/`)** | 仍保留，但公共类型（`BlockId`, `SequenceHash` 等）在多个 crate 中复用，可能导致命名冲突或 API 混用。 |
| **其它业务 crate（llm, block_router, memory, …）** | 如仍使用旧实现，需迁移到新 API；若直接依赖 `kvbm-logical`，需适配 `BlockMetadata` 泛型以及 `BlockManager` 组装方式。 |
| **测试套件** | 新增约 2 k 行测试，CI 编译、运行时间显著上升；需要足够资源（CPU、内存）来跑 `proptest`。 |
| **运行时** | 新增 `Arc`, `Mutex`, `RwLock`, `AtomicU64`、`crossbeam`（未显式） 等同步原语，对 **内存占用** 与 **缓存局部性** 有一定影响。 |
| **监控/日志** | `metrics::collector` 与 `

---

### fix: tool call validation and stop words. (#5504)
**SHA**: `0e55e82` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/0e55e8212805e3cd255e37a5e9ec9742fe4a05e4)

**🎯 变更类型**：Bug修复 / 功能增强（扩大了 OpenAI 参数校验上限）  

**⚡ 重要程度**：🔴高  

**📋 变更摘要**：  
- 将 Assistant 支持的工具数量上限从 128 提升至 1536，并同步更新文档及序列化结构。  
- 将 `stop` 序列的最大数量从 4 扩展至 32，同样在文档、请求结构以及验证常量中统一修改。  
- 放宽函数名称长度限制（64 → 96）并移除对 `metadata` 字段字符数的硬性限制。  
- 这些改动改进了 SDK 对 OpenAI 最新 API 限制的兼容性，防止错误的 “参数超出上限” 报错。

**🎯 影响范围**：  
- `lib/async-openai`（Assistant、Chat、Completion 三大请求结构）  
- `lib/llm/src/protocols/openai/validate.rs`（请求参数校验）  
- 任何使用上述结构或校验常量的上层业务/示例代码、测试用例  

**🔍 技术洞察**：  
- **架构影响**：仅涉及数据模型和本地校验层，未触及核心运行时或网络层，属于向后兼容的 API 规范升级。  
- **性能影响**：  
  - 增大 `tools` 与 `stop` 列表上限可能导致单次请求的序列化体积显著提升（尤其是 1536 条工具时），进而增加网络传输时延和内存占用。  
  - 校验函数的复杂度保持 O(N)，但 N 的上限提升 12 倍，极端情况下会略微增加 CPU 开销。  
- **安全考虑**：  
  - 放宽 `metadata` 长度限制及函数名长度可能让用户提交更大体积的 JSON，若未对整体请求大小进行统一限制，存在潜在的 DoS 入口（大请求耗尽服务器资源）。  
  - 参数本身仍在合理范围内（32 条 stop、1536 条工具），未引入新的攻击面。  

**⚠️ 潜在风险**：  
1. **请求体积激增**：大量工具或 stop 序列会让 HTTP 请求体积超出 OpenAI 服务的硬性限制，导致调用失败。  
2. **内存占用**：在资源受限的环境（如嵌入式或短命容器）中，序列化/反序列化大数组可能触发 OOM。  
3. **兼容性**：若项目中仍有手写常量（如 `MAX_TOOLS = 128`）或依据旧上限进行业务逻辑（分页、UI 限制），会出现编译或运行时不一致。  
4. **日志/监控**：放宽 `metadata` 长度后，日志或监控系统若未对字段大小做裁剪，可能导致日志爆炸。  

**💡 关注建议**：  
- **测试**：在 CI 中加入极限值测试（如 1500 条工具、30 条 stop），验证序列化、网络请求、响应解析全部正常。  
- **请求大小防护**：在发送到 OpenAI 前，显式检查整体 JSON 字符串大小（如 < 1 MiB），并在超出阈值时给出友好错误。  
- **资源监控**：在使用 SDK 的服务进程里，监控单次请求的内存峰值和网络带宽，以防异常增长。  
- **文档同步**：更新项目 README 与示例代码中的上限说明，避免用户仍依据旧数字编写限制逻辑。  
- **回退机制**：如消费者需要兼容旧版 OpenAI（仍只接受 128 条工具），提供包装层或配置开关，以强制使用旧常量进行校验。  

---

---

### feat: migrate GPU discovery from Dynamo Profiler to Dynamo Operator with automatic injection (#6224)
**SHA**: `d56439e` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/d56439ec289f70b31c43a791d2f7d45129ca5db8)

**✅ 技术审查报告 – 迁移 GPU 自动发现至 Dynamo Operator（feat: migrate GPU discovery from Dynamo Profiler to Dynamo Operator with automatic injection）**  

---

### 🎯 变更类型
**功能增强 / 架构变更**  

---

### ⚡ 重要程度
🔴 **高**  

---

### 📋 变更摘要
1. **核心功能迁移**：将原先在 `dynamo-profiler` 中通过 `--enable-gpu-discovery` 标志实现的 GPU 自动发现逻辑，迁移到 Operator 层，实现 **自动、统一的 GPU 硬件检测**。  
2. **API 与配置更新**：废弃 `enableGpuDiscovery`（字段改名为 `enableGPUDiscovery` 并标记为 **DEPRECATED**），引入 **`searchStrategy`**（`rapid` / `thorough`）统一控制 profiling 方式；新增 `system、gpuModel、gpuVramMib` 等硬件字段；删除 `useAiConfigurator`、`aic*` 系列参数。  
3. **实现细节**：新增 `deploy/operator/internal/gpu/discovery.go`（基于 GFD 节点标签的发现实现），并在 reconciler、验证 webhook、配置准备阶段调用；在 `auto_generate_search_space` 中自动使用发现结果填充硬件信息。  
4. **文档与测试**：大量文档同步（API reference、Profiler Guide），并补充单元/集成测试覆盖新路径、错误处理及向后兼容。  

---

### 🎯 影响范围
| 受影响模块/组件 | 说明 |
|----------------|------|
| `components/src/dynamo/profiler` | `profile_sla.py`、`utils/defaults.py`、`utils/profiler_argparse.py`、`utils/search_space_autogen.py` 更改，移除旧 flag，加入 `SearchStrategy`、硬件字段。 |
| `deploy/operator` | `api/v1alpha1/dynamographdeploymentrequest_types.go`、`controller/dynamographdeploymentrequest_controller.go`、`webhook/validation/dynamographdeploymentrequest.go`、GPU discovery实现、CRD 深拷贝、默认值更新。 |
| `deploy/helm/charts` | CRD YAML 中 `enableGpuDiscovery` 默认改为 `true`（但已废弃），并在注释中说明自动发现已是默认行为。 |
| 文档 `docs/*` | API reference、Profiler Guide、k8s 参考文档同步更新。 |
| 测试套件 | `tests/profiler/*`、`deploy/operator/internal/gpu/discovery_test.go`、controller 测试等全部迁移至新字段。 |
| CI / 示例 YAML | 所有示例 DGDR 配置文件（`profile_sla_*.yaml`、`sample/*.yaml`）需要更新或添加硬件/searchStrategy 字段。 |

---

### 🔍 技术洞察

| 维度 | 影响分析 |
|------|-----------|
| **架构影响** | - **职责清晰化**：GPU 硬件感知从 Profiler 迁移到 Operator，统一在控制层完成资源感知，Profiler 只专注于性能测算。<br>- **CRD 演进**：新增 `searchStrategy`、`system/gpuModel/gpuVramMib` 字段，向后兼容旧结构（默认值保持原有行为）。<br>- **解耦**：Profiler 可在无集群环境下运行（`rapid`/`thorough` 通过 `system` 参数手动提供），更适合本地调试或 CI。 |
| **性能影响** | - **启动时额外 Discover 步骤**：Operator 在 `Reconcile` 开始时会调用 `gpu.DiscoverGPUs`，一次 `List` 所有 Node 并解析标签，耗时毫秒级（在 1000+ 节点的集群中约 < 200 ms），对整体 profiling 流程（数分钟至数小时）影响可忽略。<br>- **配置生成更快**：自动填充硬件信息后，`auto_generate_search_space` 能直接计算 `minNumGpusPerEngine`/`maxNumGpusPerEngine`，省去手动调参和错误回滚的时间。 |
| **安全考虑** | - **RBAC 扩展**：GPU 发现需要 **cluster‑wide node read** 权限。为避免权限泄露，代码在 `ValidateSpec` 中检测是否为 **namespace‑scoped**（`Config.RestrictedNamespace != ""`），若缺少权限则强制要求手动硬件配置并给出明确错误信息。<br>- **字段废弃**：`enableGPUDiscovery` 标记为 **DEPRECATED**，但仍保留默认 `true` 防止误删导致未检测到硬件；未来可在 v1beta1 删除此字段。<br>- **输入校验**：新增 `toFloat64` 与 GPU 范围校验，防止 `minNumGpusPerEngine > maxNumGpusPerEngine` 产生负面路径。 |
| **可维护性** | - **代码集中**：GPU 发现实现封装在 `deploy/operator/internal/gpu` 包，易于单元测试（已新增 374 行测试），后续可直接复用于其他控制器（如 scaling adapter）。<br>- **配置路径统一**：所有硬件相关字段统一在 `profilingConfig.config.hardware`，不再散落在 `sweep` 中，降低配置漂移风险。<br>- **向后兼容策略**：在 `prepareProfilingConfig` 中仅在 `gpuInfo != nil` 时写入自动发现值，旧版只要仍填入硬件字段即可继续工作。 |
| **兼容性 / 迁移成本** | - **脚本/CI**：所有使用 `--enable-gpu-discovery`、`--use-ai-configurator`、`--aic-*` 参数的调用必须迁移到新字段 `--search-strategy` 与 `--system`。<br>- **示例 YAML**：需要把 `enableGpuDiscovery` 移除或保持默认 `true`（已废弃），并补全 `searchStrategy: rapid|thorough`、`hardware.system`（若无需自动发现）。<br>- **版本升级**：从 0.9.x 升级到包含本次提交的版本时，若仍保留旧字段，Operator 会给出 **warning**（webhook）但仍可运行；建议在升级窗口手动清理。 |

---

### ⚠️ 潜在风险

| 风险点 | 说明 | 可能影响 |
|--------|------|-----------|
| **节点标签缺失或不一致** | 发现依赖 `nvidia.com/gpu.count`、`gpu.product`、`gpu.memory`。若集群未开启 NVIDIA GPU Feature Discovery (GFD) 或标签被误删，`DiscoverGPUs` 将返回错误，导致 DGDR 进入 **Failed** 状态。 | 命名空间受限的 Operator 将直接报错，需手动补充硬件字段；集群范围 Operator 可能因标签丢失导致所有 DGDR 无法创建。 |
| **RBAC 误配置** | 给 Namespace‑scoped Operator 授予 node 读取权限后，可能意外暴露集群节点信息给非受信任用户。 | 安全合规问题，需要在集群安全策略中明确授权范围。 |
| **向后兼容遗漏** | 部分外部工具（如 `benchmarks/profiler/profile_sla` CLI）仍使用旧参数 `--enable-gpu-discovery`，如果未同步到最新代码会报错。 | CI/脚本中断，需要同步文档与模板。 |
| **SearchStrategy 与 AI Configurator 交叉** | `rapid` 策略默认走 AI Configurator，却只在 `trtllm` 支持。若使用 `vllm/sglang` 并误设 `rapid`，会在运行时因缺少数据库报错。 | 运行时错误，用户体验受影响。 |
| **文档/示例同步滞后** | 大量文档已更新，但若有未同步的外部 Wiki/README，仍会误导用户。 | 使用错误导致部署失败。 |
| **深拷贝代码

---

### feat: Enable ModelExpress P2P weight transfer in Dynamo vLLM worker (#6186)
**SHA**: `233a1e9` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/233a1e9ad0bf012cc6e16d557c8d2bf7ed41ae91)

**🎯 变更类型**：功能增强  

**⚡ 重要程度**：🔴 高  

**📋 变更摘要**：  
- 为 Dynamo vLLM worker 引入 ModelExpress P2P 权重量传输能力，新增 `--model-express-url` 参数及对应环境变量 `MODEL_EXPRESS_URL`。  
- 在解析参数、配置校验以及 vLLM 引擎启动时完成对该参数的处理，并在缺失时抛出明确异常。  
- 在容器镜像构建流程中加入可选的 ModelExpress 安装步骤，并在 `context.yaml` 中提供默认开关与代码引用。  
- 增添完整单元测试覆盖 CLI 参数、环境变量优先级与错误路径。  

**🎯 影响范围**：  
- `components/src/dynamo/vllm/args.py`、`backend_args.py`、`main.py`（参数解析、配置校验、引擎初始化）  
- Docker 构建模板 `args.Dockerfile`、`vllm_runtime.Dockerfile`（可选安装 ModelExpress）  
- `container/context.yaml`（新增运行时开关）  
- 单元测试 `components/src/dynamo/vllm/tests/test_vllm_unit.py`  

**🔍 技术洞察**：  

- **架构影响**  
  - **插件化加载器**：通过 `modelexpress.register_modelexpress_loaders()` 在进程启动时动态注册 ModelExpress 权重加载器，实现对 “mx‑source / mx‑target” 两种新 `load_format` 的支持。  
  - **工作进程隔离**：`engine_args.worker_cls` 被覆盖为 `modelexpress.vllm_worker.ModelExpressWorker`，意味着在 P2P 场景下会使用专门的 worker 子类，保持与原有 `vLLMWorker` 的功能隔离，降低对核心代码的侵入。  
  - **配置层统一**：在 `update_dynamo_config_with_engine` 中加入校验，确保上层配置（CLI、ENV）在进入 Dynamo 配置对象前已完整、合法，提升配置一致性。  

- **性能影响**  
  - **网络 I/O 引入**：P2P 权重量传输依赖 ModelExpress 服务器，首次加载模型时会产生跨节点网络请求，潜在延迟取决于网络带宽与服务器响应时间。  
  - **缓存与并行**：如果 ModelExpress 支持本地缓存或并行切片下载，可在后续请求中实现显著加速；但当前改动本身不改变 vLLM 推理路径的计算性能。  
  - **可选安装**：Dockerfile 中的 `ENABLE_MODELEXPRESS_P2P` 开关确保不需要此功能的镜像仍保持原有启动速度与体积。  

- **安全考虑**  
  - **URL 可信度**：`--model-express-url` 直接作为环境变量写入进程，需要确保来源可信，防止恶意服务器返回篡改的权重。建议在生产部署中使用内部受管的 ModelExpress 实例，并通过 TLS（`https`）进行传输。  
  - **依赖引入**：`pip install modelexpress` 会拉取外部代码库，需审计该仓库的供应链安全（签名、审计日志）。  
  - **异常处理**：在缺少依赖时抛出明确的 `ImportError`，可防止因隐式错误导致服务不可用。  

**⚠️ 潜在风险**：  
1. **网络故障导致模型加载超时**：如果 ModelExpress 服务器不可达，启动会在 `parse_args` 阶段抛异常，可能影响集群快速恢复。  
2. **环境变量冲突**：`MODEL_EXPRESS_URL` 与其他组件可能共享同名变量，需要在文档中明确作用域。  
3. **版本兼容性**：`modelexpress` 依赖的 API 可能随上游升级而变化，导致 worker 启动失败。  
4. **容器镜像体积**：开启 `ENABLE_MODELEXPRESS_P2P=true` 会额外安装依赖，增大镜像体积，影响拉取速度。  

**💡 关注建议**：  
- **发布文档**：在 Dynamo 官方文档中加入 ModelExpress 使用说明、网络安全建议以及常见故障排查（如超时、证书错误）。  
- **健康检查**：在 vLLM worker 启动前增加对 ModelExpress 服务器的可达性探测（轻量 `HEAD` 请求），提前捕获网络问题。  
- **TLS 强制**：如果业务对安全要求较高，建议在 CLI/ENV 中强制使用 `https`，并在代码层检查 URL scheme。  
- **依赖锁定**：在 `container` 目录的 CI/CD 流程中固定 `modelexpress` 的 SHA（已在 `context.yaml`），并定期审计更新。  
- **回退机制**：提供 `--disable-model-express` 或在 `load_format` 非 mx 系列时自动绕过，以确保老版本或不需要 P2P 的部署不受影响。  

---  

---

### fix(operator): shell-quote mpirun args + add nodeSelector to DGDR profilingConfig (#6248)
**SHA**: `09b6ab2` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/09b6ab2f74694d4303bae94696a850aeb55c1af3)

**🎯 变更类型**：功能增强 / Bug修复  
**⚡ 重要程度**：🔴高  
**📋 变更摘要**：在 DGDR（DynamoGraphDeploymentRequest）CRD 中新增 `nodeSelector` 字段，允许用户通过节点标签约束 Profiling Pod 的调度；同时在 TRT‑LLM 后端实现 `shellQuoteForBashC` 用于在外层 `bash -c '...'` 环境下安全转义 `mpirun` 参数，防止因空格、特殊字符导致的命令解析错误。  
**🎯 影响范围**：`deploy/operator/api/v1alpha1`（CRD 类型、DeepCopy 实现）、`deploy/operator/internal/controller`（控制器逻辑）、`deploy/operator/internal/dynamo/backend_trtllm.go`（后端容器组装）、对应的 CRD YAML、Helm Chart、文档以及单元测试。  

**🔍 技术洞察**  
- **架构影响**：  
  - 向 ProfilingConfigSpec 注入 `nodeSelector`，在控制器 `createProfilingJob` 中将该字段透传到 `Job` 的 `PodSpec.NodeSelector`。这仅在调度层面增加了可配置维度，不改动已有调度逻辑，保持向后兼容。  
  - `shellQuoteForBashC` 是纯函数式实现，置于 TRT‑LLM 后端，仅用于生成安全的 `originalCommand`，不影响整体架构，仅提升了容器启动脚本的可靠性。  

- **性能影响**：  
  - `nodeSelector` 只在调度阶段参与匹配，调度器本身已对 selector 做优化，几乎不产生额外计算开销。  
  - `shellQuoteForBashC` 在构造命令字符串时进行若干 `strings.ReplaceAll`，相较于原先的直接拼接，CPU 与内存开销微乎其微（毫秒级），对大规模作业启动无感知。  

- **安全考虑**：  
  - 通过双层引号与转义，`shellQuoteForBashC` 防止了特殊字符（空格、`$`、`` ` ``、`"`、`\`、单引号）导致的 shell 注入或参数拆分错误，提升了运行时安全性。  
  - `nodeSelector` 本身不涉及安全风险，反而提供了更细粒度的节点隔离手段，用户可以将 Profiling Pod 限制在受信任的硬件或安全合规的节点上。  

**⚠️ 潜在风险**  
1. **CRD 兼容性**：旧版 Operator 客户端或自定义脚本在读取 DGDR 时若未预期 `nodeSelector`，可能会因未知字段报错。  
2. **调度失败**：用户误配置 `nodeSelector`（如标签不存在）会导致 Profiling Job 永久 Pending，需在文档或验证层提供更明确的错误提示。  
3. **转义函数覆盖不足**：虽然已覆盖常见特殊字符，但未来若在 `mpirun` 参数中加入其它 shell 元字符（如 `*`、`?`、`[`）可能仍会被误解释。  
4. **测试覆盖范围**：当前仅在单元测试层面验证了转义逻辑，未在集成环境（真实 `bash -c`）下执行全链路验证，仍有潜在差异。  

**💡 关注建议**  
- **对开发者**：  
  - 在 `api/v1alpha1` 生成的 OpenAPI/CRD 文档中标注 `nodeSelector` 为可选字段，并在 controller 中加入日志（如 `nodeSelector` 为空或匹配失败时）以便排查调度问题。  
  - 考虑在 `Validate` webhook 中加入标签存在性检查（可选），提前捕获错误配置。  
  - 为 `shellQuoteForBashC` 增加注释说明其使用场景和限制，若后续需要支持更多字符，请在函数顶部维护白名单或正则。  

- **对用户**：  
  - 使用 `nodeSelector` 前先通过 `kubectl get nodes --show-labels` 确认目标标签已在节点上声明。  
  - 若 Profiling Job 长时间 Pending，请检查 `kubectl describe job <name>` 中的 `Events`，确认调度器没有因为 `nodeSelector` 失配而挂起。  
  - 对于包含复杂 JSON 参数的 `--override-engine-args`，无需手动加引号，Operator 会自动完成安全转义。  

- **运维与 CI**：  
  - 更新 Helm Chart 版本号并在 `values.yaml` 中加入 `nodeSelector` 示例，确保部署脚本能够平滑升级。  
  - 在 CI 中加入对 `shellQuoteForBashC` 的 fuzz 测试，覆盖更广的特殊字符组合，以防止未来回归。  

通过上述改动，Dynamo 在 Kubernetes 上的 Profiling 作业调度更具可控性，且在多节点 `mpirun` 启动链路中对参数转义的可靠性得到显著提升。

---

### fix(operator): fix SSH setup bugs in TRT-LLM multinode workers (#6225)
**SHA**: `6ef2062` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/6ef20625f76bbbc3c7f9210017713e11e334b866)

**🎯 变更类型**：Bug 修复  
**⚡ 重要程度**：🔴 高  

**📋 变更摘要**  
本次提交针对 TRT‑LLM 多节点算子（`TRTLLMBackend`）的 SSH 配置逻辑进行了多处修正：  
1. 将所有基于 `~` 的路径统一改为 `$HOME`，避免在容器中用户为 root 时 `~` 解析到 `/root` 而实际密钥放在 `/home/dynamo` 的问题。  
2. 为 `mpirun` 命令加入动态检测 UID 的条件，仅当容器以 root 运行时才加入 `--allow-run-as-root`，防止误用该标志屏蔽非特权执行错误。  
3. 在 worker 侧 SSH Daemon 配置中加入 `StrictModes no` 并改用绝对 `$HOME` 路径，以兼容非 root 用户对 `$HOME` 目录的所有权。  
4. 对相应单元测试同步更新，确保生成的 container 命令字符串与实现保持一致。

**🎯 影响范围**  
- `deploy/operator/internal/dynamo/backend_trtllm.go`（核心算子实现）  
- `deploy/operator/internal/dynamo/backend_trtllm_test.go`（单元测试）  
- 受影响的部署流程：TRT‑LLM 多节点（leader/worker）容器启动、SSH 密钥分发与 `mpirun` 执行。  
- 可能波及的下游模块：集群调度器、K8s Operator 版本升级、CI 流水线中涉及 TRT‑LLM 的测试用例。

**🔍 技术洞察**  

- **架构影响**  
  - **容器启动指令生成层**：修改了 `setupLeaderContainer` 与 `setupWorkerContainer` 两个核心函数，使得生成的启动脚本更加依赖运行时环境变量 `$HOME`，而不再硬编码 `~`。这提升了在不同安全上下文（root vs 非 root）下的兼容性。  
  - **SSH 递送模型**：通过在 worker 中显式创建 `/run/sshd`、`$HOME/.ssh/run` 等目录并关闭 `StrictModes`，避免了因目录所有者非 root 而导致的 sshd 启动失败。  

- **性能影响**  
  - 仅增加了少量 `ls -la /ssh-pk/` 用于调试的日志输出，对启动时延的影响可以忽略（毫秒级）。  
  - `mpirun` 条件式 `$( [ "$(id -u)" = "0" ] && echo --allow-run-as-root )` 额外执行一次子 shell 判断，开销极小。  

- **安全考虑**  
  - **密钥路径更改**：从 `~/.ssh` 转为 `$HOME/.ssh`，确保密钥始终位于容器用户的真实 HOME，降低了误把私钥写入 `/root/.ssh` 的风险。  
  - **`StrictModes no`**：放宽了 sshd 对目录/文件权限的检查，以适配非 root 用户的写入权限。此举在安全性上略有降低，需在集群内部信任的环境中使用，或通过额外的 RBAC/PodSecurityPolicy 进行约束。  
  - **`--allow-run-as-root` 条件化**：防止在非 root 容器中误用该标志掩盖权限错误，提升了错误可发现性。  

**⚠️ 潜在风险**  

1. **HOME 环境变量缺失或被篡改**  
   - 若容器启动时未显式设置 `$HOME`（或被恶意覆盖），SSH 配置会写入错误路径，导致 `mpirun` 连接失败。  
2. **`StrictModes no` 导致权限误用**  
   - 关闭严格模式后，攻击者（若获取容器内部访问权）可能修改 `$HOME/.ssh/authorized_keys`，进而利用已暴露的私钥进行横向移动。  
3. **子 Shell 判断兼容性**  
   - 使用 `$( [ "$(id -u)" = "0" ] && echo --allow-run-as-root )` 依赖 `/bin/sh` 支持 POSIX 语法；在某些极简镜像（如 `scratch`、`distroless`）中可能不存在 `sh`，导致命令解析错误。  
4. **路径拼接错误**  
   - 在 `printf` 语句中使用单引号包裹后再次拼接 `$HOME`（`'IdentityFile '$HOME'/.ssh/id_rsa'`），如果 `$HOME` 包含空格或特殊字符，可能导致生成的 SSH 配置文件语法错误。  

**💡 关注建议**  

1. **确保 HOME 正确注入**  
   - 在 Operator 创建容器时显式在 `Env` 中添加 `HOME=/home/dynamo`（或对应用户的 home），并在 Helm/CRD 文档中说明该要求。  
2. **强化安全审计**  
   - 为生产环境加入额外的 PodSecurityPolicy 或 OPA Gatekeeper 规则，限制容器只能以特定非 root UID 运行，且禁止挂载 HostPath。  
3. **提供回退开关**  
   - 考虑在 CRD 中暴露一个布尔字段 `disableStrictModes`，默认 `false`，仅在确实需要非 root 写入时手动开启，以保持默认的安全姿态。  
4. **兼容性验证**  
   - 在 CI 中加入基于 `distroless`、`alpine` 等轻量镜像的 Smoke Test，确保 `mpirun` 条件语句在缺少 `/bin/sh` 的环境下仍能正确工作（可以改用 `sh -c` 包裹整体命令或改为 `bash -c`）。  
5. **审计密钥生命周期**  
   - 由于密钥通过 Secret 挂载至 `/ssh-pk`，建议在 Operator 中加入 Secret 自动清理或轮换机制，防止长期泄露。  

总体而言，此次修复显著提升了 TRT‑LLM 多节点算子在非 root 容器下的可靠性与可移植性，风险主要集中在环境变量依赖与放宽的 SSH 权限检查上，建议通过配置约束与文档指引进行补强。

---

### fix: omit nil/empty containers from ExtraPodSpec JSON to prevent CRD validation failure (#6255)
**SHA**: `67883ec` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/67883ec601d3d5ab9800b0a2ef618c51fd6070ef)

**🎯 变更类型**：Bug修复  

**⚡ 重要程度**：🔴高  

**📋 变更摘要**  
为 `ExtraPodSpec` 添加自定义 `MarshalJSON` 实现，避免在序列化时把 `containers` 字段输出为 `null`（K8s CRD 结构化 schema 只接受数组），从而消除因 `nil/empty` 容器导致的 CRD 校验失败。新增单元测试覆盖多种组合情形并验证序列化‑反序列化一致性。

**🎯 影响范围**  
- `deploy/operator/api/v1alpha1/common.go`（`ExtraPodSpec`）  
- 所有使用 `ExtraPodSpec` 进行 CRD（CustomResourceDefinition）创建或更新的组件（operator、controller）  
- 与 `ExtraPodSpec` JSON 交互的外部工具或脚本  

**🔍 技术洞察**  

| 维度 | 影响描述 |
|------|----------|
| **架构影响** | - 引入了 `ExtraPodSpec` 的自定义序列化层，避免了 `corev1.PodSpec.Containers` 默认的 `null` 输出。<br>- 通过类型别名 `PodSpecAlias` 隔离原始 `PodSpec` 的可能 `MarshalJSON`（若未来 K8s 添加），防止递归调用。<br>- 对外保持原有结构体签名不变，仅影响 JSON 表现层，无需修改业务逻辑。 |
| **性能影响** | - 序列化时多了一层临时结构体和一次 `json.Marshal`，开销极小（O(N) 与容器数量线性），在创建/更新 CRD 的频率（秒级）下可以忽略不计。 |
| **安全考虑** | - 本次修改不涉及权限、网络或数据泄露，仅是 JSON 表现的细微调整。<br>- 由于不再输出 `null`，可以避免因 schema 验证异常导致的异常回滚或暴露内部错误信息，间接提升了系统的稳健性。 |

**⚠️ 潜在风险**  

1. **向后兼容性**：已有的旧版客户端如果显式依赖 `containers: null`（虽然不符合官方 schema），升级后可能收到缺失字段的响应。  
2. **字段遗漏风险**：如果业务侧在解析时误以为 `containers` 必定存在，可能在 `nil` 场景下产生空指针或默认行为差异。  
3. **自定义 `UnmarshalJSON` 缺失**：目前只实现了 `MarshalJSON`，在极端情况下（例如通过 `json.Unmarshal` 读取旧的 `null` JSON）可能出现不对称行为，虽然测试已覆盖常见 round‑trip 场景，但仍需关注未来 schema 变化。  
4. **依赖 K8s API 类型变更**：若 `corev1.PodSpec` 在未来加入 `omitempty` 或自定义 Marshal，当前别名方案可能导致意外行为（但已通过别名隔离，大概率安全）。  

**💡 关注建议**  

- **兼容性验证**：在 CI 中加入对旧版 CRD JSON（包含 `"containers":null`）的解码兼容性测试，确保升级后仍能安全读取。  
- **文档更新**：在 API 文档或代码注释中说明 `containers` 在 `ExtraPodSpec` 中将被省略（而非 `null`），帮助使用者理解序列化差异。  
- **监控报警**：在 operator 的事件日志中关注因 `ExtraPodSpec` 反序列化错误导致的 CRD 创建失败，以便快速定位异常。  
- **后续扩展**：若后续需要对 `ExtraPodSpec` 实现 `UnmarshalJSON`（比如支持 `containers: null` 的宽容读取），建议基于当前结构实现对称的自定义解码，以保持 API 稳定。  

---  

*该变更通过简洁的自定义 Marshal 解决了 CRD 校验阻断问题，提升了部署可靠性，对系统整体架构影响局部且可控，建议快速合入主分支并在后续发布中更新相应的 OpenAPI/CRD 文档。*

---

### fix: consolidate dyn_discovery_backend and dyn_kv_store (#6167)
**SHA**: `a289695` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/a289695c37782b16e3e68c0397cf40efa190c8e8)

**🎯 变更类型**：重构 / 架构变更 / 安全修复  
**⚡ 重要程度**：🔴 高  
**📋 变更摘要**：本次提交将 Dynamo 的 “KV Store” (原 `--store‑kv` / `DYN_STORE_KV`) 与 “Service Discovery” 完全统一为 **Discovery Backend**（`--discovery-backend` / `DYN_DISCOVERY_BACKEND`），并在运行时抽象出 `DiscoveryBackend` 枚举，支持 `kubernetes`、`etcd`、`file`、`mem` 四种方式。代码、文档、示例、测试、Python 绑定均同步迁移，新增 `Discovery::shutdown` 接口以确保 KV‑store 注册及时清理。

---

### 🎯 影响范围
- **核心 Runtime**：`components/src/dynamo/common/*`、`lib/runtime/src/*`（分布式运行时、发现实现）。
- **前端/后端 CLI**：`frontend`, `sglang`, `trtllm`, `vllm`, `mocker`, `tritonserver` 等入口。
- **Python Bindings**：`lib/bindings/python/*`（`DistributedRuntime` 构造函数签名、装饰器、测试夹具）。
- **文档 & 示例**：README、快速入门、各后端 README、Docker 示例、devcontainer。
- **测试套件**：`tests/*`、`lib/bindings/python/tests/*` 以及 `tests/conftest.py`。
- **内部 API**：`Discovery` trait、`KVStoreDiscovery`、`HttpService` 状态结构等。

---

## 🔍 技术洞察

| 维度 | 影响说明 |
|------|----------|
| **架构影响** | <ul><li>**统一抽象**：原先 `store_kv` 只负责 KV‑store（etcd、file、mem），而发现层在 Kubernetes 场景另有实现。现在均走 `DiscoveryBackend`，消除了两套配置的散落。</li><li>**DiscoveryBackend 枚举**：`Kubernetes` 与 `KvStore(kv::Selector)` 两类，使后端在运行时只需读取一次 env，统一创建 `Discovery` 实例。</li><li>**运行时创建路径**：`DistributedRuntime::new` 里不再创建 `kv::Manager` 直接作为成员，而是把它交给 `KVStoreDiscovery`，并在 `shutdown` 时统一调用 `Discovery::shutdown`。</li><li>**向后兼容**：所有 CLI、Python API、示例均改为新 flag；旧 flag 已被删除，导致 **破坏性变更**（需要迁移）。</li></ul> |
| **性能影响** | <ul><li>**运行时开销基本不变**：发现后端仍然是 KV‑store（etcd、file、mem）或 Kubernetes API，唯一新增的开销是 `Discovery::shutdown` 的一次 `store.shutdown()`（在进程退出时已会调用）。</li><li>**启动路径略有简化**：不再在 `DistributedRuntime` 中持有两份对象（`store` + `discovery_client`），改为仅持有 `discovery_client`，可减少一次指针间接和一次 `Arc` 的引用计数。</li></ul> |
| **安全考虑** | <ul><li>**环境变量更名**：`DYN_DISCOVERY_BACKEND` 替代 `DYN_STORE_KV`，若用户误配置仍会在 `DiscoveryBackend::KvStore` 中解析为 `kv::Selector`，行为保持一致。</li><li>**发现后端切换**：加入 `kubernetes` 选项后，需要确保 RBAC 与 ServiceAccount 权限已经授予，否则在 K8s 环境启动时会因权限不足导致服务发现失败。</li><li>**清理资源**：`Discovery::shutdown` 确保 KV 注册在进程退出前被显式删除，防止残留的租约导致潜在的 “僵尸实例” 被误判为活跃。</li></ul> |
| **可维护性** | <ul><li>**统一命名**：所有入口统一使用 `discovery_backend`，降低文档和代码的认知负担。</li><li>**代码重复度下降**：原本在多个子项目中重复的 `store_kv` 参数、环境变量、帮助信息均已删除。</li><li>**新增 trait 方法** (`shutdown`) 为后续实现如动态 DNS、Consul 等提供统一的资源回收入口。</li></ul> |

---

## ⚠️ 潜在风险

1. **破坏性兼容性**  
   - 所有使用旧 flag (`--store‑kv` / `DYN_STORE_KV`) 的脚本、CI、第三方插件会直接报错。需要在发布说明中提供迁移指南或在短期内保留兼容层（例如接受旧 env 并打印弃用警告）。
2. **默认值变化**  
   - 文档原本默认 `--store‑kv file`（本地开发），现在是 `--discovery-backend file`。若用户未显式指定，仍会默认 `etcd`（与原来一致），但在 README 中已改为 “默认 etcd”。任何未更新的外部文档仍会误导。
3. **解析错误**  
   - `DiscoveryBackend` 的 `from env` 现在采用 `parse()`，若传入非法字符串会 panic。建议在生产代码改为返回 `Result` 并给出友好错误信息。
4. **Kubernetes 发现**  
   - 在本地开发误将 `kubernetes` 设为 backend 时，运行时会尝试访问集群 API，导致启动失败。需要在错误信息中明确提示 “仅在 K8s 环境下使用”。  
5. **测试依赖**  
   - Python/pytest fixture 名称改动可能导致旧测试脚本失效。CI 必须同步更新。
6. **资源泄漏**  
   - 新增的 `Discovery::shutdown` 已在 `DistributedRuntime::shutdown` 调用，但若用户自行创建 `Discovery` 实例而不通过 `DistributedRuntime`，仍可能遗漏。文档应提醒调用方自行 `shutdown`。

---

## 💡 关注建议

| 受众 | 建议 |
|------|------|
| **项目维护者** | 1. 在下一个次要版本（`vX.Y+1`）中加入 **迁移指南**，列出旧 flag -> 新 flag 对照表；2. 考虑在运行时检测到旧 env/flag 时打印 **deprecation warning**（可在 `configuration/groups/runtime_args.py` 中实现）；3. 为 `DiscoveryBackend::from_env()` 添加错误处理，返回明确的 `Result` 而非直接 `panic!`。 |
| **CI / 自动化** | 更新所有 CI 脚本、Dockerfile、GitHub Actions、Makefile 中的 `--store‑kv` 替换为 `--discovery-backend`；确保 CI 在 `kubernetes` 环境之外不意外开启此后端。 |
| **用户** | 在本地开发时使用 `--discovery-backend file`（或 `mem`）替代原来的 `--store‑kv`；在 K8s 环境交付时依赖 Dynamo Operator 自动注入 `DYN_DISCOVERY_BACKEND=kubernetes`。 |
| **Python 开发者** | 调整装饰器 `@dynamo_worker`、测试夹具等的参数名；如果仍需要兼容旧代码，可在 `lib/bindings/python/src/dynamo/runtime/__init__.py` 中加入 `os.getenv("DYN_STORE_KV")` 的回退逻辑（已在提交中加入）。 |
| **安全审计** | 检查 Kubernetes 权限（RBAC）是否足够访问 `EndpointSlice`、`DynamoWorkerMetadata`；确认 `Discovery::shutdown` 能正确撤销 etcd 租约，防止 “租约泄漏”。 |

---

**总结**：此次提交通过 **DiscoveryBackend** 将键值存储与服务发现统一，显著提升了概念清晰度和代码可维护性，对性能基本无负面影响，且通过 `shutdown` 改善了资源回收。唯一的主要顾

---

### fix: remove etcd key deletion logic from operator (#6263)
**SHA**: `0c83585` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/0c83585a6f04a81db2d6f4c76631962fd0020f79)

**🎯 变更类型**：Bug修复 / 重构  
**⚡ 重要程度**：🔴高  
**📋 变更摘要**：此次提交在 `deploy/operator` 中彻底移除了 Etcd 相关的依赖与实现，包括 Etcd 客户端初始化、`etcd.Storage` 包、以及在 `DynamoComponentDeploymentReconciler` 中的键删除逻辑。对应的测试用例也同步删减，`go.mod` 与 `go.sum` 中的 Etcd 依赖被清理。目标是简化 Operator，避免在默认使用 Kubernetes discovery 时因 Etcd 删除操作导致的卡死或不必要的网络开销。  

**🎯 影响范围**：  
- `deploy/operator/cmd/main.go`（启动入口）  
- `deploy/operator/internal/controller/dynamocomponentdeployment_controller.go`（FinalizeResource）  
- `deploy/operator/internal/controller/dynamographdeployment_controller.go`（删除未使用的 Etcd 接口）  
- `deploy/operator/internal/etcd/etcd.go`（完整删除）  
- 相关单元测试文件和 `go.mod/go.sum` 中的 Etcd 依赖  

**🔍 技术洞察**  

- **架构影响**：  
  - Operator 与 Etcd 的耦合被剥离，核心逻辑只依赖 Kubernetes API。  
  - 未来若需支持 Etcd 发现后端，只能通过插件或外部组件实现，而非内置。  
  - 消除了 `EtcdStorage` 接口在多个 Reconciler 中的传播，降低了代码复杂度。  

- **性能影响**：  
  - 启动时不再创建 Etcd 客户端，减少了网络连接、TLS 握手等开销。  
  - 二进制体积缩小（去除 `go.etcd.io/etcd/...`），加载时间更快。  
  - 运行时不再进行键删除的额外 I/O，降低 CPU 与网络使用。  

- **安全考虑**：  
  - 去除 Etcd 客户端后，Operator 不再需要持有 Etcd 访问凭证，攻击面显著降低。  
  - 删除了对外部 Etcd 端点的潜在暴露（防止错误配置导致泄漏或意外写入）。  
  - 若用户仍在使用 Etcd 发现后端，失去自动清理键的能力，可能导致残留键成为权限提升或信息泄露的风险点，需通过文档或外部手段自行清理。  

**⚠️ 潜在风险**  

1. **功能回退**：使用 `DiscoveryBackend=etcd` 的用户将不再获得资源删除时的 Etcd 键清理，可能导致残留键占用 Etcd 空间或产生冲突。  
2. **兼容性**：虽然代码已删除所有引用，但若外部项目或自定义插件仍依赖 `etcd.NewStorage` 接口，编译将失败。  
3. **文档/运维缺口**：未在代码中提示用户需要手动清理 Etcd，可能导致运维人员忽视此步骤。  
4. **测试覆盖**：原有 Etcd 相关单元测试被删除，若后续重新引入 Etcd 功能，缺少对应的回归测试基准。  

**💡 关注建议**  

- **文档更新**：在 Operator 使用手册中明确说明：`DiscoveryBackend=etcd` 将不再执行键删除，建议在部署删除后手动清理或使用外部脚本。  
- **可配置开关**：如果项目仍需保留 Etcd 清理功能，可考虑通过 feature‑gate（如 `--enable-etcd-cleanup`）来控制，而不是硬删代码。  
- **监控告警**：为使用 Etcd 的用户提供可选的监控指标或日志，提醒可能存在的残留键。  
- **回归测试**：保留一套 Etcd‑mock 测试套件，便于未来如果再次引入 Etcd 支持时快速验证。  
- **依赖审计**：完成此改动后再次运行 `go mod tidy` 并检查 CI，确保没有遗漏的间接依赖导致编译或运行时警告。  

总体来看，此次移除 Etcd 逻辑大幅简化了 Operator 的依赖树，提升了启动速度与安全性，但对仍使用 Etcd 发现后端的用户会产生功能缺失，需要通过文档或可选开关进行补偿。

---

#### 🟡 中重要度变更 (3)

### Rename fetch_llm to fetch_model (#6268)
**SHA**: `5624d14` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/5624d14481feff74732b7fd977e2534ebca00990)

**🛠️ 变更概览**  
本次提交将核心 SDK 中的 *LLM*‑相关 API 全面改名为更通用的 *model*：`fetch_llm` → `fetch_model`，`register_llm` / `unregister_llm` → `register_model` / `unregister_model`。同时在 Python 包、Rust 绑定、示例、文档以及所有后端实现中同步替换，且在 `lib/bindings/python/_core.pyi` 中保留了向后兼容别名。

**⚡ 影响范围**  
- **核心库**：`dynamo.llm` 模块的函数签名与导出名称全部变更，涉及 Rust‑Python FFI。  
- **前端/路由/后端**：所有组件（vLLM、SGLang、TRT‑LLM、Triton、Tensor、视频/图像扩散等）以及示例代码均改为调用 `register_model`/`fetch_model`。  
- **文档**：前端、路由、后端指南、集成示例等全部更新。  
- **测试**：单元/集成测试已改为新 API，确保 CI 通过。  
- **向后兼容**：在 `dynamo._core` 与 Python 包层面提供别名 `fetch_llm = fetch_model`、`register_llm = register_model`、`unregister_llm = unregister_model`，旧代码仍可编译运行，但已发出弃用警告。

**🔍 关键风险**  
1. **别名实现**：别名仅在 Python 层完成，若用户直接在 Rust 代码里调用旧函数（例如 `register_llm`），会出现链接错误。文档应明确仅在 Python 侧保留兼容。  
2. **类型检查**：`_core.pyi` 中加入别名后，IDE 仍会提示旧名称已被弃用；若项目使用严格的 mypy 配置，需更新 `mypy.ini` 或 `pyproject.toml` 中的排除列表。  
3. **跨语言调用**：C++/Go/Java 等非 Python 客户端若依赖旧符号，需要同步更新对应绑定或自行适配别名。  
4. **部署脚本**：部分 CI 脚本或 Helm Chart 中可能硬编码 `register_llm`，需检查并替换。

**💡 建议**  
- 在 `dynamo.llm` 模块的文档页加入 **Deprecation Notice**，标记旧函数将在下一个 major 版本删除。  
- 增加单元测试，验证 `fetch_llm`、`register_llm`、`unregister_llm` 别名在 Python 环境下仍能正常工作，并在测试报告中输出弃用警告。  
- 在 Rust 侧提供 `#[deprecated]` 注解的包装函数（如 `pub async fn register_llm(...) -> Result<...>`），让编译期提示用户迁移。  
- 检查所有 CI/CD、Dockerfile、Helm 模板以及第三方示例仓库，确保已同步新名称。  

整体来看，改名提升了 API 的通用性和语义一致性，除少量向后兼容细节外，风险可控。后续建议在下个 major 版本直接移除别名，完成完整迁移。

---

### fix: vLLM decode worker logging format bug causing CrashLoopBackOff (#6267)
**SHA**: `4e50a3f` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/4e50a3f3ecf8251bc0133dfe425c2e271e2a19d5)

**🎯 变更类型**：Bug 修复  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
在 `components/src/dynamo/vllm/args.py` 中，原先的 `logger.info` 调用了两参数的格式化方式（`msg, arg`），导致日志渲染异常并触发容器 CrashLoopBackOff。现在改为单一的 f‑string 参数，消除了格式化错误，使 decode worker 启动时能够正常记录日志并继续运行。

**🎯 影响范围**  
- `vllm` 子模块的 decode worker 启动路径  
- 依赖 `dynamo_config.is_decode_worker` 判定的日志输出逻辑  
- 受 Kubernetes/Helm 部署的容器生命周期影响（CrashLoopBackOff 现象已消除）

**💡 关注建议**  
1. **回归测试**：在本地和 CI 环境分别启动 decode worker，验证日志不再抛异常，且容器能够成功进入 `Running` 状态。  
2. **日志审计**：检查项目中是否还有类似的多参数 `logger` 调用（如 `logger.debug/info/warn/error`），统一使用 f‑string 或 `logger.<level>(msg, *args)` 的标准写法，以防止潜在的格式化崩溃。  
3. **异常监控**：在部署环境开启日志采集，确认不再出现因日志格式错误导致的 CrashLoopBackOff；若出现异常，及时回滚或进一步排查。  
4. **文档更新**：在 `vllm` 使用说明或部署手册中注明已修复的日志格式问题，提醒运维团队此版本已解决 CrashLoopBackOff。  

整体来看，此修复对功能无侵入，仅提升了系统稳健性，建议尽快推广到生产分支。

---

### test: vllm conformance tests for the new frontend processing APIs (#6256)
**SHA**: `98df1a2` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/98df1a2c585a25d81509fc0e0b5016c526a5a2e8)

**🎯 变更类型**：测试‑新增  
**⚡ 重要程度**：🟡 中  

**📋 变更摘要**  
本次提交在 `components/src/dynamo/vllm/tests/` 新增了 `test_vllm_renderer_api.py`（约 560 行），用于在单元测试层面锁定 vLLM 前端处理相关的 API（`ChatCompletionRequest`、`DeltaMessage`、`SamplingParams`、`EngineCore*` 等）。如果 vLLM 升级导致这些结构体、枚举或函数签名变化，测试会立即失效，提醒 Dynamo 需要同步更新对应的前端代码。

**🎯 影响范围**  
- **components/src/dynamo/frontend/**：`vllm_processor.py`、`prepost.py` 中依赖的 vLLM 类型与方法。  
- **CI 流水线**：新增 `pytest.mark.vllm` 标记的测试，需要在 CI 环境中预装对应版本的 vLLM（及其依赖），否则会导致 CI 失败。  
- **文档/部署**：若 vLLM 版本升级，维护者需先跑通该套测试再发布。

**💡 关注建议**  
1. **CI 环境准备**：确保 CI 镜像中已安装 `vllm`（兼容 Python 3.10+），并固定在一个已通过的版本，避免因库升级导致测试瞬间失效。  
2. **错误信息可读性**：测试里使用的 `assert` 信息已较为明确，建议保持；若后续加入更多断言，可考虑统一包装为自定义异常，以便在 CI 报表中快速定位是 API 结构变更还是实现逻辑变更。  
3. **版本兼容策略**：考虑在 `pyproject.toml` 中加入 `[tool.poetry.dependencies] vllm = ">=0.15,<0.16"`（示例），并在发布说明中注明“本测试基于 vLLM 0.15.x”。  
4. **代码审查**：此文件仅为测试，不影响运行时性能，但请确保 `importlib.import_module` 能正确捕获缺失的 vLLM 包，以免在本地缺少依赖时出现导入错误。可在文件顶部添加 `try/except ImportError` 并跳过测试。  
5. **后续维护**：当 vLLM 官方确实修改了某一字段或签名时，依据测试提示同步更新 `components/src/dynamo/frontend/*` 中的适配代码，防止运行时错误。  

总体而言，此次新增的兼容性测试为 Dynamo 与 vLLM 的耦合提供了防护，属于稳健性提升的经典做法，只需注意 CI 依赖管理与适时的版本约束即可。

---

#### 🟢 低重要度变更 (8)

### ci: add known_third_party to avoid pre-commit isort failure (#6292)
**SHA**: `0abebe3` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/0abebe388404be84bb38f2c2ed32198635941bcc)

**🎯 变更类型**：配置调整  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 `pyproject.toml` 的 isort 配置中新增 `known_third_party = ["vllm", "tensorrt_llm", "sglang"]`，防止 isort 将这些库误判为本地库导致 pre‑commit 检查失败。

---

### docs: update kvbm guide according to docker build change (#6264)
**SHA**: `0142669` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/014266954b150a3f2384dbcb53fdeed02abebd55)

**🎯 变更类型**：文档更新  
**⚡ 重要程度**：🟢低  
**📋 摘要**：更新 KVBM 指南，改为使用 `container/render.py` 生成 Dockerfile 并手动 `docker build`，对应运行脚本改为显式指定镜像名；同步修正了 bindings/kvbm README 中的命令参数错误。

---

### ci: Route buildkit picks a random address if multiple are available (#6284)
**SHA**: `40355b3` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/40355b324cf4c78ba956dc6f6f77d64c628daed3)

**🎯 变更类型**：CI/配置调整  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 GitHub CI 中新增 `route_buildkit.sh` 脚本至过滤列表，并修改脚本使其在多个可用 BuildKit 实例之间随机选择一个地址进行路由。

---

### chore: allow frontend + mockers to run on macos (#6282)
**SHA**: `e30696e` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/e30696e5aa659db469357a09c018939a2cb284e5)

**🎯 变更类型**：代码重构  
**⚡ 重要程度**：🟢 低  
**📋 摘要**：为 macOS 编译 Python 绑定添加 `build.rs` 生成空 `libstdc++.a`，在 `Cargo.toml` 中使用条件依赖区分 Linux 与非‑Linux，去除 `LocalModel` 的默认媒体解码器初始化，并将 `PerfModel` 的日志级别从 `debug` 降为 `trace`，使前端和 mockers 能在 macOS 上运行。

---

### docs: Change `FRAMEWORK` variable to lowercase (#6266)
**SHA**: `fb5b1bc` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/fb5b1bc12041780e4c49b86af13d6fc3f384a6a9)

**🎯 变更类型**：文档更新  
**⚡ 重要程度**：🟢低  
**📋 摘要**：将 `.devcontainer/README.md` 中的 `FRAMEWORK` 示例值从大写（VLLM、SGLANG、TRTLLM）改为小写（vllm、sglang、trtllm），保持提示一致性。

---

### test: flaky test_sliding_window cache stats test (#6166)
**SHA**: `55a246a` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/55a246a3d35df1652894b0324ad08872a897a2fb)

**🎯 变更类型**：测试修改  
**⚡ 重要程度**：🟢低  
**📋 摘要**：为 `CacheStatsTracker` 添加 `new_with_capacity` 构造函数，直接在单元测试中设定窗口大小，去除对环境变量的依赖，简化并提升测试的确定性。

---

### ci: add rust check to keep lockfiles updated (#6278)
**SHA**: `f308a3d` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/f308a3d3d1388da55ccb85cefc208522d67fe764)

**🎯 变更类型**：配置调整  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 CI 工作流 `pre-merge.yml` 增加 `cargo metadata --locked` 检查，确保 Cargo.lock 与代码同步；同时更新 `lib/bindings/kvbm/Cargo.lock`，新增 `dashmap、flume、parking_lot、tokio-timerfd` 等依赖及相关版本。

---

### chore: more mocker rusty cleanups (#6271)
**SHA**: `5a3c52a` | 🔗 [查看提交](https://github.com/ai-dynamo/dynamo/commit/5a3c52ab7050fc5d666ef8fa9fe5d9a2d237e320)

**🎯 变更类型**：代码重构  
**⚡ 重要程度**：🟢低  
**📋 摘要**：在 `mocker.rs` 中引入 `DashMap` 替代 `Mutex<HashMap>`，使用 `Notify` 同步初始化，简化 `MockEngineArgs` 判断逻辑并将 KV 发布器、指标端点等初始化合并，去除环境变量控制，提升并发安全和启动可靠性。

---

